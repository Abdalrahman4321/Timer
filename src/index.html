<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProTimer ⏱️ - Professional Timer App</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProTimer">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-TileColor" content="#0f172a">
    
    <!-- Favicon for PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Roboto+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            background: var(--darker);
            color: var(--light);
            height: 100vh;
            width: 100vw;
            -webkit-overflow-scrolling: touch;
            transition: all 0.3s ease;
        }
        
        /* PWA Styles */
        @media (display-mode: standalone) {
            body {
                height: 100dvh;
                width: 100dvw;
            }
            
            .pwa-controls {
                display: none !important;
            }
            
            .control-panel {
                padding-bottom: max(16px, env(safe-area-inset-bottom)) !important;
            }
            
            #installPWAButton {
                display: none !important;
            }
            
            /* مميزات إضافية عند التثبيت كتطبيق */
            .pwa-feature {
                display: block !important;
            }
        }
        
        /* Safe Area Insets for Notch Devices */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes flash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(255, 65, 54, 0.3); }
        }
        
        @keyframes wipe {
            0% { 
                transform: translate(-50%, -50%) scale(0); 
                border-radius: 50%; 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(3); 
                border-radius: 0; 
                opacity: 1; 
            }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Utility Classes */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-bounce-slow { animation: bounce 2s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out; }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-out { animation: fadeOut 0.3s ease-out; }
        
        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Digit Styles */
        .digit {
            text-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.3),
                0 8px 16px rgba(0, 0, 0, 0.2),
                0 0 0 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .digit-interactive:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }
        
        .digit-interactive:active {
            transform: scale(0.95);
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Settings Panel */
        .settings-panel {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Tabs Container Scrollable */
        .tabs-container {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        
        .tabs-container::-webkit-scrollbar {
            display: none;
        }
        
        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            stroke-linecap: round;
            transition: stroke-dashoffset 0.35s;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            width: 60px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .toggle-switch.active {
            background: var(--secondary);
        }
        
        .toggle-switch-handle {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active .toggle-switch-handle {
            transform: translateX(28px);
        }
        
        /* Color Picker */
        .color-picker {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 10px;
        }
        
        /* Range Slider */
        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            border: 2px solid white;
        }
        
        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        /* علامات النقطتين مصممة بشكل أفضل */
        .time-separator {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            user-select: none;
            height: 100%;
            padding: 0 5px;
            position: relative;
        }
        
        .time-separator-dot {
            width: 8px;
            height: 8px;
            background-color: currentColor;
            border-radius: 50%;
            opacity: 0.8;
            margin: 4px 0;
        }
        
        /* تحسينات للشاشات المختلفة */
        .focus-mode .time-separator-dot {
            width: 12px;
            height: 12px;
            margin: 6px 0;
        }
        
        @media (max-width: 768px) {
            .time-separator-dot {
                width: 6px;
                height: 6px;
                margin: 3px 0;
            }
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        /* Card Styles */
        .card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* Tab Styles */
        .tab {
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            flex-shrink: 0;
            touch-action: manipulation;
        }
        
        .tab.active {
            background: rgba(99, 102, 241, 0.2);
            color: white;
            border: 1px solid rgba(99, 102, 241, 0.4);
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Input Styles */
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 16px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        
        /* Timer Finish Wipe */
        .wipe-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 100vh;
            height: 100vh;
            background: var(--danger);
            border-radius: 50%;
            z-index: 100;
            animation: wipe 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            pointer-events: none;
        }
        
        /* Finish Overlay */
        .finish-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--danger), #dc2626);
            z-index: 90;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Flashing Background */
        .flashing-bg {
            animation: flash 0.5s infinite alternate;
        }
        
        /* Media Background */
        .media-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            transition: opacity 0.5s ease;
        }
        
        /* Control Panel */
        .control-panel {
            background: linear-gradient(to top, rgba(2, 6, 23, 0.9), transparent);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            padding-bottom: 15px;
        }
        
        /* PWA Install Button */
        .pwa-install-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 40;
            animation: bounce 2s infinite;
        }
        
        /* Settings Panel Scrollable Content */
        .settings-content {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* نظام Flexbox محسن لمنع التزاحم */
        .timer-digits-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 100vw;
            overflow: hidden;
            padding: 10px 0;
        }
        
        .time-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            min-width: 100px;
        }
        
        .time-value {
            font-size: 4.5rem;
            line-height: 1;
            text-align: center;
            transition: all 0.3s ease;
            font-variant-numeric: tabular-nums;
            -moz-font-feature-settings: "tnum";
            -webkit-font-feature-settings: "tnum";
            font-feature-settings: "tnum";
            cursor: pointer;
            font-weight: 700;
            min-width: 110px;
        }
        
        .time-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .time-unit {
                min-width: 70px;
            }
            
            .time-value {
                font-size: 3.2rem;
                min-width: 80px;
            }
            
            .time-label {
                font-size: 0.75rem;
            }
            
            .time-separator-dot {
                width: 5px;
                height: 5px;
                margin: 2.5px 0;
            }
        }
        
        @media (max-width: 480px) {
            .time-unit {
                min-width: 60px;
            }
            
            .time-value {
                font-size: 2.8rem;
                min-width: 70px;
            }
            
            .time-label {
                font-size: 0.65rem;
            }
            
            .time-separator-dot {
                width: 4px;
                height: 4px;
                margin: 2px 0;
            }
        }
        
        /* تحسينات الفوكس مود - التايمر في المنتصف دائماً */
        .focus-mode .timer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 95vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .focus-mode .timer-digits-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            flex-wrap: nowrap;
        }
        
        .focus-mode .time-unit {
            min-width: auto;
            flex: 0 0 auto;
        }
        
        .focus-mode .time-value {
            font-size: 14vw !important;
            line-height: 1;
            min-width: auto;
            width: auto;
            margin: 0;
        }
        
        .focus-mode .time-label {
            font-size: 2vw !important;
            margin-top: 1vw;
            display: block;
        }
        
        .focus-mode .time-separator {
            margin: 0 2vw;
        }
        
        .focus-mode .time-separator-dot {
            width: 1.5vw !important;
            height: 1.5vw !important;
            margin: 0.8vw 0 !important;
        }
        
        .focus-mode .control-panel,
        .focus-mode #instructions,
        .focus-mode #quickAddButtons,
        .focus-mode .timer-title-section,
        .focus-mode .progress-container,
        .focus-mode .app-title,
        .focus-mode #timerStatus {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            transform: translateY(100%) !important;
            transition: all 0.3s ease;
        }
        
        /* إصلاح وقت النظام في الفوكس مود */
        .focus-mode .header-section .system-time {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            transform: none !important;
            position: fixed !important;
            top: 15px !important;
            right: 15px !important;
            z-index: 1000 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        /* إخفاء العنوان في الفوكس مود */
        .focus-mode .header-section .app-title {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        #focusModeToggle {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            z-index: 1000 !important;
            background: rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 50% !important;
            width: 60px !important;
            height: 60px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
            animation: pulse 2s infinite !important;
        }
        
        #focusModeToggle:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            transform: scale(1.1) !important;
        }
        
        /* Minimized Controls */
        .minimized-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(100%);
            transition: all 0.3s ease;
        }
        
        .minimized-controls.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .minimized-controls .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }
        
        .minimized-controls .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .minimized-controls .control-btn:active {
            transform: scale(0.95);
        }
        
        /* تحسينات التناسق العامة */
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .header-section {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
            min-height: 70px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 10px 20px;
            position: relative;
            z-index: 10;
            overflow: hidden;
            min-height: 0;
        }
        
        .timer-display-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .progress-container {
            margin: 10px 0;
            position: relative;
            width: 140px;
            height: 140px;
            flex-shrink: 0;
        }
        
        .timer-title-section {
            margin-bottom: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .quick-add-section {
            margin-bottom: 10px;
            width: 100%;
            max-width: 600px;
            flex-shrink: 0;
        }
        
        .instructions-section {
            margin-top: 10px;
            width: 100%;
            max-width: 800px;
            flex-shrink: 0;
        }
        
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            flex-shrink: 0;
        }
        
        /* تحسينات لمنع التزاحم */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        
        .non-scrollable {
            flex-shrink: 0;
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover, .btn-secondary:hover, .tab:hover, .card:hover {
                transform: none;
            }
            
            .digit-interactive:hover {
                transform: none;
            }
        }
        
        /* Custom Alert Styles */
        .swal2-popup {
            background: var(--darker) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 16px !important;
        }
        
        .swal2-title {
            color: var(--light) !important;
        }
        
        .swal2-html-container {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .swal2-confirm {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
            border-radius: 12px !important;
        }
        
        .swal2-deny {
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 12px !important;
            color: white !important;
        }
        
        /* مميزات إضافية عند التثبيت كتطبيق */
        .pwa-feature {
            display: none;
        }
        
        /* تحسينات للموبايل */
        .touch-feedback:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        /* Keyboard Shortcut Help */
        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 2px 6px;
            margin: 0 2px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
        
        /* Font Upload Styles */
        .font-upload-container {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .font-upload-container:hover {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .font-upload-container.drag-over {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .font-preview {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .font-preview-text {
            font-size: 24px;
            text-align: center;
            padding: 10px;
        }
        
        /* Uploaded Fonts List */
        .uploaded-fonts-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .font-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .font-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .font-item.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
        }
        
        .font-actions {
            display: flex;
            gap: 10px;
        }
        
        .font-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .font-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .font-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* تحسين تناسق عناصر التحكم */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 800px;
        }
        
        .control-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        /* التمرير السلس */
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        /* ضبط تباعد أزرار الكويك أد */
        .quick-add-section .flex {
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-add-section button {
            padding: 8px 12px;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        /* إصلاحات للعرض العام */
        .timer-digits-container > * {
            flex-shrink: 0;
        }
        
        /* ضبط الحجم في الوضع العادي */
        @media (min-width: 769px) {
            .time-value {
                font-size: 5rem !important;
                min-width: 120px !important;
            }
        }
        
        /* إصلاح مشكلة تحميل الخطوط */
        @font-face {
            font-family: 'DigitalFont';
            src: local('Arial');
        }
        
        /* تصميم أزرار المطورين */
        .developer-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .developer-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }
        
        .developer-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .developer-role {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 10px;
        }
        
        .developer-contact-btn {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(37, 211, 102, 0.2);
            border: 1px solid rgba(37, 211, 102, 0.3);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .developer-contact-btn:hover {
            background: rgba(37, 211, 102, 0.3);
            transform: translateY(-1px);
        }
        
        .whatsapp-icon {
            color: #25D366;
        }
        
        /* WhatsApp Contact Styles */
        .whatsapp-contact-modal {
            max-width: 500px !important;
        }
        
        .whatsapp-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .whatsapp-option:hover {
            background: rgba(37, 211, 102, 0.1);
            border-color: rgba(37, 211, 102, 0.3);
            transform: translateY(-2px);
        }
        
        .whatsapp-option-icon {
            width: 40px;
            height: 40px;
            background: rgba(37, 211, 102, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .whatsapp-option-icon i {
            color: #25D366;
            font-size: 20px;
        }
        
        .whatsapp-option-content {
            flex: 1;
        }
        
        .whatsapp-option-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .whatsapp-option-description {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .contact-instructions {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .contact-instructions ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .contact-instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        /* إضافة: إخفاء الساعات في الفوكس مود إذا كانت صفر */
        .focus-mode .time-unit.hours-zero {
            display: none !important;
        }
        
        .focus-mode .time-separator.hide-separator {
            display: none !important;
        }
        
        /* سهم التمرير في واجهة تايمر */
        .scroll-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            animation: bounce 2s infinite;
            z-index: 10;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        
        .scroll-indicator:hover {
            opacity: 1;
        }
        
        .scroll-indicator i {
            font-size: 24px;
        }
        
        /* لوحة المهام السريعة */
        .quick-tasks-panel {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            display: none;
            flex-direction: column;
            gap: 12px;
        }
        
        .quick-tasks-panel.show {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }
        
        .task-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .task-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .task-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .task-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .task-time {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .task-description {
            font-size: 0.9rem;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .task-action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .task-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .task-action-btn.complete {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .task-action-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* تذييل المهام */
        .tasks-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* نظرة عامة على المساحة */
        .storage-overview {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .storage-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .storage-stat {
            text-align: center;
            flex: 1;
            padding: 10px;
        }
        
        .storage-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .storage-stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        .storage-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .storage-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .storage-info {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 10px;
            text-align: center;
        }
        
        /* تاريخ انتهاء الصلاحية */
        .expiration-date {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .expiration-date.warning {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="h-screen w-screen overflow-hidden relative">
        <!-- Media Background -->
        <div id="mediaBackground" class="media-bg opacity-0 transition-opacity duration-500">
            <!-- Background image/video will be inserted here -->
        </div>
        
        <!-- Header Section -->
        <div class="header-section">
            <!-- App Title -->
            <div class="app-title glass rounded-2xl px-4 py-2">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-stopwatch text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">ProTimer ⏱️</h1>
                        <p class="text-xs opacity-60">Professional Timer</p>
                    </div>
                </div>
            </div>
            
            <!-- Current Time -->
            <div class="system-time glass rounded-2xl px-4 py-2 text-center">
                <div id="currentTime" class="font-mono font-bold">00:00:00 PM</div>
                <div class="text-xs opacity-60">SYSTEM TIME</div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Timer Title -->
            <div class="timer-title-section">
                <div id="timerTitle" class="text-3xl md:text-4xl font-bold gradient-text">PROFESSIONAL TIMER</div>
            </div>
            
            <!-- Timer Display Section -->
            <div class="timer-display-section">
                <!-- Progress Ring -->
                <div class="progress-container">
                    <svg class="progress-ring w-full h-full" width="140" height="140">
                        <circle class="progress-ring-circle" 
                                stroke="rgba(99, 102, 241, 0.3)" 
                                stroke-width="8" 
                                fill="transparent" 
                                r="60" 
                                cx="70" 
                                cy="70" />
                        <circle id="progressCircle" 
                                class="progress-ring-circle" 
                                stroke="#6366f1" 
                                stroke-width="8" 
                                fill="transparent" 
                                r="60" 
                                cx="70" 
                                cy="70"
                                stroke-dasharray="377"
                                stroke-dashoffset="377" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div id="progressText" class="text-xl font-bold">100%</div>
                    </div>
                </div>
                
                <!-- Timer Digits -->
                <div class="timer-container">
    <div id="timerDigitsContainer" class="timer-digits-container">
        <div id="hoursUnit" class="time-unit">
            <div id="hoursDisplay" 
                 class="time-value cursor-pointer transition-all duration-300 hover:scale-105 active:scale-95"
                 onclick="adjustTime('hours', 1)"
                 oncontextmenu="event.preventDefault(); adjustTime('hours', -1)"
                 ondblclick="openKeyboardInput('hours')">
                00
            </div>
            <div class="time-label"></div>
        </div>
        
        <div id="firstSeparator" class="time-separator">
            <div class="time-separator-dot"></div>
            <div class="time-separator-dot"></div>
        </div>
        
        <div class="time-unit">
            <div id="minutesDisplay" 
                 class="time-value cursor-pointer transition-all duration-300 hover:scale-105 active:scale-95"
                 onclick="adjustTime('minutes', 1)"
                 oncontextmenu="event.preventDefault(); adjustTime('minutes', -1)"
                 ondblclick="openKeyboardInput('minutes')">
                10
            </div>
            <div class="time-label"></div>
        </div>
        
        <div class="time-separator">
            <div class="time-separator-dot"></div>
            <div class="time-separator-dot"></div>
        </div>
        
        <div class="time-unit">
            <div id="secondsDisplay" 
                 class="time-value cursor-pointer transition-all duration-300 hover:scale-105 active:scale-95"
                 onclick="adjustTime('seconds', 1)"
                 oncontextmenu="event.preventDefault(); adjustTime('seconds', -1)"
                 ondblclick="openKeyboardInput('seconds')">
                00
            </div>
            <div class="time-label"></div>
        </div>
    </div>
</div>
                
                <!-- سهم التمرير -->
                <div class="scroll-indicator hidden" id="scrollIndicator">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            
            <!-- Quick Add Minutes Buttons -->
            <div id="quickAddButtons" class="quick-add-section glass rounded-2xl px-6 py-4 animate-fade-in mx-4">
                <div class="flex items-center justify-center gap-3 md:gap-4">
                    <span class="opacity-80 font-medium mr-2">Quick Add:</span>
                    <button onclick="addMinutes(1)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +1 min
                    </button>
                    <button onclick="addMinutes(5)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +5 min
                    </button>
                    <button onclick="addMinutes(10)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +10 min
                    </button>
                    <button onclick="addMinutes(15)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +15 min
                    </button>
                    <button onclick="addMinutes(30)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +30 min
                    </button>
                </div>
            </div>
            
            <!-- Timer Status -->
            <div id="timerStatus" class="text-center mt-2 text-lg opacity-80">
                <div class="flex items-center justify-center gap-3">
                    <i class="fas fa-info-circle"></i>
                    <span>Timer is ready. Set your time and press START.</span>
                </div>
            </div>
            
            <!-- Instructions -->
            <div id="instructions" class="instructions-section glass rounded-2xl px-4 py-3 animate-fade-in mx-4">
                <div class="flex flex-wrap items-center justify-center gap-3 text-sm md:text-base">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-keyboard text-xs"></i>
                        </div>
                        <span><span class="shortcut-key">SPACE</span> Start/Pause</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-mouse-pointer text-xs"></i>
                        </div>
                        <span>CLICK to Add Time</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-eye text-xs"></i>
                        </div>
                        <span><span class="shortcut-key">F</span> Focus Mode</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel absolute bottom-0 left-0 right-0 p-4 z-20">
            <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4">
                <!-- Start/Pause Button -->
                <button id="startPauseBtn" 
                        class="btn-primary flex items-center gap-3 animate-glow touch-feedback"
                        onclick="toggleTimer()">
                    <i class="fas fa-play text-lg"></i>
                    <span class="text-lg font-semibold">START TIMER</span>
                </button>
                
                <!-- Reset Button -->
                <button id="resetBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="confirmReset()">
                    <i class="fas fa-redo text-lg"></i>
                    <span>RESET</span>
                </button>
                
                <!-- Add Minute Button -->
                <button id="addMinuteBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="addMinutes(1)">
                    <i class="fas fa-plus text-lg"></i>
                    <span>+1 MIN</span>
                </button>
                
                <!-- Settings Button -->
                <button id="settingsBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="toggleSettings()">
                    <i class="fas fa-cog text-lg"></i>
                    <span>SETTINGS</span>
                </button>
                
                <!-- Fullscreen Button -->
                <button id="fullscreenBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="toggleFullscreen()">
                    <i class="fas fa-expand text-lg"></i>
                    <span>FULLSCREEN</span>
                </button>
                
                <!-- Sound Toggle -->
                <button id="soundToggleBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="toggleSound()">
                    <i id="soundIcon" class="fas fa-volume-up text-lg"></i>
                    <span id="soundText">SOUND ON</span>
                </button>
                
                <!-- Focus Mode Toggle -->
                <button id="focusModeToggle" 
                        class="btn-secondary flex items-center justify-center gap-0 touch-feedback"
                        onclick="toggleFocusMode()">
                    <i id="focusIcon" class="fas fa-eye text-lg"></i>
                </button>
                
                <!-- Quick Tasks Button -->
                <button id="quickTasksBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="toggleQuickTasks()">
                    <i class="fas fa-tasks text-lg"></i>
                    <span>TASKS</span>
                </button>
            </div>
            
            <!-- Keyboard Shortcuts Help (Collapsible) -->
            <div class="mt-2 text-center">
                <button onclick="toggleShortcutsHelp()" class="text-sm opacity-60 hover:opacity-100 transition-opacity">
                    <i class="fas fa-keyboard mr-1"></i> All Keyboard Shortcuts
                </button>
                <div id="shortcutsHelp" class="hidden mt-2 glass rounded-lg p-3 text-xs">
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="shortcut-key">SPACE</span> Start/Pause</div>
                        <div><span class="shortcut-key">R</span> Reset Timer</div>
                        <div><span class="shortcut-key">+</span> Add 1 min</div>
                        <div><span class="shortcut-key">-</span> Subtract 1 min</div>
                        <div><span class="shortcut-key">0-9</span> Quick Presets</div>
                        <div><span class="shortcut-key">:</span> Manual Time Input</div>
                        <div><span class="shortcut-key">F</span> Toggle Focus Mode</div>
                        <div><span class="shortcut-key">F11</span> Fullscreen</div>
                        <div><span class="shortcut-key">ESC</span> Close Panels</div>
                        <div><span class="shortcut-key">Ctrl+S</span> Save Preset</div>
                        <div><span class="shortcut-key">Ctrl+O</span> Open Settings</div>
                        <div><span class="shortcut-key">Ctrl+I</span> Manual Input</div>
                        <div><span class="shortcut-key">H</span> Show Shortcuts</div>
                        <div><span class="shortcut-key">T</span> Toggle Tasks</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Minimized Controls (Hidden by default) -->
        <div id="minimizedControls" class="minimized-controls">
            <button id="minimizedStartPause" class="control-btn" onclick="toggleTimer()">
                <i class="fas fa-play"></i>
            </button>
            <button id="minimizedReset" class="control-btn" onclick="confirmReset()">
                <i class="fas fa-redo"></i>
            </button>
            <button id="minimizedSettings" class="control-btn" onclick="toggleSettings()">
                <i class="fas fa-cog"></i>
            </button>
            <button id="minimizedFocus" class="control-btn" onclick="toggleFocusMode()">
                <i class="fas fa-eye"></i>
            </button>
            <button id="minimizedTasks" class="control-btn" onclick="toggleQuickTasks()">
                <i class="fas fa-tasks"></i>
            </button>
        </div>
        
        <!-- Quick Tasks Panel -->
        <div id="quickTasksPanel" class="quick-tasks-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Quick Tasks</h3>
                <button onclick="toggleQuickTasks()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors touch-feedback">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="tasksList" class="flex-1 overflow-y-auto">
                <!-- المهام ستضاف هنا ديناميكياً -->
                <div class="text-center py-8 opacity-50">
                    <i class="fas fa-tasks text-3xl mb-3"></i>
                    <p>No tasks yet</p>
                    <p class="text-sm mt-2">Add tasks to track your activities</p>
                </div>
            </div>
            
            <div class="tasks-footer">
                <div class="flex gap-2">
                    <input type="text" id="newTaskInput" placeholder="New task..." class="input-field flex-1 text-sm">
                    <button onclick="addNewTask()" class="btn-primary px-4 py-2 text-sm touch-feedback">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="flex justify-between items-center mt-3 text-sm opacity-70">
                    <span id="tasksCount">0 tasks</span>
                    <button onclick="clearCompletedTasks()" class="text-red-300 hover:text-red-400 touch-feedback">
                        Clear Completed
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PWA Install Button -->
        <button id="installPWAButton" class="fixed bottom-24 right-6 z-40 btn-primary shadow-lg flex items-center gap-2 pwa-install-btn hidden">
            <i class="fas fa-download"></i>
            <span>Install App</span>
        </button>
        
        <!-- Settings Panel -->
        <div id="settingsPanel" class="settings-panel fixed inset-y-0 right-0 w-full md:w-1/3 lg:w-1/4 glass-dark z-30 transform translate-x-full transition-transform duration-300 overflow-hidden">
            <div class="h-full flex flex-col">
                <!-- Header -->
                <div class="p-6 border-b border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">Timer Settings</h2>
                            <p class="opacity-60">Customize your experience</p>
                        </div>
                        <button onclick="toggleSettings()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors touch-feedback">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Tabs Container (Scrollable) -->
                <div class="tabs-container px-6 pt-4">
                    <button data-tab="timer" class="tab active" onclick="switchTab('timer')">
                        <i class="fas fa-clock mr-2"></i> Timer
                    </button>
                    <button data-tab="appearance" class="tab" onclick="switchTab('appearance')">
                        <i class="fas fa-palette mr-2"></i> Appearance
                    </button>
                    <button data-tab="fonts" class="tab" onclick="switchTab('fonts')">
                        <i class="fas fa-font mr-2"></i> Fonts
                    </button>
                    <button data-tab="media" class="tab" onclick="switchTab('media')">
                        <i class="fas fa-photo-video mr-2"></i> Media
                    </button>
                    <button data-tab="audio" class="tab" onclick="switchTab('audio')">
                        <i class="fas fa-volume-up mr-2"></i> Audio
                    </button>
                    <button data-tab="notifications" class="tab" onclick="switchTab('notifications')">
                        <i class="fas fa-bell mr-2"></i> Notifications
                    </button>
                    <button data-tab="storage" class="tab" onclick="switchTab('storage')">
                        <i class="fas fa-database mr-2"></i> Storage
                    </button>
                    <button data-tab="advanced" class="tab" onclick="switchTab('advanced')">
                        <i class="fas fa-cogs mr-2"></i> Advanced
                    </button>
                    <!-- Scroll indicator -->
                    <div class="flex items-center px-2 opacity-50">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                
                <!-- Tab Content (Scrollable) -->
                <div class="settings-content flex-1 overflow-y-auto px-6 smooth-scroll">
                    <div id="tabContent" class="space-y-6 pb-6">
                        <!-- Timer Tab -->
                        <div data-tab-content="timer" class="tab-content active">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-hourglass-start"></i> Timer Duration
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Hours -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Hours</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="hoursSlider" min="0" max="99" value="0" class="range-slider flex-1">
                                                <input type="number" id="hoursInput" min="0" max="99" value="0" class="input-field w-20 text-center">
                                            </div>
                                        </div>
                                        
                                        <!-- Minutes -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Minutes</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="minutesSlider" min="0" max="59" value="10" class="range-slider flex-1">
                                                <input type="number" id="minutesInput" min="0" max="59" value="10" class="input-field w-20 text-center">
                                            </div>
                                        </div>
                                        
                                        <!-- Seconds -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Seconds</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="secondsSlider" min="0" max="59" value="0" class="range-slider flex-1">
                                                <input type="number" id="secondsInput" min="0" max="59" value="0" class="input-field w-20 text-center">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-flag-checkered"></i> Finish Message
                                    </h3>
                                    <input type="text" id="finishMessage" value="Time's Up!" class="input-field" placeholder="Enter finish message...">
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-bolt"></i> Quick Presets
                                    </h3>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="setQuickPreset(1)" class="btn-secondary py-3 touch-feedback">1 min</button>
                                        <button onclick="setQuickPreset(5)" class="btn-secondary py-3 touch-feedback">5 min</button>
                                        <button onclick="setQuickPreset(10)" class="btn-secondary py-3 touch-feedback">10 min</button>
                                        <button onclick="setQuickPreset(15)" class="btn-secondary py-3 touch-feedback">15 min</button>
                                        <button onclick="setQuickPreset(30)" class="btn-secondary py-3 touch-feedback">30 min</button>
                                        <button onclick="setQuickPreset(60)" class="btn-secondary py-3 touch-feedback">1 hour</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Appearance Tab -->
                        <div data-tab-content="appearance" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-fill-drip"></i> Colors
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Background Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Background Color</label>
                                            <input type="color" id="bgColor" value="#0f172a" class="color-picker">
                                        </div>
                                        
                                        <!-- Text Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Digit Color</label>
                                            <input type="color" id="textColor" value="#ffffff" class="color-picker">
                                        </div>
                                        
                                        <!-- Outline Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Outline Color</label>
                                            <input type="color" id="outlineColor" value="#000000" class="color-picker">
                                        </div>
                                        
                                        <!-- Progress Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Progress Ring Color</label>
                                            <input type="color" id="progressColor" value="#6366f1" class="color-picker">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-brush"></i> Outline Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Outline Toggle -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Enable Outline</span>
                                            <div id="outlineToggle" class="toggle-switch" onclick="toggleOutline()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Outline Thickness -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Outline Thickness: <span id="outlineThicknessValue">2</span>px</label>
                                            <input type="range" id="outlineThickness" min="1" max="10" value="2" class="range-slider">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-adjust"></i> Opacity Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Background Opacity -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Background Opacity: <span id="bgOpacityValue">100</span>%</label>
                                            <input type="range" id="bgOpacity" min="20" max="100" value="100" class="range-slider">
                                        </div>
                                        
                                        <!-- Control Panel Opacity -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Control Panel Opacity: <span id="panelOpacityValue">90</span>%</label>
                                            <input type="range" id="panelOpacity" min="50" max="100" value="90" class="range-slider">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fonts Tab -->
                        <div data-tab-content="fonts" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-font"></i> Font Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Font Family -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Font Family</label>
                                            <select id="fontFamily" class="input-field">
                                                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                                                <option value="'Inter', sans-serif">Inter</option>
                                                <option value="'Orbitron', sans-serif">Orbitron (Digital)</option>
                                                <option value="'Roboto Mono', monospace">Roboto Mono</option>
                                                <option value="'Segoe UI', sans-serif">Segoe UI</option>
                                                <option value="Arial, sans-serif">Arial</option>
                                                <option value="'Courier New', monospace">Courier New</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Font Size -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Digit Size: <span id="fontSizeValue">12</span>rem</label>
                                            <input type="range" id="fontSize" min="8" max="20" value="12" class="range-slider">
                                        </div>
                                        
                                        <!-- Font Weight -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Font Weight</label>
                                            <select id="fontWeight" class="input-field">
                                                <option value="400">Normal</option>
                                                <option value="600">Semibold</option>
                                                <option value="700" selected>Bold</option>
                                                <option value="800">Extra Bold</option>
                                                <option value="900">Black</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-upload"></i> Upload Custom Fonts
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Font Upload Area -->
                                        <div id="fontUploadArea" class="font-upload-container" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleFontDrop(event)">
                                            <i class="fas fa-cloud-upload-alt text-4xl opacity-50 mb-4"></i>
                                            <h4 class="text-lg font-semibold mb-2">Drag & Drop Font Files</h4>
                                            <p class="opacity-70 mb-4">Supports: .ttf, .otf, .woff, .woff2</p>
                                            <button onclick="document.getElementById('fontFileInput').click()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-folder-open mr-2"></i> Browse Files
                                            </button>
                                            <input type="file" id="fontFileInput" accept=".ttf,.otf,.woff,.woff2" multiple class="hidden" onchange="handleFontFileSelect(event)">
                                        </div>
                                        
                                        <!-- Uploaded Fonts -->
                                        <div class="mt-4">
                                            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
                                                <i class="fas fa-font-case"></i> Uploaded Fonts
                                            </h4>
                                            <div id="uploadedFontsList" class="uploaded-fonts-list">
                                                <!-- Uploaded fonts will be listed here -->
                                                <div class="text-center py-8 opacity-50">
                                                    <i class="fas fa-font text-3xl mb-3"></i>
                                                    <p>No custom fonts uploaded yet</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Font Preview -->
                                        <div id="fontPreviewContainer" class="hidden">
                                            <h4 class="text-lg font-semibold mb-3">Font Preview</h4>
                                            <div class="font-preview">
                                                <div id="fontPreviewText" class="font-preview-text" style="font-size: 24px;">
                                                    00:10:00
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Media Tab -->
                        <div data-tab-content="media" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-image"></i> Background Media
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Media Toggle -->
                                        <div class="flex items-center justify-between mb-4">
                                            <span class="opacity-80">Enable Background Media</span>
                                            <div id="mediaToggle" class="toggle-switch" onclick="toggleMedia()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Media Type -->
                                        <div class="space-y-4">
                                            <!-- URL Input -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Media URL</label>
                                                <div class="flex gap-2">
                                                    <input type="text" id="mediaUrl" placeholder="Enter image/video URL..." class="input-field flex-1">
                                                    <button onclick="testMedia()" class="btn-secondary whitespace-nowrap touch-feedback">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </div>
                                                <p class="text-xs opacity-50 mt-1">Supports: JPG, PNG, GIF, MP4, WebM</p>
                                            </div>
                                            
                                            <!-- File Upload -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Upload Local File</label>
                                                <div class="flex gap-2">
                                                    <input type="file" id="mediaFile" accept="image/*,video/*" class="hidden">
                                                    <button onclick="document.getElementById('mediaFile').click()" class="btn-secondary flex-1 touch-feedback">
                                                        <i class="fas fa-upload mr-2"></i> Choose File
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Remove Media Button -->
                                            <div>
                                                <button onclick="removeMedia()" class="btn-secondary w-full text-red-300 border-red-500/30 touch-feedback">
                                                    <i class="fas fa-trash-alt mr-2"></i> Remove Current Media
                                                </button>
                                            </div>
                                            
                                            <!-- Media Audio -->
                                            <div class="flex items-center justify-between pt-4 border-t border-white/10">
                                                <span class="opacity-80">Enable Media Audio</span>
                                                <div id="mediaAudioToggle" class="toggle-switch" onclick="toggleMediaAudio()">
                                                    <div class="toggle-switch-handle"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- Media Opacity -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Media Opacity: <span id="mediaOpacityValue">30</span>%</label>
                                                <input type="range" id="mediaOpacity" min="10" max="100" value="30" class="range-slider">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Media Preview -->
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-eye"></i> Preview
                                    </h3>
                                    <div id="mediaPreview" class="aspect-video bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden">
                                        <div class="text-center p-4">
                                            <i class="fas fa-image text-4xl opacity-30 mb-2"></i>
                                            <p class="opacity-50">No media selected</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audio Tab -->
                        <div data-tab-content="audio" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-music"></i> Soundtrack
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Audio Toggle -->
                                        <div class="flex items-center justify-between mb-4">
                                            <span class="opacity-80">Enable Soundtrack</span>
                                            <div id="audioToggle" class="toggle-switch" onclick="toggleAudio()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Audio Source -->
                                        <div class="space-y-4">
                                            <!-- URL Input -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Audio URL</label>
                                                <div class="flex gap-2">
                                                    <input type="text" id="audioUrl" placeholder="Enter audio URL..." class="input-field flex-1">
                                                    <button onclick="testAudio()" class="btn-secondary whitespace-nowrap touch-feedback">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- File Upload -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Upload Audio File</label>
                                                <div class="flex gap-2">
                                                    <input type="file" id="audioFile" accept="audio/*" class="hidden">
                                                    <button onclick="document.getElementById('audioFile').click()" class="btn-secondary flex-1 touch-feedback">
                                                        <i class="fas fa-upload mr-2"></i> Choose File
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Remove Audio Button -->
                                            <div>
                                                <button onclick="removeAudio()" class="btn-secondary w-full text-red-300 border-red-500/30 touch-feedback">
                                                    <i class="fas fa-trash-alt mr-2"></i> Remove Current Audio
                                                </button>
                                            </div>
                                            
                                            <!-- Volume Control -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Volume: <span id="volumeValue">50</span>%</label>
                                                <input type="range" id="volumeSlider" min="0" max="100" value="50" class="range-slider">
                                            </div>
                                            
                                            <!-- Loop Control -->
                                            <div class="flex items-center justify-between">
                                                <span class="opacity-80">Loop Audio</span>
                                                <div id="loopToggle" class="toggle-switch active" onclick="toggleLoop()">
                                                    <div class="toggle-switch-handle"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-bell"></i> Alert Sounds
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Tick Sound -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Tick Sound (Last 10s)</span>
                                            <div id="tickToggle" class="toggle-switch" onclick="toggleTickSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Finish Sound -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Finish Sound</span>
                                            <div id="finishSoundToggle" class="toggle-switch active" onclick="toggleFinishSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Finish Sound Selector -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Finish Sound</label>
                                            <select id="finishSound" class="input-field">
                                                <option value="bell">Bell</option>
                                                <option value="alarm">Alarm</option>
                                                <option value="beep">Beep</option>
                                                <option value="chime">Chime</option>
                                                <option value="horn">Horn</option>
                                                <option value="digital">Digital Beep</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Click Sound -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Click Sound</span>
                                            <div id="clickSoundToggle" class="toggle-switch" onclick="toggleClickSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Warning Sound (Last 30s) -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Warning Sound (Last 30s)</span>
                                            <div id="warningSoundToggle" class="toggle-switch active" onclick="toggleWarningSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Warning Sound Selector -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Warning Sound</label>
                                            <select id="warningSound" class="input-field">
                                                <option value="tick">Tick</option>
                                                <option value="beep">Soft Beep</option>
                                                <option value="ping">Ping</option>
                                                <option value="click">Click</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notifications Tab (مفصول جديد) -->
                        <div data-tab-content="notifications" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-bell"></i> Notifications Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Notifications Toggle -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Enable Notifications</span>
                                            <div id="notificationsToggle" class="toggle-switch active" onclick="toggleNotifications()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Notification Sound -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Notification Sound</span>
                                            <div id="notificationSoundToggle" class="toggle-switch active" onclick="toggleNotificationSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Double Tap Toggle -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Double Tap for Manual Input</span>
                                            <div id="doubleTapToggle" class="toggle-switch active" onclick="toggleDoubleTap()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Click Adjustments Toggle -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Click Adjustments (Left/Right)</span>
                                            <div id="clickAdjustToggle" class="toggle-switch active" onclick="toggleClickAdjust()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- إظهار التذكير في الفوكس مود -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Show Reminder in Focus Mode</span>
                                            <div id="focusReminderToggle" class="toggle-switch active" onclick="toggleFocusReminder()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- الإشعارات عند الإنهاء -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Finish Notifications</span>
                                            <div id="finishNotificationsToggle" class="toggle-switch active" onclick="toggleFinishNotifications()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- التنبيه عند قرب النهاية -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Near Finish Alert (Last 10s)</span>
                                            <div id="nearFinishAlertToggle" class="toggle-switch active" onclick="toggleNearFinishAlert()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- إعدادات متقدمة للإشعارات -->
                                        <div class="pt-4 border-t border-white/10">
                                            <h4 class="text-lg font-semibold mb-3">Advanced Notification Settings</h4>
                                            <div class="space-y-4">
                                                <!-- تخصيص صوت التنبيه -->
                                                <div>
                                                    <label class="block mb-2 opacity-80">Custom Notification Sound</label>
                                                    <select id="notificationSoundType" class="input-field">
                                                        <option value="default">Default</option>
                                                        <option value="soft">Soft</option>
                                                        <option value="urgent">Urgent</option>
                                                        <option value="musical">Musical</option>
                                                        <option value="silent">Silent</option>
                                                    </select>
                                                </div>
                                                
                                                <!-- مدة الإشعار -->
                                                <div>
                                                    <label class="block mb-2 opacity-80">Notification Duration: <span id="notificationDurationValue">3</span>s</label>
                                                    <input type="range" id="notificationDuration" min="1" max="10" value="3" class="range-slider">
                                                </div>
                                                
                                                <!-- إعدادات تخصيصية -->
                                                <div class="grid grid-cols-2 gap-4">
                                                    <div class="flex items-center justify-between">
                                                        <span class="opacity-80 text-sm">Show in Fullscreen</span>
                                                        <div id="fullscreenNotificationsToggle" class="toggle-switch active" onclick="toggleFullscreenNotifications()">
                                                            <div class="toggle-switch-handle"></div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="flex items-center justify-between">
                                                        <span class="opacity-80 text-sm">Vibrate with Notifications</span>
                                                        <div id="vibrateNotificationsToggle" class="toggle-switch active" onclick="toggleVibrateNotifications()">
                                                            <div class="toggle-switch-handle"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-history"></i> Notification History
                                    </h3>
                                    <div class="space-y-4">
                                        <div id="notificationHistory" class="max-h-60 overflow-y-auto space-y-2">
                                            <!-- التاريخ سيتم إضافته هنا ديناميكياً -->
                                            <div class="text-center py-4 opacity-50">
                                                <i class="fas fa-history text-2xl mb-2"></i>
                                                <p>No notification history yet</p>
                                            </div>
                                        </div>
                                        <button onclick="clearNotificationHistory()" class="btn-secondary w-full text-red-300 border-red-500/30 touch-feedback">
                                            <i class="fas fa-trash-alt mr-2"></i> Clear History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Storage Tab (جديد) -->
                        <div data-tab-content="storage" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="storage-overview">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-database"></i> Storage Overview
                                    </h3>
                                    
                                    <div class="storage-stats">
                                        <div class="storage-stat">
                                            <div id="storageUsedValue" class="storage-stat-value">0 MB</div>
                                            <div class="storage-stat-label">Used</div>
                                        </div>
                                        <div class="storage-stat">
                                            <div id="storagePresetsValue" class="storage-stat-value">0</div>
                                            <div class="storage-stat-label">Presets</div>
                                        </div>
                                        <div class="storage-stat">
                                            <div id="storageFontsValue" class="storage-stat-value">0</div>
                                            <div class="storage-stat-label">Fonts</div>
                                        </div>
                                    </div>
                                    
                                    <div class="storage-progress-bar">
                                        <div id="storageProgressFill" class="storage-progress-fill" style="width: 0%"></div>
                                    </div>
                                    
                                    <div class="storage-info">
                                        <span id="storagePercentage">0%</span> of local storage used
                                    </div>
                                    
                                    <!-- إضافة تاريخ انتهاء الصلاحية -->
                                    <div id="expirationInfo" class="expiration-date">
                                        <div class="flex items-center justify-between">
                                            <span>Auto-cleanup after:</span>
                                            <span id="expirationDays">30 days</span>
                                        </div>
                                        <div class="text-xs mt-1 opacity-80">
                                            Old data will be automatically cleared
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-cog"></i> Storage Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Auto Cleanup Settings -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Auto-cleanup After (Days)</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="cleanupDays" min="7" max="365" value="30" class="range-slider flex-1">
                                                <span id="cleanupDaysValue" class="text-lg font-bold">30</span>
                                            </div>
                                            <p class="text-sm opacity-50 mt-1">Data older than this will be auto-cleaned</p>
                                        </div>
                                        
                                        <!-- Storage Limits -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Unlimited Storage</span>
                                            <div class="text-green-400 font-bold">ENABLED</div>
                                        </div>
                                        
                                        <!-- Backup Settings -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Auto Backup</span>
                                            <div id="autoBackupToggle" class="toggle-switch active" onclick="toggleAutoBackup()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Backup Frequency -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Backup Frequency</label>
                                            <select id="backupFrequency" class="input-field">
                                                <option value="daily">Daily</option>
                                                <option value="weekly" selected>Weekly</option>
                                                <option value="monthly">Monthly</option>
                                                <option value="manual">Manual Only</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-trash-alt"></i> Manual Cleanup
                                    </h3>
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="cleanupOldData()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-broom mr-2"></i> Clean Old Data
                                            </button>
                                            <button onclick="clearAllData()" class="btn-secondary text-red-300 border-red-500/30 touch-feedback">
                                                <i class="fas fa-trash mr-2"></i> Clear All
                                            </button>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="exportBackup()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-download mr-2"></i> Export Backup
                                            </button>
                                            <button onclick="importBackup()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-upload mr-2"></i> Import Backup
                                            </button>
                                        </div>
                                        
                                        <!-- Storage Analysis -->
                                        <div class="pt-4 border-t border-white/10">
                                            <h4 class="text-lg font-semibold mb-3">Storage Analysis</h4>
                                            <div id="storageAnalysis" class="space-y-2">
                                                <!-- التحليل سيتم إضافته هنا ديناميكياً -->
                                                <div class="text-center py-4 opacity-50">
                                                    <i class="fas fa-chart-pie text-2xl mb-2"></i>
                                                    <p>Run analysis to see details</p>
                                                </div>
                                            </div>
                                            <button onclick="analyzeStorage()" class="btn-secondary w-full mt-3 touch-feedback">
                                                <i class="fas fa-chart-bar mr-2"></i> Analyze Storage
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Tab -->
                        <div data-tab-content="advanced" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-magic"></i> Features
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Wake Lock -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Keep Screen Awake</span>
                                            <div id="wakeLockToggle" class="toggle-switch" onclick="toggleWakeLock()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Auto Start -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Auto-start on Load</span>
                                            <div id="autoStartToggle" class="toggle-switch" onclick="toggleAutoStart()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Countdown Flash -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Countdown Flash (last 10s)</span>
                                            <div id="flashToggle" class="toggle-switch active" onclick="toggleFlash()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Show Milliseconds -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Show Milliseconds</span>
                                            <div id="millisecondsToggle" class="toggle-switch" onclick="toggleMilliseconds()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Vibrate on Finish -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Vibrate on Finish</span>
                                            <div id="vibrateToggle" class="toggle-switch active" onclick="toggleVibrate()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Focus Mode Auto-hide -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Auto-hide in Focus Mode</span>
                                            <div id="focusAutoHideToggle" class="toggle-switch active" onclick="toggleFocusAutoHide()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Minimized Controls -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Show Minimized Controls</span>
                                            <div id="minimizedControlsToggle" class="toggle-switch active" onclick="toggleMinimizedControls()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Hide Hours in Focus Mode when Zero -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Hide Hours when Zero (Focus Mode)</span>
                                            <div id="hideHoursToggle" class="toggle-switch active" onclick="toggleHideHours()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Auto-save Interval -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Auto-save Interval: <span id="autoSaveIntervalValue">10</span>s</label>
                                            <input type="range" id="autoSaveInterval" min="5" max="60" value="10" class="range-slider">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-save"></i> Save & Load
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Preset Name -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Preset Name</label>
                                            <input type="text" id="presetName" placeholder="My Timer Preset" class="input-field">
                                        </div>
                                        
                                        <!-- Preset Actions -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="savePreset()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-save mr-2"></i> Save
                                            </button>
                                            <button onclick="loadPreset()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-folder-open mr-2"></i> Load
                                            </button>
                                        </div>
                                        
                                        <!-- Preset List -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Saved Presets</label>
                                            <select id="presetList" class="input-field">
                                                <option value="">Select a preset...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Export/Import -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="exportSettings()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-download mr-2"></i> Export
                                            </button>
                                            <button onclick="importSettings()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-upload mr-2"></i> Import
                                            </button>
                                        </div>
                                        
                                        <!-- Reset All -->
                                        <button onclick="resetAllSettings()" class="btn-secondary w-full mt-4 text-red-300 border-red-500/30 touch-feedback">
                                            <i class="fas fa-trash-alt mr-2"></i> Reset All Settings
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-code"></i> About
                                    </h3>
                                    <div class="space-y-4">
                                        <div class="flex justify-between">
                                            <span class="opacity-80">Version</span>
                                            <span>2.2.0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="opacity-80">Developers</span>
                                            <span class="gradient-text font-bold">Ahmed & Abdalrahman</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="opacity-80">Platform</span>
                                            <span id="platformInfo">Web/Desktop</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="opacity-80">License</span>
                                            <span>MIT</span>
                                        </div>
                                        
                                        <!-- قسم المطورين مع روابط الاتصال -->
                                        <div class="mt-4 pt-4 border-t border-white/10">
                                            <h4 class="text-lg font-semibold mb-3">Contact Developers</h4>
                                            
                                            <!-- مطور: عبدالرحمن -->
                                            <div class="developer-card">
                                                <div class="developer-name">Abdalrahman</div>
                                                <div class="developer-role">Lead Developer</div>
                                                <button onclick="contactDeveloper('abdalrahman')" class="developer-contact-btn touch-feedback">
                                                    <i class="fab fa-whatsapp whatsapp-icon"></i>
                                                    Contact on WhatsApp
                                                </button>
                                            </div>
                                            
                                            <!-- مطور: أحمد -->
                                            <div class="developer-card">
                                                <div class="developer-name">Ahmed</div>
                                                <div class="developer-role">Developer</div>
                                                <button onclick="contactDeveloper('ahmed')" class="developer-contact-btn touch-feedback">
                                                    <i class="fab fa-whatsapp whatsapp-icon"></i>
                                                    Contact on WhatsApp
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="pt-4 border-t border-white/10">
                                            <p class="text-sm opacity-60">Professional Timer App with PWA support and advanced features.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="p-6 border-t border-white/10">
                    <div class="flex gap-3">
                        <button onclick="applySettings()" class="btn-primary flex-1 touch-feedback">
                            <i class="fas fa-check mr-2"></i> Apply Settings
                        </button>
                        <button onclick="toggleSettings()" class="btn-secondary touch-feedback">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Finish Overlay -->
        <div id="finishOverlay" class="finish-overlay hidden">
            <div class="text-center p-8 max-w-4xl">
                <h1 id="finishMessageDisplay" class="text-6xl md:text-8xl font-bold mb-8 animate-bounce-slow">TIME'S UP!</h1>
                <p class="text-2xl mb-12 opacity-90">The timer has completed successfully</p>
                <div class="flex flex-wrap gap-4 justify-center">
                    <button onclick="resetTimer()" class="btn-primary text-2xl px-10 py-5 touch-feedback">
                        <i class="fas fa-redo mr-3"></i> RESTART TIMER
                    </button>
                    <button onclick="closeFinishOverlay()" class="btn-secondary text-2xl px-10 py-5 touch-feedback">
                        <i class="fas fa-times mr-3"></i> CLOSE
                    </button>
                </div>
                <div class="mt-12 text-xl opacity-70">
                    <p>Press SPACE or TAP to start a new timer</p>
                </div>
            </div>
        </div>
        
        <!-- Wipe Effect -->
        <div id="wipeEffect" class="wipe-effect hidden"></div>
        
        <!-- Toast Notifications -->
        <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-3 max-w-md"></div>
        
        <!-- Keyboard Time Input Overlay -->
        <div id="keyboardInputOverlay" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-4">Enter Time Manually</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block mb-2 opacity-80">Time (HH:MM:SS)</label>
                        <input type="text" id="manualTimeInput" 
                               placeholder="00:10:00" 
                               class="input-field text-center text-2xl font-mono"
                               value="00:10:00"
                               onkeydown="handleManualInputKeydown(event)">
                        <p class="text-sm opacity-50 mt-2">Format: Hours:Minutes:Seconds (Press Enter to set)</p>
                        <p class="text-sm opacity-50">Press 1-9 to quick set minutes</p>
                    </div>
                    
                    <!-- Quick Time Presets -->
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="setManualTime('00:01:00')" class="btn-secondary py-2 touch-feedback">1 min</button>
                        <button onclick="setManualTime('00:05:00')" class="btn-secondary py-2 touch-feedback">5 min</button>
                        <button onclick="setManualTime('00:10:00')" class="btn-secondary py-2 touch-feedback">10 min</button>
                        <button onclick="setManualTime('00:15:00')" class="btn-secondary py-2 touch-feedback">15 min</button>
                        <button onclick="setManualTime('00:30:00')" class="btn-secondary py-2 touch-feedback">30 min</button>
                        <button onclick="setManualTime('01:00:00')" class="btn-secondary py-2 touch-feedback">1 hour</button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="applyManualTime()" class="btn-primary flex-1 touch-feedback">
                        <i class="fas fa-check mr-2"></i> Set Time
                    </button>
                    <button onclick="closeKeyboardInput()" class="btn-secondary touch-feedback">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ============================================
        // PWA & INSTALLATION HANDLING
        // ============================================
        let deferredPrompt;
        let isPWAInstalled = false;
        let platform = {
            isDesktop: false,
            isMobile: false,
            isTauri: false,
            isExe: false,
            isDMG: false
        };
        
        // كشف النظام الأساسي
        function detectPlatform() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            platform.isDesktop = !/android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
            platform.isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
            platform.isTauri = window.__TAURI__ !== undefined;
            platform.isExe = userAgent.includes('Windows') && !platform.isTauri;
            platform.isDMG = userAgent.includes('Mac') && !platform.isTauri;
            
            return platform;
        }
        
        // Check if app is installed as PWA
        function checkPWAInstallation() {
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                isPWAInstalled = true;
                document.getElementById('installPWAButton').classList.add('hidden');
                document.body.classList.add('pwa-installed');
                
                // Show PWA installed indicator
                const pwaFeatures = document.querySelectorAll('.pwa-feature');
                pwaFeatures.forEach(feature => feature.style.display = 'flex');
                
                // Register service worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered with scope:', registration.scope);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            }
        }
        
        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button if not already installed
            if (!isPWAInstalled) {
                setTimeout(() => {
                    document.getElementById('installPWAButton').classList.remove('hidden');
                }, 3000);
            }
        });
        
        // Install PWA
        function installPWA() {
            if (!deferredPrompt) {
                showToast('App installation is not available', 'warning');
                return;
            }
            
            deferredPrompt.prompt();
            
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    showToast('App installed successfully!', 'success');
                    isPWAInstalled = true;
                    document.getElementById('installPWAButton').classList.add('hidden');
                    
                    // Show PWA features
                    const pwaFeatures = document.querySelectorAll('.pwa-feature');
                    pwaFeatures.forEach(feature => feature.style.display = 'flex');
                } else {
                    showToast('App installation cancelled', 'info');
                }
                deferredPrompt = null;
            });
        }
        
        // Detect app installed
        window.addEventListener('appinstalled', () => {
            isPWAInstalled = true;
            document.getElementById('installPWAButton').classList.add('hidden');
            showToast('ProTimer installed successfully!', 'success');
            
            // Show PWA features
            const pwaFeatures = document.querySelectorAll('.pwa-feature');
            pwaFeatures.forEach(feature => feature.style.display = 'flex');
        });
        
        // Attach install function to button
        document.getElementById('installPWAButton').addEventListener('click', installPWA);
        
        // ============================================
        // APPLICATION STATE & CONFIGURATION
        // ============================================
        const APP_STATE = {
            // Timer State
            hours: 0,
            minutes: 10,
            seconds: 0,
            totalSeconds: 600,
            remainingSeconds: 600,
            originalHours: 0,
            originalMinutes: 10,
            originalSeconds: 0,
            isRunning: false,
            isPaused: false,
            isFinished: false,
            timerInterval: null,
            
            // Focus Mode State
            focusMode: false,
            focusModeAutoHide: true,
            showMinimizedControls: true,
            hideHoursWhenZero: true,
            
            // Touch state for mobile
            touchTimer: null,
            touchElement: null,
            touchType: null,
            touchAmount: 0,
            lastTapTime: 0,
            tapCount: 0,
            
            // Audio State
            audioEnabled: true,
            audioContext: null,
            tickSoundEnabled: true,
            finishSoundEnabled: true,
            clickSoundEnabled: true,
            warningSoundEnabled: true,
            backgroundAudio: null,
            backgroundAudioEnabled: false,
            backgroundAudioVolume: 0.5,
            lastTickTime: 0,
            lastWarningTime: 0,
            
            // Notifications and Input Settings
            notificationsEnabled: true,
            notificationSoundEnabled: true,
            doubleTapEnabled: true,
            clickAdjustEnabled: true,
            focusReminderEnabled: true,
            finishNotificationsEnabled: true,
            nearFinishAlertEnabled: true,
            
            // Font State
            uploadedFonts: {},
            currentFont: "'JetBrains Mono', monospace",
            
            // Tasks State
            tasks: [],
            showTasks: false,
            
            // Storage State
            autoBackup: true,
            backupFrequency: 'weekly',
            cleanupDays: 30,
            lastCleanupDate: null,
            lastBackupDate: null,
            
            // Settings
            settings: {
                // Appearance
                bgColor: '#0f172a',
                textColor: '#ffffff',
                outlineColor: '#000000',
                progressColor: '#6366f1',
                outlineEnabled: false,
                outlineThickness: 2,
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: 12,
                fontWeight: 700,
                bgOpacity: 100,
                panelOpacity: 90,             
                // Media
                mediaEnabled: false,
                mediaUrl: '',
                mediaType: '',
                mediaAudioEnabled: false,
                mediaOpacity: 30,
                
                // Audio
                audioEnabled: false,
                audioUrl: '',
                audioLoop: true,
                audioVolume: 50,
                
                // Timer
                finishMessage: "Time's Up!",
                flashEnabled: true,
                wakeLockEnabled: false,
                autoStart: false,
                showMilliseconds: false,
                vibrateOnFinish: true,
                focusAutoHide: true,
                minimizedControls: true,
                hideHoursWhenZero: true,
                
                // Sounds
                finishSound: 'bell',
                tickSound: true,
                clickSound: true,
                warningSound: 'tick',
                warningSoundEnabled: true,
                finishSoundEnabled: true,
                
                // Notifications Settings
                notificationsEnabled: true,
                notificationSoundEnabled: true,
                doubleTapEnabled: true,
                clickAdjustEnabled: true,
                focusReminderEnabled: true,
                finishNotificationsEnabled: true,
                nearFinishAlertEnabled: true,
                notificationSoundType: 'default',
                notificationDuration: 3,
                fullscreenNotificationsEnabled: true,
                vibrateNotificationsEnabled: true,
                
                // Storage Settings
                autoBackup: true,
                backupFrequency: 'weekly',
                cleanupDays: 30,
                autoSaveInterval: 10
            },
            
            // Presets
            presets: {},
            currentPreset: null,
            
            // System
            wakeLock: null,
            lastSaveTime: 0,
            isFullscreen: false,
            keyboardInputBuffer: '',
            keyboardInputTimeout: null,
            minimizedControlsVisible: false,
            minimizedControlsTimeout: null,
            settingsPanelTimeout: null,
            
            // Notification History
            notificationHistory: []
        };
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            // Timer Display
            hoursDisplay: document.getElementById('hoursDisplay'),
            minutesDisplay: document.getElementById('minutesDisplay'),
            secondsDisplay: document.getElementById('secondsDisplay'),
            hoursUnit: document.getElementById('hoursUnit'),
            firstSeparator: document.getElementById('firstSeparator'),
            
            // Progress
            progressCircle: document.getElementById('progressCircle'),
            progressText: document.getElementById('progressText'),
            
            // Controls
            startPauseBtn: document.getElementById('startPauseBtn'),
            resetBtn: document.getElementById('resetBtn'),
            addMinuteBtn: document.getElementById('addMinuteBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            soundToggleBtn: document.getElementById('soundToggleBtn'),
            soundIcon: document.getElementById('soundIcon'),
            soundText: document.getElementById('soundText'),
            focusModeToggle: document.getElementById('focusModeToggle'),
            focusIcon: document.getElementById('focusIcon'),
            focusText: document.getElementById('focusText'),
            quickTasksBtn: document.getElementById('quickTasksBtn'),
            installPWAButton: document.getElementById('installPWAButton'),
            shortcutsHelp: document.getElementById('shortcutsHelp'),
            minimizedControls: document.getElementById('minimizedControls'),
            minimizedStartPause: document.getElementById('minimizedStartPause'),
            minimizedReset: document.getElementById('minimizedReset'),
            minimizedSettings: document.getElementById('minimizedSettings'),
            minimizedFocus: document.getElementById('minimizedFocus'),
            minimizedTasks: document.getElementById('minimizedTasks'),
            
            // Status
            timerStatus: document.getElementById('timerStatus'),
            timerTitle: document.getElementById('timerTitle'),
            instructions: document.getElementById('instructions'),
            quickAddButtons: document.getElementById('quickAddButtons'),
            scrollIndicator: document.getElementById('scrollIndicator'),
            
            // Tasks
            quickTasksPanel: document.getElementById('quickTasksPanel'),
            tasksList: document.getElementById('tasksList'),
            newTaskInput: document.getElementById('newTaskInput'),
            tasksCount: document.getElementById('tasksCount'),
            
            // Settings
            settingsPanel: document.getElementById('settingsPanel'),
            
            // Timer Settings
            hoursSlider: document.getElementById('hoursSlider'),
            hoursInput: document.getElementById('hoursInput'),
            minutesSlider: document.getElementById('minutesSlider'),
            minutesInput: document.getElementById('minutesInput'),
            secondsSlider: document.getElementById('secondsSlider'),
            secondsInput: document.getElementById('secondsInput'),
            finishMessage: document.getElementById('finishMessage'),
            
            // Appearance Settings
            bgColor: document.getElementById('bgColor'),
            textColor: document.getElementById('textColor'),
            outlineColor: document.getElementById('outlineColor'),
            progressColor: document.getElementById('progressColor'),
            outlineToggle: document.getElementById('outlineToggle'),
            outlineThickness: document.getElementById('outlineThickness'),
            outlineThicknessValue: document.getElementById('outlineThicknessValue'),
            bgOpacity: document.getElementById('bgOpacity'),
            bgOpacityValue: document.getElementById('bgOpacityValue'),
            panelOpacity: document.getElementById('panelOpacity'),
            panelOpacityValue: document.getElementById('panelOpacityValue'),
            
            // Font Settings
            fontFamily: document.getElementById('fontFamily'),
            fontSize: document.getElementById('fontSize'),
            fontSizeValue: document.getElementById('fontSizeValue'),
            fontWeight: document.getElementById('fontWeight'),
            fontUploadArea: document.getElementById('fontUploadArea'),
            fontFileInput: document.getElementById('fontFileInput'),
            uploadedFontsList: document.getElementById('uploadedFontsList'),
            fontPreviewContainer: document.getElementById('fontPreviewContainer'),
            fontPreviewText: document.getElementById('fontPreviewText'),
            
            // Media Settings
            mediaToggle: document.getElementById('mediaToggle'),
            mediaUrl: document.getElementById('mediaUrl'),
            mediaFile: document.getElementById('mediaFile'),
            mediaAudioToggle: document.getElementById('mediaAudioToggle'),
            mediaPreview: document.getElementById('mediaPreview'),
            mediaOpacity: document.getElementById('mediaOpacity'),
            mediaOpacityValue: document.getElementById('mediaOpacityValue'),
            
            // Audio Settings
            audioToggle: document.getElementById('audioToggle'),
            audioUrl: document.getElementById('audioUrl'),
            audioFile: document.getElementById('audioFile'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeValue: document.getElementById('volumeValue'),
            loopToggle: document.getElementById('loopToggle'),
            tickToggle: document.getElementById('tickToggle'),
            finishSoundToggle: document.getElementById('finishSoundToggle'),
            clickSoundToggle: document.getElementById('clickSoundToggle'),
            warningSoundToggle: document.getElementById('warningSoundToggle'),
            finishSound: document.getElementById('finishSound'),
            warningSound: document.getElementById('warningSound'),
            
            // Notifications Settings
            notificationsToggle: document.getElementById('notificationsToggle'),
            notificationSoundToggle: document.getElementById('notificationSoundToggle'),
            doubleTapToggle: document.getElementById('doubleTapToggle'),
            clickAdjustToggle: document.getElementById('clickAdjustToggle'),
            focusReminderToggle: document.getElementById('focusReminderToggle'),
            finishNotificationsToggle: document.getElementById('finishNotificationsToggle'),
            nearFinishAlertToggle: document.getElementById('nearFinishAlertToggle'),
            notificationSoundType: document.getElementById('notificationSoundType'),
            notificationDuration: document.getElementById('notificationDuration'),
            notificationDurationValue: document.getElementById('notificationDurationValue'),
            fullscreenNotificationsToggle: document.getElementById('fullscreenNotificationsToggle'),
            vibrateNotificationsToggle: document.getElementById('vibrateNotificationsToggle'),
            notificationHistory: document.getElementById('notificationHistory'),
            
            // Storage Settings
            storageUsedValue: document.getElementById('storageUsedValue'),
            storagePresetsValue: document.getElementById('storagePresetsValue'),
            storageFontsValue: document.getElementById('storageFontsValue'),
            storageProgressFill: document.getElementById('storageProgressFill'),
            storagePercentage: document.getElementById('storagePercentage'),
            expirationInfo: document.getElementById('expirationInfo'),
            expirationDays: document.getElementById('expirationDays'),
            cleanupDays: document.getElementById('cleanupDays'),
            cleanupDaysValue: document.getElementById('cleanupDaysValue'),
            autoBackupToggle: document.getElementById('autoBackupToggle'),
            backupFrequency: document.getElementById('backupFrequency'),
            storageAnalysis: document.getElementById('storageAnalysis'),
            
            // Advanced Settings
            wakeLockToggle: document.getElementById('wakeLockToggle'),
            autoStartToggle: document.getElementById('autoStartToggle'),
            flashToggle: document.getElementById('flashToggle'),
            millisecondsToggle: document.getElementById('millisecondsToggle'),
            vibrateToggle: document.getElementById('vibrateToggle'),
            focusAutoHideToggle: document.getElementById('focusAutoHideToggle'),
            minimizedControlsToggle: document.getElementById('minimizedControlsToggle'),
            hideHoursToggle: document.getElementById('hideHoursToggle'),
            autoSaveInterval: document.getElementById('autoSaveInterval'),
            autoSaveIntervalValue: document.getElementById('autoSaveIntervalValue'),
            presetName: document.getElementById('presetName'),
            presetList: document.getElementById('presetList'),
            platformInfo: document.getElementById('platformInfo'),
            
            // Overlays
            finishOverlay: document.getElementById('finishOverlay'),
            finishMessageDisplay: document.getElementById('finishMessageDisplay'),
            wipeEffect: document.getElementById('wipeEffect'),
            mediaBackground: document.getElementById('mediaBackground'),
            keyboardInputOverlay: document.getElementById('keyboardInputOverlay'),
            manualTimeInput: document.getElementById('manualTimeInput'),
            
            // System
            currentTime: document.getElementById('currentTime'),
            toastContainer: document.getElementById('toastContainer')
        };
        // ============================================
// ESSENTIAL MISSING FUNCTIONS - FIX ALL ISSUES
// ============================================

// تنسيق الوقت لرقمين
function formatTime(num) {
    return num.toString().padStart(2, '0');
}

// حساب الثواني الكلية
function calculateTotalSeconds() {
    return APP_STATE.hours * 3600 + APP_STATE.minutes * 60 + APP_STATE.seconds;
}

// تحديث الثواني الكلية
function updateTotalSeconds() {
    APP_STATE.totalSeconds = calculateTotalSeconds();
    APP_STATE.remainingSeconds = APP_STATE.totalSeconds;
}
// إضافة دقائق (لكل الأزرار)
function addMinutes(minutes) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) {
        showToast('لا يمكن تعديل الوقت أثناء التشغيل', 'warning');
        return;
    }
    
    // صوت النقر
    if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
        playSound('click');
    }
    
    // حفظ الوقت الأصلي
    if (APP_STATE.originalHours === undefined) {
        saveOriginalTime();
    }
    
    const totalMinutes = APP_STATE.hours * 60 + APP_STATE.minutes + minutes;
    APP_STATE.hours = Math.floor(totalMinutes / 60);
    APP_STATE.minutes = totalMinutes % 60;
    
    if (APP_STATE.hours < 0) APP_STATE.hours = 0;
    if (APP_STATE.minutes < 0) APP_STATE.minutes = 0;
    
    updateTotalSeconds();
    updateDisplay();
    
    showToast(`تم إضافة ${minutes} دقيقة`, 'info');
    saveToLocalStorage();
}

// تعيين بريسيت سريع
function setQuickPreset(minutes) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) return;
    
    saveOriginalTime();
    
    APP_STATE.hours = Math.floor(minutes / 60);
    APP_STATE.minutes = minutes % 60;
    APP_STATE.seconds = 0;
    
    updateTotalSeconds();
    updateDisplay();
    
    showToast(`تم تعيين المؤقت لـ ${minutes} دقيقة`, 'success');
}

// حفظ الوقت الأصلي
function saveOriginalTime() {
    APP_STATE.originalHours = APP_STATE.hours;
    APP_STATE.originalMinutes = APP_STATE.minutes;
    APP_STATE.originalSeconds = APP_STATE.seconds;
    APP_STATE.originalTimeSaved = Date.now();
}
// ============================================
// UI UPDATE FUNCTIONS - FIX DISPLAY
// ============================================

// تحديث العرض
function updateDisplay() {
    if (!elements.hoursDisplay || !elements.minutesDisplay || !elements.secondsDisplay) return;
    
    elements.hoursDisplay.textContent = formatTime(APP_STATE.hours);
    elements.minutesDisplay.textContent = formatTime(APP_STATE.minutes);
    elements.secondsDisplay.textContent = formatTime(APP_STATE.seconds);
    
    updateProgressRing();
    updateTimerStatus();
    
    // تحديث الفوكس مود
    if (APP_STATE.focusMode) {
        updateFocusModeDisplay();
    }
}

// تحديث حلقة التقدم
function updateProgressRing() {
    if (!elements.progressCircle || APP_STATE.totalSeconds === 0) return;
    
    const progress = (APP_STATE.remainingSeconds / APP_STATE.totalSeconds) * 100;
    const circumference = 2 * Math.PI * 60;
    const offset = circumference - (progress / 100) * circumference;
    
    elements.progressCircle.style.strokeDashoffset = offset;
    elements.progressText.textContent = `${Math.round(progress)}%`;
}

// تحديث حالة المؤقت
function updateTimerStatus() {
    if (!elements.timerStatus) return;
    
    if (APP_STATE.isFinished) {
        elements.timerStatus.innerHTML = `
            <div class="flex items-center justify-center gap-3 text-red-300">
                <i class="fas fa-flag-checkered animate-pulse"></i>
                <span>انتهى المؤقت!</span>
            </div>
        `;
        return;
    }
    
    if (APP_STATE.isRunning) {
        elements.timerStatus.innerHTML = `
            <div class="flex items-center justify-center gap-3 text-green-300">
                <i class="fas fa-play-circle"></i>
                <span>المؤقت يعمل... ${APP_STATE.remainingSeconds} ثانية متبقية</span>
            </div>
        `;
    } else if (APP_STATE.isPaused) {
        elements.timerStatus.innerHTML = `
            <div class="flex items-center justify-center gap-3 text-yellow-300">
                <i class="fas fa-pause-circle"></i>
                <span>المؤقت متوقف</span>
            </div>
        `;
    } else {
        elements.timerStatus.innerHTML = `
            <div class="flex items-center justify-center gap-3">
                <i class="fas fa-clock"></i>
                <span>المؤقت جاهز. المدة: ${APP_STATE.hours}:${formatTime(APP_STATE.minutes)}:${formatTime(APP_STATE.seconds)}</span>
            </div>
        `;
    }
}
        
        // ============================================
        // ENHANCED NOTIFICATIONS SYSTEM
        // ============================================
        
        // إضافة إدخال إلى تاريخ الإشعارات
        function addNotificationToHistory(message, type = 'info') {
            if (!APP_STATE.settings.notificationsEnabled) return;
            
            const notification = {
                id: Date.now(),
                message: message,
                type: type,
                timestamp: new Date().toLocaleString(),
                date: new Date().toISOString()
            };
            
            APP_STATE.notificationHistory.unshift(notification);
            
            // الاحتفاظ بـ 50 إدخال فقط
            if (APP_STATE.notificationHistory.length > 50) {
                APP_STATE.notificationHistory.pop();
            }
            
            updateNotificationHistory();
        }
        
        // تحديث تاريخ الإشعارات
        function updateNotificationHistory() {
            const historyContainer = elements.notificationHistory;
            if (!historyContainer) return;
            
            if (APP_STATE.notificationHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-4 opacity-50">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p>No notification history yet</p>
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = '';
            
            APP_STATE.notificationHistory.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item flex items-start gap-3 p-3 mb-2 rounded-lg ${
                    notification.type === 'success' ? 'bg-green-500/10 border border-green-500/20' :
                    notification.type === 'error' ? 'bg-red-500/10 border border-red-500/20' :
                    notification.type === 'warning' ? 'bg-yellow-500/10 border border-yellow-500/20' :
                    'bg-blue-500/10 border border-blue-500/20'
                }`;
                
                const icon = notification.type === 'success' ? 'fa-check-circle' :
                            notification.type === 'error' ? 'fa-exclamation-circle' :
                            notification.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
                
                const iconColor = notification.type === 'success' ? 'text-green-400' :
                                notification.type === 'error' ? 'text-red-400' :
                                notification.type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
                
                notificationItem.innerHTML = `
                    <div class="${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium">${notification.message}</div>
                        <div class="text-xs opacity-60 mt-1">${notification.timestamp}</div>
                    </div>
                `;
                
                historyContainer.appendChild(notificationItem);
            });
        }
        
        // مسح تاريخ الإشعارات
        function clearNotificationHistory() {
            Swal.fire({
                title: 'Clear Notification History?',
                text: 'This will permanently delete all notification history.',
                icon: 'warning',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, clear it!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    APP_STATE.notificationHistory = [];
                    updateNotificationHistory();
                    saveToLocalStorage();
                    showToast('Notification history cleared', 'success');
                }
            });
        }
        
        // Toggle focus reminder
        function toggleFocusReminder() {
            elements.focusReminderToggle.classList.toggle('active');
            APP_STATE.settings.focusReminderEnabled = elements.focusReminderToggle.classList.contains('active');
            
            if (APP_STATE.settings.focusReminderEnabled) {
                showToast('Focus mode reminders enabled', 'info');
            } else {
                showToast('Focus mode reminders disabled', 'info');
            }
        }
        
        // Toggle finish notifications
        function toggleFinishNotifications() {
            elements.finishNotificationsToggle.classList.toggle('active');
            APP_STATE.settings.finishNotificationsEnabled = elements.finishNotificationsToggle.classList.contains('active');
            
            if (APP_STATE.settings.finishNotificationsEnabled) {
                showToast('Finish notifications enabled', 'info');
            } else {
                showToast('Finish notifications disabled', 'info');
            }
        }
        
        // Toggle near finish alert
        function toggleNearFinishAlert() {
            elements.nearFinishAlertToggle.classList.toggle('active');
            APP_STATE.settings.nearFinishAlertEnabled = elements.nearFinishAlertToggle.classList.contains('active');
            
            if (APP_STATE.settings.nearFinishAlertEnabled) {
                showToast('Near finish alerts enabled', 'info');
            } else {
                showToast('Near finish alerts disabled', 'info');
            }
        }
        
        // Toggle fullscreen notifications
        function toggleFullscreenNotifications() {
            elements.fullscreenNotificationsToggle.classList.toggle('active');
            APP_STATE.settings.fullscreenNotificationsEnabled = elements.fullscreenNotificationsToggle.classList.contains('active');
            
            if (APP_STATE.settings.fullscreenNotificationsEnabled) {
                showToast('Fullscreen notifications enabled', 'info');
            } else {
                showToast('Fullscreen notifications disabled', 'info');
            }
        }
        
        // Toggle vibrate notifications
        function toggleVibrateNotifications() {
            elements.vibrateNotificationsToggle.classList.toggle('active');
            APP_STATE.settings.vibrateNotificationsEnabled = elements.vibrateNotificationsToggle.classList.contains('active');
            
            if (APP_STATE.settings.vibrateNotificationsEnabled) {
                showToast('Vibrate with notifications enabled', 'info');
            } else {
                showToast('Vibrate with notifications disabled', 'info');
            }
        }
        
        // Show enhanced toast notification
        function showToast(message, type = 'info', duration = 3000) {
            // Check if notifications are enabled globally
            if (!APP_STATE.settings.notificationsEnabled) return;
            
            // Check specific notification settings
            if (APP_STATE.isFullscreen && !APP_STATE.settings.fullscreenNotificationsEnabled) return;
            if (APP_STATE.focusMode && !APP_STATE.settings.focusReminderEnabled) return;
            
            // Add to history
            addNotificationToHistory(message, type);
            
            const toast = document.createElement('div');
            toast.className = `animate-slide-in-right glass rounded-2xl p-4 flex items-start gap-3 ${type === 'success' ? 'border-l-4 border-green-500' : type === 'error' ? 'border-l-4 border-red-500' : type === 'warning' ? 'border-l-4 border-yellow-500' : 'border-l-4 border-blue-500'}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-lg ${type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : 'text-blue-400'}"></i>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-white/40 hover:text-white/60 touch-feedback">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration || APP_STATE.settings.notificationDuration * 1000);
            
            // Vibrate if enabled
            if (APP_STATE.settings.vibrateNotificationsEnabled && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // ============================================
        // STORAGE MANAGEMENT SYSTEM
        // ============================================
        // حساب حجم التخزين
function calculateStorageSize() {
    try {
        const data = {
            timer: APP_STATE,
            presets: APP_STATE.presets,
            uploadedFonts: APP_STATE.uploadedFonts,
            tasks: APP_STATE.tasks,
            notificationHistory: APP_STATE.notificationHistory
        };
        
        const jsonString = JSON.stringify(data);
        const sizeInBytes = new Blob([jsonString]).size;
        const sizeInMB = sizeInBytes / (1024 * 1024);
        
        return {
            bytes: sizeInBytes,
            mb: parseFloat(sizeInMB.toFixed(2)),
            presets: Object.keys(APP_STATE.presets).length,
            fonts: Object.keys(APP_STATE.uploadedFonts).length,
            tasks: APP_STATE.tasks.length,
            notifications: APP_STATE.notificationHistory.length
        };
    } catch (error) {
        return { bytes: 0, mb: 0, presets: 0, fonts: 0, tasks: 0, notifications: 0 };
    }
}
// عرض التخزين
function updateStorageDisplay() {
    if (!elements.storageUsedValue) return;
    
    const storage = calculateStorageSize();
    
    elements.storageUsedValue.textContent = `${storage.mb} MB`;
    elements.storagePresetsValue.textContent = storage.presets;
    elements.storageFontsValue.textContent = storage.fonts;
    
    // حساب النسبة المئوية
    const maxStorageMB = 100;
    const percentage = Math.min((storage.mb / maxStorageMB) * 100, 100);
    elements.storageProgressFill.style.width = `${percentage}%`;
    elements.storagePercentage.textContent = `${percentage.toFixed(1)}%`;
    
    // تحديث أيام التنظيف
    elements.cleanupDaysValue.textContent = APP_STATE.settings.cleanupDays;
    elements.expirationDays.textContent = `${APP_STATE.settings.cleanupDays} يوم`;
}
        // حساب حجم البيانات المخزنة
        function calculateStorageSize() {
            try {
                const data = {
                    timer: APP_STATE,
                    presets: APP_STATE.presets,
                    uploadedFonts: APP_STATE.uploadedFonts,
                    tasks: APP_STATE.tasks,
                    notificationHistory: APP_STATE.notificationHistory
                };
                
                const jsonString = JSON.stringify(data);
                const sizeInBytes = new Blob([jsonString]).size;
                const sizeInMB = sizeInBytes / (1024 * 1024);
                
                return {
                    bytes: sizeInBytes,
                    mb: parseFloat(sizeInMB.toFixed(2)),
                    presets: Object.keys(APP_STATE.presets).length,
                    fonts: Object.keys(APP_STATE.uploadedFonts).length,
                    tasks: APP_STATE.tasks.length,
                    notifications: APP_STATE.notificationHistory.length
                };
            } catch (error) {
                console.error('Error calculating storage size:', error);
                return { bytes: 0, mb: 0, presets: 0, fonts: 0, tasks: 0, notifications: 0 };
            }
        }
        
        // تحديث عرض المساحة
        function updateStorageDisplay() {
            const storage = calculateStorageSize();
            
            elements.storageUsedValue.textContent = `${storage.mb} MB`;
            elements.storagePresetsValue.textContent = storage.presets;
            elements.storageFontsValue.textContent = storage.fonts;
            
            // حساب النسبة المئوية (افتراضياً 100MB كحد أقصى وهمي)
            const maxStorageMB = 100;
            const percentage = Math.min((storage.mb / maxStorageMB) * 100, 100);
            elements.storageProgressFill.style.width = `${percentage}%`;
            elements.storagePercentage.textContent = `${percentage.toFixed(1)}%`;
            
            // تحديث أيام انتهاء الصلاحية
            elements.expirationDays.textContent = `${APP_STATE.settings.cleanupDays} days`;
            
            // إضافة تحذير إذا كانت المساحة قريبة من الحد
            if (percentage > 80) {
                elements.expirationInfo.classList.add('warning');
                elements.expirationInfo.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-exclamation-triangle mr-2"></i>Storage nearly full!</span>
                        <span id="expirationDays">${APP_STATE.settings.cleanupDays} days</span>
                    </div>
                    <div class="text-xs mt-1 opacity-80">
                        Consider cleaning up old data
                    </div>
                `;
            } else {
                elements.expirationInfo.classList.remove('warning');
                elements.expirationInfo.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>Auto-cleanup after:</span>
                        <span id="expirationDays">${APP_STATE.settings.cleanupDays} days</span>
                    </div>
                    <div class="text-xs mt-1 opacity-80">
                        Old data will be automatically cleared
                    </div>
                `;
            }
        }
        
        // تحليل المساحة المستخدمة
        function analyzeStorage() {
            const storage = calculateStorageSize();
            
            let analysisHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span>Total Storage:</span>
                        <span class="font-bold">${storage.mb} MB</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Presets:</span>
                        <span>${storage.presets} (${(storage.presets * 0.1).toFixed(2)} MB)</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Fonts:</span>
                        <span>${storage.fonts} (${(storage.fonts * 0.5).toFixed(2)} MB)</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Tasks:</span>
                        <span>${storage.tasks} (${(storage.tasks * 0.01).toFixed(2)} MB)</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Notifications:</span>
                        <span>${storage.notifications} (${(storage.notifications * 0.02).toFixed(2)} MB)</span>
                    </div>
                    <div class="pt-3 border-t border-white/10">
                        <div class="flex justify-between items-center">
                            <span>Estimated Free Space:</span>
                            <span class="text-green-400 font-bold">${(100 - storage.mb).toFixed(2)} MB</span>
                        </div>
                    </div>
                </div>
            `;
            
            elements.storageAnalysis.innerHTML = analysisHTML;
            
            showToast('Storage analysis completed', 'success');
        }
        
        // تنظيف البيانات القديمة
        function cleanupOldData() {
            Swal.fire({
                title: 'Clean Up Old Data?',
                html: `
                    <div class="text-left">
                        <p class="mb-3">This will remove data older than <strong>${APP_STATE.settings.cleanupDays} days</strong>.</p>
                        <div class="bg-white/5 p-3 rounded-lg mb-3">
                            <p class="text-sm">The following will be affected:</p>
                            <ul class="text-sm mt-2 space-y-1">
                                <li><i class="fas fa-trash text-red-400 mr-2"></i> Old presets</li>
                                <li><i class="fas fa-trash text-red-400 mr-2"></i> Old notification history</li>
                                <li><i class="fas fa-trash text-red-400 mr-2"></i> Completed tasks</li>
                            </ul>
                        </div>
                        <p class="text-sm opacity-70">Current data will be preserved.</p>
                    </div>
                `,
                icon: 'warning',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, clean up!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    performCleanup();
                }
            });
        }
        
        // تنفيذ عملية التنظيف
        function performCleanup() {
            const cutoffDate = Date.now() - (APP_STATE.settings.cleanupDays * 24 * 60 * 60 * 1000);
            let cleanedCount = 0;
            
            // تنظيف البريسيتات القديمة
            Object.keys(APP_STATE.presets).forEach(key => {
                if (APP_STATE.presets[key].timestamp && APP_STATE.presets[key].timestamp < cutoffDate) {
                    delete APP_STATE.presets[key];
                    cleanedCount++;
                }
            });
            
            // تنظيف تاريخ الإشعارات القديم
            APP_STATE.notificationHistory = APP_STATE.notificationHistory.filter(notification => {
                const notificationDate = new Date(notification.date).getTime();
                return notificationDate > cutoffDate;
            });
            
            // تنظيف المهام المكتملة القديمة
            APP_STATE.tasks = APP_STATE.tasks.filter(task => {
                if (task.completed) {
                    const taskDate = new Date(task.date).getTime();
                    return taskDate > cutoffDate;
                }
                return true;
            });
            
            APP_STATE.lastCleanupDate = Date.now();
            saveToLocalStorage();
            updateStorageDisplay();
            updateTasksList();
            updateNotificationHistory();
            updatePresetList();
            
            showToast(`Cleaned up ${cleanedCount} old items`, 'success');
        }
        
        // مسح جميع البيانات
        function clearAllData() {
            Swal.fire({
                title: 'Clear ALL Data?',
                text: 'This will delete ALL your presets, fonts, tasks, and settings! This cannot be undone!',
                icon: 'error',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete everything!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                showDenyButton: true,
                denyButtonText: 'Keep settings only'
            }).then((result) => {
                if (result.isConfirmed) {
                    clearEverything();
                } else if (result.isDenied) {
                    clearAllButSettings();
                }
            });
        }
        
        // مسح كل شيء
        function clearEverything() {
            APP_STATE.presets = {};
            APP_STATE.uploadedFonts = {};
            APP_STATE.tasks = [];
            APP_STATE.notificationHistory = [];
            APP_STATE.currentPreset = null;
            
            // Reset to defaults but keep essential settings
            APP_STATE.settings = {
                bgColor: '#0f172a',
                textColor: '#ffffff',
                outlineColor: '#000000',
                progressColor: '#6366f1',
                outlineEnabled: false,
                outlineThickness: 2,
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: 12,
                fontWeight: 700,
                bgOpacity: 100,
                panelOpacity: 90,
                
                mediaEnabled: false,
                mediaUrl: '',
                mediaType: '',
                mediaAudioEnabled: false,
                mediaOpacity: 30,
                
                audioEnabled: false,
                audioUrl: '',
                audioLoop: true,
                audioVolume: 50,
                
                finishMessage: "Time's Up!",
                flashEnabled: true,
                wakeLockEnabled: false,
                autoStart: false,
                showMilliseconds: false,
                vibrateOnFinish: true,
                focusAutoHide: true,
                minimizedControls: true,
                hideHoursWhenZero: true,
                
                finishSound: 'bell',
                tickSound: true,
                clickSound: true,
                finishSoundEnabled: true,
                warningSound: 'tick',
                warningSoundEnabled: true,
                
                notificationsEnabled: true,
                notificationSoundEnabled: true,
                doubleTapEnabled: true,
                clickAdjustEnabled: true,
                focusReminderEnabled: true,
                finishNotificationsEnabled: true,
                nearFinishAlertEnabled: true,
                notificationSoundType: 'default',
                notificationDuration: 3,
                fullscreenNotificationsEnabled: true,
                vibrateNotificationsEnabled: true,
                
                autoBackup: true,
                backupFrequency: 'weekly',
                cleanupDays: 30,
                autoSaveInterval: 10
            };
            
            saveToLocalStorage();
            updateStorageDisplay();
            updateTasksList();
            updateNotificationHistory();
            updatePresetList();
            updateSettingsUI();
            applySettings();
            
            showToast('All data cleared successfully', 'success');
        }
        
        // مسح كل شيء باستثناء الإعدادات
        function clearAllButSettings() {
            APP_STATE.presets = {};
            APP_STATE.uploadedFonts = {};
            APP_STATE.tasks = [];
            APP_STATE.notificationHistory = [];
            APP_STATE.currentPreset = null;
            
            saveToLocalStorage();
            updateStorageDisplay();
            updateTasksList();
            updateNotificationHistory();
            updatePresetList();
            
            showToast('Data cleared (settings preserved)', 'success');
        }
        
        // تصدير نسخة احتياطية
        function exportBackup() {
            const backupData = {
                version: '2.2.0',
                exportDate: new Date().toISOString(),
                timer: APP_STATE,
                presets: APP_STATE.presets,
                uploadedFonts: APP_STATE.uploadedFonts,
                tasks: APP_STATE.tasks,
                notificationHistory: APP_STATE.notificationHistory,
                settings: APP_STATE.settings
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `protimer-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            APP_STATE.lastBackupDate = Date.now();
            showToast('Backup exported successfully', 'success');
        }
        
        // استيراد نسخة احتياطية
        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => { 
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        Swal.fire({
                            title: 'Import Backup?',
                            html: `
                                <div class="text-left">
                                    <p class="mb-3">This will <strong>overwrite</strong> your current data with the backup.</p>
                                    <div class="bg-white/5 p-3 rounded-lg mb-3">
                                        <p class="text-sm">Backup details:</p>
                                        <ul class="text-sm mt-2 space-y-1">
                                            <li><i class="fas fa-database text-blue-400 mr-2"></i> Version: ${data.version || 'Unknown'}</li>
                                            <li><i class="fas fa-calendar text-blue-400 mr-2"></i> Date: ${new Date(data.exportDate).toLocaleDateString()}</li>
                                            <li><i class="fas fa-save text-blue-400 mr-2"></i> Presets: ${Object.keys(data.presets || {}).length}</li>
                                        </ul>
                                    </div>
                                    <p class="text-sm opacity-70">Make sure this is the correct backup file.</p>
                                </div>
                            `,
                            icon: 'warning',
                            background: '#0f172a',
                            color: '#f8fafc',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, import backup!',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#10b981',
                            cancelButtonColor: '#6b7280'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                importBackupData(data);
                            }
                        });
                    } catch (error) {
                        showToast('Failed to import backup: Invalid file format', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // استيراد بيانات النسخة الاحتياطية
        function importBackupData(data) {
            if (data.timer) {
                Object.assign(APP_STATE, data.timer);
            }
            
            if (data.presets) {
                APP_STATE.presets = data.presets;
            }
            
            if (data.uploadedFonts) {
                APP_STATE.uploadedFonts = data.uploadedFonts;
            }
            
            if (data.tasks) {
                APP_STATE.tasks = data.tasks;
            }
            
            if (data.notificationHistory) {
                APP_STATE.notificationHistory = data.notificationHistory;
            }
            
            if (data.settings) {
                APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
            }
            
            updateDisplay();
            updateSettingsUI();
            applySettings();
            updateStorageDisplay();
            updateTasksList();
            updateNotificationHistory();
            updatePresetList();
            saveToLocalStorage();
            
            showToast('Backup imported successfully', 'success');
        }
        
        // Toggle auto backup
        function toggleAutoBackup() {
            elements.autoBackupToggle.classList.toggle('active');
            APP_STATE.settings.autoBackup = elements.autoBackupToggle.classList.contains('active');
            
            if (APP_STATE.settings.autoBackup) {
                showToast('Auto backup enabled', 'info');
            } else {
                showToast('Auto backup disabled', 'info');
            }
        }
        
        // التحقق من التنظيف التلقائي
        function checkAutoCleanup() {
            if (!APP_STATE.lastCleanupDate || 
                Date.now() - APP_STATE.lastCleanupDate > (APP_STATE.settings.cleanupDays * 24 * 60 * 60 * 1000)) {
                performCleanup();
            }
        }
        
        // ============================================
        // QUICK TASKS SYSTEM
        // ============================================
        
        // Toggle quick tasks panel
        function toggleQuickTasks() {
            elements.quickTasksPanel.classList.toggle('show');
            APP_STATE.showTasks = !APP_STATE.showTasks;
            
            if (APP_STATE.showTasks) {
                updateTasksList();
            }
        }
        
        // Add new task
        function addNewTask() {
            const input = elements.newTaskInput;
            const title = input.value.trim();
            
            if (!title) {
                showToast('Please enter a task title', 'warning');
                return;
            }
            
            const task = {
                id: Date.now(),
                title: title,
                description: '',
                completed: false,
                date: new Date().toISOString(),
                createdAt: Date.now()
            };
            
            APP_STATE.tasks.unshift(task);
            input.value = '';
            updateTasksList();
            saveToLocalStorage();
            
            showToast('Task added successfully', 'success');
        }
        
        // Update tasks list
        function updateTasksList() {
            const tasksList = elements.tasksList;
            const tasks = APP_STATE.tasks;
            
            if (tasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="text-center py-8 opacity-50">
                        <i class="fas fa-tasks text-3xl mb-3"></i>
                        <p>No tasks yet</p>
                        <p class="text-sm mt-2">Add tasks to track your activities</p>
                    </div>
                `;
                elements.tasksCount.textContent = '0 tasks';
                return;
            }
            
            let html = '';
            let completedCount = 0;
            
            tasks.forEach(task => {
                if (task.completed) completedCount++;
                
                html += `
                    <div class="task-item ${task.completed ? 'completed' : ''}" data-id="${task.id}">
                        <div class="task-header">
                            <div class="task-title">${task.title}</div>
                            <div class="task-time">${new Date(task.date).toLocaleDateString()}</div>
                        </div>
                        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                        <div class="task-actions">
                            <button onclick="toggleTaskComplete(${task.id})" class="task-action-btn complete">
                                <i class="fas fa-${task.completed ? 'undo' : 'check'}"></i>
                                ${task.completed ? 'Undo' : 'Complete'}
                            </button>
                            <button onclick="deleteTask(${task.id})" class="task-action-btn delete">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            tasksList.innerHTML = html;
            elements.tasksCount.textContent = `${completedCount}/${tasks.length} completed`;
        }
        
        // Toggle task complete
        function toggleTaskComplete(taskId) {
            const task = APP_STATE.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                task.date = new Date().toISOString();
                updateTasksList();
                saveToLocalStorage();
                
                showToast(`Task ${task.completed ? 'completed' : 'marked as incomplete'}`, 'info');
            }
        }
        
        // Delete task
        function deleteTask(taskId) {
            APP_STATE.tasks = APP_STATE.tasks.filter(t => t.id !== taskId);
            updateTasksList();
            saveToLocalStorage();
            
            showToast('Task deleted', 'info');
        }
        
        // Clear completed tasks
        function clearCompletedTasks() {
            const completedCount = APP_STATE.tasks.filter(t => t.completed).length;
            
            if (completedCount === 0) {
                showToast('No completed tasks to clear', 'info');
                return;
            }
            
            Swal.fire({
                title: 'Clear Completed Tasks?',
                text: `This will remove ${completedCount} completed tasks.`,
                icon: 'warning',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, clear them!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    APP_STATE.tasks = APP_STATE.tasks.filter(t => !t.completed);
                    updateTasksList();
                    saveToLocalStorage();
                    
                    showToast(`${completedCount} completed tasks cleared`, 'success');
                }
            });
        }
        
        // ============================================
        // ENHANCED KEYBOARD INPUT SYSTEM
        // ============================================
        
        // Handle manual input keydown
        function handleManualInputKeydown(e) {
            // Quick number input (1-9 for minutes)
            if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const minutes = parseInt(e.key);
                setManualTime(`00:${minutes.toString().padStart(2, '0')}:00`);
                e.preventDefault();
                return;
            }
            
            // Enter to apply
            if (e.key === 'Enter') {
                applyManualTime();
                e.preventDefault();
                return;
            }
            
            // Escape to close
            if (e.key === 'Escape') {
                closeKeyboardInput();
                e.preventDefault();
                return;
            }
            
            // Allow navigation with arrow keys
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                // Let the cursor move normally
                return;
            }
            
            // Handle colons for formatting
            if (e.key === ':' && elements.manualTimeInput.selectionStart !== null) {
                const input = elements.manualTimeInput;
                const currentPos = input.selectionStart;
                const value = input.value;
                
                // Count existing colons
                const colonCount = (value.substring(0, currentPos).match(/:/g) || []).length;
                
                if (colonCount >= 2) {
                    e.preventDefault();
                    return;
                }
                
                // Auto format
                if (currentPos === 2 || currentPos === 5) {
                    // Already at correct position, allow colon
                    return;
                } else if (currentPos < 2) {
                    // Before hours, auto fill
                    setTimeout(() => {
                        if (input.value.length === 2 && !input.value.includes(':')) {
                            input.value = input.value + ':';
                        }
                    }, 10);
                } else if (currentPos < 5) {
                    // Before minutes, auto fill
                    setTimeout(() => {
                        const parts = input.value.split(':');
                        if (parts[1] && parts[1].length === 2 && parts.length === 2) {
                            input.value = input.value + ':';
                        }
                    }, 10);
                }
            }
            
            // Restrict to numbers and colons only
            if (!/[\d:]/.test(e.key) && !e.ctrlKey && !e.metaKey && 
                !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key)) {
                e.preventDefault();
            }
        }
        
        // Set manual time quickly
        function setManualTime(timeString) {
            elements.manualTimeInput.value = timeString;
            elements.manualTimeInput.focus();
            
            // Auto-apply after a short delay if input is valid
            if (/^\d{2}:\d{2}:\d{2}$/.test(timeString)) {
                setTimeout(() => {
                    applyManualTime();
                }, 500);
            }
        }
        

        
        // ============================================
        // ENHANCED RESET FUNCTION
        // ============================================
        
        // Reset timer with proper original time preservation
        function resetTimer() {
            try {
                // أولاً: إيقاف أي مؤقتات حالية
                if (APP_STATE.timerInterval) {
                    clearInterval(APP_STATE.timerInterval);
                    APP_STATE.timerInterval = null;
                }
                
                // ثانياً: إعادة تعيين حالة التايمر
                APP_STATE.isRunning = false;
                APP_STATE.isPaused = false;
                APP_STATE.isFinished = false;
                
                // ثالثاً: استعادة الوقت الأصلي بدقة
                // إذا كان هناك وقت أصلي محفوظ، استخدمه
                if (APP_STATE.originalHours !== undefined && 
                    APP_STATE.originalMinutes !== undefined && 
                    APP_STATE.originalSeconds !== undefined) {
                    APP_STATE.hours = APP_STATE.originalHours;
                    APP_STATE.minutes = APP_STATE.originalMinutes;
                    APP_STATE.seconds = APP_STATE.originalSeconds;
                } else {
                    // إذا لم يكن هناك وقت أصلي، احفظ الوقت الحالي كأصلي
                    saveOriginalTime();
                }
                
                // رابعاً: تحديث الوقت الكلي والوقت المتبقي
                updateTotalSeconds();
                APP_STATE.remainingSeconds = APP_STATE.totalSeconds;
                
                // خامساً: تحديث واجهة المستخدم
                elements.startPauseBtn.innerHTML = `
                    <i class="fas fa-play text-lg"></i>
                    <span class="text-lg font-semibold">START TIMER</span>
                `;
                elements.startPauseBtn.classList.remove('animate-glow');
                
                // تحديث عناصر التحكم المصغرة
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
                
                // تحديث العرض
                updateDisplay();
                
                // إزالة الوميض
                document.body.classList.remove('flashing-bg');
                
                // إغلاق نافذة الإنهاء إذا كانت مفتوحة
                if (!elements.finishOverlay.classList.contains('hidden')) {
                    closeFinishOverlay();
                }
                
                // إطلاق Wake Lock
                if (APP_STATE.wakeLock) {
                    try {
                        APP_STATE.wakeLock.release()
                            .then(() => {
                                APP_STATE.wakeLock = null;
                                console.log('Wake lock released');
                            })
                            .catch(err => {
                                console.error('Error releasing wake lock:', err);
                                APP_STATE.wakeLock = null;
                            });
                    } catch (err) {
                        console.error('Error releasing wake lock:', err);
                        APP_STATE.wakeLock = null;
                    }
                }
                
                // إظهار عناصر التحكم المصغرة
                if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                    showMinimizedControls();
                }
                
                showToast('Timer reset successfully', 'info');
                
            } catch (error) {
                console.error('Error in resetTimer:', error);
                // محاولة إعادة التعيين الأساسية
                APP_STATE.hours = 0;
                APP_STATE.minutes = 10;
                APP_STATE.seconds = 0;
                saveOriginalTime();
                updateTotalSeconds();
                updateDisplay();
                showToast('Timer reset to default', 'info');
            }
        }
        
        // Save original time with timestamp
        function saveOriginalTime() {
            APP_STATE.originalHours = APP_STATE.hours;
            APP_STATE.originalMinutes = APP_STATE.minutes;
            APP_STATE.originalSeconds = APP_STATE.seconds;
            APP_STATE.originalTimeSaved = Date.now();
        }
        
        // ============================================
        // SETTINGS PANEL AUTO-CLOSE
        // ============================================
        
        // Setup settings panel auto-close
        function setupSettingsAutoClose() {
            // إغلاق الإعدادات عند النقر خارجها
            document.addEventListener('click', (e) => {
                const settingsPanel = elements.settingsPanel;
                const settingsBtn = elements.settingsBtn;
                
                if (!settingsPanel.classList.contains('translate-x-full') &&
                    !settingsPanel.contains(e.target) &&
                    !settingsBtn.contains(e.target) &&
                    !e.target.closest('.tab')) {
                    
                    toggleSettings();
                }
            });
            
            // إغلاق الإعدادات بعد فترة من عدم النشاط
            let settingsActivityTimer;
            function resetSettingsActivityTimer() {
                clearTimeout(settingsActivityTimer);
                settingsActivityTimer = setTimeout(() => {
                    if (!elements.settingsPanel.classList.contains('translate-x-full')) {
                        toggleSettings();
                        showToast('Settings closed due to inactivity', 'info');
                    }
                }, 30000); // 30 ثانية من عدم النشاط
            }
            
            // إعادة ضبط المؤقت عند النشاط
            elements.settingsPanel.addEventListener('mousemove', resetSettingsActivityTimer);
            elements.settingsPanel.addEventListener('click', resetSettingsActivityTimer);
            elements.settingsPanel.addEventListener('scroll', resetSettingsActivityTimer);
            
            // إعادة ضبط المؤقت عند الفتح
            const originalToggleSettings = window.toggleSettings;
            window.toggleSettings = function() {
                originalToggleSettings();
                if (!elements.settingsPanel.classList.contains('translate-x-full')) {
                    resetSettingsActivityTimer();
                }
            };
        }
        
        // ============================================
        // SCROLL INDICATOR
        // ============================================
        
        // Show/hide scroll indicator
        function updateScrollIndicator() {
            const mainContent = document.querySelector('.main-content');
            const scrollIndicator = elements.scrollIndicator;
            
            if (mainContent.scrollHeight > mainContent.clientHeight) {
                scrollIndicator.classList.remove('hidden');
            } else {
                scrollIndicator.classList.add('hidden');
            }
        }
        
        // Scroll to bottom
        function scrollToTasks() {
            const mainContent = document.querySelector('.main-content');
            mainContent.scrollTo({
                top: mainContent.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        function initializeApp() {
            // كشف النظام الأساسي
            detectPlatform();
            
            // تحديث معلومات المنصة
            if (platform.isTauri) {
                elements.platformInfo.textContent = 'Tauri Desktop';
            } else if (platform.isExe) {
                elements.platformInfo.textContent = 'Windows EXE';
            } else if (platform.isDMG) {
                elements.platformInfo.textContent = 'Mac DMG';
            } else if (platform.isDesktop) {
                elements.platformInfo.textContent = 'Desktop App';
            } else if (platform.isMobile) {
                elements.platformInfo.textContent = 'Mobile App';
            } else {
                elements.platformInfo.textContent = 'Web App';
            }
            
            checkPWAInstallation();
            
            updateDisplay();
            updateCurrentTime();
            
            saveOriginalTime();
            
            setInterval(updateCurrentTime, 1000);
            
            loadFromLocalStorage();
            
            setupAutoSave();
            
            applySettings();
            

            
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // تحديث مؤشر التمرير
            window.addEventListener('resize', updateScrollIndicator);
            setTimeout(updateScrollIndicator, 1000);
            
            // إعداد إغلاق الإعدادات التلقائي
            setupSettingsAutoClose();
            
            // التحقق من التنظيف التلقائي عند البدء
            setTimeout(checkAutoCleanup, 5000);
            
            // تحديث عرض المساحة
            setTimeout(updateStorageDisplay, 1000);
            
            if (APP_STATE.settings.autoStart && APP_STATE.totalSeconds > 0) {
                setTimeout(() => {
                    startTimer();
                }, 1000);
            }
            
            setTimeout(() => {
                showToast('Professional Timer v2.2.0 loaded successfully!', 'success');
                if (!isPWAInstalled) {
                    showToast('Install as app for better experience', 'info', 5000);
                }
            }, 1000);
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            document.querySelectorAll('button, .time-value, .tab, .toggle-switch, .control-btn').forEach(el => {
                el.classList.add('touch-feedback');
            });
            
            console.log('Professional Timer Enhanced App v2.2.0 initialized successfully');
        }
        
        // ============================================
        // LOAD/SAVE FUNCTIONS (NO LIMITS)
        // ============================================
        
        // Enhanced save to localStorage with NO LIMIT
        function saveToLocalStorage() {
            const now = Date.now();
            
            // Only save every configured interval to prevent performance issues
            if (now - APP_STATE.lastSaveTime < (APP_STATE.settings.autoSaveInterval * 1000)) return;
            
            APP_STATE.lastSaveTime = now;
            
            try {
                const data = {
                    timer: {
                        hours: APP_STATE.hours,
                        minutes: APP_STATE.minutes,
                        seconds: APP_STATE.seconds,
                        originalHours: APP_STATE.originalHours,
                        originalMinutes: APP_STATE.originalMinutes,
                        originalSeconds: APP_STATE.originalSeconds,
                        totalSeconds: APP_STATE.totalSeconds,
                        remainingSeconds: APP_STATE.remainingSeconds,
                        isRunning: APP_STATE.isRunning,
                        isPaused: APP_STATE.isPaused,
                        isFinished: APP_STATE.isFinished
                    },
                    settings: APP_STATE.settings,
                    presets: APP_STATE.presets,
                    currentPreset: APP_STATE.currentPreset,
                    uploadedFonts: APP_STATE.uploadedFonts,
                    currentFont: APP_STATE.currentFont,
                    tasks: APP_STATE.tasks,
                    notificationHistory: APP_STATE.notificationHistory,
                    lastCleanupDate: APP_STATE.lastCleanupDate,
                    lastBackupDate: APP_STATE.lastBackupDate,
                    timestamp: now,
                    version: '2.2.0'
                };
                
                const compressedData = JSON.stringify(data);
                localStorage.setItem('proTimerEnhancedData', compressedData);
                console.debug('Enhanced data saved to localStorage (NO LIMIT)');
                
                // تحديث عرض المساحة بعد الحفظ
                updateStorageDisplay();
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
                // NO LIMITS - نحاول فقط مرة واحدة، لا نحذف أي بيانات قديمة
                showToast('Save failed. Consider exporting your data.', 'error');
            }
        }
        
        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('proTimerEnhancedData');
                if (!saved) {
                    const oldData = localStorage.getItem('proTimerData');
                    if (oldData) {
                        migrateOldData(JSON.parse(oldData));
                    }
                    return;
                }
                
                const data = JSON.parse(saved);
                
                if (data.version && data.version !== '2.2.0') {
                    migrateData(data);
                }
                
                if (data.timer) {
                    APP_STATE.hours = data.timer.hours || 0;
                    APP_STATE.minutes = data.timer.minutes || 10;
                    APP_STATE.seconds = data.timer.seconds || 0;
                    APP_STATE.originalHours = data.timer.originalHours || APP_STATE.hours;
                    APP_STATE.originalMinutes = data.timer.originalMinutes || APP_STATE.minutes;
                    APP_STATE.originalSeconds = data.timer.originalSeconds || APP_STATE.seconds;
                    APP_STATE.totalSeconds = data.timer.totalSeconds || calculateTotalSeconds();
                    APP_STATE.remainingSeconds = data.timer.remainingSeconds || APP_STATE.totalSeconds;
                    APP_STATE.isRunning = data.timer.isRunning || false;
                    APP_STATE.isPaused = data.timer.isPaused || false;
                    APP_STATE.isFinished = data.timer.isFinished || false;
                    
                    updateDisplay();
                }
                
                if (data.settings) {
                    APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
                    updateSettingsUI();
                    applySettings();
                }
                
                if (data.uploadedFonts) {
                    APP_STATE.uploadedFonts = data.uploadedFonts;
                    updateUploadedFontsList();
                }
                
                if (data.currentFont) {
                    APP_STATE.currentFont = data.currentFont;
                }
                
                if (data.presets) {
                    APP_STATE.presets = data.presets;
                    updatePresetList();
                }
                
                if (data.currentPreset) {
                    APP_STATE.currentPreset = data.currentPreset;
                    elements.presetName.value = data.currentPreset;
                }
                
                if (data.tasks) {
                    APP_STATE.tasks = data.tasks;
                }
                
                if (data.notificationHistory) {
                    APP_STATE.notificationHistory = data.notificationHistory;
                    updateNotificationHistory();
                }
                
                if (data.lastCleanupDate) {
                    APP_STATE.lastCleanupDate = data.lastCleanupDate;
                }
                
                if (data.lastBackupDate) {
                    APP_STATE.lastBackupDate = data.lastBackupDate;
                }
                
                console.log('Enhanced data loaded from localStorage');
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
                showToast('Failed to load saved data', 'error');
            }
        }
        
        // تهيئة التطبيق مع جميع الإصلاحات
function initializeAppComplete() {
    // التهيئة الأساسية
    if (typeof initializeApp === 'function') {
        initializeApp();
    }
    
    // إصلاحات إضافية
    setTimeout(() => {
        // 1. ربط جميع الأزرار
        setupAllButtons();
        
        // 2. تحديث التخزين
        updateStorageDisplay();
        
        // 3. التحقق من الصوت
        if (APP_STATE.audioEnabled) {
            console.log('نظام الصوت مفعل');
        }
        
        // 4. رسالة نجاح
        showToast('تم تحميل ProTimer بنجاح مع جميع الإصلاحات!', 'success');
        
        // 5. اختبار الأزرار
        testAllButtons();
        
    }, 2000);
}

// ربط جميع الأزرار
function setupAllButtons() {
    // أزرار Quick Add
    const quickAddButtons = [
        { selector: 'button[onclick*="addMinutes(1)"]', minutes: 1 },
        { selector: 'button[onclick*="addMinutes(5)"]', minutes: 5 },
        { selector: 'button[onclick*="addMinutes(10)"]', minutes: 10 },
        { selector: 'button[onclick*="addMinutes(15)"]', minutes: 15 },
        { selector: 'button[onclick*="addMinutes(30)"]', minutes: 30 }
    ];
    
    quickAddButtons.forEach(btn => {
        const element = document.querySelector(btn.selector);
        if (element) {
            element.onclick = () => addMinutes(btn.minutes);
        }
    });
    
    // زر الصوت
    if (elements.soundToggleBtn) {
        elements.soundToggleBtn.onclick = toggleSound;
    }
    
    // أزرار الإعدادات
    if (elements.settingsBtn) {
        elements.settingsBtn.onclick = toggleSettings;
    }
    
    if (elements.resetBtn) {
        elements.resetBtn.onclick = confirmReset;
    }
    
    if (elements.startPauseBtn) {
        elements.startPauseBtn.onclick = toggleTimer;
    }
    
    if (elements.fullscreenBtn) {
        elements.fullscreenBtn.onclick = toggleFullscreen;
    }
}

// اختبار جميع الأزرار
function testAllButtons() {
    console.log('=== اختبار الأزرار ===');
    console.log('1. أزرار Quick Add:', document.querySelectorAll('button[onclick*="addMinutes"]').length);
    console.log('2. زر الصوت:', elements.soundToggleBtn ? 'موجود' : 'مفقود');
    console.log('3. زر الإعدادات:', elements.settingsBtn ? 'موجود' : 'مفقود');
    console.log('4. نظام الصوت:', APP_STATE.audioEnabled ? 'مفعل' : 'معطل');
    console.log('5. المساحة المستخدمة:', calculateStorageSize().mb + ' MB');
}

// تشغيل التهيئة الكاملة
window.addEventListener('DOMContentLoaded', initializeAppComplete);

// تحديث دوري للتخزين
setInterval(() => {
    updateStorageDisplay();
}, 10000);
        
                

        
        // Handle touch end
        function handleTouchEnd(element) {
            if (APP_STATE.touchTimer) {
                clearTimeout(APP_STATE.touchTimer);
                clearInterval(APP_STATE.touchTimer);
                APP_STATE.touchTimer = null;
            }
            
            if (element) {
                element.classList.remove('scale-95', 'opacity-80');
            }
        }
        
        // ============================================
        // ENHANCED NOTIFICATION SETTINGS
        // ============================================
        
        // Toggle notifications
        function toggleNotifications() {
            elements.notificationsToggle.classList.toggle('active');
            APP_STATE.settings.notificationsEnabled = elements.notificationsToggle.classList.contains('active');
            
            if (APP_STATE.settings.notificationsEnabled) {
                showToast('Notifications enabled', 'info');
                if (APP_STATE.audioEnabled && APP_STATE.settings.notificationSoundEnabled) {
                    playAlarmSequence('notification');
                }
            } else {
                showToast('Notifications disabled', 'info');
            }
        }
        
        // Toggle notification sound
        function toggleNotificationSound() {
            elements.notificationSoundToggle.classList.toggle('active');
            APP_STATE.settings.notificationSoundEnabled = elements.notificationSoundToggle.classList.contains('active');
            
            if (APP_STATE.settings.notificationSoundEnabled && APP_STATE.audioEnabled) {
                playAlarmSequence('notification');
            }
        }
        
        // Toggle double tap for manual input
        function toggleDoubleTap() {
            elements.doubleTapToggle.classList.toggle('active');
            APP_STATE.settings.doubleTapEnabled = elements.doubleTapToggle.classList.contains('active');
            
            if (APP_STATE.settings.doubleTapEnabled) {
                showToast('Double tap enabled for manual input', 'info');
            } else {
                showToast('Double tap disabled', 'info');
            }
        }
        
        // Toggle click adjustments
        function toggleClickAdjust() {
            elements.clickAdjustToggle.classList.toggle('active');
            APP_STATE.settings.clickAdjustEnabled = elements.clickAdjustToggle.classList.contains('active');
            
            if (APP_STATE.settings.clickAdjustEnabled) {
                showToast('Click adjustments enabled', 'info');
            } else {
                showToast('Click adjustments disabled', 'info');
            }
        }
        
        // Toggle hide hours when zero
        function toggleHideHours() {
            elements.hideHoursToggle.classList.toggle('active');
            APP_STATE.settings.hideHoursWhenZero = elements.hideHoursToggle.classList.contains('active');
            
            if (APP_STATE.focusMode) {
                updateFocusModeDisplay();
            }
            
            if (APP_STATE.settings.hideHoursWhenZero) {
                showToast('Hide hours when zero enabled', 'info');
            } else {
                showToast('Hide hours when zero disabled', 'info');
            }
        }
        
        // ============================================
        // ENHANCED UTILITY FUNCTIONS
        // ============================================
        
        // Format time to 2 digits
        function formatTime(num) {
            return num.toString().padStart(2, '0');
        }
        
        // Calculate total seconds
        function calculateTotalSeconds() {
            return APP_STATE.hours * 3600 + APP_STATE.minutes * 60 + APP_STATE.seconds;
        }
        
        // Update total seconds
        function updateTotalSeconds() {
            APP_STATE.totalSeconds = calculateTotalSeconds();
            APP_STATE.remainingSeconds = APP_STATE.totalSeconds;
        }
        
        // Save original time
        function saveOriginalTime() {
            APP_STATE.originalHours = APP_STATE.hours;
            APP_STATE.originalMinutes = APP_STATE.minutes;
            APP_STATE.originalSeconds = APP_STATE.seconds;
        }
        
        // Restore original time
        function restoreOriginalTime() {
            APP_STATE.hours = APP_STATE.originalHours;
            APP_STATE.minutes = APP_STATE.originalMinutes;
            APP_STATE.seconds = APP_STATE.originalSeconds;
            updateTotalSeconds();
            updateDisplay();
        }
        
        // Show toast notification
        function showToast(message, type = 'info', duration = 3000) {
            // Check if notifications are enabled
            if (!APP_STATE.settings.notificationsEnabled) return;
            
            const toast = document.createElement('div');
            toast.className = `animate-slide-in-right glass rounded-2xl p-4 flex items-start gap-3 ${type === 'success' ? 'border-l-4 border-green-500' : type === 'error' ? 'border-l-4 border-red-500' : type === 'warning' ? 'border-l-4 border-yellow-500' : 'border-l-4 border-blue-500'}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-lg ${type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : 'text-blue-400'}"></i>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-white/40 hover:text-white/60 touch-feedback">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
        
        // Vibrate device if supported
        function vibrate(pattern = [200, 100, 200]) {
            if (APP_STATE.settings.vibrateOnFinish && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }
        
        // Update progress ring with enhanced styling
        function updateProgressRing() {
            if (APP_STATE.totalSeconds === 0) return;
            
            const progress = (APP_STATE.remainingSeconds / APP_STATE.totalSeconds) * 100;
            const circumference = 2 * Math.PI * 60;
            const offset = circumference - (progress / 100) * circumference;
            
            elements.progressCircle.style.strokeDashoffset = offset;
            elements.progressCircle.style.stroke = APP_STATE.settings.progressColor;
            elements.progressText.textContent = `${Math.round(progress)}%`;
            
            // Update progress color based on remaining time
            if (progress <= 25) {
                elements.progressCircle.style.stroke = '#ef4444';
            } else if (progress <= 50) {
                elements.progressCircle.style.stroke = '#f59e0b';
            } else {
                elements.progressCircle.style.stroke = APP_STATE.settings.progressColor;
            }
        }
        
        // Update digit colors with enhanced styling
        function updateDigitColors() {
            const textColor = APP_STATE.settings.textColor;
            const outlineColor = APP_STATE.settings.outlineColor;
            const outlineEnabled = APP_STATE.settings.outlineEnabled;
            const outlineThickness = APP_STATE.settings.outlineThickness;
            const fontWeight = APP_STATE.settings.fontWeight;
            
            const timeValues = document.querySelectorAll('.time-value');
            const timeLabels = document.querySelectorAll('.time-label');
            
            timeValues.forEach(digit => {
                digit.style.color = textColor;
                digit.style.fontWeight = fontWeight;
                
                if (outlineEnabled) {
                    digit.style.textShadow = `
                        0 0 ${outlineThickness}px ${outlineColor},
                        0 0 ${outlineThickness * 2}px ${outlineColor},
                        0 0 ${outlineThickness * 3}px ${outlineColor},
                        0 4px 8px rgba(0, 0, 0, 0.3)
                    `;
                } else {
                    digit.style.textShadow = `
                        0 4px 8px rgba(0, 0, 0, 0.3),
                        0 8px 16px rgba(0, 0, 0, 0.2)
                    `;
                }
            });
            
            timeLabels.forEach(label => {
                label.style.color = textColor;
                label.style.opacity = 0.6;
            });
        }
        
        // Update background with opacity control
        function updateBackground() {
            const bgOpacity = APP_STATE.settings.bgOpacity / 100;
            document.body.style.backgroundColor = APP_STATE.settings.bgColor;
            document.body.style.opacity = bgOpacity;
            
            // Update control panel opacity
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.style.opacity = APP_STATE.settings.panelOpacity / 100;
            }
            
            // Update media background
            if (APP_STATE.settings.mediaEnabled && APP_STATE.settings.mediaUrl) {
                elements.mediaBackground.style.opacity = (APP_STATE.settings.mediaOpacity / 100).toString();
                
                if (APP_STATE.settings.mediaType === 'video') {
                    elements.mediaBackground.innerHTML = `
                        <video autoplay loop muted playsinline class="media-bg">
                            <source src="${APP_STATE.settings.mediaUrl}" type="video/mp4">
                        </video>
                    `;
                    
                    const video = elements.mediaBackground.querySelector('video');
                    if (video) {
                        video.muted = !APP_STATE.settings.mediaAudioEnabled;
                        video.volume = APP_STATE.settings.audioVolume / 100;
                    }
                } else {
                    elements.mediaBackground.innerHTML = `
                        <img src="${APP_STATE.settings.mediaUrl}" alt="Background" class="media-bg">
                    `;
                }
            } else {
                elements.mediaBackground.style.opacity = '0';
                elements.mediaBackground.innerHTML = '';
            }
        }
        
        // Update font settings
        function updateFontSettings() {
            const timeValues = document.querySelectorAll('.time-value');
            const timeLabels = document.querySelectorAll('.time-label');
            
            timeValues.forEach(digit => {
                digit.style.fontFamily = APP_STATE.currentFont;
                digit.style.fontSize = `${APP_STATE.settings.fontSize * 0.5}rem`;
                digit.style.fontWeight = APP_STATE.settings.fontWeight;
            });
            
            timeLabels.forEach(label => {
                label.style.fontFamily = APP_STATE.currentFont;
            });
            
            if (elements.fontPreviewContainer.classList.contains('hidden') === false) {
                elements.fontPreviewText.style.fontFamily = APP_STATE.currentFont;
            }
        }
        
        // Enhanced save to localStorage with NO LIMIT
        function saveToLocalStorage() {
            const now = Date.now();
            
            // Only save every 2 seconds to prevent performance issues
            if (now - APP_STATE.lastSaveTime < 2000) return;
            
            APP_STATE.lastSaveTime = now;
            
            try {
                const data = {
                    timer: {
                        hours: APP_STATE.hours,
                        minutes: APP_STATE.minutes,
                        seconds: APP_STATE.seconds,
                        originalHours: APP_STATE.originalHours,
                        originalMinutes: APP_STATE.originalMinutes,
                        originalSeconds: APP_STATE.originalSeconds,
                        totalSeconds: APP_STATE.totalSeconds,
                        remainingSeconds: APP_STATE.remainingSeconds,
                        isRunning: APP_STATE.isRunning,
                        isPaused: APP_STATE.isPaused,
                        isFinished: APP_STATE.isFinished
                    },
                    settings: APP_STATE.settings,
                    presets: APP_STATE.presets,
                    currentPreset: APP_STATE.currentPreset,
                    uploadedFonts: APP_STATE.uploadedFonts,
                    currentFont: APP_STATE.currentFont,
                    timestamp: now,
                    version: '2.1.0'
                };
                
                const compressedData = JSON.stringify(data);
                localStorage.setItem('proTimerEnhancedData', compressedData);
                console.debug('Enhanced data saved to localStorage (NO LIMIT)');
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
                // Try to clear some old data if quota exceeded
                if (error.name === 'QuotaExceededError') {
                    try {
                        // Clear old presets if we have more than 20
                        const presetKeys = Object.keys(APP_STATE.presets);
                        if (presetKeys.length > 20) {
                            const sortedPresets = presetKeys.map(key => ({
                                key,
                                timestamp: APP_STATE.presets[key].timestamp || 0
                            })).sort((a, b) => b.timestamp - a.timestamp);
                            
                            for (let i = 20; i < sortedPresets.length; i++) {
                                delete APP_STATE.presets[sortedPresets[i].key];
                            }
                            
                            // Try to save again with fewer presets
                            saveToLocalStorage();
                        }
                    } catch (clearError) {
                        console.error('Failed to clear old data:', clearError);
                        showToast('Storage full. Consider exporting and clearing data.', 'warning');
                    }
                }
            }
        }
        
        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('proTimerEnhancedData');
                if (!saved) {
                    const oldData = localStorage.getItem('proTimerData');
                    if (oldData) {
                        migrateOldData(JSON.parse(oldData));
                    }
                    return;
                }
                
                const data = JSON.parse(saved);
                
                if (data.version && data.version !== '2.1.0') {
                    migrateData(data);
                }
                
                if (data.timer) {
                    APP_STATE.hours = data.timer.hours || 0;
                    APP_STATE.minutes = data.timer.minutes || 10;
                    APP_STATE.seconds = data.timer.seconds || 0;
                    APP_STATE.originalHours = data.timer.originalHours || APP_STATE.hours;
                    APP_STATE.originalMinutes = data.timer.originalMinutes || APP_STATE.minutes;
                    APP_STATE.originalSeconds = data.timer.originalSeconds || APP_STATE.seconds;
                    APP_STATE.totalSeconds = data.timer.totalSeconds || calculateTotalSeconds();
                    APP_STATE.remainingSeconds = data.timer.remainingSeconds || APP_STATE.totalSeconds;
                    APP_STATE.isRunning = data.timer.isRunning || false;
                    APP_STATE.isPaused = data.timer.isPaused || false;
                    APP_STATE.isFinished = data.timer.isFinished || false;
                    
                    updateDisplay();
                }
                
                if (data.settings) {
                    APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
                    updateSettingsUI();
                    applySettings();
                }
                
                if (data.uploadedFonts) {
                    APP_STATE.uploadedFonts = data.uploadedFonts;
                    updateUploadedFontsList();
                }
                
                if (data.currentFont) {
                    APP_STATE.currentFont = data.currentFont;
                }
                
                if (data.presets) {
                    APP_STATE.presets = data.presets;
                    updatePresetList();
                }
                
                if (data.currentPreset) {
                    APP_STATE.currentPreset = data.currentPreset;
                    elements.presetName.value = data.currentPreset;
                }
                
                console.log('Enhanced data loaded from localStorage');
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
                showToast('Failed to load saved data', 'error');
            }
        }
        
        // Migrate old data format
        function migrateOldData(oldData) {
            try {
                if (oldData.timer) {
                    APP_STATE.hours = oldData.timer.hours || 0;
                    APP_STATE.minutes = oldData.timer.minutes || 10;
                    APP_STATE.seconds = oldData.timer.seconds || 0;
                    APP_STATE.originalHours = APP_STATE.hours;
                    APP_STATE.originalMinutes = APP_STATE.minutes;
                    APP_STATE.originalSeconds = APP_STATE.seconds;
                }
                
                if (oldData.settings) {
                    APP_STATE.settings = { ...APP_STATE.settings, ...oldData.settings };
                }
                
                if (oldData.presets) {
                    APP_STATE.presets = oldData.presets;
                }
                
                updateDisplay();
                updateSettingsUI();
                applySettings();
                updatePresetList();
                
                showToast('Data migrated from old version', 'success');
                saveToLocalStorage();
            } catch (error) {
                console.error('Migration failed:', error);
            }
        }
        
        // Migrate data between versions
        function migrateData(data) {
            console.log(`Migrating data from version ${data.version} to 2.1.0`);
            
            // Add new settings if they don't exist
            if (!data.settings.notificationsEnabled) {
                data.settings.notificationsEnabled = true;
            }
            if (!data.settings.notificationSoundEnabled) {
                data.settings.notificationSoundEnabled = true;
            }
            if (!data.settings.doubleTapEnabled) {
                data.settings.doubleTapEnabled = true;
            }
            if (!data.settings.clickAdjustEnabled) {
                data.settings.clickAdjustEnabled = true;
            }
            if (!data.settings.hideHoursWhenZero) {
                data.settings.hideHoursWhenZero = true;
            }
            
            return data;
        }
        
        // Setup auto-save
        function setupAutoSave() {
            window.addEventListener('beforeunload', () => {
                saveToLocalStorage();
            });
            
            // Save every 10 seconds
            setInterval(saveToLocalStorage, 10000);
            
            document.addEventListener('input', (e) => {
                if (e.target.closest('#settingsPanel')) {
                    saveToLocalStorage();
                }
            });
        }
        
        // ============================================
        // ENHANCED TIMER FUNCTIONS
        // ============================================
        // Enhanced add minutes function with NO LIMIT
function addMinutes(minutes) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) {
        showToast('Cannot adjust time while timer is running', 'warning');
        return;
    }
    
    // Play click sound
    if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
        playSound('click');
    }
    
    // Save original time if not already saved
    if (APP_STATE.originalHours === undefined) {
        saveOriginalTime();
    }
    
    const totalMinutes = APP_STATE.hours * 60 + APP_STATE.minutes + minutes;
    APP_STATE.hours = Math.floor(totalMinutes / 60);
    APP_STATE.minutes = totalMinutes % 60;
    
    // NO LIMIT - يمكن تجاوز 24 ساعة
    if (APP_STATE.hours < 0) APP_STATE.hours = 0;
    if (APP_STATE.minutes < 0) APP_STATE.minutes = 0;
    
    updateTotalSeconds();
    updateDisplay();
    
    showToast(`Added ${minutes} minute${minutes !== 1 ? 's' : ''}`, 'info');
    saveToLocalStorage();
}

// Enhanced function to handle time click with double tap detection

        // Update timer display with focus mode support
        function updateDisplay() {
            elements.hoursDisplay.textContent = formatTime(APP_STATE.hours);
            elements.minutesDisplay.textContent = formatTime(APP_STATE.minutes);
            elements.secondsDisplay.textContent = formatTime(APP_STATE.seconds);
            
            updateProgressRing();
            updateTimerStatus();
            updateMinimizedControls();
            
            // Update focus mode display if active
            if (APP_STATE.focusMode) {
                updateFocusModeDisplay();
            }
        }
        
        // Update focus mode display - hide hours when zero
        function updateFocusModeDisplay() {
            if (!APP_STATE.focusMode) return;
            
            const hoursUnit = elements.hoursUnit;
            const firstSeparator = elements.firstSeparator;
            
            if (APP_STATE.settings.hideHoursWhenZero && APP_STATE.hours === 0) {
                hoursUnit.classList.add('hours-zero');
                firstSeparator.classList.add('hide-separator');
            } else {
                hoursUnit.classList.remove('hours-zero');
                firstSeparator.classList.remove('hide-separator');
            }
        }
        
        // Update timer status text
        function updateTimerStatus() {
            const status = elements.timerStatus;
            
            if (APP_STATE.isFinished) {
                status.innerHTML = `
                    <div class="flex items-center justify-center gap-3 text-red-300">
                        <i class="fas fa-flag-checkered animate-pulse"></i>
                        <span>Timer finished!</span>
                    </div>
                `;
                return;
            }
            
            if (APP_STATE.isRunning) {
                const remainingSeconds = APP_STATE.remainingSeconds;
                
                if (remainingSeconds <= 10 && APP_STATE.settings.flashEnabled) {
                    status.innerHTML = `
                        <div class="flex items-center justify-center gap-3 text-yellow-300 animate-pulse">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>${remainingSeconds} seconds remaining!</span>
                        </div>
                    `;
                } else {
                    const hours = Math.floor(remainingSeconds / 3600);
                    const minutes = Math.floor((remainingSeconds % 3600) / 60);
                    const seconds = remainingSeconds % 60;
                    
                    let timeString = '';
                    if (hours > 0) timeString += `${hours}h `;
                    if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                    timeString += `${seconds}s`;
                    
                    status.innerHTML = `
                        <div class="flex items-center justify-center gap-3 text-green-300">
                            <i class="fas fa-play-circle"></i>
                            <span>Timer running... ${timeString} remaining</span>
                        </div>
                    `;
                }
            } else if (APP_STATE.isPaused) {
                status.innerHTML = `
                    <div class="flex items-center justify-center gap-3 text-yellow-300">
                        <i class="fas fa-pause-circle"></i>
                        <span>Timer paused</span>
                    </div>
                `;
            } else {
                const totalSeconds = calculateTotalSeconds();
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let timeString = '';
                if (hours > 0) timeString += `${hours}h `;
                if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                timeString += `${seconds}s`;
                
                status.innerHTML = `
                    <div class="flex items-center justify-center gap-3">
                        <i class="fas fa-clock"></i>
                        <span>Timer ready. Total duration: ${timeString}</span>
                    </div>
                `;
            }
        }
        

        
        // Add minutes function
        function addMinutes(minutes) {
            if (APP_STATE.isRunning || APP_STATE.isFinished) return;
            
            // Play click sound
            if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
                playSound('click');
            }
            
            // Save original time if not already saved
            if (APP_STATE.originalHours === undefined) {
                saveOriginalTime();
            }
            
            const totalMinutes = APP_STATE.hours * 60 + APP_STATE.minutes + minutes;
            APP_STATE.hours = Math.floor(totalMinutes / 60);
            APP_STATE.minutes = totalMinutes % 60;
            
            // NO LIMIT on hours - can go beyond 24
            updateTotalSeconds();
            updateDisplay();
            
            showToast(`Added ${minutes} minute${minutes !== 1 ? 's' : ''}`, 'info');
        }
        
        // Set quick preset
        function setQuickPreset(minutes) {
            if (APP_STATE.isRunning || APP_STATE.isFinished) return;
            
            // Save original time
            saveOriginalTime();
            
            APP_STATE.hours = Math.floor(minutes / 60);
            APP_STATE.minutes = minutes % 60;
            APP_STATE.seconds = 0;
            
            updateTotalSeconds();
            updateDisplay();
            
            showToast(`Timer set to ${minutes} minute${minutes !== 1 ? 's' : ''}`, 'success');
        }
        
        // Toggle timer (start/pause)
        function toggleTimer() {
            if (APP_STATE.isFinished) {
                resetTimer();
                return;
            }
            
            if (APP_STATE.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }
        
        // Start timer
        function startTimer() {
            if (APP_STATE.totalSeconds === 0) {
                showToast('Please set a timer duration first', 'warning');
                return;
            }
            
            // Save original time if not already saved
            if (APP_STATE.originalHours === undefined) {
                saveOriginalTime();
            }
            
            APP_STATE.isRunning = true;
            APP_STATE.isPaused = false;
            APP_STATE.isFinished = false;
            
            // Update button
            elements.startPauseBtn.innerHTML = `
                <i class="fas fa-pause text-lg"></i>
                <span class="text-lg font-semibold">PAUSE TIMER</span>
            `;
            elements.startPauseBtn.classList.add('animate-glow');
            
            // Update minimized controls
            elements.minimizedStartPause.innerHTML = '<i class="fas fa-pause"></i>';
            
            // Update status
            updateTimerStatus();
            
            // Reset sound timers
            APP_STATE.lastTickTime = 0;
            APP_STATE.lastWarningTime = 0;
            
            // Start countdown
            APP_STATE.timerInterval = setInterval(() => {
                if (APP_STATE.remainingSeconds <= 0) {
                    finishTimer();
                    return;
                }
                
                APP_STATE.remainingSeconds--;
                
                // Update time display
                const hours = Math.floor(APP_STATE.remainingSeconds / 3600);
                const minutes = Math.floor((APP_STATE.remainingSeconds % 3600) / 60);
                const seconds = APP_STATE.remainingSeconds % 60;
                
                APP_STATE.hours = hours;
                APP_STATE.minutes = minutes;
                APP_STATE.seconds = seconds;
                
                // Update display
                updateDisplay();
                
                // Handle sounds based on remaining time
                const now = Date.now();
                
                // Warning sound for last 30 seconds
                if (APP_STATE.remainingSeconds <= 30 && APP_STATE.remainingSeconds > 0) {
                    if (APP_STATE.settings.warningSoundEnabled && 
                        now - APP_STATE.lastWarningTime > 1000) {
                        playAlarmSequence('warning');
                        APP_STATE.lastWarningTime = now;
                    }
                }
                
                // Tick sound for last 10 seconds
                if (APP_STATE.remainingSeconds <= 10) {
                    if (APP_STATE.settings.flashEnabled) {
                        document.body.classList.toggle('flashing-bg');
                    }
                    
                    if (APP_STATE.settings.tickSound && 
                        now - APP_STATE.lastTickTime > 1000) {
                        playSound('tick');
                        APP_STATE.lastTickTime = now;
                    }
                }
                
                // Update progress
                updateProgressRing();
                
            }, 1000);
            
            // Request wake lock
            if (APP_STATE.settings.wakeLockEnabled && 'wakeLock' in navigator) {
                navigator.wakeLock.request('screen')
                    .then(wakeLock => {
                        APP_STATE.wakeLock = wakeLock;
                        console.log('Wake lock acquired');
                    })
                    .catch(err => {
                        console.error('Wake lock error:', err);
                    });
            }
            
            // Auto-hide controls in focus mode
            if (APP_STATE.focusMode && APP_STATE.settings.focusAutoHide) {
                setTimeout(() => {
                    hideMinimizedControls();
                }, 2000);
            }
            
            showToast('Timer started', 'success');
        }
        
        // Pause timer
        function pauseTimer() {
            APP_STATE.isRunning = false;
            APP_STATE.isPaused = true;
            
            clearInterval(APP_STATE.timerInterval);
            
            // Update button
            elements.startPauseBtn.innerHTML = `
                <i class="fas fa-play text-lg"></i>
                <span class="text-lg font-semibold">RESUME TIMER</span>
            `;
            elements.startPauseBtn.classList.remove('animate-glow');
            
            // Update minimized controls
            elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
            
            // Update status
            updateTimerStatus();
            
            // Release wake lock
            if (APP_STATE.wakeLock) {
                APP_STATE.wakeLock.release()
                    .then(() => {
                        APP_STATE.wakeLock = null;
                        console.log('Wake lock released');
                    });
            }
            
            // Remove flashing
            document.body.classList.remove('flashing-bg');
            
            // Show minimized controls
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
            
            showToast('Timer paused', 'warning');
        }
        
        // Confirm reset with SweetAlert
        function confirmReset() {
            if (APP_STATE.isRunning || APP_STATE.isPaused || APP_STATE.isFinished) {
                Swal.fire({
                    title: 'Reset Timer?',
                    text: 'Are you sure you want to reset the timer?',
                    icon: 'warning',
                    background: '#0f172a',
                    color: '#f8fafc',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, reset it!',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    customClass: {
                        popup: 'glass-dark'
                    },
                    allowOutsideClick: false,
                    allowEscapeKey: true,
                    allowEnterKey: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        resetTimer();
                    }
                }).catch(() => {
                    console.log('Reset confirmation cancelled or errored');
                    if (APP_STATE.isRunning || APP_STATE.isPaused) {
                        resetTimer();
                    }
                });
            } else {
                resetTimer();
            }
        }
        
        // Reset timer
        function resetTimer() {
            try {
                // أولاً: إيقاف أي مؤقتات حالية
                if (APP_STATE.timerInterval) {
                    clearInterval(APP_STATE.timerInterval);
                    APP_STATE.timerInterval = null;
                }
                
                // ثانياً: إعادة تعيين حالة التايمر
                APP_STATE.isRunning = false;
                APP_STATE.isPaused = false;
                APP_STATE.isFinished = false;
                
                // ثالثاً: استعادة الوقت الأصلي
                if (APP_STATE.originalHours !== undefined && 
                    APP_STATE.originalMinutes !== undefined && 
                    APP_STATE.originalSeconds !== undefined) {
                    APP_STATE.hours = APP_STATE.originalHours;
                    APP_STATE.minutes = APP_STATE.originalMinutes;
                    APP_STATE.seconds = APP_STATE.originalSeconds;
                } else {
                    // قيم افتراضية إذا لم يتم حفظ وقت أصلي
                    APP_STATE.hours = 0;
                    APP_STATE.minutes = 10;
                    APP_STATE.seconds = 0;
                    saveOriginalTime();
                }
                
                // رابعاً: تحديث الوقت الكلي
                updateTotalSeconds();
                APP_STATE.remainingSeconds = APP_STATE.totalSeconds;
                
                // خامساً: تحديث واجهة المستخدم
                elements.startPauseBtn.innerHTML = `
                    <i class="fas fa-play text-lg"></i>
                    <span class="text-lg font-semibold">START TIMER</span>
                `;
                elements.startPauseBtn.classList.remove('animate-glow');
                
                // تحديث عناصر التحكم المصغرة
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
                
                // تحديث العرض
                updateDisplay();
                
                // إزالة الوميض
                document.body.classList.remove('flashing-bg');
                
                // إغلاق نافذة الإنهاء إذا كانت مفتوحة
                if (!elements.finishOverlay.classList.contains('hidden')) {
                    closeFinishOverlay();
                }
                
                // إطلاق Wake Lock
                if (APP_STATE.wakeLock) {
                    try {
                        APP_STATE.wakeLock.release()
                            .then(() => {
                                APP_STATE.wakeLock = null;
                                console.log('Wake lock released');
                            })
                            .catch(err => {
                                console.error('Error releasing wake lock:', err);
                                APP_STATE.wakeLock = null;
                            });
                    } catch (err) {
                        console.error('Error releasing wake lock:', err);
                        APP_STATE.wakeLock = null;
                    }
                }
                
                // إظهار عناصر التحكم المصغرة
                if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                    showMinimizedControls();
                }
                
                showToast('Timer reset successfully', 'info');
                
            } catch (error) {
                console.error('Error in resetTimer:', error);
                // محاولة إعادة التعيين الأساسية
                APP_STATE.hours = 0;
                APP_STATE.minutes = 10;
                APP_STATE.seconds = 0;
                saveOriginalTime();
                updateTotalSeconds();
                updateDisplay();
                showToast('Timer reset to default', 'info');
            }
        }
        
        // Finish timer with enhanced effects
        function finishTimer() {
            APP_STATE.isRunning = false;
            APP_STATE.isFinished = true;
            
            clearInterval(APP_STATE.timerInterval);
            
            // Update button
            elements.startPauseBtn.innerHTML = `
                <i class="fas fa-redo text-lg"></i>
                <span class="text-lg font-semibold">RESTART TIMER</span>
            `;
            elements.startPauseBtn.classList.remove('animate-glow');
            
            // Update minimized controls
            elements.minimizedStartPause.innerHTML = '<i class="fas fa-redo"></i>';
            
            // Remove flashing
            document.body.classList.remove('flashing-bg');
            
            // Release wake lock
            if (APP_STATE.wakeLock) {
                APP_STATE.wakeLock.release()
                    .then(() => {
                        APP_STATE.wakeLock = null;
                    });
            }
            
            // Vibrate on finish
            vibrate([500, 200, 500]);
            
            // Show wipe effect
            elements.wipeEffect.classList.remove('hidden');
            setTimeout(() => {
                elements.wipeEffect.classList.add('hidden');
            }, 500);
            
            // Show finish overlay
            setTimeout(() => {
                elements.finishMessageDisplay.textContent = APP_STATE.settings.finishMessage;
                elements.finishOverlay.classList.remove('hidden');
            }, 500);
            
            // Play finish sound
            if (APP_STATE.audioEnabled && APP_STATE.settings.finishSoundEnabled) {
                playAlarmSequence('finish');
            }
            
            // Show minimized controls
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
            
            showToast('Timer completed!', 'success');
        }
        
        // Close finish overlay
        function closeFinishOverlay() {
            elements.finishOverlay.classList.add('hidden');
        }
        
        // ============================================
        // FOCUS MODE FUNCTIONS
        // ============================================
        
        // Toggle focus mode
        function toggleFocusMode() {
            APP_STATE.focusMode = !APP_STATE.focusMode;
            
            if (APP_STATE.focusMode) {
                enableFocusMode();
            } else {
                disableFocusMode();
            }
            
            updateFocusModeUI();
        }
        
        // Enable focus mode
        function enableFocusMode() {
            document.body.classList.add('focus-mode');
            
            // إخفاء جميع العناصر الغير ضرورية
            const elementsToHide = [
                elements.instructions,
                elements.quickAddButtons,
                elements.timerStatus,
                document.querySelector('.timer-title-section'),
                document.querySelector('.progress-container'),
                document.querySelector('.app-title')
            ];
            
            elementsToHide.forEach(el => {
                if (el) {
                    el.style.opacity = '0';
                    el.style.visibility = 'hidden';
                    el.style.pointerEvents = 'none';
                }
            });
            
            // إخفاء لوحة التحكم
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.style.opacity = '0';
                controlPanel.style.visibility = 'hidden';
                controlPanel.style.pointerEvents = 'none';
            }
            
            // تحديث الوقت الحالي
            const systemTime = elements.currentTime.parentElement;
            if (systemTime) {
                systemTime.style.position = 'fixed';
                systemTime.style.top = '15px';
                systemTime.style.right = '15px';
                systemTime.style.zIndex = '1000';
                systemTime.style.background = 'rgba(0, 0, 0, 0.5)';
                systemTime.style.backdropFilter = 'blur(10px)';
                systemTime.style.borderRadius = '12px';
                systemTime.style.padding = '8px 12px';
                systemTime.style.opacity = '1';
                systemTime.style.visibility = 'visible';
            }
            
            // إعادة ضبط التايمر ليكون في منتصف الشاشة بالضبط
            const timerContainer = document.querySelector('.timer-container');
            if (timerContainer) {
                timerContainer.style.position = 'fixed';
                timerContainer.style.top = '50%';
                timerContainer.style.left = '50%';
                timerContainer.style.transform = 'translate(-50%, -50%)';
                timerContainer.style.width = '100%';
                timerContainer.style.textAlign = 'center';
                timerContainer.style.zIndex = '10';
            }
            
            // إعادة ضبط عناصر الأرقام
            const timerDigits = document.querySelector('.timer-digits-container');
            if (timerDigits) {
                timerDigits.style.display = 'flex';
                timerDigits.style.justifyContent = 'center';
                timerDigits.style.alignItems = 'center';
                timerDigits.style.width = '100%';
                timerDigits.style.margin = '0 auto';
            }
            
            // تحديث الأيقونة
            elements.focusIcon.className = 'fas fa-eye-slash text-lg';
            
            // تحديث الأيقونة المصغرة
            elements.minimizedFocus.innerHTML = '<i class="fas fa-eye-slash"></i>';
            
            // تحديث عرض الساعات إذا كانت صفر
            updateFocusModeDisplay();
            
            // إظهار عناصر التحكم المصغرة
            if (APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
                
                if (APP_STATE.settings.focusAutoHide && APP_STATE.isRunning) {
                    setTimeout(() => {
                        hideMinimizedControls();
                    }, 2000);
                }
            }
            
            showToast('Focus mode enabled', 'success');
        }
        
        // Disable focus mode
        function disableFocusMode() {
            document.body.classList.remove('focus-mode');
            
            // إعادة إظهار جميع العناصر
            const elementsToShow = [
                elements.instructions,
                elements.quickAddButtons,
                elements.timerStatus,
                document.querySelector('.timer-title-section'),
                document.querySelector('.progress-container'),
                document.querySelector('.app-title')
            ];
            
            elementsToShow.forEach(el => {
                if (el) {
                    el.style.opacity = '';
                    el.style.visibility = '';
                    el.style.pointerEvents = '';
                }
            });
            
            // إعادة إظهار لوحة التحكم
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.style.opacity = '';
                controlPanel.style.visibility = '';
                controlPanel.style.pointerEvents = '';
            }
            
            // إعادة ضبط الوقت الحالي
            const systemTime = elements.currentTime.parentElement;
            if (systemTime) {
                systemTime.style.position = '';
                systemTime.style.top = '';
                systemTime.style.right = '';
                systemTime.style.zIndex = '';
                systemTime.style.background = '';
                systemTime.style.backdropFilter = '';
                systemTime.style.borderRadius = '';
                systemTime.style.padding = '';
            }
            
            // إعادة ضبط التايمر
            const timerContainer = document.querySelector('.timer-container');
            if (timerContainer) {
                timerContainer.style.position = '';
                timerContainer.style.top = '';
                timerContainer.style.left = '';
                timerContainer.style.transform = '';
                timerContainer.style.width = '';
                timerContainer.style.textAlign = '';
                timerContainer.style.zIndex = '';
            }
            
            // إعادة إظهار الساعات والفاصل
            elements.hoursUnit.classList.remove('hours-zero');
            elements.firstSeparator.classList.remove('hide-separator');
            
            // تحديث الأيقونة
            elements.focusIcon.className = 'fas fa-eye text-lg';
            
            // تحديث الأيقونة المصغرة
            elements.minimizedFocus.innerHTML = '<i class="fas fa-eye"></i>';
            
            // إخفاء عناصر التحكم المصغرة
            hideMinimizedControls();
            
            showToast('Focus mode disabled', 'info');
        }
        
        // Update focus mode UI
        function updateFocusModeUI() {
            if (APP_STATE.focusMode) {
                elements.focusModeToggle.classList.add('bg-blue-500/20', 'border-blue-500/30');
            } else {
                elements.focusModeToggle.classList.remove('bg-blue-500/20', 'border-blue-500/30');
            }
        }
        
        // Toggle focus auto-hide
        function toggleFocusAutoHide() {
            elements.focusAutoHideToggle.classList.toggle('active');
            APP_STATE.settings.focusAutoHide = elements.focusAutoHideToggle.classList.contains('active');
            
            if (!APP_STATE.settings.focusAutoHide && APP_STATE.focusMode) {
                showMinimizedControls();
            }
        }
        
        // ============================================
        // MINIMIZED CONTROLS FUNCTIONS
        // ============================================
        
        // Show minimized controls
        function showMinimizedControls() {
            if (!APP_STATE.settings.minimizedControls || !APP_STATE.focusMode) return;
            
            clearTimeout(APP_STATE.minimizedControlsTimeout);
            elements.minimizedControls.classList.add('show');
            APP_STATE.minimizedControlsVisible = true;
            
            if (APP_STATE.settings.focusAutoHide && APP_STATE.isRunning) {
                APP_STATE.minimizedControlsTimeout = setTimeout(() => {
                    hideMinimizedControls();
                }, 3000);
            }
        }
        
        // Hide minimized controls
        function hideMinimizedControls() {
            if (!APP_STATE.minimizedControlsVisible) return;
            
            elements.minimizedControls.classList.remove('show');
            APP_STATE.minimizedControlsVisible = false;
        }
        
        // Toggle minimized controls
        function toggleMinimizedControls() {
            elements.minimizedControlsToggle.classList.toggle('active');
            APP_STATE.settings.minimizedControls = elements.minimizedControlsToggle.classList.contains('active');
            
            if (APP_STATE.settings.minimizedControls && APP_STATE.focusMode) {
                showMinimizedControls();
            } else {
                hideMinimizedControls();
            }
        }
        
        // Update minimized controls
        function updateMinimizedControls() {
            if (APP_STATE.isRunning) {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-pause"></i>';
            } else if (APP_STATE.isPaused) {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
            } else if (APP_STATE.isFinished) {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-redo"></i>';
            } else {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
            }
            
            if (APP_STATE.focusMode) {
                elements.minimizedFocus.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                elements.minimizedFocus.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }
        
        // Handle mouse movement for showing controls
        document.addEventListener('mousemove', (e) => {
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
        });
        
        // Handle touch for showing controls
        document.addEventListener('touchstart', () => {
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
        });
        
        // ============================================
        // ENHANCED DEVELOPER CONTACT FUNCTIONS
        // ============================================
        
        // Detect platform and app type
        function detectPlatform() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
            const isWindows = /windows|win32|win64/i.test(userAgent);
            const isMac = /macintosh|mac os x|macintel/i.test(userAgent);
            const isLinux = /linux/i.test(userAgent);
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;
            const isExe = userAgent.includes('Electron') || userAgent.includes('NWJS');
            
            return {
                isMobile,
                isWindows,
                isMac,
                isLinux,
                isPWA,
                isExe,
                isWeb: !isPWA && !isMobile && !isExe,
                userAgent
            };
        }
        
        // Enhanced function to contact developer via multiple platforms
        function contactDeveloper(developer) {
            const platform = detectPlatform();
            let phoneNumber = '';
            let developerName = '';
            
            if (developer === 'abdalrahman') {
                phoneNumber = '+201065351971';
                developerName = 'Abdalrahman';
            } else if (developer === 'ahmed') {
                phoneNumber = '+201152681848';
                developerName = 'Ahmed';
            } else {
                showToast('Invalid developer selection', 'error');
                return;
            }
            
            const message = `Hello ${developerName}, I'm using ProTimer App and would like to contact you.`;
            const encodedMessage = encodeURIComponent(message);
            
            // Create WhatsApp URLs for different platforms
            const whatsappWebUrl = `https://web.whatsapp.com/send?phone=${phoneNumber.replace('+', '')}&text=${encodedMessage}`;
            const whatsappMobileUrl = `https://wa.me/${phoneNumber.replace('+', '')}?text=${encodedMessage}`;
            
            // Determine which URL to use based on platform
            let whatsappUrl = whatsappMobileUrl;
            let openMethod = 'app';
            
            if (platform.isExe) {
                // For EXE/APK/DMG applications
                if (platform.isWindows) {
                    // Try to open Windows WhatsApp app
                    const windowsAppOpened = openWhatsAppWindows(phoneNumber, message);
                    if (!windowsAppOpened) {
                        whatsappUrl = whatsappWebUrl;
                        openMethod = 'web';
                    }
                } else if (platform.isMac) {
                    // Try to open Mac WhatsApp app
                    const macAppOpened = openWhatsAppMac(phoneNumber, message);
                    if (!macAppOpened) {
                        whatsappUrl = whatsappWebUrl;
                        openMethod = 'web';
                    }
                } else if (platform.isLinux) {
                    // For Linux, try web first
                    whatsappUrl = whatsappWebUrl;
                    openMethod = 'web';
                }
            } else if (platform.isMobile) {
                // For mobile devices (Android, iOS)
                whatsappUrl = whatsappMobileUrl;
                openMethod = 'app';
            } else if (platform.isWindows || platform.isMac || platform.isLinux || platform.isWeb) {
                // For desktop (Windows, Mac, Linux) and web
                whatsappUrl = whatsappWebUrl;
                openMethod = 'web';
            }
            
            // For PWA apps, try both methods
            if (platform.isPWA && !platform.isExe) {
                // Try to open mobile app first, fallback to web
                const mobileAppOpened = openWhatsAppMobile(phoneNumber, message);
                if (!mobileAppOpened) {
                    whatsappUrl = whatsappWebUrl;
                    openMethod = 'web';
                } else {
                    return; // Mobile app was opened successfully
                }
            }
            
            // Show confirmation before opening WhatsApp
            Swal.fire({
                title: `Contact ${developerName}`,
                html: `
                    <div class="text-left">
                        <p class="mb-4">You're about to contact <strong>${developerName}</strong> via WhatsApp.</p>
                        <div class="whatsapp-option" onclick="openWhatsAppDirect('${whatsappUrl}', '${openMethod}', '${developerName}')">
                            <div class="whatsapp-option-icon">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <div class="whatsapp-option-content">
                                <div class="whatsapp-option-title">Open WhatsApp ${openMethod === 'app' ? 'App' : 'Web'}</div>
                                <div class="whatsapp-option-description">
                                    ${openMethod === 'app' ? 'Open in WhatsApp application' : 'Open in WhatsApp Web'}
                                </div>
                            </div>
                        </div>
                        <div class="contact-instructions">
                            <p class="mb-2 font-medium">If WhatsApp doesn't open:</p>
                            <ol class="text-sm">
                                <li>Open WhatsApp manually</li>
                                <li>Send a message to: <strong>${phoneNumber}</strong></li>
                                <li>Say you're using ProTimer App</li>
                            </ol>
                            <button onclick="copyToClipboard('${phoneNumber}')" class="btn-secondary w-full mt-3 text-sm">
                                <i class="fas fa-copy mr-2"></i> Copy Phone Number
                            </button>
                        </div>
                    </div>
                `,
                icon: 'info',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Open WhatsApp',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#25D366',
                cancelButtonColor: '#6b7280',
                customClass: {
                    popup: 'whatsapp-contact-modal glass-dark'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    openWhatsAppDirect(whatsappUrl, openMethod, developerName);
                }
            });
        }
        
        // Try to open WhatsApp mobile app
        function openWhatsAppMobile(phoneNumber, message) {
            // Try different URL schemes for WhatsApp
            const urlSchemes = [
                `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`,
                `whatsapp://send?phone=${phoneNumber.replace('+', '')}&text=${encodeURIComponent(message)}`,
                `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`
            ];
            
            // Create iframe to try opening WhatsApp app
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            let appOpened = false;
            
            for (const url of urlSchemes) {
                try {
                    iframe.src = url;
                    // Check if app opened (this is not foolproof but works in most cases)
                    setTimeout(() => {
                        // If we're still here after a short time, the app probably didn't open
                        if (!appOpened) {
                            iframe.src = '';
                        }
                    }, 500);
                    
                    // If we get here without error, assume app opened
                    appOpened = true;
                    break;
                } catch (error) {
                    console.log(`WhatsApp scheme ${url} failed:`, error);
                    continue;
                }
            }
            
            // Clean up
            setTimeout(() => {
                if (iframe.parentNode) {
                    iframe.parentNode.removeChild(iframe);
                }
            }, 1000);
            
            return appOpened;
        }
        
        // Try to open WhatsApp Windows app (for EXE applications)
        function openWhatsAppWindows(phoneNumber, message) {
            try {
                // Try Windows app protocol
                const url = `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`;
                window.location.href = url;
                
                // Fallback after timeout
                setTimeout(() => {
                    if (document.hasFocus()) {
                        return false;
                    }
                }, 1000);
                
                return true;
            } catch (error) {
                console.error('Failed to open WhatsApp Windows app:', error);
                return false;
            }
        }
        
        // Try to open WhatsApp Mac app (for DMG applications)
        function openWhatsAppMac(phoneNumber, message) {
            try {
                // Try Mac app protocol
                const url = `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`;
                window.location.href = url;
                
                // Fallback after timeout
                setTimeout(() => {
                    if (document.hasFocus()) {
                        return false;
                    }
                }, 1000);
                
                return true;
            } catch (error) {
                console.error('Failed to open WhatsApp Mac app:', error);
                return false;
            }
        }
        
        // Open WhatsApp directly (without confirmation)
        function openWhatsAppDirect(url, method, developerName) {
            // Try to open in new tab/window
            const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
            
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                // Popup blocked or failed, try direct navigation
                try {
                    window.location.href = url;
                } catch (error) {
                    // Fallback: Show instructions
                    showWhatsAppInstructions(developerName);
                }
            } else {
                showToast(`Opening WhatsApp ${method} to contact ${developerName}`, 'info');
            }
        }
        
        // Fallback: Show instructions for contacting via WhatsApp
        function showWhatsAppInstructions(developerName) {
            const phoneNumbers = {
                'abdalrahman': '+201065351971',
                'ahmed': '+201152681848'
            };
            
            const developerKey = developerName.toLowerCase();
            const phoneNumber = phoneNumbers[developerKey] || '';
            
            if (!phoneNumber) {
                showToast('Could not find contact information', 'error');
                return;
            }
            
            Swal.fire({
                title: `Contact ${developerName}`,
                html: `
                    <div class="text-left">
                        <p class="mb-4">To contact ${developerName} via WhatsApp:</p>
                        <ol class="list-decimal pl-5 mb-4 space-y-2">
                            <li>Open WhatsApp on your device</li>
                            <li>Add this number to your contacts: <strong>${phoneNumber}</strong></li>
                            <li>Send a message saying you're using ProTimer App</li>
                        </ol>
                        <p class="text-sm opacity-70">Or copy the number:</p>
                        <div class="mt-2 p-3 bg-white/10 rounded-lg flex justify-between items-center">
                            <code class="font-mono">${phoneNumber}</code>
                            <button onclick="copyToClipboard('${phoneNumber}')" class="btn-secondary px-3 py-1 text-sm">
                                <i class="fas fa-copy mr-1"></i> Copy
                            </button>
                        </div>
                    </div>
                `,
                icon: 'info',
                background: '#0f172a',
                color: '#f8fafc',
                confirmButtonText: 'Got it!',
                confirmButtonColor: '#10b981',
                customClass: {
                    popup: 'glass-dark'
                }
            });
        }
        
        // Helper function to copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(
                () => {
                    showToast('Phone number copied to clipboard!', 'success');
                },
                () => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Phone number copied to clipboard!', 'success');
                    } catch (error) {
                        showToast('Failed to copy phone number', 'error');
                    }
                    document.body.removeChild(textArea);
                }
            );
        }
        
        // ============================================
        // ENHANCED SETTINGS FUNCTIONS
        // ============================================
        
        // Toggle settings panel
        function toggleSettings() {
            elements.settingsPanel.classList.toggle('translate-x-full');
            
            if (!elements.settingsPanel.classList.contains('translate-x-full')) {
                updateSettingsUI();
                
                setTimeout(() => {
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab) {
                        activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }, 100);
            }
        }
        
        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });
            document.querySelector(`[data-tab-content="${tabName}"]`).classList.remove('hidden');
            document.querySelector(`[data-tab-content="${tabName}"]`).classList.add('active');
            
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
            
            if (tabName === 'fonts') {
                updateUploadedFontsList();
            }
        }
        
        // Update settings UI from state
        function updateSettingsUI() {
            // Timer settings
            elements.hoursSlider.value = APP_STATE.hours;
            elements.hoursInput.value = APP_STATE.hours;
            elements.minutesSlider.value = APP_STATE.minutes;
            elements.minutesInput.value = APP_STATE.minutes;
            elements.secondsSlider.value = APP_STATE.seconds;
            elements.secondsInput.value = APP_STATE.seconds;
            elements.finishMessage.value = APP_STATE.settings.finishMessage;
            
            // Appearance settings
            elements.bgColor.value = APP_STATE.settings.bgColor;
            elements.textColor.value = APP_STATE.settings.textColor;
            elements.outlineColor.value = APP_STATE.settings.outlineColor;
            elements.progressColor.value = APP_STATE.settings.progressColor;
            elements.outlineToggle.classList.toggle('active', APP_STATE.settings.outlineEnabled);
            elements.outlineThickness.value = APP_STATE.settings.outlineThickness;
            elements.outlineThicknessValue.textContent = APP_STATE.settings.outlineThickness;
            elements.bgOpacity.value = APP_STATE.settings.bgOpacity;
            elements.bgOpacityValue.textContent = APP_STATE.settings.bgOpacity;
            elements.panelOpacity.value = APP_STATE.settings.panelOpacity;
            elements.panelOpacityValue.textContent = APP_STATE.settings.panelOpacity;
            
            // Font settings
            elements.fontFamily.value = APP_STATE.currentFont;
            elements.fontSize.value = APP_STATE.settings.fontSize;
            elements.fontSizeValue.textContent = APP_STATE.settings.fontSize;
            elements.fontWeight.value = APP_STATE.settings.fontWeight;
            
            // Media settings
            elements.mediaToggle.classList.toggle('active', APP_STATE.settings.mediaEnabled);
            elements.mediaUrl.value = APP_STATE.settings.mediaUrl;
            elements.mediaAudioToggle.classList.toggle('active', APP_STATE.settings.mediaAudioEnabled);
            elements.mediaOpacity.value = APP_STATE.settings.mediaOpacity;
            elements.mediaOpacityValue.textContent = APP_STATE.settings.mediaOpacity;
            updateMediaPreview();
            
            // Audio settings
            elements.audioToggle.classList.toggle('active', APP_STATE.settings.audioEnabled);
            elements.audioUrl.value = APP_STATE.settings.audioUrl;
            elements.volumeSlider.value = APP_STATE.settings.audioVolume;
            elements.volumeValue.textContent = APP_STATE.settings.audioVolume;
            elements.loopToggle.classList.toggle('active', APP_STATE.settings.audioLoop);
            elements.tickToggle.classList.toggle('active', APP_STATE.settings.tickSound);
            elements.finishSoundToggle.classList.toggle('active', APP_STATE.settings.finishSoundEnabled);
            elements.clickSoundToggle.classList.toggle('active', APP_STATE.settings.clickSound);
            elements.warningSoundToggle.classList.toggle('active', APP_STATE.settings.warningSoundEnabled);
            elements.finishSound.value = APP_STATE.settings.finishSound;
            elements.warningSound.value = APP_STATE.settings.warningSound;
            elements.notificationsToggle.classList.toggle('active', APP_STATE.settings.notificationsEnabled);
            elements.notificationSoundToggle.classList.toggle('active', APP_STATE.settings.notificationSoundEnabled);
            elements.doubleTapToggle.classList.toggle('active', APP_STATE.settings.doubleTapEnabled);
            elements.clickAdjustToggle.classList.toggle('active', APP_STATE.settings.clickAdjustEnabled);
            
            // Advanced settings
            elements.wakeLockToggle.classList.toggle('active', APP_STATE.settings.wakeLockEnabled);
            elements.autoStartToggle.classList.toggle('active', APP_STATE.settings.autoStart);
            elements.flashToggle.classList.toggle('active', APP_STATE.settings.flashEnabled);
            elements.millisecondsToggle.classList.toggle('active', APP_STATE.settings.showMilliseconds);
            elements.vibrateToggle.classList.toggle('active', APP_STATE.settings.vibrateOnFinish);
            elements.focusAutoHideToggle.classList.toggle('active', APP_STATE.settings.focusAutoHide);
            elements.minimizedControlsToggle.classList.toggle('active', APP_STATE.settings.minimizedControls);
            elements.hideHoursToggle.classList.toggle('active', APP_STATE.settings.hideHoursWhenZero);
            
            // Presets
            elements.presetName.value = APP_STATE.currentPreset || '';
            updatePresetList();
        }
        
        // Update media preview
        function updateMediaPreview() {
            if (APP_STATE.settings.mediaUrl) {
                if (APP_STATE.settings.mediaType === 'video') {
                    elements.mediaPreview.innerHTML = `
                        <video class="w-full h-full object-cover" controls>
                            <source src="${APP_STATE.settings.mediaUrl}" type="video/mp4">
                        </video>
                    `;
                } else {
                    elements.mediaPreview.innerHTML = `
                        <img src="${APP_STATE.settings.mediaUrl}" alt="Preview" class="w-full h-full object-cover">
                    `;
                }
            } else {
                elements.mediaPreview.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-image text-4xl opacity-30 mb-2"></i>
                        <p class="opacity-50">No media selected</p>
                    </div>
                `;
            }
        }
        
        // Apply settings
        function applySettings() {
            // Timer settings
            APP_STATE.hours = parseInt(elements.hoursInput.value) || 0;
            APP_STATE.minutes = parseInt(elements.minutesInput.value) || 0;
            APP_STATE.seconds = parseInt(elements.secondsInput.value) || 0;
            APP_STATE.settings.finishMessage = elements.finishMessage.value;
            
            // Save original time
            saveOriginalTime();
            
            // Appearance settings
            APP_STATE.settings.bgColor = elements.bgColor.value;
            APP_STATE.settings.textColor = elements.textColor.value;
            APP_STATE.settings.outlineColor = elements.outlineColor.value;
            APP_STATE.settings.progressColor = elements.progressColor.value;
            APP_STATE.settings.outlineEnabled = elements.outlineToggle.classList.contains('active');
            APP_STATE.settings.outlineThickness = parseInt(elements.outlineThickness.value);
            APP_STATE.settings.bgOpacity = parseInt(elements.bgOpacity.value);
            APP_STATE.settings.panelOpacity = parseInt(elements.panelOpacity.value);
            
            // Font settings
            APP_STATE.currentFont = elements.fontFamily.value;
            APP_STATE.settings.fontSize = parseInt(elements.fontSize.value);
            APP_STATE.settings.fontWeight = elements.fontWeight.value;
            
            // Media settings
            APP_STATE.settings.mediaEnabled = elements.mediaToggle.classList.contains('active');
            APP_STATE.settings.mediaUrl = elements.mediaUrl.value;
            APP_STATE.settings.mediaAudioEnabled = elements.mediaAudioToggle.classList.contains('active');
            APP_STATE.settings.mediaOpacity = parseInt(elements.mediaOpacity.value);
            
            // Audio settings
            APP_STATE.settings.audioEnabled = elements.audioToggle.classList.contains('active');
            APP_STATE.settings.audioUrl = elements.audioUrl.value;
            APP_STATE.settings.audioVolume = parseInt(elements.volumeSlider.value);
            APP_STATE.settings.audioLoop = elements.loopToggle.classList.contains('active');
            APP_STATE.settings.tickSound = elements.tickToggle.classList.contains('active');
            APP_STATE.settings.finishSoundEnabled = elements.finishSoundToggle.classList.contains('active');
            APP_STATE.settings.clickSound = elements.clickSoundToggle.classList.contains('active');
            APP_STATE.settings.warningSoundEnabled = elements.warningSoundToggle.classList.contains('active');
            APP_STATE.settings.finishSound = elements.finishSound.value;
            APP_STATE.settings.warningSound = elements.warningSound.value;
            
            // Notification settings
            APP_STATE.settings.notificationsEnabled = elements.notificationsToggle.classList.contains('active');
            APP_STATE.settings.notificationSoundEnabled = elements.notificationSoundToggle.classList.contains('active');
            APP_STATE.settings.doubleTapEnabled = elements.doubleTapToggle.classList.contains('active');
            APP_STATE.settings.clickAdjustEnabled = elements.clickAdjustToggle.classList.contains('active');
            
            // Advanced settings
            APP_STATE.settings.wakeLockEnabled = elements.wakeLockToggle.classList.contains('active');
            APP_STATE.settings.autoStart = elements.autoStartToggle.classList.contains('active');
            APP_STATE.settings.flashEnabled = elements.flashToggle.classList.contains('active');
            APP_STATE.settings.showMilliseconds = elements.millisecondsToggle.classList.contains('active');
            APP_STATE.settings.vibrateOnFinish = elements.vibrateToggle.classList.contains('active');
            APP_STATE.settings.focusAutoHide = elements.focusAutoHideToggle.classList.contains('active');
            APP_STATE.settings.minimizedControls = elements.minimizedControlsToggle.classList.contains('active');
            APP_STATE.settings.hideHoursWhenZero = elements.hideHoursToggle.classList.contains('active');
            
            // Update display
            updateTotalSeconds();
            updateDisplay();
            updateDigitColors();
            updateBackground();
            updateFontSettings();
            updateFocusModeUI();
            
            // Close settings
            toggleSettings();
            
            // Save to localStorage
            saveToLocalStorage();
            
            showToast('Settings applied successfully', 'success');
        }
        
        // Toggle outline
        function toggleOutline() {
            elements.outlineToggle.classList.toggle('active');
        }
        
        // Toggle media
        function toggleMedia() {
            elements.mediaToggle.classList.toggle('active');
        }
        
        // Toggle media audio
        function toggleMediaAudio() {
            elements.mediaAudioToggle.classList.toggle('active');
        }
        
        // Test media
        function testMedia() {
            const url = elements.mediaUrl.value;
            if (!url) {
                showToast('Please enter a media URL', 'warning');
                return;
            }
            
            const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi'];
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
            
            const extension = url.substring(url.lastIndexOf('.')).toLowerCase();
            
            if (videoExtensions.includes(extension)) {
                APP_STATE.settings.mediaType = 'video';
            } else if (imageExtensions.includes(extension)) {
                APP_STATE.settings.mediaType = 'image';
            } else {
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    showToast('YouTube URLs are not directly supported. Please use a direct video link.', 'warning');
                    return;
                } else {
                    APP_STATE.settings.mediaType = 'image';
                }
            }
            
            APP_STATE.settings.mediaUrl = url;
            updateMediaPreview();
            showToast('Media loaded for preview', 'success');
        }
        
        // Remove media
        function removeMedia() {
            APP_STATE.settings.mediaUrl = '';
            APP_STATE.settings.mediaType = '';
            elements.mediaUrl.value = '';
            updateMediaPreview();
            updateBackground();
            showToast('Media removed', 'info');
        }
        
        // Handle media file upload
        elements.mediaFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                APP_STATE.settings.mediaUrl = event.target.result;
                APP_STATE.settings.mediaType = file.type.startsWith('video/') ? 'video' : 'image';
                elements.mediaUrl.value = APP_STATE.settings.mediaUrl;
                updateMediaPreview();
                showToast('Media file loaded', 'success');
            };
            reader.readAsDataURL(file);
        });
        
        // Toggle audio
        function toggleAudio() {
            elements.audioToggle.classList.toggle('active');
        }
        
        // Test audio
        function testAudio() {
            const url = elements.audioUrl.value;
            if (!url) {
                showToast('Please enter an audio URL', 'warning');
                return;
            }
            
            if (APP_STATE.backgroundAudio) {
                APP_STATE.backgroundAudio.pause();
                APP_STATE.backgroundAudio = null;
            }
            
            APP_STATE.backgroundAudio = new Audio(url);
            APP_STATE.backgroundAudio.volume = APP_STATE.settings.audioVolume / 100;
            APP_STATE.backgroundAudio.loop = APP_STATE.settings.audioLoop;
            
            APP_STATE.backgroundAudio.play()
                .then(() => {
                    showToast('Audio playback started', 'success');
                })
                .catch(error => {
                    showToast('Failed to play audio: ' + error.message, 'error');
                });
        }
        
        // Remove audio
        function removeAudio() {
            if (APP_STATE.backgroundAudio) {
                APP_STATE.backgroundAudio.pause();
                APP_STATE.backgroundAudio = null;
            }
            
            APP_STATE.settings.audioUrl = '';
            elements.audioUrl.value = '';
            showToast('Audio removed', 'info');
        }
        
        // Handle audio file upload (including MP3 from local storage)
        elements.audioFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check if it's an MP3 or other audio file
            if (!file.type.startsWith('audio/')) {
                showToast('Please select an audio file (MP3, WAV, etc.)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                APP_STATE.settings.audioUrl = event.target.result;
                elements.audioUrl.value = APP_STATE.settings.audioUrl;
                showToast(`${file.name} loaded successfully`, 'success');
                
                // Auto-test the audio
                testAudio();
            };
            reader.readAsDataURL(file);
        });
        
        // Update volume display
        elements.volumeSlider.addEventListener('input', function() {
            elements.volumeValue.textContent = this.value;
        });
        
        // Update opacity displays
        elements.bgOpacity.addEventListener('input', function() {
            elements.bgOpacityValue.textContent = this.value;
        });
        
        elements.panelOpacity.addEventListener('input', function() {
            elements.panelOpacityValue.textContent = this.value;
        });
        
        elements.mediaOpacity.addEventListener('input', function() {
            elements.mediaOpacityValue.textContent = this.value;
        });
        
        // Toggle loop
        function toggleLoop() {
            elements.loopToggle.classList.toggle('active');
        }
        
        // Toggle tick sound
        function toggleTickSound() {
            elements.tickToggle.classList.toggle('active');
        }
        
        // Toggle finish sound
        function toggleFinishSound() {
            elements.finishSoundToggle.classList.toggle('active');
        }
        
        // Toggle click sound
        function toggleClickSound() {
            elements.clickSoundToggle.classList.toggle('active');
        }
        
        // Toggle warning sound
        function toggleWarningSound() {
            elements.warningSoundToggle.classList.toggle('active');
        }
        
        // Toggle wake lock
        function toggleWakeLock() {
            elements.wakeLockToggle.classList.toggle('active');
        }
        
        // Toggle auto start
        function toggleAutoStart() {
            elements.autoStartToggle.classList.toggle('active');
        }
        
        // Toggle flash
        function toggleFlash() {
            elements.flashToggle.classList.toggle('active');
        }
        
        // Toggle milliseconds
        function toggleMilliseconds() {
            elements.millisecondsToggle.classList.toggle('active');
        }
        
        // Toggle vibrate
        function toggleVibrate() {
            elements.vibrateToggle.classList.toggle('active');
        }
        
        // Update outline thickness display
        elements.outlineThickness.addEventListener('input', function() {
            elements.outlineThicknessValue.textContent = this.value;
        });
        
        // Update font size display
        elements.fontSize.addEventListener('input', function() {
            elements.fontSizeValue.textContent = this.value;
        });
        
        // Link sliders and inputs
        function linkSliderAndInput(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            
            slider.addEventListener('input', function() {
                input.value = this.value;
            });
            
            input.addEventListener('input', function() {
                let value = parseInt(this.value) || 0;
                const max = parseInt(slider.max);
                const min = parseInt(slider.min);
                
                if (value > max) value = max;
                if (value < min) value = min;
                
                this.value = value;
                slider.value = value;
            });
        }
        
        // Link all timer controls
        linkSliderAndInput('hoursSlider', 'hoursInput');
        linkSliderAndInput('minutesSlider', 'minutesInput');
        linkSliderAndInput('secondsSlider', 'secondsInput');
        
        // ============================================
        // KEYBOARD TIME INPUT FUNCTIONALITY
        // ============================================
        
// ==========================================
// الكود النهائي الموحد للتحكم في الوقت والرسائل
// ==========================================

function adjustTime(type, amount) {
    // 1. لا تفعل شيئاً إذا كان المؤقت يعمل أو انتهى
    if (APP_STATE.isRunning || APP_STATE.isFinished) return;

    // 2. فحص حالة الزر (OFF أو ON)
    const isDoubleTapOff = APP_STATE.settings.doubleTapEnabled === false;
    const now = Date.now();
    const lastTap = APP_STATE._lastAdjustTime || 0;
    
    // 3. التعديل هنا: غيرنا 350 لـ 100 عشان الضغط السريع يشتغل بسلاسة
    if (isDoubleTapOff && (now - lastTap < 100) && amount > 0) {
        return; 
    }
    APP_STATE._lastAdjustTime = now;

    // 4. تشغيل صوت النقر إذا كان مفعلاً
    if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
        playSound('click');
    }

    // 5. تنفيذ العملية الحسابية
    if (type === 'hours') {
        APP_STATE.hours = (APP_STATE.hours + amount + 100) % 100;
    } else if (type === 'minutes') {
        APP_STATE.minutes = (APP_STATE.minutes + amount + 60) % 60;
    } else if (type === 'seconds') {
        APP_STATE.seconds = (APP_STATE.seconds + amount + 60) % 60;
    }

    // 6. تحديث الأرقام على الشاشة
    updateTotalSeconds();
    updateDisplay();
}

function openKeyboardInput(type) {
    // 1. إذا كان الإعداد OFF -> ارفض فتح الرسالة نهائياً
    if (APP_STATE.settings.doubleTapEnabled === false) {
        return;
    }

    // 2. إذا كان الإعداد ON -> افتح واجهة الإدخال
    APP_STATE.currentInputType = type;
    const value = type === 'hours' ? APP_STATE.hours : (type === 'minutes' ? APP_STATE.minutes : APP_STATE.seconds);
    
    if (elements.manualTimeInput) {
        elements.manualTimeInput.value = formatTime(value);
        elements.keyboardInputOverlay.classList.remove('hidden');
        elements.manualTimeInput.focus();
        elements.manualTimeInput.select();
    }
}
        // Close keyboard input overlay
        function closeKeyboardInput() {
            elements.keyboardInputOverlay.classList.add('hidden');
        }
        
        // Apply manual time input
        function applyManualTime() {
            const timeString = elements.manualTimeInput.value.trim();
            const timeRegex = /^(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            
            if (!timeRegex.test(timeString)) {
                showToast('Invalid time format. Use HH:MM:SS', 'error');
                return;
            }
            
            const matches = timeString.match(timeRegex);
            let hours = parseInt(matches[1]);
            let minutes = parseInt(matches[2]);
            let seconds = parseInt(matches[3]);
            
            // NO LIMITS - يمكن وضع أي قيم
            saveOriginalTime();
            
            APP_STATE.hours = hours;
            APP_STATE.minutes = minutes;
            APP_STATE.seconds = seconds;
            
            updateTotalSeconds();
            updateDisplay();
            closeKeyboardInput();
            
            showToast(`Time set to ${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`, 'success');
        }
        

        
        // ============================================
        // ENHANCED PRESET FUNCTIONS
        // ============================================
        
        // Save preset with confirmation
        function savePreset() {
            const name = elements.presetName.value.trim();
            if (!name) {
                showToast('Please enter a preset name', 'warning');
                return;
            }
            
            if (APP_STATE.presets[name]) {
                Swal.fire({
                    title: 'Overwrite Preset?',
                    text: `A preset named "${name}" already exists. Do you want to overwrite it?`,
                    icon: 'warning',
                    background: '#0f172a',
                    color: '#f8fafc',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, overwrite it!',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280'
                }).then((result) => {
                    if (result.isConfirmed) {
                        savePresetConfirmed(name);
                    }
                });
            } else {
                savePresetConfirmed(name);
            }
        }
        
        // Save preset confirmed
        function savePresetConfirmed(name) {
            APP_STATE.presets[name] = {
                timer: {
                    hours: APP_STATE.hours,
                    minutes: APP_STATE.minutes,
                    seconds: APP_STATE.seconds,
                    originalHours: APP_STATE.originalHours,
                    originalMinutes: APP_STATE.originalMinutes,
                    originalSeconds: APP_STATE.originalSeconds
                },
                settings: { ...APP_STATE.settings },
                timestamp: Date.now()
            };
            
            APP_STATE.currentPreset = name;
            updatePresetList();
            saveToLocalStorage();
            
            showToast(`Preset "${name}" saved`, 'success');
        }
        
        // Load preset
        function loadPreset() {
            const name = elements.presetList.value;
            if (!name || !APP_STATE.presets[name]) {
                showToast('Please select a preset', 'warning');
                return;
            }
            
            const preset = APP_STATE.presets[name];
            
            Swal.fire({
                title: 'Load Preset?',
                text: `Are you sure you want to load preset "${name}"?`,
                icon: 'question',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, load it!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    APP_STATE.hours = preset.timer.hours;
                    APP_STATE.minutes = preset.timer.minutes;
                    APP_STATE.seconds = preset.timer.seconds;
                    APP_STATE.originalHours = preset.timer.originalHours || preset.timer.hours;
                    APP_STATE.originalMinutes = preset.timer.originalMinutes || preset.timer.minutes;
                    APP_STATE.originalSeconds = preset.timer.originalSeconds || preset.timer.seconds;
                    updateTotalSeconds();
                    
                    APP_STATE.settings = { ...APP_STATE.settings, ...preset.settings };
                    
                    updateDisplay();
                    updateSettingsUI();
                    applySettings();
                    
                    APP_STATE.currentPreset = name;
                    elements.presetName.value = name;
                    
                    showToast(`Preset "${name}" loaded`, 'success');
                }
            });
        }
        
        // Update preset list
        function updatePresetList() {
            const select = elements.presetList;
            select.innerHTML = '<option value="">Select a preset...</option>';
            
            const presetNames = Object.keys(APP_STATE.presets).sort((a, b) => {
                return (APP_STATE.presets[b].timestamp || 0) - (APP_STATE.presets[a].timestamp || 0);
            });
            
            for (const name of presetNames) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
            
            if (APP_STATE.currentPreset) {
                select.value = APP_STATE.currentPreset;
            }
        }
        
        // Export settings
        function exportSettings() {
            const data = {
                settings: APP_STATE.settings,
                presets: APP_STATE.presets,
                uploadedFonts: APP_STATE.uploadedFonts,
                currentFont: APP_STATE.currentFont,
                version: '2.1.0',
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `protimer-settings-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Settings exported successfully', 'success');
        }
        
        // Import settings
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => { 
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        Swal.fire({
                            title: 'Import Settings?',
                            text: 'This will overwrite your current settings and presets. Are you sure?',
                            icon: 'warning',
                            background: '#0f172a',
                            color: '#f8fafc',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, import them!',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#ef4444',
                            cancelButtonColor: '#6b7280'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                if (data.settings) {
                                    APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
                                }
                                
                                if (data.presets) {
                                    APP_STATE.presets = data.presets;
                                }
                                
                                if (data.uploadedFonts) {
                                    APP_STATE.uploadedFonts = data.uploadedFonts;
                                }
                                
                                if (data.currentFont) {
                                    APP_STATE.currentFont = data.currentFont;
                                }
                                
                                updateSettingsUI();
                                applySettings();
                                updateUploadedFontsList();
                                updatePresetList();
                                saveToLocalStorage();
                                
                                showToast('Settings imported successfully', 'success');
                            }
                        });
                    } catch (error) {
                        showToast('Failed to import settings: Invalid file format', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Reset all settings
        function resetAllSettings() {
            Swal.fire({
                title: 'Reset All Settings?',
                text: 'This will reset ALL settings to defaults and cannot be undone!',
                icon: 'warning',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, reset everything!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                showDenyButton: true,
                denyButtonText: 'Keep presets only'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetEverything();
                } else if (result.isDenied) {
                    resetSettingsKeepPresets();
                }
            });
        }
        
        // Reset everything
        function resetEverything() {
            APP_STATE.hours = 0;
            APP_STATE.minutes = 10;
            APP_STATE.seconds = 0;
            saveOriginalTime();
            updateTotalSeconds();
            
            APP_STATE.settings = {
                bgColor: '#0f172a',
                textColor: '#ffffff',
                outlineColor: '#000000',
                progressColor: '#6366f1',
                outlineEnabled: false,
                outlineThickness: 2,
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: 12,
                fontWeight: 700,
                bgOpacity: 100,
                panelOpacity: 90,
                
                mediaEnabled: false,
                mediaUrl: '',
                mediaType: '',
                mediaAudioEnabled: false,
                mediaOpacity: 30,
                
                audioEnabled: false,
                audioUrl: '',
                audioLoop: true,
                audioVolume: 50,
                
                finishMessage: "Time's Up!",
                flashEnabled: true,
                wakeLockEnabled: false,
                autoStart: false,
                showMilliseconds: false,
                vibrateOnFinish: true,
                focusAutoHide: true,
                minimizedControls: true,
                hideHoursWhenZero: true,
                
                finishSound: 'bell',
                tickSound: true,
                clickSound: true,
                finishSoundEnabled: true,
                warningSound: 'tick',
                warningSoundEnabled: true,
                
                notificationsEnabled: true,
                notificationSoundEnabled: true,
                doubleTapEnabled: true,
                clickAdjustEnabled: true
            };
            
            APP_STATE.uploadedFonts = {};
            APP_STATE.currentFont = "'JetBrains Mono', monospace";
            
            APP_STATE.presets = {};
            APP_STATE.currentPreset = null;
            
            APP_STATE.focusMode = false;
            document.body.classList.remove('focus-mode');
            
            updateDisplay();
            updateSettingsUI();
            applySettings();
            updateUploadedFontsList();
            updateFocusModeUI();
            
            showToast('All settings reset to defaults', 'success');
        }
        
        // Reset settings but keep presets
        function resetSettingsKeepPresets() {
            APP_STATE.hours = 0;
            APP_STATE.minutes = 10;
            APP_STATE.seconds = 0;
            saveOriginalTime();
            updateTotalSeconds();
            
            APP_STATE.settings = {
                bgColor: '#0f172a',
                textColor: '#ffffff',
                outlineColor: '#000000',
                progressColor: '#6366f1',
                outlineEnabled: false,
                outlineThickness: 2,
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: 12,
                fontWeight: 700,
                bgOpacity: 100,
                panelOpacity: 90,
                
                mediaEnabled: false,
                mediaUrl: '',
                mediaType: '',
                mediaAudioEnabled: false,
                mediaOpacity: 30,
                
                audioEnabled: false,
                audioUrl: '',
                audioLoop: true,
                audioVolume: 50,
                
                finishMessage: "Time's Up!",
                flashEnabled: true,
                wakeLockEnabled: false,
                autoStart: false,
                showMilliseconds: false,
                vibrateOnFinish: true,
                focusAutoHide: true,
                minimizedControls: true,
                hideHoursWhenZero: true,
                
                finishSound: 'bell',
                tickSound: true,
                clickSound: true,
                finishSoundEnabled: true,
                warningSound: 'tick',
                warningSoundEnabled: true,
                
                notificationsEnabled: true,
                notificationSoundEnabled: true,
                doubleTapEnabled: true,
                clickAdjustEnabled: true
            };
            
            APP_STATE.currentFont = "'JetBrains Mono', monospace";
            
            APP_STATE.focusMode = false;
            document.body.classList.remove('focus-mode');
            
            updateDisplay();
            updateSettingsUI();
            applySettings();
            updateFocusModeUI();
            
            showToast('Settings reset, presets kept', 'success');
        }
        
        // ============================================
        // ENHANCED SYSTEM FUNCTIONS
        // ============================================
        
        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    showToast('Fullscreen not supported', 'warning');
                });
                APP_STATE.isFullscreen = true;
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress text-lg"></i><span>EXIT FULLSCREEN</span>';
            } else {
                document.exitFullscreen();
                APP_STATE.isFullscreen = false;
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand text-lg"></i><span>FULLSCREEN</span>';
            }
        }
        
        // Toggle shortcuts help
        function toggleShortcutsHelp() {
            elements.shortcutsHelp.classList.toggle('hidden');
        }
        

        
        // Handle fullscreen change
        function handleFullscreenChange() {
            if (!document.fullscreenElement && APP_STATE.isFullscreen) {
                APP_STATE.isFullscreen = false;
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand text-lg"></i><span>FULLSCREEN</span>';
            }
        }
        
        // Handle visibility change for PWA
        function handleVisibilityChange() {
            if (document.hidden && APP_STATE.isRunning) {
                console.log('App went to background');
            }
        }
        
        // ============================================
        // FONT HANDLING FUNCTIONS
        // ============================================
        
        // Handle drag over for font upload
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            elements.fontUploadArea.classList.add('drag-over');
        }
        
        // Handle drag leave for font upload
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            elements.fontUploadArea.classList.remove('drag-over');
        }
        
        // Handle font drop
        function handleFontDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            elements.fontUploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            handleFontFiles(files);
        }
        
        // Handle font file selection
        function handleFontFileSelect(e) {
            const files = e.target.files;
            handleFontFiles(files);
        }
        
        // Handle font files
        function handleFontFiles(files) {
            const fontFiles = Array.from(files).filter(file => 
                file.name.match(/\.(ttf|otf|woff|woff2)$/i)
            );
            
            if (fontFiles.length === 0) {
                showToast('No valid font files selected. Supported formats: .ttf, .otf, .woff, .woff2', 'error');
                return;
            }
            
            let loadedCount = 0;
            const totalFiles = fontFiles.length;
            
            fontFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fontData = e.target.result;
                    const fontName = file.name.replace(/\.[^/.]+$/, "");
                    
                    const fontFamilyName = `CustomFont_${fontName.replace(/\s+/g, '_')}_${Date.now()}`;
                    
                    const fontFace = new FontFace(fontFamilyName, `url(${fontData})`);
                    
                    fontFace.load().then(loadedFace => {
                        document.fonts.add(loadedFace);
                        
                        APP_STATE.uploadedFonts[fontFamilyName] = {
                            name: fontName,
                            family: fontFamilyName,
                            data: fontData,
                            timestamp: Date.now()
                        };
                        
                        loadedCount++;
                        
                        if (loadedCount === totalFiles) {
                            updateUploadedFontsList();
                            showToast(`${loadedCount} font${loadedCount > 1 ? 's' : ''} uploaded successfully`, 'success');
                            saveToLocalStorage();
                        }
                    }).catch(error => {
                        console.error('Failed to load font:', error);
                        showToast(`Failed to load font: ${file.name}`, 'error');
                    });
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // Update uploaded fonts list
        function updateUploadedFontsList() {
            const fontsList = elements.uploadedFontsList;
            const fonts = APP_STATE.uploadedFonts;
            
            if (Object.keys(fonts).length === 0) {
                fontsList.innerHTML = `
                    <div class="text-center py-8 opacity-50">
                        <i class="fas fa-font text-3xl mb-3"></i>
                        <p>No custom fonts uploaded yet</p>
                    </div>
                `;
                return;
            }
            
            fontsList.innerHTML = '';
            
            Object.entries(fonts).forEach(([family, font]) => {
                const fontItem = document.createElement('div');
                fontItem.className = `font-item ${APP_STATE.currentFont === `'${family}', sans-serif` ? 'active' : ''}`;
                fontItem.innerHTML = `
                    <div class="font-info">
                        <div class="font-name font-medium">${font.name}</div>
                        <div class="font-family text-xs opacity-60">${family}</div>
                    </div>
                    <div class="font-actions">
                        <button class="font-action-btn preview" onclick="previewFont('${family}')" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="font-action-btn ${APP_STATE.currentFont === `'${family}', sans-serif` ? 'active' : ''}" onclick="selectFont('${family}')" title="Select">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="font-action-btn delete" onclick="deleteFont('${family}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                fontsList.appendChild(fontItem);
            });
        }
        
        // Preview font
        function previewFont(fontFamily) {
            elements.fontPreviewText.style.fontFamily = `'${fontFamily}', sans-serif`;
            elements.fontPreviewContainer.classList.remove('hidden');
            
            elements.fontPreviewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Select font
        function selectFont(fontFamily) {
            APP_STATE.currentFont = `'${fontFamily}', sans-serif`;
            updateFontSettings();
            updateUploadedFontsList();
            showToast(`Font "${APP_STATE.uploadedFonts[fontFamily].name}" selected`, 'success');
            saveToLocalStorage();
        }
        
        // Delete font
        function deleteFont(fontFamily) {
            Swal.fire({
                title: 'Delete Font?',
                text: `Are you sure you want to delete "${APP_STATE.uploadedFonts[fontFamily].name}"?`,
                icon: 'warning',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    const fontFaces = Array.from(document.fonts).filter(font => 
                        font.family === fontFamily
                    );
                    
                    fontFaces.forEach(font => {
                        document.fonts.delete(font);
                    });
                    
                    delete APP_STATE.uploadedFonts[fontFamily];
                    
                    if (APP_STATE.currentFont === `'${fontFamily}', sans-serif`) {
                        APP_STATE.currentFont = "'JetBrains Mono', monospace";
                        updateFontSettings();
                    }
                    
                    updateUploadedFontsList();
                    saveToLocalStorage();
                    
                    showToast('Font deleted successfully', 'success');
                }
            });
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        function initializeApp() {
            checkPWAInstallation();
            
            updateDisplay();
            updateCurrentTime();
            
            saveOriginalTime();
            
            setInterval(updateCurrentTime, 1000);
            
            loadFromLocalStorage();
            
            setupAutoSave();
            
            applySettings();
            

            
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            elements.mediaFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    APP_STATE.settings.mediaUrl = event.target.result;
                    APP_STATE.settings.mediaType = file.type.startsWith('video/') ? 'video' : 'image';
                    elements.mediaUrl.value = APP_STATE.settings.mediaUrl;
                    updateMediaPreview();
                    showToast('Media file loaded', 'success');
                };
                reader.readAsDataURL(file);
            });
            
            elements.audioFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    APP_STATE.settings.audioUrl = event.target.result;
                    elements.audioUrl.value = APP_STATE.settings.audioUrl;
                    showToast('Audio file loaded', 'success');
                };
                reader.readAsDataURL(file);
            });
            
            if (APP_STATE.settings.autoStart && APP_STATE.totalSeconds > 0) {
                setTimeout(() => {
                    startTimer();
                }, 1000);
            }
            
            setTimeout(() => {
                showToast('Professional Timer v2.1.0 loaded successfully!', 'success');
                if (!isPWAInstalled) {
                    showToast('Install as app for better experience', 'info', 5000);
                }
            }, 1000);
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            document.querySelectorAll('button, .time-value, .tab, .toggle-switch, .control-btn').forEach(el => {
                el.classList.add('touch-feedback');
            });
            
            console.log('Professional Timer PWA App v2.1.0 initialized successfully');
        }
        
        window.addEventListener('DOMContentLoaded', initializeApp);
        
        document.addEventListener('touchend', function(e) {
            handleTouchEnd();
        });
        // Essential utility functions
        function formatTime(num) {
            return num.toString().padStart(2, '0');
        }
        
        function calculateTotalSeconds() {
            return APP_STATE.hours * 3600 + APP_STATE.minutes * 60 + APP_STATE.seconds;
        }
        
        function updateTotalSeconds() {
            APP_STATE.totalSeconds = calculateTotalSeconds();
            APP_STATE.remainingSeconds = APP_STATE.totalSeconds;
        }
        

        
        // تابع بقية الدوال من الكود الأصلي هنا...
        // Due to character limit, please copy all remaining functions from the original code
        
    </script>
    <!-- Add missing functions script -->
<script>
// ============================================
// MISSING FUNCTIONS - ADD THIS AT THE END OF HTML
// ============================================

// 1. وظيفة إضافة الدقائق المفقودة
function addMinutes(minutes) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) {
        showToast('لا يمكن تعديل الوقت أثناء تشغيل المؤقت', 'warning');
        return;
    }
    
    // تشغيل صوت النقر
    if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
        playSound('click');
    }
    
    // حفظ الوقت الأصلي إذا لم يتم حفظه
    if (APP_STATE.originalHours === undefined) {
        saveOriginalTime();
    }
    
    const totalMinutes = APP_STATE.hours * 60 + APP_STATE.minutes + minutes;
    APP_STATE.hours = Math.floor(totalMinutes / 60);
    APP_STATE.minutes = totalMinutes % 60;
    
    // لا يوجد حد أقصى - يمكن تجاوز 24 ساعة
    if (APP_STATE.hours < 0) APP_STATE.hours = 0;
    if (APP_STATE.minutes < 0) APP_STATE.minutes = 0;
    
    updateTotalSeconds();
    updateDisplay();
    
    showToast(`تم إضافة ${minutes} دقيقة${minutes !== 1 ? '' : ''}`, 'info');
    saveToLocalStorage();
}

// 2. وظيفة حفظ الوقت الأصلي
function saveOriginalTime() {
    APP_STATE.originalHours = APP_STATE.hours;
    APP_STATE.originalMinutes = APP_STATE.minutes;
    APP_STATE.originalSeconds = APP_STATE.seconds;
    APP_STATE.originalTimeSaved = Date.now();
}

// 3. وظيفة تحديث حساب التخزين
function calculateAndDisplayStorage() {
    try {
        const data = {
            timer: APP_STATE,
            presets: APP_STATE.presets,
            uploadedFonts: APP_STATE.uploadedFonts,
            tasks: APP_STATE.tasks,
            notificationHistory: APP_STATE.notificationHistory
        };
        
        const jsonString = JSON.stringify(data);
        const sizeInBytes = new Blob([jsonString]).size;
        const sizeInMB = sizeInBytes / (1024 * 1024);
        
        const storage = {
            bytes: sizeInBytes,
            mb: parseFloat(sizeInMB.toFixed(2)),
            presets: Object.keys(APP_STATE.presets).length,
            fonts: Object.keys(APP_STATE.uploadedFonts).length,
            tasks: APP_STATE.tasks.length,
            notifications: APP_STATE.notificationHistory.length
        };
        
        // تحديث العرض
        if (elements.storageUsedValue) {
            elements.storageUsedValue.textContent = `${storage.mb.toFixed(2)} MB`;
            elements.storagePresetsValue.textContent = storage.presets;
            elements.storageFontsValue.textContent = storage.fonts;
            
            // حساب النسبة المئوية
            const maxStorageMB = 50;
            const percentage = Math.min((storage.mb / maxStorageMB) * 100, 100);
            elements.storageProgressFill.style.width = `${percentage}%`;
            elements.storagePercentage.textContent = `${percentage.toFixed(1)}%`;
        }
        
        return storage;
    } catch (error) {
        console.error('Error calculating storage:', error);
        return { bytes: 0, mb: 0, presets: 0, fonts: 0, tasks: 0, notifications: 0 };
    }
}

// 4. نظام الصوت المفقود
let audioContext = null;

function getAudioContext() {
    if (!audioContext && APP_STATE.audioEnabled) {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (error) {
            console.error('Audio context not supported:', error);
        }
    }
    return audioContext;
}

function playSound(type) {
    if (!APP_STATE.audioEnabled) return;
    
    const context = getAudioContext();
    if (!context) return;
    
    try {
        const oscillator = context.createOscillator();
        const gainNode = context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(context.destination);
        
        let frequency = 800;
        let duration = 0.1;
        let volume = 0.3;
        
        switch(type) {
            case 'click':
                frequency = 800;
                duration = 0.05;
                break;
            case 'tick':
                frequency = 1000;
                duration = 0.05;
                break;
            case 'notification':
                frequency = 1200;
                duration = 0.2;
                volume = 0.5;
                break;
        }
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, context.currentTime);
        gainNode.gain.linearRampToValueAtTime(volume, context.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + duration);
        
        oscillator.start(context.currentTime);
        oscillator.stop(context.currentTime + duration);
        
    } catch (error) {
        console.error('Error playing sound:', error);
    }
}

function toggleSound() {
    APP_STATE.audioEnabled = !APP_STATE.audioEnabled;
    
    if (APP_STATE.audioEnabled) {
        // تهيئة الصوت عند التفعيل
        getAudioContext();
        
        elements.soundIcon.className = 'fas fa-volume-up text-lg';
        elements.soundText.textContent = 'SOUND ON';
        showToast('الصوت مفعل', 'success');
        
        // اختبار الصوت
        setTimeout(() => playSound('notification'), 100);
    } else {
        elements.soundIcon.className = 'fas fa-volume-mute text-lg';
        elements.soundText.textContent = 'SOUND OFF';
        showToast('الصوت معطل', 'info');
    }
    
    saveToLocalStorage();
}

// 5. وظيفة التنظيف التلقائي
function checkAutoCleanup() {
    if (!APP_STATE.lastCleanupDate || 
        Date.now() - APP_STATE.lastCleanupDate > (APP_STATE.settings.cleanupDays * 24 * 60 * 60 * 1000)) {
        
        performAutoCleanup();
    }
}

function performAutoCleanup() {
    const cutoffDate = Date.now() - (APP_STATE.settings.cleanupDays * 24 * 60 * 60 * 1000);
    let cleanedCount = 0;
    
    // تنظيف البريسيتات القديمة
    Object.keys(APP_STATE.presets).forEach(key => {
        if (APP_STATE.presets[key].timestamp && APP_STATE.presets[key].timestamp < cutoffDate) {
            delete APP_STATE.presets[key];
            cleanedCount++;
        }
    });
    
    // تنظيف تاريخ الإشعارات
    APP_STATE.notificationHistory = APP_STATE.notificationHistory.filter(notification => {
        const notificationDate = new Date(notification.date).getTime();
        return notificationDate > cutoffDate;
    });
    
    // تنظيف المهام المكتملة القديمة
    APP_STATE.tasks = APP_STATE.tasks.filter(task => {
        if (task.completed) {
            const taskDate = new Date(task.date).getTime();
            return taskDate > cutoffDate;
        }
        return true;
    });
    
    APP_STATE.lastCleanupDate = Date.now();
    
    if (cleanedCount > 0) {
        saveToLocalStorage();
        updateTasksList();
        updateNotificationHistory();
        updatePresetList();
        calculateAndDisplayStorage();
        
        showToast(`تم تنظيف ${cleanedCount} عنصر قديم تلقائياً`, 'info');
    }
}



// 7. وظائف الإعدادات المفقودة
function toggleOutline() {
    elements.outlineToggle.classList.toggle('active');
    APP_STATE.settings.outlineEnabled = elements.outlineToggle.classList.contains('active');
}

function toggleMedia() {
    elements.mediaToggle.classList.toggle('active');
    APP_STATE.settings.mediaEnabled = elements.mediaToggle.classList.contains('active');
}

function toggleMediaAudio() {
    elements.mediaAudioToggle.classList.toggle('active');
    APP_STATE.settings.mediaAudioEnabled = elements.mediaAudioToggle.classList.contains('active');
}

function toggleAudio() {
    elements.audioToggle.classList.toggle('active');
    APP_STATE.settings.audioEnabled = elements.audioToggle.classList.contains('active');
}

function toggleLoop() {
    elements.loopToggle.classList.toggle('active');
    APP_STATE.settings.audioLoop = elements.loopToggle.classList.contains('active');
}

function toggleTickSound() {
    elements.tickToggle.classList.toggle('active');
    APP_STATE.settings.tickSound = elements.tickToggle.classList.contains('active');
}

function toggleFinishSound() {
    elements.finishSoundToggle.classList.toggle('active');
    APP_STATE.settings.finishSoundEnabled = elements.finishSoundToggle.classList.contains('active');
}

function toggleClickSound() {
    elements.clickSoundToggle.classList.toggle('active');
    APP_STATE.settings.clickSound = elements.clickSoundToggle.classList.contains('active');
}

function toggleWarningSound() {
    elements.warningSoundToggle.classList.toggle('active');
    APP_STATE.settings.warningSoundEnabled = elements.warningSoundToggle.classList.contains('active');
}

// 8. تحديث وظيفة التهيئة
function initializeAppEnhanced() {
    // تحديث كل شيء عند التحميل
    setTimeout(() => {
        // تحديث عرض التخزين
        calculateAndDisplayStorage();
        
        // التحقق من التنظيف التلقائي
        checkAutoCleanup();
        
        // تأكيد تهيئة الصوت
        if (APP_STATE.audioEnabled) {
            getAudioContext();
        }
        
        // رسالة ترحيب
        setTimeout(() => {
            showToast('ProTimer جاهز للاستخدام!', 'success');
        }, 1000);
    }, 2000);
}

// تشغيل التهيئة المحسنة
setTimeout(initializeAppEnhanced, 1000);
// ============================================
// TOUCH AND CLICK HANDLING - FIX DOUBLE TAP
// ============================================
// 2. القفل الميكانيكي (يستبدل الـ setInterval القديم)
// هذا الجزء سيجعل الواجهة "تختفي من الوجود" برمجياً لو الإعداد OFF
setInterval(() => {
    const overlay = document.getElementById('keyboardInputOverlay');
    if (!overlay) return;

    const isOff = window.APP_STATE?.settings?.doubleTapEnabled === false;

    if (isOff) {
        // إخفاء إجباري بكل الطرق الممكنة لمنع "العناد" البرمجي
        overlay.style.cssText = "display: none !important; opacity: 0 !important; pointer-events: none !important; visibility: hidden !important;";
    } else {
        // لو ON: بنشيل القيود عشان الكود الأصلي يظهرها لما يحتاج
        if (overlay.style.opacity === "0") {
            overlay.style.cssText = "";
        }
    }
}, 50);


// ابدأ مراقبة جسم الصفحة بالكامل
timeInputObserver.observe(document.body, { 
    attributes: true, 
    childList: true, 
    subtree: true, 
    attributeFilter: ['style', 'class'] 
});
// 1. مراقبة شاملة لأي عنصر جديد يضاف للصفحة
const globalObserver = new MutationObserver((mutations) => {
    const isOff = window.APP_STATE?.settings?.doubleTapEnabled === false;
    
    if (isOff) {
        // قائمة بكل الكلمات اللي ممكن تكون مستخدمة في الكود الأصلي بتاعك للواجهة
        const forbiddenSelectors = [
            '#keyboardInputOverlay', 
            '[id*="keyboard"]', 
            '[class*="manual-input"]', 
            '[id*="ManualInput"]',
            '.modal-overlay' // لو الواجهة بتستخدم كلاس عام
        ];

        forbiddenSelectors.forEach(selector => {
            document.querySelectorAll(selector).forEach(el => {
                el.style.display = 'none';
                el.remove(); // احذفه تماماً من الصفحة لو ظهر
            });
        });
    }
});

globalObserver.observe(document.documentElement, { 
    childList: true, 
    subtree: true 
});


// شغل الربط
initCleanListeners();
// إغلاق الإدخال اليدوي
function closeKeyboardInput() {
    elements.keyboardInputOverlay.classList.add('hidden');
}

// تطبيق الوقت اليدوي
function applyManualTime() {
    const timeString = elements.manualTimeInput.value.trim();
    const timeRegex = /^(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
    
    if (!timeRegex.test(timeString)) {
        showToast('صيغة وقت غير صحيحة. استخدم HH:MM:SS', 'error');
        return;
    }
    
    const matches = timeString.match(timeRegex);
    const hours = parseInt(matches[1]);
    const minutes = parseInt(matches[2]);
    const seconds = parseInt(matches[3]);
    
    saveOriginalTime();
    APP_STATE.hours = hours;
    APP_STATE.minutes = minutes;
    APP_STATE.seconds = seconds;
    
    updateTotalSeconds();
    updateDisplay();
    closeKeyboardInput();
    
    showToast(`تم تعيين الوقت لـ ${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`, 'success');
}

// تعيين وقت يدوي سريع
function setManualTime(timeString) {
    elements.manualTimeInput.value = timeString;
    setTimeout(() => applyManualTime(), 100);
}
</script>
<script>
(function() {
    let globalLock = false; // منع تكرار الأحداث على العناصر نفسها

})();
// ============================================
// KEYBOARD SHORTCUTS - ONE KEY PER ACTION
// ============================================

document.addEventListener('keydown', function(e) {
    // متسمعش لما المستخدم بيطبع في حقل
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
    }
    
    const key = e.key.toLowerCase();
    const keyCode = e.code;
    
    // === SPACE (تشغيل/إيقاف) ===
    if (key === ' ' || keyCode === 'Space') {
        e.preventDefault();
        toggleTimer();
        return;
    }
    
    // === R (إعادة تعيين) ===
    if (keyCode === 'KeyR' || key === 'r') {
        e.preventDefault();
        confirmReset();
        return;
    }
    
    // === + (إضافة دقيقة) ===
    if (key === '+' || key === '=' || keyCode === 'Equal' || keyCode === 'NumpadAdd') {
        e.preventDefault();
        addMinutes(1);
        return;
    }
    
    // === - (طرح دقيقة) ===
    if (key === '-' || key === '_' || keyCode === 'Minus' || keyCode === 'NumpadSubtract') {
        e.preventDefault();
        addMinutes(-1);
        return;
    }
    
    // === H (المساعدة) ===
    if (keyCode === 'KeyH' || key === 'h') {
        e.preventDefault();
        toggleShortcutsHelp();
        return;
    }
    
    // === F (وضع التركيز) ===
    if (keyCode === 'KeyF' || key === 'f') {
        e.preventDefault();
        toggleFocusMode();
        return;
    }
    
    // === T (المهام) ===
    if (keyCode === 'KeyT' || key === 't') {
        e.preventDefault();
        toggleQuickTasks();
        return;
    }
    
    // === P (تشغيل/إيقاف بديل) ===
    if (keyCode === 'KeyP' || key === 'p') {
        e.preventDefault();
        toggleTimer();
        return;
    }
    
    // === A (إضافة دقيقة بديل) ===
    if (keyCode === 'KeyA' || key === 'a') {
        e.preventDefault();
        addMinutes(1);
        return;
    }
    
    // === S (طرح دقيقة بديل) ===
    if (keyCode === 'KeyS' || key === 's') {
        if (!e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            addMinutes(-1);
        }
        return;
    }
    
    // === D (المطورين) ===
    if (keyCode === 'KeyD' || key === 'd') {
        e.preventDefault();
        if (elements.settingsPanel) {
            toggleSettings();
            setTimeout(() => {
                switchTab('advanced');
            }, 300);
        }
        return;
    }
    
    // === M (الوسائط) ===
    if (keyCode === 'KeyM' || key === 'm') {
        e.preventDefault();
        if (elements.settingsPanel) {
            toggleSettings();
            setTimeout(() => {
                switchTab('media');
            }, 300);
        }
        return;
    }
    
    // === N (الإشعارات) ===
    if (keyCode === 'KeyN' || key === 'n') {
        e.preventDefault();
        if (elements.settingsPanel) {
            toggleSettings();
            setTimeout(() => {
                switchTab('notifications');
            }, 300);
        }
        return;
    }
    
    // === Z (التخزين) ===
    if (keyCode === 'KeyZ' || key === 'z') {
        e.preventDefault();
        if (elements.settingsPanel) {
            toggleSettings();
            setTimeout(() => {
                switchTab('storage');
            }, 300);
        }
        return;
    }
    
    // === C (الألوان) ===
    if (keyCode === 'KeyC' || key === 'c') {
        if (!e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            if (elements.settingsPanel) {
                toggleSettings();
                setTimeout(() => {
                    switchTab('appearance');
                }, 300);
            }
        }
        return;
    }
    
    // === L (قفل الشاشة) ===
    if (keyCode === 'KeyL' || key === 'l') {
        e.preventDefault();
        if (elements.wakeLockToggle) {
            toggleWakeLock();
        }
        return;
    }
    
    // === V (الاهتزاز) ===
    if (keyCode === 'KeyV' || key === 'v') {
        e.preventDefault();
        if (elements.vibrateToggle) {
            toggleVibrate();
        }
        return;
    }
    
    // === ESC (إغلاق النوافذ) ===
    if (key === 'escape' || key === 'esc' || keyCode === 'Escape') {
        e.preventDefault();
        
        if (elements.settingsPanel && !elements.settingsPanel.classList.contains('translate-x-full')) {
            toggleSettings();
        }
        
        if (elements.quickTasksPanel && elements.quickTasksPanel.classList.contains('show')) {
            toggleQuickTasks();
        }
        
        if (elements.keyboardInputOverlay && !elements.keyboardInputOverlay.classList.contains('hidden')) {
            closeKeyboardInput();
        }
        
        return;
    }
    
    // === F11 (ملء الشاشة) ===
    if (key === 'f11' || keyCode === 'F11') {
        e.preventDefault();
        toggleFullscreen();
        return;
    }
    
    // === : (الإدخال اليدوي) ===
    if (key === ':' || key === ';' || keyCode === 'Semicolon' || keyCode === 'Colon') {
        e.preventDefault();
        openKeyboardInput('hours');
        return;
    }
    
    // === الأرقام 1-9 (ضبط سريع) ===
    if (keyCode.includes('Digit') || keyCode.includes('Numpad')) {
        e.preventDefault();
        
        let minutes = 0;
        
        if (keyCode.includes('Digit')) {
            minutes = parseInt(keyCode.replace('Digit', ''));
        } else if (keyCode.includes('Numpad')) {
            minutes = parseInt(keyCode.replace('Numpad', ''));
        }
        
        if (minutes > 0 && minutes <= 9) {
            setQuickPreset(minutes);
        }
        return;
    }
    
    // === الأرقام من لوحة المفاتيح ===
    if (key >= '1' && key <= '9') {
        e.preventDefault();
        const minutes = parseInt(key);
        if (minutes > 0) {
            setQuickPreset(minutes);
        }
        return;
    }
    
    // === Ctrl+S (حفظ) ===
    if ((e.ctrlKey || e.metaKey) && (keyCode === 'KeyS' || key === 's')) {
        e.preventDefault();
        savePreset();
        return;
    }
    
    // === Ctrl+O (فتح الإعدادات) ===
    if ((e.ctrlKey || e.metaKey) && (keyCode === 'KeyO' || key === 'o')) {
        e.preventDefault();
        toggleSettings();
        return;
    }
    
    // === Ctrl+I (الإدخال اليدوي) ===
    if ((e.ctrlKey || e.metaKey) && (keyCode === 'KeyI' || key === 'i')) {
        e.preventDefault();
        openKeyboardInput('hours');
        return;
    }
});

// ============================================
// اختصارات Ctrl + رقم لأوقات أطول
// ============================================

document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    if (e.ctrlKey || e.metaKey) {
        const key = e.key;
        const keyCode = e.code;
        
        // Ctrl+1 = 10 دقائق
        if (key === '1' || keyCode === 'Digit1' || keyCode === 'Numpad1') {
            e.preventDefault();
            setQuickPreset(10);
            return;
        }
        
        // Ctrl+2 = 15 دقائق
        if (key === '2' || keyCode === 'Digit2' || keyCode === 'Numpad2') {
            e.preventDefault();
            setQuickPreset(15);
            return;
        }
        
        // Ctrl+3 = 30 دقائق
        if (key === '3' || keyCode === 'Digit3' || keyCode === 'Numpad3') {
            e.preventDefault();
            setQuickPreset(30);
            return;
        }
        
        // Ctrl+4 = 60 دقيقة
        if (key === '4' || keyCode === 'Digit4' || keyCode === 'Numpad4') {
            e.preventDefault();
            setQuickPreset(60);
            return;
        }
        
        // Ctrl+5 = 90 دقيقة
        if (key === '5' || keyCode === 'Digit5' || keyCode === 'Numpad5') {
            e.preventDefault();
            setQuickPreset(90);
            return;
        }
        
        // Ctrl+6 = 120 دقيقة
        if (key === '6' || keyCode === 'Digit6' || keyCode === 'Numpad6') {
            e.preventDefault();
            setQuickPreset(120);
            return;
        }
    }
});
// ============================================
// SYSTEM TIME UPDATER
// ============================================

function updateCurrentTime() {
    if (!elements.currentTime) return;
    
    const now = new Date();
    
    // الصيغة 12 ساعة مع AM/PM
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    
    // تحويل لـ 12 ساعة
    hours = hours % 12;
    hours = hours ? hours : 12; // الساعة 0 تصبح 12
    
    const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;
    elements.currentTime.textContent = timeString;
}

// تحديث الوقت كل ثانية
setInterval(updateCurrentTime, 1000);

// تحديث مباشر عند التحميل
updateCurrentTime();

// إذا دالة updateMediaPreview مش موجودة
if (typeof window.updateMediaPreview === 'undefined') {
    window.updateMediaPreview = function() {
        if (APP_STATE.settings.mediaUrl) {
            if (APP_STATE.settings.mediaType === 'video') {
                elements.mediaPreview.innerHTML = `
                    <video class="w-full h-full object-cover rounded-lg" controls muted>
                        <source src="${APP_STATE.settings.mediaUrl}" type="video/mp4">
                    </video>
                `;
            } else {
                elements.mediaPreview.innerHTML = `
                    <img src="${APP_STATE.settings.mediaUrl}" alt="Preview" class="w-full h-full object-cover rounded-lg">
                `;
            }
        } else {
            elements.mediaPreview.innerHTML = `
                <div class="text-center p-4">
                    <i class="fas fa-image text-4xl opacity-30 mb-2"></i>
                    <p class="opacity-50">لم يتم اختيار وسائط</p>
                </div>
            `;
        }
    };
}
// ============================================
// COMPLETE SAVING SYSTEM - SAVE EVERYTHING
// ============================================

// دالة حفظ كاملة
function saveAllSettings() {
    try {
        const saveData = {
            // حالة التايمر
            timerState: {
                hours: APP_STATE.hours,
                minutes: APP_STATE.minutes,
                seconds: APP_STATE.seconds,
                originalHours: APP_STATE.originalHours,
                originalMinutes: APP_STATE.originalMinutes,
                originalSeconds: APP_STATE.originalSeconds,
                totalSeconds: APP_STATE.totalSeconds,
                remainingSeconds: APP_STATE.remainingSeconds,
                isRunning: APP_STATE.isRunning,
                isPaused: APP_STATE.isPaused,
                isFinished: APP_STATE.isFinished
            },
            
            // كل الإعدادات
            settings: APP_STATE.settings,
            
            // الفيديوهات والصور (بمعلوماتها)
            mediaData: {
                mediaUrl: APP_STATE.settings.mediaUrl,
                mediaType: APP_STATE.settings.mediaType,
                mediaEnabled: APP_STATE.settings.mediaEnabled
            },
            
            // المهام
            tasks: APP_STATE.tasks,
            
            // البريسيتات
            presets: APP_STATE.presets,
            
            // الخطوط
            uploadedFonts: APP_STATE.uploadedFonts,
            currentFont: APP_STATE.currentFont,
            
            // تاريخ الإشعارات
            notificationHistory: APP_STATE.notificationHistory,
            
            // حالات خاصة
            focusMode: APP_STATE.focusMode,
            audioEnabled: APP_STATE.audioEnabled,
            
            // معلومات النسخة
            version: '2.2.0',
            lastSave: new Date().toISOString()
        };
        
        // تحويل لـ JSON
        const jsonData = JSON.stringify(saveData);
        
        // حفظ في localStorage
        localStorage.setItem('proTimerCompleteData', jsonData);
        
        console.log('✅ All settings saved successfully');
        return true;
        
    } catch (error) {
        console.error('❌ Save error:', error);
        showToast('خطأ في الحفظ، تأكد من المساحة', 'error');
        return false;
    }
}

// دالة تحميل كاملة
function loadAllSettings() {
    try {
        const saved = localStorage.getItem('proTimerCompleteData');
        if (!saved) {
            console.log('No saved data found');
            return false;
        }
        
        const data = JSON.parse(saved);
        
        // حالة التايمر
        if (data.timerState) {
            APP_STATE.hours = data.timerState.hours || 0;
            APP_STATE.minutes = data.timerState.minutes || 10;
            APP_STATE.seconds = data.timerState.seconds || 0;
            APP_STATE.originalHours = data.timerState.originalHours || APP_STATE.hours;
            APP_STATE.originalMinutes = data.timerState.originalMinutes || APP_STATE.minutes;
            APP_STATE.originalSeconds = data.timerState.originalSeconds || APP_STATE.seconds;
            APP_STATE.totalSeconds = data.timerState.totalSeconds || calculateTotalSeconds();
            APP_STATE.remainingSeconds = data.timerState.remainingSeconds || APP_STATE.totalSeconds;
            APP_STATE.isRunning = data.timerState.isRunning || false;
            APP_STATE.isPaused = data.timerState.isPaused || false;
            APP_STATE.isFinished = data.timerState.isFinished || false;
        }
        
        // الإعدادات
        if (data.settings) {
            APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
        }
        
        // المهام
        if (data.tasks) {
            APP_STATE.tasks = data.tasks;
        }
        
        // البريسيتات
        if (data.presets) {
            APP_STATE.presets = data.presets;
        }
        
        // الخطوط
        if (data.uploadedFonts) {
            APP_STATE.uploadedFonts = data.uploadedFonts;
        }
        
        if (data.currentFont) {
            APP_STATE.currentFont = data.currentFont;
        }
        
        // تاريخ الإشعارات
        if (data.notificationHistory) {
            APP_STATE.notificationHistory = data.notificationHistory;
        }
        
        // حالات خاصة
        if (data.focusMode !== undefined) {
            APP_STATE.focusMode = data.focusMode;
        }
        
        if (data.audioEnabled !== undefined) {
            APP_STATE.audioEnabled = data.audioEnabled;
        }
        
        // تطبيق كل التحديثات
        updateDisplay();
        updateSettingsUI();
        updateTasksList();
        updateNotificationHistory();
        updatePresetList();
        updateUploadedFontsList();
        
        // خاص بالفيديو - تأخير التحميل
        setTimeout(() => {
            if (data.mediaData && data.mediaData.mediaEnabled && data.mediaData.mediaUrl) {
                // تحميل الفيديو/الصورة
                APP_STATE.settings.mediaUrl = data.mediaData.mediaUrl;
                APP_STATE.settings.mediaType = data.mediaData.mediaType;
                APP_STATE.settings.mediaEnabled = data.mediaData.mediaEnabled;
                
                // تحديث واجهة الإعدادات
                if (elements.mediaUrl) {
                    elements.mediaUrl.value = data.mediaData.mediaUrl;
                }
                if (elements.mediaToggle) {
                    elements.mediaToggle.classList.toggle('active', data.mediaData.mediaEnabled);
                }
                
                // تشغيل الفيديو لو كان فيديو
                if (data.mediaData.mediaType === 'video' && data.mediaData.mediaUrl) {
                    setTimeout(() => {
                        playVideoBackground(data.mediaData.mediaUrl);
                    }, 1000);
                } else if (data.mediaData.mediaType === 'image') {
                    // تحميل الصورة
                    updateBackground();
                }
            }
            
            // تطبيق الإعدادات
            applySettings();
        }, 500);
        
        console.log('✅ All settings loaded successfully');
        return true;
        
    } catch (error) {
        console.error('❌ Load error:', error);
        return false;
    }
}

// ============================================
// نظام حفظ تلقائي ذكي
// ============================================

let autoSaveTimeout = null;
let lastSaveState = '';

// دالة حفظ ذكي (تحفظ بس لو فيه تغيير)
function smartSave() {
    // إلغاء أي حفظ قادم
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
    }
    
    // حفظ بعد 2 ثانية (لتجميع التغييرات)
    autoSaveTimeout = setTimeout(() => {
        // مقارنة مع آخر حالة
        const currentState = JSON.stringify({
            timer: APP_STATE,
            settings: APP_STATE.settings,
            mediaUrl: APP_STATE.settings.mediaUrl
        });
        
        // إذا فيه تغيير، احفظ
        if (currentState !== lastSaveState) {
            saveAllSettings();
            lastSaveState = currentState;
        }
    }, 2000);
}

// إضافة مستمعات للحفظ التلقائي
function setupAutoSaveListeners() {
    // مستمعات للحقول
    const inputElements = document.querySelectorAll('input, select, textarea, .toggle-switch');
    inputElements.forEach(element => {
        element.addEventListener('change', smartSave);
        element.addEventListener('input', smartSave);
    });
    
    // مستمعات للأزرار
    const buttonElements = document.querySelectorAll('button');
    buttonElements.forEach(button => {
        if (!button.id.includes('installPWA')) {
            button.addEventListener('click', smartSave);
        }
    });
    
    // مستمعات للتايمر
    const timerActions = ['toggleTimer', 'confirmReset', 'addMinutes', 'setQuickPreset'];
    timerActions.forEach(action => {
        const original = window[action];
        if (original) {
            window[action] = function(...args) {
                const result = original.apply(this, args);
                setTimeout(smartSave, 100);
                return result;
            };
        }
    });
    
    // حفظ عند إغلاق الصفحة
    window.addEventListener('beforeunload', function() {
        saveAllSettings();
    });
    
    // حفظ كل دقيقة (سفيتي)
    setInterval(() => {
        smartSave();
    }, 60000);
    
    console.log('✅ Auto-save system activated');
}

// ============================================
// استعادة الفيديو الكبيرة (Blob Storage)
// ============================================

// دالة خاصة لحفظ الفيديوهات الكبيرة
function saveLargeVideo() {
    if (!APP_STATE.settings.mediaUrl || APP_STATE.settings.mediaType !== 'video') return;
    
    // إذا الفيديو رابط خارجي (URL)، مش لازم نخزنه
    if (APP_STATE.settings.mediaUrl.startsWith('http') || APP_STATE.settings.mediaUrl.startsWith('https')) {
        console.log('External video URL, skipping local storage');
        return;
    }
    
    // إذا الفيديو Base64 (من رفع ملف)، نخزنه في IndexedDB
    if (APP_STATE.settings.mediaUrl.startsWith('data:video/')) {
        try {
            const videoKey = 'current_video_' + Date.now();
            
            // تخزين المفتاح فقط
            localStorage.setItem('videoReferenceKey', videoKey);
            localStorage.setItem('videoReference', APP_STATE.settings.mediaUrl.substring(0, 100));
            
            console.log('✅ Video reference saved');
        } catch (error) {
            console.warn('Could not save video locally:', error);
        }
    }
}

// ============================================
// استعادة من نسخ قديمة
// ============================================

function migrateOldData() {
    // محاولة تحميل من النسخ القديمة
    const oldKeys = [
        'proTimerEnhancedData',
        'proTimerData',
        'timerSettings',
        'mediaSettings'
    ];
    
    oldKeys.forEach(key => {
        const oldData = localStorage.getItem(key);
        if (oldData) {
            try {
                const data = JSON.parse(oldData);
                console.log(`Found old data in ${key}, migrating...`);
                
                // دمج مع البيانات الحالية
                if (data.settings) {
                    APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
                }
                
                if (data.timer) {
                    APP_STATE.hours = data.timer.hours || APP_STATE.hours;
                    APP_STATE.minutes = data.timer.minutes || APP_STATE.minutes;
                    APP_STATE.seconds = data.timer.seconds || APP_STATE.seconds;
                }
                
                // حفظ البيانات المدمجة
                saveAllSettings();
                
                // مسح القديم
                localStorage.removeItem(key);
                
            } catch (error) {
                console.error('Migration error:', error);
            }
        }
    });
}

// ============================================
// بدء النظام
// ============================================

// تشغيل عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // هجرة البيانات القديمة
    setTimeout(migrateOldData, 500);
    
    // تحميل الإعدادات
    setTimeout(() => {
        const loaded = loadAllSettings();
        
        if (loaded) {
            console.log('✅ Settings loaded from previous session');
            
            // رسالة للمستخدم
            setTimeout(() => {
                showToast('تم استعادة الإعدادات السابقة', 'success');
                
                // إذا كان فيه فيديو محفوظ
                if (APP_STATE.settings.mediaEnabled && APP_STATE.settings.mediaUrl) {
                    setTimeout(() => {
                        if (APP_STATE.settings.mediaType === 'video') {
                            showToast('جاري استعادة الفيديو الخلفية...', 'info');
                        }
                    }, 1000);
                }
            }, 1000);
            
        } else {
            console.log('No previous settings found, using defaults');
        }
        
        // تفعيل نظام الحفظ التلقائي
        setTimeout(setupAutoSaveListeners, 2000);
        
    }, 1000);
});

// ============================================
// أزرار يدوية للحفظ والاستعادة
// ============================================

// إضافة أزرار في واجهة الإعدادات
setTimeout(() => {
    const advancedTab = document.querySelector('[data-tab-content="advanced"]');
    if (advancedTab) {
        const saveButtons = `
            <div class="card">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-save"></i> التحكم في الحفظ
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="forceSaveNow()" class="btn-secondary touch-feedback">
                            <i class="fas fa-save mr-2"></i> حفظ الآن
                        </button>
                        <button onclick="loadAllSettings()" class="btn-secondary touch-feedback">
                            <i class="fas fa-undo mr-2"></i> استعادة
                        </button>
                    </div>
                    <button onclick="exportAllData()" class="btn-secondary w-full touch-feedback">
                        <i class="fas fa-download mr-2"></i> تصدير جميع البيانات
                    </button>
                    <button onclick="clearAllDataConfirm()" class="btn-secondary w-full text-red-300 border-red-500/30 touch-feedback">
                        <i class="fas fa-trash-alt mr-2"></i> مسح كل البيانات
                    </button>
                    <div class="text-xs opacity-60 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        يتم الحفظ تلقائياً عند أي تغيير
                    </div>
                </div>
            </div>
        `;
        
        // البحث عن مكان مناسب للإضافة
        const existingCards = advancedTab.querySelectorAll('.card');
        if (existingCards.length > 1) {
            existingCards[existingCards.length - 1].insertAdjacentHTML('afterend', saveButtons);
        }
    }
}, 3000);

// دالة الحفظ القسري
function forceSaveNow() {
    if (saveAllSettings()) {
        showToast('تم حفظ جميع الإعدادات', 'success');
    }
}

// دالة تصدير كل البيانات
function exportAllData() {
    saveAllSettings();
    
    const data = localStorage.getItem('proTimerCompleteData');
    if (!data) {
        showToast('لا توجد بيانات للتصدير', 'warning');
        return;
    }
    
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `protimer-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('تم تصدير جميع البيانات', 'success');
}

// تأكيد مسح البيانات
function clearAllDataConfirm() {
    Swal.fire({
        title: 'مسح كل البيانات؟',
        text: 'هذا سيمسح جميع الإعدادات، المهام، البريسيتات، والوسائط! لا يمكن التراجع عن هذا!',
        icon: 'warning',
        background: '#0f172a',
        color: '#f8fafc',
        showCancelButton: true,
        confirmButtonText: 'نعم، امسح الكل!',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280'
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.clear();
            APP_STATE.tasks = [];
            APP_STATE.presets = {};
            APP_STATE.uploadedFonts = {};
            APP_STATE.notificationHistory = [];
            APP_STATE.settings.mediaUrl = '';
            APP_STATE.settings.mediaEnabled = false;
            
            location.reload();
        }
    });
}
</script>
<script>
// ============================================
// ENHANCED FLASH & SOUND SYSTEM - FIXED
// ============================================

// نظام الوميض النهائي - إصلاح كامل
let flashInterval = null;
let tickSoundInterval = null;

function startFlashAndTick(secondsLeft) {
    if (!APP_STATE.settings.flashEnabled && !APP_STATE.settings.tickSound) return;
    
    console.log(`⚡ تفعيل الوميض والتنبيه لـ ${secondsLeft} ثانية متبقية`);
    
    // تنظيف أي فترات سابقة
    stopFlashAndTick();
    
    let counter = secondsLeft;
    
    flashInterval = setInterval(() => {
        if (counter <= 0) {
            stopFlashAndTick();
            return;
        }
        
        // ⚡ الوميض (إذا مفعل في الإعدادات)
        if (APP_STATE.settings.flashEnabled) {
            document.body.classList.toggle('flash-red');
            
            // إزالة الوميض بعد 200ms
            setTimeout(() => {
                document.body.classList.remove('flash-red');
            }, 200);
        }
        
        // 🔊 صوت التنبيه (إذا مفعل في الإعدادات)
        if (APP_STATE.settings.tickSound && APP_STATE.audioEnabled) {
            playTickSound(counter);
        }
        
        counter--;
    }, 1000);
}

function stopFlashAndTick() {
    if (flashInterval) {
        clearInterval(flashInterval);
        flashInterval = null;
    }
    if (tickSoundInterval) {
        clearInterval(tickSoundInterval);
        tickSoundInterval = null;
    }
    document.body.classList.remove('flash-red');
}

function playTickSound(counter) {
    try {
        // أصوات مختلفة حسب العد التنازلي
        let frequency = 800;
        let duration = 0.1;
        
        if (counter <= 3) {
            frequency = 1200; // صوت عالي للأخيرة
            duration = 0.2;
        } else if (counter <= 6) {
            frequency = 1000; // صوت متوسط
            duration = 0.15;
        }
        
        // إنشاء صوت
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + duration);
        
    } catch (e) {
        console.log("🎵 استخدام الصوت البديل للتنبيه");
    }
}

// ربط النظام بالمؤقت
const originalStartTimer = window.startTimer;
window.startTimer = function() {
    if (originalStartTimer) originalStartTimer();
    
    // بدء مراقبة الـ 10 ثواني الأخيرة
    const checkInterval = setInterval(() => {
        if (APP_STATE.isRunning && APP_STATE.remainingSeconds <= 10 && APP_STATE.remainingSeconds > 0) {
            startFlashAndTick(APP_STATE.remainingSeconds);
            clearInterval(checkInterval);
        }
        
        if (!APP_STATE.isRunning) {
            clearInterval(checkInterval);
            stopFlashAndTick();
        }
    }, 100);
};

// ============================================
// ENHANCED BACKGROUND TIMER - FIXED
// ============================================

// تتبع الوقت في الخلفية
let backgroundStartTime = 0;
let backgroundElapsed = 0;

// عند تحويل الصفحة للخلفية
document.addEventListener('visibilitychange', function() {
    if (APP_STATE.isRunning) {
        if (document.hidden) {
            // حفظ وقت البدء
            backgroundStartTime = Date.now();
            console.log('⏱️ المؤقت مستمر في الخلفية...');
            
            // إشعار بسيط
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('⏱️ ProTimer', {
                    body: 'المؤقت مستمر في العمل في الخلفية',
                    icon: '/icons/icon-192x192.png',
                    silent: true
                });
            }
        } else {
            // حساب الوقت المنقضي في الخلفية
            if (backgroundStartTime > 0) {
                backgroundElapsed = Math.floor((Date.now() - backgroundStartTime) / 1000);
                backgroundStartTime = 0;
                
                // تحديث الوقت المتبقي
                if (APP_STATE.remainingSeconds > backgroundElapsed) {
                    APP_STATE.remainingSeconds -= backgroundElapsed;
                    
                    // تحديث العرض
                    const hours = Math.floor(APP_STATE.remainingSeconds / 3600);
                    const minutes = Math.floor((APP_STATE.remainingSeconds % 3600) / 60);
                    const seconds = APP_STATE.remainingSeconds % 60;
                    
                    APP_STATE.hours = hours;
                    APP_STATE.minutes = minutes;
                    APP_STATE.seconds = seconds;
                    
                    updateDisplay();
                    console.log(`🔄 تم تحديث المؤقت بعد ${backgroundElapsed} ثانية في الخلفية`);
                }
            }
        }
    }
});

// استمرار المؤقت حتى إذا أغلقت الصفحة
window.addEventListener('beforeunload', function(e) {
    if (APP_STATE.isRunning) {
        // يمكنك حفظ حالة المؤقت هنا
        localStorage.setItem('timerRunning', JSON.stringify({
            remaining: APP_STATE.remainingSeconds,
            timestamp: Date.now()
        }));
    }
});

// ============================================
// FOCUS MODE ENHANCEMENT - NO DISTRACTIONS
// ============================================

// Focus Mode الحقيقي - بدون إشعارات
const originalEnableFocusMode = window.enableFocusMode;
window.enableFocusMode = function() {
    // استدعاء الوظيفة الأصلية أولاً
    if (originalEnableFocusMode) originalEnableFocusMode();
    
    // إخفاء كل الإشعارات
    hideAllNotifications();
    
    // تعطيل أي إشعارات مستقبلية
    disableNotificationsInFocusMode();
    
    console.log("🎯 وضع التركيز: تم إخفاء جميع الإشعارات");
};

function hideAllNotifications() {
    // إخفاء كل الإشعارات المرئية
    document.querySelectorAll('.swal2-container, .toast, .notification').forEach(el => {
        el.style.display = 'none';
        el.remove();
    });
    
    // إخفاء لوحة المهام
    const tasksPanel = document.getElementById('quickTasksPanel');
    if (tasksPanel) tasksPanel.style.display = 'none';
}

function disableNotificationsInFocusMode() {
    // حفظ الإعدادات الأصلية
    const originalNotifications = APP_STATE.settings.notificationsEnabled;
    const originalSounds = APP_STATE.settings.notificationSoundEnabled;
    
    // تعطيل مؤقت
    APP_STATE.settings.notificationsEnabled = false;
    APP_STATE.settings.notificationSoundEnabled = false;
    
    // استعادة عند الخروج من Focus Mode
    const originalDisableFocusMode = window.disableFocusMode;
    window.disableFocusMode = function() {
        if (originalDisableFocusMode) originalDisableFocusMode();
        APP_STATE.settings.notificationsEnabled = originalNotifications;
        APP_STATE.settings.notificationSoundEnabled = originalSounds;
    };
}

// ============================================
// ENHANCED TIMER FUNCTIONS - FIXED
// ============================================

// إصلاح مشكلة إيقاف المؤقت
const originalToggleTimer = window.toggleTimer;
window.toggleTimer = function() {
    const wasRunning = APP_STATE.isRunning;
    
    if (originalToggleTimer) originalToggleTimer();
    
    // إيقاف الوميض والصوت عند إيقاف المؤقت
    if (wasRunning && !APP_STATE.isRunning) {
        stopFlashAndTick();
    }
};

// CSS للوميض
const flashStyle = document.createElement('style');
flashStyle.textContent = `
    @keyframes flash-red {
        0%, 100% { background-color: transparent; }
        50% { background-color: rgba(239, 68, 68, 0.3); }
    }
    
    .flash-red {
        animation: flash-red 0.5s infinite alternate;
    }
`;
document.head.appendChild(flashStyle);

// ============================================
// INITIALIZATION - SIMPLIFIED
// ============================================

// تهيئة مبسطة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    console.log("🚀 ProTimer المحسن جاهز للعمل!");
    
    // إشعار ترحيبي بسيط
    setTimeout(() => {
        if (!localStorage.getItem('proTimer_welcomed_v2')) {
            Swal.fire({
                title: '🎯 ProTimer المحسن',
                html: `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 20px; margin-bottom: 15px;">بكل بساطة:</div>
                        <div>• ⚡ وميض وصوت في آخر 10 ثواني</div>
                        <div>• 🎯 وضع تركيز حقيقي (بدون إشعارات)</div>
                        <div>• ⏱️ استمرار المؤقت في الخلفية</div>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'ابدأ الآن',
                background: '#0f172a',
                color: '#f8fafc',
                timer: 3000
            });
            localStorage.setItem('proTimer_welcomed_v2', 'true');
        }
    }, 1000);
    
    // استعادة المؤقت إذا كان يعمل قبل إغلاق الصفحة
    const savedTimer = localStorage.getItem('timerRunning');
    if (savedTimer) {
        try {
            const data = JSON.parse(savedTimer);
            const elapsed = Math.floor((Date.now() - data.timestamp) / 1000);
            
            if (data.remaining > elapsed) {
                const remaining = data.remaining - elapsed;
                
                // ضبط الوقت
                APP_STATE.hours = Math.floor(remaining / 3600);
                APP_STATE.minutes = Math.floor((remaining % 3600) / 60);
                APP_STATE.seconds = remaining % 60;
                APP_STATE.totalSeconds = remaining;
                APP_STATE.remainingSeconds = remaining;
                
                // بدء المؤقت
                setTimeout(() => {
                    startTimer();
                    showToast('🔄 تم استعادة المؤقت من الخلفية', 'info');
                }, 1000);
            }
            
            localStorage.removeItem('timerRunning');
        } catch (e) {
            console.error("❌ خطأ في استعادة المؤقت:", e);
        }
    }
});

// ============================================
// AUTO-SAVE ENHANCEMENT
// ============================================

// حفظ عند إغلاق الصفحة
window.addEventListener('beforeunload', function() {
    // حفظ حالة المؤقت إذا كان يعمل
    if (APP_STATE.isRunning) {
        localStorage.setItem('timerRunning', JSON.stringify({
            remaining: APP_STATE.remainingSeconds,
            timestamp: Date.now()
        }));
    }
});

console.log("✨ ProTimer Enhanced System Loaded Successfully!");
</script>


</script>
<!-- ============================================ -->
<!-- COMPLETE RIGHT-CLICK & TASKS SYSTEM -->
<!-- ============================================ -->

<!-- Right-Click Context Menu -->
<div id="contextMenu" class="fixed hidden z-[9999] glass-dark rounded-xl p-2 shadow-2xl border border-white/10 min-w-[200px]">
    <div class="menu-section mb-2">
        <div class="menu-header text-xs uppercase opacity-50 px-2 py-1">Timer Controls</div>
        <button onclick="toggleTimer()" class="menu-item">
            <i class="fas fa-play mr-2 text-green-400"></i>
            <span>Start/Pause</span>
            <span class="menu-shortcut">Space</span>
        </button>
        <button onclick="confirmReset()" class="menu-item">
            <i class="fas fa-redo mr-2 text-yellow-400"></i>
            <span>Reset Timer</span>
            <span class="menu-shortcut">R</span>
        </button>
        <button onclick="addMinutes(1)" class="menu-item">
            <i class="fas fa-plus mr-2 text-blue-400"></i>
            <span>Add 1 Minute</span>
            <span class="menu-shortcut">+</span>
        </button>
    </div>
    
    <div class="menu-section mb-2">
        <div class="menu-header text-xs uppercase opacity-50 px-2 py-1">Quick Actions</div>
        <button onclick="toggleFocusMode()" class="menu-item">
            <i class="fas fa-eye mr-2 text-purple-400"></i>
            <span>Focus Mode</span>
            <span class="menu-shortcut">F</span>
        </button>
        <button onclick="toggleFullscreen()" class="menu-item">
            <i class="fas fa-expand mr-2 text-indigo-400"></i>
            <span>Fullscreen</span>
            <span class="menu-shortcut">F11</span>
        </button>
        <button onclick="toggleSettings()" class="menu-item">
            <i class="fas fa-cog mr-2 text-gray-400"></i>
            <span>Settings</span>
            <span class="menu-shortcut">Ctrl+O</span>
        </button>
    </div>
    
    <div class="menu-section">
        <div class="menu-header text-xs uppercase opacity-50 px-2 py-1">Stats</div>
        <button onclick="toggleStatsPanel()" class="menu-item">
            <i class="fas fa-chart-line mr-2 text-green-400"></i>
            <span>Show Stats</span>
        </button>
        <button onclick="exportAllData()" class="menu-item">
            <i class="fas fa-download mr-2 text-blue-400"></i>
            <span>Export All Data</span>
        </button>
    </div>
</div>

<!-- Stats Widget Button -->
<div id="timerStatsWidget" class="fixed bottom-28 left-4 z-40 animate-fade-in">
    <button onclick="toggleStatsPanel()" class="timer-stats-btn glass rounded-full p-3 shadow-lg touch-feedback">
        <i class="fas fa-history text-xl"></i>
    </button>
    <div class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center animate-pulse" id="liveTimerBadge" style="display: none;">
        <i class="fas fa-play"></i>
    </div>
</div>

<!-- Draggable Stats Panel -->
<div id="timerStatsPanel" class="fixed z-50 glass-dark rounded-2xl p-4 shadow-2xl hidden animate-slide-up draggable-panel" style="width: 320px; top: 150px; left: 20px;">
    <div class="panel-header flex justify-between items-center mb-4 cursor-move" id="statsPanelDragHandle">
        <h3 class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-chart-line"></i>
            <span>سجل التايمر الحي</span>
            <span id="liveStatus" class="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded-full hidden">
                <i class="fas fa-circle animate-pulse-slow"></i> مباشر
            </span>
        </h3>
        <button onclick="toggleStatsPanel()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors touch-feedback">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Live Timer Section -->
    <div id="liveTimerSection" class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-xl p-3 mb-4 border border-blue-500/20 hidden">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <i class="fas fa-running text-blue-400"></i>
                <span class="text-sm font-medium">تايمر يعمل الآن</span>
            </div>
            <div id="currentSessionTime" class="font-mono font-bold text-lg">00:00:00</div>
        </div>
        <div class="text-xs opacity-70">يتم الحساب تلقائياً...</div>
        <div class="mt-2 flex gap-2">
            <button onclick="pauseLiveTracking()" class="btn-secondary text-xs px-2 py-1 flex-1">
                <i class="fas fa-pause mr-1"></i> إيقاف مؤقت
            </button>
            <button onclick="endCurrentSession()" class="btn-primary text-xs px-2 py-1 flex-1">
                <i class="fas fa-stop mr-1"></i> إنهاء الجلسة
            </button>
        </div>
    </div>
    
    <!-- Stats Overview -->
    <div id="statsOverview" class="space-y-4 mb-4">
        <!-- Today Stats -->
        <div class="bg-white/5 rounded-xl p-3">
            <h4 class="text-sm font-medium mb-2 flex items-center gap-2">
                <i class="fas fa-calendar-day text-blue-400"></i>
                <span>اليوم</span>
                <span class="text-xs opacity-60" id="currentDate"></span>
            </h4>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div>
                    <div class="text-2xl font-bold" id="todayHours">0</div>
                    <div class="text-xs opacity-60">ساعات</div>
                </div>
                <div>
                    <div class="text-2xl font-bold" id="todayMinutes">0</div>
                    <div class="text-xs opacity-60">دقائق</div>
                </div>
                <div>
                    <div class="text-2xl font-bold" id="todaySessionsCount">0</div>
                    <div class="text-xs opacity-60">جلسة</div>
                </div>
            </div>
            <div class="mt-2 text-center text-xs opacity-70" id="todaySeconds">0 ثانية</div>
        </div>
        
        <!-- Total Stats -->
        <div class="bg-white/5 rounded-xl p-3">
            <h4 class="text-sm font-medium mb-2 flex items-center gap-2">
                <i class="fas fa-chart-bar text-green-400"></i>
                <span>الإجمالي</span>
            </h4>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div>
                    <div class="text-2xl font-bold" id="totalHours">0</div>
                    <div class="text-xs opacity-60">ساعات</div>
                </div>
                <div>
                    <div class="text-2xl font-bold" id="totalMinutes">0</div>
                    <div class="text-xs opacity-60">دقائق</div>
                </div>
                <div>
                    <div class="text-2xl font-bold" id="totalSessions">0</div>
                    <div class="text-xs opacity-60">جلسة</div>
                </div>
            </div>
            <div class="mt-2 text-center text-xs opacity-70">
                بدء التسجيل: <span id="firstRecordDate">-</span>
            </div>
        </div>
        
        <!-- Best Session -->
        <div class="bg-white/5 rounded-xl p-3">
            <h4 class="text-sm font-medium mb-2 flex items-center gap-2">
                <i class="fas fa-trophy text-yellow-400"></i>
                <span>أفضل جلسة</span>
            </h4>
            <div id="bestSession" class="text-center">
                <div class="text-lg font-bold" id="bestSessionTime">00:00:00</div>
                <div class="text-xs opacity-70" id="bestSessionDate">-</div>
            </div>
        </div>
    </div>
    
    <!-- Sessions History -->
    <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
            <h4 class="text-sm font-medium">الجلسات الأخيرة</h4>
            <div class="flex gap-1">
                <button onclick="exportSessionsData()" class="text-xs btn-secondary px-2 py-1 touch-feedback">
                    <i class="fas fa-download"></i>
                </button>
                <button onclick="refreshSessions()" class="text-xs btn-secondary px-2 py-1 touch-feedback">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div id="sessionsList" class="space-y-2 max-h-48 overflow-y-auto">
            <div class="text-center py-4 opacity-50">
                <i class="fas fa-clock text-2xl mb-2"></i>
                <p>لا توجد جلسات مسجلة</p>
            </div>
        </div>
    </div>
    
    <!-- Stats Controls -->
    <div class="flex gap-2">
        <button onclick="clearTodaySessions()" class="btn-secondary flex-1 text-sm touch-feedback">
            <i class="fas fa-broom mr-1"></i> مسح اليوم
        </button>
        <button onclick="clearAllSessions()" class="btn-secondary flex-1 text-sm text-red-300 border-red-500/30 touch-feedback">
            <i class="fas fa-trash-alt mr-1"></i> مسح الكل
        </button>
    </div>
    
    <!-- Panel Footer -->
    <div class="mt-3 text-xs opacity-50 text-center panel-footer">
        <i class="fas fa-arrows-alt mr-1"></i>
        اسحب العنوان لتحريك اللوحة
    </div>
</div>

<!-- Quick Tasks Panel -->
<div id="quickTasksPanel" class="quick-tasks-panel">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">📝 المهام السريعة</h3>
        <button onclick="toggleQuickTasks()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors touch-feedback">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Add New Task -->
    <div class="mb-4">
        <div class="flex gap-2">
            <input type="text" id="newTaskInput" placeholder="اكتب مهمة جديدة..." class="input-field flex-1 text-sm" onkeypress="handleTaskInputKeyPress(event)">
            <button onclick="addNewTask()" class="btn-primary px-4 py-2 text-sm touch-feedback">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <div class="flex gap-2 mt-2">
            <button onclick="addQuickTask('قراءة')" class="btn-secondary text-xs px-3 py-1 flex-1 touch-feedback">
                قراءة
            </button>
            <button onclick="addQuickTask('دراسة')" class="btn-secondary text-xs px-3 py-1 flex-1 touch-feedback">
                دراسة
            </button>
            <button onclick="addQuickTask('عمل')" class="btn-secondary text-xs px-3 py-1 flex-1 touch-feedback">
                عمل
            </button>
        </div>
    </div>
    
    <!-- Tasks List -->
    <div id="tasksList" class="flex-1 overflow-y-auto max-h-60">
        <div class="text-center py-8 opacity-50">
            <i class="fas fa-tasks text-3xl mb-3"></i>
            <p>لا توجد مهام بعد</p>
            <p class="text-sm mt-2">أضف مهام لتتبع أنشطتك</p>
        </div>
    </div>
    
    <!-- Tasks Footer -->
    <div class="tasks-footer mt-4">
        <div class="flex justify-between items-center text-sm opacity-70">
            <span id="tasksCount">0 مهام</span>
            <div class="flex gap-2">
                <button onclick="clearCompletedTasks()" class="text-red-300 hover:text-red-400 touch-feedback text-xs">
                    مسح المكتملة
                </button>
                <button onclick="exportTasks()" class="text-blue-300 hover:text-blue-400 touch-feedback text-xs">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
        <div class="mt-2 text-xs opacity-50 text-center">
            <i class="fas fa-info-circle mr-1"></i>
            اضغط على المهمة لتحديدها كمنتهية
        </div>
    </div>
</div>

<style>
/* Context Menu Styles */
#contextMenu {
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    animation: fadeIn 0.15s ease-out;
}

.menu-section {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.menu-section:last-child {
    border-bottom: none;
}

.menu-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    color: white;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    font-size: 14px;
}

.menu-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(2px);
}

.menu-item:active {
    transform: translateX(0) scale(0.98);
}

.menu-shortcut {
    font-size: 11px;
    opacity: 0.5;
    font-family: 'JetBrains Mono', monospace;
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 10px;
}

.menu-header {
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* Hide original tasks button */
#quickTasksBtn {
    display: none !important;
}

/* Stats Panel Styles */
body.focus-mode #timerStatsWidget,
body.focus-mode #timerStatsPanel {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* Draggable Panel Styles */
.draggable-panel {
    position: fixed;
    z-index: 1000;
    cursor: default;
    user-select: none;
    transition: transform 0.1s ease-out;
}

.draggable-panel.dragging {
    cursor: grabbing !important;
    user-select: none;
    opacity: 0.9;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    z-index: 1001 !important;
}

.panel-header {
    padding: 8px 12px;
    margin: -12px -12px 12px -12px;
    border-radius: 12px 12px 0 0;
    background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    cursor: move;
    user-select: none;
}

.panel-header:hover {
    background: linear-gradient(90deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
}

.panel-footer {
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 10px;
}

/* Stats Widget */
.timer-stats-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    animation: pulse 2s infinite;
    border: 2px solid rgba(255, 255, 255, 0.3);
    position: relative;
    cursor: pointer;
}

.timer-stats-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
}

.timer-stats-btn.live {
    background: linear-gradient(135deg, #10b981, #059669);
    animation: pulse-glow 1s infinite;
}

@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
    50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.8); }
}

/* Session Items */
.session-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.session-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
}

.session-item.active {
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
}

.session-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.session-time {
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
}

.session-date {
    font-size: 11px;
    opacity: 0.7;
}

.session-duration {
    font-size: 12px;
    opacity: 0.8;
}

.session-progress {
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 5px;
}

.session-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    border-radius: 2px;
}

/* Prevent context menu on timer digits */
.time-value {
    user-select: none;
}

/* Close outside click overlay */
.panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 999;
    background: transparent;
    display: none;
}

.panel-overlay.active {
    display: block;
}

/* Live badge */
#liveTimerBadge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    font-size: 10px;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: none;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255, 255, 255, 0.3);
    animation: pulse 1.5s infinite;
}

/* Ensure everything is saved properly */
.autosave-notice {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #10b981;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 11px;
    z-index: 1000;
    animation: fadeInOut 2s ease-in-out;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translateY(10px); }
    20%, 80% { opacity: 1; transform: translateY(0); }
}

/* Quick Tasks Panel */
.quick-tasks-panel {
    position: fixed;
    bottom: 100px;
    right: 20px;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 20px;
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 100;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    display: none;
    flex-direction: column;
    gap: 12px;
}

.quick-tasks-panel.show {
    display: flex;
    animation: slideUp 0.3s ease-out;
}

.task-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
    cursor: pointer;
    margin-bottom: 8px;
}

.task-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
}

.task-item.completed {
    opacity: 0.6;
    text-decoration: line-through;
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.2);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.task-title {
    font-weight: 600;
    font-size: 0.95rem;
    flex: 1;
}

.task-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-left: 8px;
}

.task-description {
    font-size: 0.85rem;
    opacity: 0.8;
    line-height: 1.4;
    margin-top: 5px;
}

.task-actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
}

.task-action-btn {
    padding: 4px 8px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 4px;
}

.task-action-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.task-action-btn.complete {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.task-action-btn.complete:hover {
    background: rgba(16, 185, 129, 0.3);
}

.task-action-btn.delete {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.task-action-btn.delete:hover {
    background: rgba(239, 68, 68, 0.3);
}

.task-priority {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
    margin-left: 6px;
}

.priority-high {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.priority-medium {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.priority-low {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.tasks-footer {
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Hide tasks in focus mode */
body.focus-mode #quickTasksPanel,
body.focus-mode #quickTasksBtn {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}
</style>

<script>
// ============================================
// COMPLETE AUTO-SAVE SYSTEM FOR ALL SETTINGS
// ============================================

const AUTO_SAVE = {
    enabled: true,
    interval: 5000,
    lastSave: 0,
    timeout: null
};

// Initialize complete auto-save system
function initializeAutoSaveSystem() {
    console.log("💾 تهيئة نظام الحفظ التلقائي...");
    
    // Load all data on startup
    loadAllData();
    
    // Start auto-save interval
    startAutoSaveInterval();
    
    // Save on page unload
    setupUnloadSave();
    
    console.log("✅ نظام الحفظ التلقائي جاهز");
}

// Load all data from localStorage
function loadAllData() {
    try {
        console.log("📂 جاري تحميل جميع البيانات...");
        
        // 1. Load timer state
        const timerData = localStorage.getItem('proTimerState');
        if (timerData) {
            const data = JSON.parse(timerData);
            if (data.timer) {
                APP_STATE.hours = data.timer.hours || 0;
                APP_STATE.minutes = data.timer.minutes || 10;
                APP_STATE.seconds = data.timer.seconds || 0;
                APP_STATE.originalHours = data.timer.originalHours || APP_STATE.hours;
                APP_STATE.originalMinutes = data.timer.originalMinutes || APP_STATE.minutes;
                APP_STATE.originalSeconds = data.timer.originalSeconds || APP_STATE.seconds;
                APP_STATE.totalSeconds = data.timer.totalSeconds || calculateTotalSeconds();
                APP_STATE.remainingSeconds = data.timer.remainingSeconds || APP_STATE.totalSeconds;
                APP_STATE.isRunning = data.timer.isRunning || false;
                APP_STATE.isPaused = data.timer.isPaused || false;
                APP_STATE.isFinished = data.timer.isFinished || false;
            }
        }
        
        // 2. Load settings
        const settingsData = localStorage.getItem('proTimerSettings');
        if (settingsData) {
            const data = JSON.parse(settingsData);
            APP_STATE.settings = { ...APP_STATE.settings, ...data };
        }
        
        // 3. Load media settings
        const mediaData = localStorage.getItem('proTimerMedia');
        if (mediaData) {
            const data = JSON.parse(mediaData);
            APP_STATE.settings.mediaUrl = data.mediaUrl || '';
            APP_STATE.settings.mediaType = data.mediaType || '';
            APP_STATE.settings.mediaEnabled = data.mediaEnabled || false;
            APP_STATE.settings.mediaOpacity = data.mediaOpacity || 30;
        }
        
        // 4. Load audio settings
        const audioData = localStorage.getItem('proTimerAudio');
        if (audioData) {
            const data = JSON.parse(audioData);
            APP_STATE.settings.audioEnabled = data.audioEnabled || false;
            APP_STATE.settings.audioUrl = data.audioUrl || '';
            APP_STATE.settings.audioVolume = data.audioVolume || 50;
            APP_STATE.audioEnabled = data.audioEnabled || false;
        }
        
        // 5. Load stats data
        const statsData = localStorage.getItem('proTimerStats');
        if (statsData) {
            LIVE_TIMER.sessions = JSON.parse(statsData).sessions || [];
            LIVE_TIMER.totalSeconds = JSON.parse(statsData).totalSeconds || 0;
            LIVE_TIMER.totalSessions = JSON.parse(statsData).totalSessions || 0;
            LIVE_TIMER.bestSession = JSON.parse(statsData).bestSession || { seconds: 0, time: "00:00:00", date: null };
        }
        
        // Apply all loaded settings
        updateDisplay();
        updateSettingsUI();
        applySettings();
        
    } catch (error) {
        console.error("❌ خطأ في تحميل البيانات:", error);
    }
}

// Save all data to localStorage
function saveAllData() {
    if (!AUTO_SAVE.enabled) return;
    
    try {
        const now = Date.now();
        if (now - AUTO_SAVE.lastSave < 1000) return;
        
        // 1. Save timer state
        const timerState = {
            timer: {
                hours: APP_STATE.hours,
                minutes: APP_STATE.minutes,
                seconds: APP_STATE.seconds,
                originalHours: APP_STATE.originalHours,
                originalMinutes: APP_STATE.originalMinutes,
                originalSeconds: APP_STATE.originalSeconds,
                totalSeconds: APP_STATE.totalSeconds,
                remainingSeconds: APP_STATE.remainingSeconds,
                isRunning: APP_STATE.isRunning,
                isPaused: APP_STATE.isPaused,
                isFinished: APP_STATE.isFinished
            },
            timestamp: now
        };
        localStorage.setItem('proTimerState', JSON.stringify(timerState));
        
        // 2. Save settings
        localStorage.setItem('proTimerSettings', JSON.stringify(APP_STATE.settings));
        
        // 3. Save media settings
        const mediaSettings = {
            mediaUrl: APP_STATE.settings.mediaUrl,
            mediaType: APP_STATE.settings.mediaType,
            mediaEnabled: APP_STATE.settings.mediaEnabled,
            mediaOpacity: APP_STATE.settings.mediaOpacity
        };
        localStorage.setItem('proTimerMedia', JSON.stringify(mediaSettings));
        
        // 4. Save audio settings
        const audioSettings = {
            audioEnabled: APP_STATE.settings.audioEnabled,
            audioUrl: APP_STATE.settings.audioUrl,
            audioVolume: APP_STATE.settings.audioVolume
        };
        localStorage.setItem('proTimerAudio', JSON.stringify(audioSettings));
        
        // 5. Save stats data
        const statsData = {
            sessions: LIVE_TIMER.sessions || [],
            totalSeconds: LIVE_TIMER.totalSeconds || 0,
            totalSessions: LIVE_TIMER.totalSessions || 0,
            bestSession: LIVE_TIMER.bestSession || { seconds: 0, time: "00:00:00", date: null }
        };
        localStorage.setItem('proTimerStats', JSON.stringify(statsData));
        
        AUTO_SAVE.lastSave = now;
        
    } catch (error) {
        console.error("❌ خطأ في حفظ البيانات:", error);
    }
}

// Start auto-save interval
function startAutoSaveInterval() {
    if (AUTO_SAVE.timeout) {
        clearInterval(AUTO_SAVE.timeout);
    }
    
    AUTO_SAVE.timeout = setInterval(() => {
        saveAllData();
    }, AUTO_SAVE.interval);
}

// Setup save on page unload
function setupUnloadSave() {
    window.addEventListener('beforeunload', () => {
        saveAllData();
        return null;
    });
    
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            saveAllData();
        }
    });
}

// Export all data function
function exportAllData() {
    try {
        const exportData = {
            app: 'ProTimer',
            version: '2.2.0',
            exportDate: new Date().toISOString(),
            
            timerState: JSON.parse(localStorage.getItem('proTimerState') || '{}'),
            settings: JSON.parse(localStorage.getItem('proTimerSettings') || '{}'),
            mediaSettings: JSON.parse(localStorage.getItem('proTimerMedia') || '{}'),
            audioSettings: JSON.parse(localStorage.getItem('proTimerAudio') || '{}'),
            statsData: JSON.parse(localStorage.getItem('proTimerStats') || '{}'),
            
            currentTime: new Date().toLocaleString()
        };
        
        const jsonString = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `protimer-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('تم تصدير جميع البيانات بنجاح', 'success');
        
    } catch (error) {
        console.error("❌ خطأ في تصدير البيانات:", error);
        showToast('خطأ في تصدير البيانات', 'error');
    }
}

// ============================================
// RIGHT-CLICK CONTEXT MENU
// ============================================

function initializeContextMenu() {
    console.log("🖱️ تهيئة قائمة النقر بزر الماوس الأيمن...");
    
    const contextMenu = document.getElementById('contextMenu');
    
    // Show on right-click EXCEPT on timer digits
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        
        // DON'T show context menu on timer digits
        if (e.target.closest('.time-value') || 
            e.target.closest('.time-unit') ||
            e.target.closest('.timer-digits-container')) {
            return;
        }
        
        // Don't show on input fields
        if (e.target.tagName === 'INPUT' || 
            e.target.tagName === 'TEXTAREA' ||
            e.target.isContentEditable) {
            return;
        }
        
        // Show context menu
        contextMenu.style.display = 'block';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        
        // Adjust position if goes off screen
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            contextMenu.style.left = (e.pageX - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            contextMenu.style.top = (e.pageY - rect.height) + 'px';
        }
    });
    
    // Hide on click anywhere
    document.addEventListener('click', function() {
        contextMenu.style.display = 'none';
    });
    
    // Hide on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            contextMenu.style.display = 'none';
        }
    });
    
    // Prevent context menu from closing when clicking inside it
    contextMenu.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    console.log("✅ قائمة النقر بزر الماوس الأيمن جاهزة");
}

// ============================================
// LIVE TIMER TRACKING SYSTEM
// ============================================

const LIVE_TIMER = {
    isTracking: false,
    isPaused: false,
    startTime: null,
    pausedTime: 0,
    elapsedSeconds: 0,
    currentSession: null,
    sessions: [],
    sessionHistory: [],
    totalSeconds: 0,
    totalSessions: 0,
    firstRecordDate: null,
    today: {
        date: new Date().toLocaleDateString('ar-EG'),
        totalSeconds: 0,
        sessions: 0
    },
    bestSession: {
        seconds: 0,
        time: "00:00:00",
        date: null
    },
    updateInterval: null,
    panelPosition: { x: 20, y: 150 }
};

// Initialize live timer system
function initializeLiveTimer() {
    console.log("⏱️ تهيئة نظام التتبع الحي...");
    
    // Load saved data
    loadLiveTimerData();
    
    // Initialize draggable panel
    initializeDraggablePanel();
    
    // Update today's date
    updateTodayDate();
    
    // Update display
    updateLiveStatsDisplay();
    updateSessionsHistory();
    
    // Start update interval
    startUpdateInterval();
    
    // Integrate with main timer
    integrateWithMainTimer();
    
    console.log("✅ نظام التتبع الحي جاهز");
}

// Load live timer data
function loadLiveTimerData() {
    try {
        const savedData = localStorage.getItem('proTimerLiveData');
        if (savedData) {
            const data = JSON.parse(savedData);
            
            if (data.sessions) {
                LIVE_TIMER.sessions = data.sessions;
                LIVE_TIMER.sessionHistory = data.sessions.slice(0, 20);
            }
            
            if (data.totalSeconds) LIVE_TIMER.totalSeconds = data.totalSeconds;
            if (data.totalSessions) LIVE_TIMER.totalSessions = data.totalSessions;
            if (data.firstRecordDate) LIVE_TIMER.firstRecordDate = data.firstRecordDate;
            
            if (data.today) {
                const todayDate = new Date().toLocaleDateString('ar-EG');
                if (data.today.date === todayDate) {
                    LIVE_TIMER.today = data.today;
                } else {
                    LIVE_TIMER.today = {
                        date: todayDate,
                        totalSeconds: 0,
                        sessions: 0
                    };
                }
            }
            
            if (data.bestSession) {
                LIVE_TIMER.bestSession = data.bestSession;
            }
            
            console.log(`📊 تم تحميل ${LIVE_TIMER.sessions.length} جلسة`);
        }
    } catch (error) {
        console.error("❌ خطأ في تحميل بيانات التتبع:", error);
    }
}

// Save live timer data
function saveLiveTimerData() {
    try {
        const saveData = {
            sessions: LIVE_TIMER.sessions,
            totalSeconds: LIVE_TIMER.totalSeconds,
            totalSessions: LIVE_TIMER.totalSessions,
            firstRecordDate: LIVE_TIMER.firstRecordDate,
            today: LIVE_TIMER.today,
            bestSession: LIVE_TIMER.bestSession,
            lastUpdate: new Date().toISOString()
        };
        
        localStorage.setItem('proTimerLiveData', JSON.stringify(saveData));
    } catch (error) {
        console.error("❌ خطأ في حفظ بيانات التتبع:", error);
    }
}

// Start live tracking
function startLiveTracking() {
    if (LIVE_TIMER.isTracking || !APP_STATE.isRunning) return;
    
    LIVE_TIMER.isTracking = true;
    LIVE_TIMER.isPaused = false;
    LIVE_TIMER.startTime = Date.now();
    LIVE_TIMER.pausedTime = 0;
    LIVE_TIMER.elapsedSeconds = 0;
    
    LIVE_TIMER.currentSession = {
        id: Date.now(),
        startTime: LIVE_TIMER.startTime,
        endTime: null,
        elapsedSeconds: 0,
        isActive: true
    };
    
    updateLiveUI();
    showLiveTimerBadge();
}

// Pause live tracking
function pauseLiveTracking() {
    if (!LIVE_TIMER.isTracking || LIVE_TIMER.isPaused) return;
    
    LIVE_TIMER.isPaused = true;
    LIVE_TIMER.currentSession.isPaused = true;
    LIVE_TIMER.currentSession.pauseStart = Date.now();
    
    updateLiveUI();
}

// End current session
function endCurrentSession() {
    if (!LIVE_TIMER.isTracking) return;
    
    const endTime = Date.now();
    const totalDuration = endTime - LIVE_TIMER.startTime - LIVE_TIMER.pausedTime;
    const elapsedSeconds = Math.floor(totalDuration / 1000);
    
    LIVE_TIMER.currentSession.endTime = endTime;
    LIVE_TIMER.currentSession.elapsedSeconds = elapsedSeconds;
    LIVE_TIMER.currentSession.isActive = false;
    
    saveCurrentSession();
    resetLiveTracking();
    updateLiveUI();
    hideLiveTimerBadge();
}

// Save current session
function saveCurrentSession() {
    if (!LIVE_TIMER.currentSession) return;
    
    const session = LIVE_TIMER.currentSession;
    const elapsedSeconds = session.elapsedSeconds;
    
    if (elapsedSeconds === 0) return;
    
    const now = new Date();
    const formattedDate = now.toLocaleDateString('ar-EG');
    const formattedTime = now.toLocaleTimeString('ar-EG', { 
        hour12: true, 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const hours = Math.floor(elapsedSeconds / 3600);
    const minutes = Math.floor((elapsedSeconds % 3600) / 60);
    const seconds = elapsedSeconds % 60;
    
    const sessionRecord = {
        id: session.id,
        date: now.toISOString(),
        displayDate: formattedDate,
        displayTime: formattedTime,
        hours: hours,
        minutes: minutes,
        seconds: seconds,
        totalSeconds: elapsedSeconds,
        duration: `${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`
    };
    
    LIVE_TIMER.sessions.unshift(sessionRecord);
    LIVE_TIMER.sessionHistory.unshift(sessionRecord);
    
    if (LIVE_TIMER.sessionHistory.length > 20) {
        LIVE_TIMER.sessionHistory.pop();
    }
    
    LIVE_TIMER.totalSeconds += elapsedSeconds;
    LIVE_TIMER.totalSessions++;
    
    if (!LIVE_TIMER.firstRecordDate) {
        LIVE_TIMER.firstRecordDate = sessionRecord.date;
    }
    
    const todayDate = new Date().toLocaleDateString('ar-EG');
    if (LIVE_TIMER.today.date === todayDate) {
        LIVE_TIMER.today.totalSeconds += elapsedSeconds;
        LIVE_TIMER.today.sessions++;
    } else {
        LIVE_TIMER.today = {
            date: todayDate,
            totalSeconds: elapsedSeconds,
            sessions: 1
        };
    }
    
    if (elapsedSeconds > LIVE_TIMER.bestSession.seconds) {
        LIVE_TIMER.bestSession = {
            seconds: elapsedSeconds,
            time: sessionRecord.duration,
            date: formattedDate
        };
    }
    
    saveLiveTimerData();
    updateLiveStatsDisplay();
    updateSessionsHistory();
}

// Reset live tracking
function resetLiveTracking() {
    LIVE_TIMER.isTracking = false;
    LIVE_TIMER.isPaused = false;
    LIVE_TIMER.startTime = null;
    LIVE_TIMER.pausedTime = 0;
    LIVE_TIMER.elapsedSeconds = 0;
    LIVE_TIMER.currentSession = null;
}

// Update live UI
function updateLiveUI() {
    const statsBtn = document.querySelector('.timer-stats-btn');
    const liveBadge = document.getElementById('liveTimerBadge');
    const liveStatus = document.getElementById('liveStatus');
    const liveTimerSection = document.getElementById('liveTimerSection');
    
    if (LIVE_TIMER.isTracking) {
        if (statsBtn) {
            if (LIVE_TIMER.isPaused) {
                statsBtn.classList.add('bg-yellow-500/20');
                statsBtn.classList.remove('live');
            } else {
                statsBtn.classList.add('live');
                statsBtn.classList.remove('bg-yellow-500/20');
            }
        }
        
        if (liveBadge) {
            liveBadge.style.display = 'flex';
            liveBadge.innerHTML = LIVE_TIMER.isPaused ? 
                '<i class="fas fa-pause"></i>' : 
                '<i class="fas fa-play"></i>';
        }
        
        if (liveStatus) {
            liveStatus.classList.remove('hidden');
            liveStatus.innerHTML = LIVE_TIMER.isPaused ?
                '<i class="fas fa-pause"></i> متوقف' :
                '<i class="fas fa-circle animate-pulse-slow"></i> مباشر';
        }
        
        if (liveTimerSection) {
            liveTimerSection.classList.remove('hidden');
        }
        
    } else {
        if (statsBtn) {
            statsBtn.classList.remove('live', 'bg-yellow-500/20');
        }
        if (liveBadge) liveBadge.style.display = 'none';
        if (liveStatus) liveStatus.classList.add('hidden');
        if (liveTimerSection) liveTimerSection.classList.add('hidden');
    }
}

// Show live timer badge
function showLiveTimerBadge() {
    const badge = document.getElementById('liveTimerBadge');
    if (badge) {
        badge.style.display = 'flex';
        badge.classList.add('animate-pulse');
    }
}

// Hide live timer badge
function hideLiveTimerBadge() {
    const badge = document.getElementById('liveTimerBadge');
    if (badge) {
        badge.style.display = 'none';
        badge.classList.remove('animate-pulse');
    }
}

// Start update interval
function startUpdateInterval() {
    if (LIVE_TIMER.updateInterval) {
        clearInterval(LIVE_TIMER.updateInterval);
    }
    
    LIVE_TIMER.updateInterval = setInterval(() => {
        if (LIVE_TIMER.isTracking && !LIVE_TIMER.isPaused) {
            const currentTime = Date.now();
            const elapsed = currentTime - LIVE_TIMER.startTime - LIVE_TIMER.pausedTime;
            LIVE_TIMER.elapsedSeconds = Math.floor(elapsed / 1000);
            LIVE_TIMER.currentSession.elapsedSeconds = LIVE_TIMER.elapsedSeconds;
            
            updateCurrentSessionDisplay();
        }
    }, 1000);
}

// Update current session display
function updateCurrentSessionDisplay() {
    const currentSessionTime = document.getElementById('currentSessionTime');
    
    if (LIVE_TIMER.isTracking && LIVE_TIMER.currentSession) {
        const elapsedSeconds = LIVE_TIMER.elapsedSeconds;
        const hours = Math.floor(elapsedSeconds / 3600);
        const minutes = Math.floor((elapsedSeconds % 3600) / 60);
        const seconds = elapsedSeconds % 60;
        
        const timeString = `${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`;
        
        if (currentSessionTime) {
            currentSessionTime.textContent = timeString;
        }
    }
}

// Update live stats display
function updateLiveStatsDisplay() {
    updateTodayDate();
    
    const todayHours = Math.floor(LIVE_TIMER.today.totalSeconds / 3600);
    const todayMinutes = Math.floor((LIVE_TIMER.today.totalSeconds % 3600) / 60);
    const todaySeconds = LIVE_TIMER.today.totalSeconds % 60;
    
    if (document.getElementById('todayHours')) {
        document.getElementById('todayHours').textContent = todayHours;
        document.getElementById('todayMinutes').textContent = todayMinutes;
        document.getElementById('todaySessionsCount').textContent = LIVE_TIMER.today.sessions;
        document.getElementById('todaySeconds').textContent = `${todaySeconds} ثانية`;
    }
    
    const totalHours = Math.floor(LIVE_TIMER.totalSeconds / 3600);
    const totalMinutes = Math.floor((LIVE_TIMER.totalSeconds % 3600) / 60);
    
    if (document.getElementById('totalHours')) {
        document.getElementById('totalHours').textContent = totalHours;
        document.getElementById('totalMinutes').textContent = totalMinutes;
        document.getElementById('totalSessions').textContent = LIVE_TIMER.totalSessions;
        
        if (LIVE_TIMER.firstRecordDate) {
            const firstDate = new Date(LIVE_TIMER.firstRecordDate);
            document.getElementById('firstRecordDate').textContent = 
                firstDate.toLocaleDateString('ar-EG');
        }
    }
    
    if (document.getElementById('bestSessionTime')) {
        document.getElementById('bestSessionTime').textContent = LIVE_TIMER.bestSession.time;
        document.getElementById('bestSessionDate').textContent = LIVE_TIMER.bestSession.date || '-';
    }
    
    if (document.getElementById('currentDate')) {
        document.getElementById('currentDate').textContent = 
            new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
    }
}

// Update today's date
function updateTodayDate() {
    const today = new Date().toLocaleDateString('ar-EG');
    
    if (LIVE_TIMER.today.date !== today) {
        LIVE_TIMER.today = {
            date: today,
            totalSeconds: 0,
            sessions: 0
        };
        saveLiveTimerData();
    }
}

// Update sessions history
function updateSessionsHistory() {
    const sessionsList = document.getElementById('sessionsList');
    if (!sessionsList) return;
    
    if (LIVE_TIMER.sessionHistory.length === 0) {
        sessionsList.innerHTML = `
            <div class="text-center py-4 opacity-50">
                <i class="fas fa-clock text-2xl mb-2"></i>
                <p>لا توجد جلسات مسجلة</p>
            </div>
        `;
        return;
    }
    
    const recentSessions = LIVE_TIMER.sessionHistory.slice(0, 10);
    let html = '';
    
    recentSessions.forEach((session, index) => {
        const percentage = LIVE_TIMER.bestSession.seconds > 0 ? 
            (session.totalSeconds / LIVE_TIMER.bestSession.seconds) * 100 : 0;
        
        html += `
            <div class="session-item ${index === 0 ? 'active' : ''}" data-id="${session.id}">
                <div class="session-header">
                    <div class="session-time">${session.duration}</div>
                    <div class="text-xs opacity-60">
                        <span class="session-date">${session.displayDate}</span>
                        <span class="mx-1">•</span>
                        <span class="session-time">${session.displayTime}</span>
                    </div>
                </div>
                <div class="session-duration">
                    ${session.hours > 0 ? `${session.hours} ساعة ` : ''}
                    ${session.minutes > 0 ? `${session.minutes} دقيقة ` : ''}
                    ${session.seconds > 0 ? `${session.seconds} ثانية` : ''}
                    ${index === 0 ? '<span class="session-badge">الأحدث</span>' : ''}
                </div>
                <div class="session-progress">
                    <div class="session-progress-bar" style="width: ${Math.min(percentage, 100)}%"></div>
                </div>
            </div>
        `;
    });
    
    sessionsList.innerHTML = html;
}

// ============================================
// DRAGGABLE PANEL SYSTEM
// ============================================

function initializeDraggablePanel() {
    const panel = document.getElementById('timerStatsPanel');
    const dragHandle = document.getElementById('statsPanelDragHandle');
    
    if (!panel || !dragHandle) return;
    
    loadPanelPosition();
    setupDragEvents(panel, dragHandle);
    setupClickOutsideToClose(panel);
}

function loadPanelPosition() {
    try {
        const saved = localStorage.getItem('statsPanelPosition');
        if (saved) {
            const position = JSON.parse(saved);
            LIVE_TIMER.panelPosition = position;
            
            const panel = document.getElementById('timerStatsPanel');
            if (panel) {
                panel.style.left = `${position.x}px`;
                panel.style.top = `${position.y}px`;
            }
        }
    } catch (error) {
        console.error("❌ خطأ في تحميل موضع اللوحة:", error);
    }
}

function savePanelPosition() {
    try {
        localStorage.setItem('statsPanelPosition', JSON.stringify(LIVE_TIMER.panelPosition));
    } catch (error) {
        console.error("❌ خطأ في حفظ موضع اللوحة:", error);
    }
}

function setupDragEvents(panel, dragHandle) {
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let panelStartX = 0;
    let panelStartY = 0;
    
    dragHandle.addEventListener('mousedown', startDrag);
    dragHandle.addEventListener('touchstart', startDragTouch);
    
    function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        
        const rect = panel.getBoundingClientRect();
        panelStartX = rect.left;
        panelStartY = rect.top;
        
        panel.classList.add('dragging');
        document.body.style.userSelect = 'none';
        
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('mouseup', stopDrag);
    }
    
    function startDragTouch(e) {
        e.preventDefault();
        isDragging = true;
        
        const touch = e.touches[0];
        dragStartX = touch.clientX;
        dragStartY = touch.clientY;
        
        const rect = panel.getBoundingClientRect();
        panelStartX = rect.left;
        panelStartY = rect.top;
        
        panel.classList.add('dragging');
        
        document.addEventListener('touchmove', doDragTouch);
        document.addEventListener('touchend', stopDrag);
    }
    
    function doDrag(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        
        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;
        
        const newX = panelStartX + deltaX;
        const newY = panelStartY + deltaY;
        
        const maxX = window.innerWidth - panel.offsetWidth;
        const maxY = window.innerHeight - panel.offsetHeight;
        
        LIVE_TIMER.panelPosition.x = Math.max(0, Math.min(newX, maxX));
        LIVE_TIMER.panelPosition.y = Math.max(0, Math.min(newY, maxY));
        
        panel.style.left = `${LIVE_TIMER.panelPosition.x}px`;
        panel.style.top = `${LIVE_TIMER.panelPosition.y}px`;
    }
    
    function doDragTouch(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        
        const touch = e.touches[0];
        
        const deltaX = touch.clientX - dragStartX;
        const deltaY = touch.clientY - dragStartY;
        
        const newX = panelStartX + deltaX;
        const newY = panelStartY + deltaY;
        
        const maxX = window.innerWidth - panel.offsetWidth;
        const maxY = window.innerHeight - panel.offsetHeight;
        
        LIVE_TIMER.panelPosition.x = Math.max(0, Math.min(newX, maxX));
        LIVE_TIMER.panelPosition.y = Math.max(0, Math.min(newY, maxY));
        
        panel.style.left = `${LIVE_TIMER.panelPosition.x}px`;
        panel.style.top = `${LIVE_TIMER.panelPosition.y}px`;
    }
    
    function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        panel.classList.remove('dragging');
        document.body.style.userSelect = '';
        
        document.removeEventListener('mousemove', doDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', doDragTouch);
        document.removeEventListener('touchend', stopDrag);
        
        savePanelPosition();
    }
}

function setupClickOutsideToClose(panel) {
    let clickOutsideTimeout = null;
    
    const originalToggleStatsPanel = window.toggleStatsPanel;
    window.toggleStatsPanel = function() {
        originalToggleStatsPanel();
        
        if (!panel.classList.contains('hidden')) {
            const overlay = document.createElement('div');
            overlay.className = 'panel-overlay active';
            overlay.id = 'panelOverlay';
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    toggleStatsPanel();
                }
            });
            
            startAutoCloseTimer();
        } else {
            const overlay = document.getElementById('panelOverlay');
            if (overlay) {
                overlay.remove();
            }
            clearAutoCloseTimer();
        }
    };
    
    function startAutoCloseTimer() {
        clearAutoCloseTimer();
        clickOutsideTimeout = setTimeout(() => {
            if (!panel.classList.contains('hidden')) {
                toggleStatsPanel();
                showToast('تم إغلاق لوحة الإحصائيات تلقائياً', 'info');
            }
        }, 30000);
    }
    
    function clearAutoCloseTimer() {
        if (clickOutsideTimeout) {
            clearTimeout(clickOutsideTimeout);
            clickOutsideTimeout = null;
        }
    }
    
    panel.addEventListener('mousedown', clearAutoCloseTimer);
    panel.addEventListener('touchstart', clearAutoCloseTimer);
    panel.addEventListener('scroll', clearAutoCloseTimer);
    panel.addEventListener('mouseleave', startAutoCloseTimer);
}

// ============================================
// INTEGRATION WITH MAIN TIMER
// ============================================

function integrateWithMainTimer() {
    let lastTimerState = APP_STATE.isRunning;
    
    setInterval(() => {
        if (APP_STATE.isRunning && !lastTimerState) {
            startLiveTracking();
        }
        
        if (!APP_STATE.isRunning && lastTimerState) {
            endCurrentSession();
        }
        
        if (APP_STATE.isFinished) {
            endCurrentSession();
        }
        
        lastTimerState = APP_STATE.isRunning;
        
    }, 1000);
    
    const originalStartTimer = window.startTimer;
    window.startTimer = function() {
        if (originalStartTimer) originalStartTimer();
        startLiveTracking();
    };
    
    const originalPauseTimer = window.pauseTimer;
    window.pauseTimer = function() {
        if (originalPauseTimer) originalPauseTimer();
        pauseLiveTracking();
    };
    
    const originalResetTimer = window.resetTimer;
    window.resetTimer = function() {
        if (originalResetTimer) originalResetTimer();
        endCurrentSession();
    };
}

// ============================================
// UI CONTROLS
// ============================================

function toggleStatsPanel() {
    const panel = document.getElementById('timerStatsPanel');
    if (panel) {
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            panel.classList.add('animate-slide-up');
            updateLiveStatsDisplay();
            updateSessionsHistory();
            updateCurrentSessionDisplay();
        } else {
            panel.classList.add('hidden');
            panel.classList.remove('animate-slide-up');
            
            const overlay = document.getElementById('panelOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
    }
}

function refreshSessions() {
    updateLiveStatsDisplay();
    updateSessionsHistory();
    showToast('تم تحديث الجلسات', 'info');
}

function clearTodaySessions() {
    Swal.fire({
        title: 'مسح جلسات اليوم؟',
        text: 'هل تريد حذف جميع جلسات اليوم؟',
        icon: 'warning',
        background: '#0f172a',
        color: '#f8fafc',
        showCancelButton: true,
        confirmButtonText: 'نعم، امسحها',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280'
    }).then((result) => {
        if (result.isConfirmed) {
            const todayDate = new Date().toLocaleDateString('ar-EG');
            const initialCount = LIVE_TIMER.sessions.length;
            
            LIVE_TIMER.sessions = LIVE_TIMER.sessions.filter(session => {
                const sessionDate = new Date(session.date).toLocaleDateString('ar-EG');
                return sessionDate !== todayDate;
            });
            
            LIVE_TIMER.sessionHistory = LIVE_TIMER.sessions.slice(0, 20);
            LIVE_TIMER.today.totalSeconds = 0;
            LIVE_TIMER.today.sessions = 0;
            
            saveLiveTimerData();
            updateLiveStatsDisplay();
            updateSessionsHistory();
            
            const removedCount = initialCount - LIVE_TIMER.sessions.length;
            showToast(`تم مسح ${removedCount} جلسة من اليوم`, 'success');
        }
    });
}

function clearAllSessions() {
    Swal.fire({
        title: 'مسح جميع الجلسات؟',
        text: 'هذا سيحذف جميع سجلات التايمر ولا يمكن التراجع عنه!',
        icon: 'error',
        background: '#0f172a',
        color: '#f8fafc',
        showCancelButton: true,
        confirmButtonText: 'نعم، امسح الكل',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280'
    }).then((result) => {
        if (result.isConfirmed) {
            const sessionCount = LIVE_TIMER.sessions.length;
            
            LIVE_TIMER.sessions = [];
            LIVE_TIMER.sessionHistory = [];
            LIVE_TIMER.totalSeconds = 0;
            LIVE_TIMER.totalSessions = 0;
            LIVE_TIMER.firstRecordDate = null;
            LIVE_TIMER.bestSession = {
                seconds: 0,
                time: "00:00:00",
                date: null
            };
            
            LIVE_TIMER.today = {
                date: new Date().toLocaleDateString('ar-EG'),
                totalSeconds: 0,
                sessions: 0
            };
            
            saveLiveTimerData();
            updateLiveStatsDisplay();
            updateSessionsHistory();
            
            showToast(`تم مسح ${sessionCount} جلسة`, 'success');
        }
    });
}

function exportSessionsData() {
    if (LIVE_TIMER.sessions.length === 0) {
        showToast('لا توجد جلسات لتصديرها', 'warning');
        return;
    }
    
    const exportData = {
        app: 'ProTimer Live Tracker',
        version: '2.2.0',
        exportDate: new Date().toISOString(),
        totalSessions: LIVE_TIMER.totalSessions,
        totalTime: {
            seconds: LIVE_TIMER.totalSeconds,
            hours: Math.floor(LIVE_TIMER.totalSeconds / 3600),
            minutes: Math.floor((LIVE_TIMER.totalSeconds % 3600) / 60)
        },
        bestSession: LIVE_TIMER.bestSession,
        todayStats: LIVE_TIMER.today,
        sessions: LIVE_TIMER.sessions.map(session => ({
            date: session.displayDate,
            time: session.displayTime,
            duration: session.duration,
            hours: session.hours,
            minutes: session.minutes,
            seconds: session.seconds,
            totalSeconds: session.totalSeconds
        }))
    };
    
    const jsonString = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `protimer-sessions-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(`تم تصدير ${LIVE_TIMER.sessions.length} جلسة`, 'success');
}

// ============================================
// FOCUS MODE INTEGRATION
// ============================================

function integrateWithFocusMode() {
    setInterval(() => {
        const isFocusMode = document.body.classList.contains('focus-mode');
        const statsWidget = document.getElementById('timerStatsWidget');
        const statsPanel = document.getElementById('timerStatsPanel');
        
        if (isFocusMode) {
            if (statsWidget) {
                statsWidget.style.opacity = '0';
                statsWidget.style.visibility = 'hidden';
                statsWidget.style.pointerEvents = 'none';
                statsWidget.style.transform = 'translateY(100%)';
            }
            if (statsPanel) {
                statsPanel.classList.add('hidden');
                const overlay = document.getElementById('panelOverlay');
                if (overlay) {
                    overlay.remove();
                }
            }
        } else {
            if (statsWidget) {
                statsWidget.style.opacity = '';
                statsWidget.style.visibility = '';
                statsWidget.style.pointerEvents = '';
                statsWidget.style.transform = '';
            }
        }
    }, 500);
}
// ============================================
// INITIALIZATION
// ============================================

// Helper function for time formatting
function formatTime(num) {
    return num.toString().padStart(2, '0');
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Remove tasks button from control panel
    setTimeout(() => {
        const tasksBtn = document.getElementById('quickTasksBtn');
        if (tasksBtn) {
            tasksBtn.style.display = 'none';
            tasksBtn.remove();
        }
        
        const tasksPanel = document.getElementById('quickTasksPanel');
        if (tasksPanel) {
            tasksPanel.remove();
        }
    }, 1000);
    
    // Initialize all systems
    setTimeout(initializeAutoSaveSystem, 500);
    setTimeout(initializeContextMenu, 1000);
    setTimeout(initializeLiveTimer, 1500);
    setTimeout(integrateWithFocusMode, 2000);
    
    // Show welcome message
    setTimeout(() => {
        applySettings();
        showToast('ProTimer جاهز! انقر بزر الماوس الأيمن للتحكم السريع', 'success');
    }, 2500);
    
    // Ensure everything saves when page closes
    window.addEventListener('pagehide', saveAllData);
    
    console.log("✨ ProTimer Enhanced v2.2.0 - Ready!");
});
</script>
<script>
/**
 * نظام التخزين العملاق (IndexedDB Video System) 🚀
 * يحل مشكلة: المساحة، اختفاء الفيديو، ثقل الموقع، وحفظ الإعدادات
 */
const ProMediaDB = {
    dbName: "ProTimerBigMedia",
    storeName: "files",

    // 1. فتح مخزن الملفات في الجهاز
    init() {
        return new Promise((resolve) => {
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (e) => e.target.result.createObjectStore(this.storeName);
            request.onsuccess = (e) => resolve(e.target.result);
        });
    },

    // 2. حفظ ملف الفيديو (بدون حد أقصى للمساحة)
    async saveVideo(file) {
        const db = await this.init();
        const tx = db.transaction(this.storeName, "readwrite");
        tx.objectStore(this.storeName).put(file, "bg_video");
        console.log("✅ تم حفظ الفيديو في مساحة الجهاز المستقلة");
    },

    // 3. جلب الفيديو وتشغيله
    async loadVideo() {
        const db = await this.init();
        const tx = db.transaction(this.storeName, "readonly");
        const request = tx.objectStore(this.storeName).get("bg_video");
        
        request.onsuccess = () => {
            const blob = request.result;
            if (blob) {
                const url = URL.createObjectURL(blob);
                this.render(url);
            }
        };
    },

    // 4. وضع الفيديو في الخلفية
    render(url) {
        const container = document.getElementById('mediaBackground');
        if (!container) return;
        container.innerHTML = `
            <video autoplay loop muted playsinline webkit-playsinline
                   style="width:100%; height:100%; object-fit:cover; position:absolute; inset:0; z-index:-1;">
                <source src="${url}">
            </video>`;
        const v = container.querySelector('video');
        v.play().catch(() => {
            document.addEventListener('click', () => v.play(), { once: true });
        });
    }
};

// اعتراض عملية الرفع الأصلية لتوجيهها للمخزن الجديد
const fileInput = document.getElementById('mediaUrl');
if (fileInput) {
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('video/')) {
            // حفظ الفيديو في المخزن الكبير
            await ProMediaDB.saveVideo(file);
            // تشغيله فوراً
            ProMediaDB.loadVideo();
            // مسح القيمة من الـ Input عشان ميتحفظش في الـ LocalStorage ويقلل المساحة
            setTimeout(() => { 
                if(APP_STATE) APP_STATE.settings.mediaUrl = ""; 
                saveAllSettings(); 
            }, 500);
        }
    });
}

// تشغيل الفيديو عند فتح التطبيق
window.addEventListener('load', () => {
    setTimeout(() => ProMediaDB.loadVideo(), 800);
});

// ضمان عدم التوقف في الخلفية
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        const v = document.querySelector('video');
        if (v) v.play();
    }
});
// ======================================================
// PRO-TASKS V23 - FULL ENTER SUPPORT & UNIFIED UI
// ======================================================

const TASKS_V23 = {
    data: JSON.parse(localStorage.getItem('pro_ledger_v23')) || { days: {} },
    isOpen: false,
    filter: 'all',
    pos: JSON.parse(localStorage.getItem('task_pos_v23')) || { y: window.innerHeight / 2 }
};

// الستايلات المخصصة (Glassmorphism)
const styleV23 = document.createElement('style');
styleV23.innerHTML = `
    .glass-overlay-v23 {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(12px);
        display: flex; align-items: center; justify-content: center; z-index: 10005;
        opacity: 0; transition: all 0.3s ease; border-radius: 3rem;
    }
    .glass-box-v23 {
        background: rgba(15, 23, 42, 0.95); width: 85%; padding: 2rem;
        border-radius: 2.5rem; border: 1px solid rgba(255,255,255,0.1);
        transform: scale(0.8); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.6); text-align: center;
    }
    .glass-overlay-v23.show { opacity: 1; }
    .glass-overlay-v23.show .glass-box-v23 { transform: scale(1); }
    
    .glass-input-v23 {
        width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        padding: 15px; border-radius: 18px; color: white; outline: none; margin: 20px 0;
        font-size: 14px; text-align: center; transition: all 0.3s;
    }
    .glass-input-v23:focus { border-color: #6366f1; background: rgba(255,255,255,0.1); box-shadow: 0 0 15px rgba(99,102,241,0.2); }
    
    .glass-btn-primary { background: #6366f1; color: white; padding: 12px 30px; border-radius: 15px; font-size: 11px; font-weight: 900; cursor: pointer; border: none; transition: 0.3s; letter-spacing: 1px; }
    .glass-btn-primary:hover { background: #4f46e5; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); }
    .glass-btn-close { background: transparent; color: #64748b; padding: 10px; font-size: 11px; font-weight: bold; cursor: pointer; border: none; }
`;
document.head.appendChild(styleV23);

function initProTasksV23() {
    const today = new Date().toLocaleDateString('en-GB');
    if (!TASKS_V23.data.days[today]) TASKS_V23.data.days[today] = [];

    if (!document.getElementById('taskFab')) {
        const fab = document.createElement('button');
        fab.id = 'taskFab';
        fab.className = 'fixed left-0 w-8 h-28 bg-indigo-600 text-white rounded-r-3xl shadow-2xl flex items-center justify-center z-[9999] transition-all hover:w-10 border-y border-r border-white/20 cursor-pointer';
        fab.style.top = TASKS_V23.pos.y + 'px';
        fab.innerHTML = '<i class="fas fa-chevron-right text-xs"></i>';
        fab.onclick = toggleLedger;
        document.body.appendChild(fab);
        makeDraggableV23(fab);
    }

    if (!document.getElementById('ledgerPanel')) {
        const panel = document.createElement('div');
        panel.id = 'ledgerPanel';
        panel.className = 'fixed top-4 left-[-500px] bottom-4 w-[430px] bg-slate-950/98 backdrop-blur-3xl border border-white/10 rounded-[3rem] z-[10001] transition-all duration-700 shadow-[30px_0_100px_rgba(0,0,0,0.8)] flex flex-col overflow-hidden text-slate-100';
        panel.innerHTML = `
            <div id="unifiedModalContainer"></div>
            <div class="p-8 bg-gradient-to-br from-indigo-600/10 to-transparent border-b border-white/5">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-black italic tracking-tighter uppercase">Ledger Hub</h3>
                        <p class="text-[9px] text-indigo-400 font-mono tracking-widest">${today}</p>
                    </div>
                    <button onclick="toggleLedger()" class="w-10 h-10 rounded-2xl bg-white/5 hover:bg-red-500/20 flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
                <div class="bg-white/5 p-2 pl-4 rounded-2xl border border-white/10 flex items-center gap-2 mb-4 focus-within:border-indigo-500/50 transition-all">
                    <input type="text" id="fastInput" placeholder="Add primary objective..." class="flex-1 bg-transparent border-none outline-none text-sm text-white py-1">
                    <button onclick="addMajorTask()" class="w-9 h-9 bg-indigo-600 rounded-xl hover:bg-indigo-500 transition-all active:scale-90"><i class="fas fa-plus text-xs"></i></button>
                </div>
                <div class="flex gap-2 p-1 bg-black/30 rounded-xl text-[8px] font-bold uppercase">
                    <button onclick="setFilter('all')" id="f-all" class="flex-1 py-2 rounded-lg bg-indigo-600 transition-all">All</button>
                    <button onclick="setFilter('pending')" id="f-pending" class="flex-1 py-2 rounded-lg transition-all">Active</button>
                    <button onclick="setFilter('completed')" id="f-completed" class="flex-1 py-2 rounded-lg transition-all">Done</button>
                </div>
            </div>
            <div id="ledgerList" class="flex-1 overflow-y-auto px-6 py-6 space-y-4 custom-scrollbar relative"></div>
        `;
        document.body.appendChild(panel);

        // دعم الـ Enter في خانة الإضافة الرئيسية
        document.getElementById('fastInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addMajorTask();
        });
    }
    renderLedger();
    syncV23();
}

function openUnifiedModal(config) {
    const container = document.getElementById('unifiedModalContainer');
    container.innerHTML = `
        <div class="glass-overlay-v23" id="v23Overlay">
            <div class="glass-box-v23">
                <h5 class="text-[10px] font-black tracking-[4px] text-indigo-400 uppercase">${config.title}</h5>
                <input type="text" id="v23Field" class="glass-input-v23" value="${config.value || ''}" placeholder="${config.placeholder || ''}" autocomplete="off">
                <div class="flex justify-center gap-4">
                    <button class="glass-btn-close" onclick="closeUnifiedModal()">CANCEL</button>
                    <button class="glass-btn-primary" id="v23ConfirmBtn">${config.confirmText || 'SAVE'}</button>
                </div>
            </div>
        </div>
    `;
    const overlay = document.getElementById('v23Overlay');
    const field = document.getElementById('v23Field');
    const btn = document.getElementById('v23ConfirmBtn');

    setTimeout(() => overlay.classList.add('show'), 10);
    field.focus();
    field.select(); // تحديد النص تلقائياً ليسهل التعديل

    const handleAction = () => {
        if (field.value.trim()) {
            config.onConfirm(field.value.trim());
            closeUnifiedModal();
        }
    };

    btn.onclick = handleAction;
    field.onkeydown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleAction();
        }
    };
}

function closeUnifiedModal() {
    const overlay = document.getElementById('v23Overlay');
    if(overlay) {
        overlay.classList.remove('show');
        setTimeout(() => overlay.remove(), 300);
    }
}

function addMajorTask() {
    const inp = document.getElementById('fastInput');
    if (!inp.value.trim()) return;
    const today = new Date().toLocaleDateString('en-GB');
    TASKS_V23.data.days[today].unshift({ 
        id: Date.now(), 
        text: inp.value.trim(), 
        subtasks: [], 
        done: false, 
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
    });
    saveLedger(); 
    inp.value = '';
}

function renderLedger() {
    const list = document.getElementById('ledgerList');
    list.innerHTML = '';
    const days = Object.keys(TASKS_V23.data.days).sort((a,b) => {
        const dateA = a.split('/').reverse().join('');
        const dateB = b.split('/').reverse().join('');
        return dateB.localeCompare(dateA);
    });
    
    days.forEach(day => {
        const tasks = TASKS_V23.data.days[day].filter(t => {
            if (TASKS_V23.filter === 'pending') return !t.done;
            if (TASKS_V23.filter === 'completed') return t.done;
            return true;
        });
        if (tasks.length === 0) return;

        list.innerHTML += `<div class="text-[9px] font-black text-indigo-500/40 mb-3 tracking-widest uppercase flex items-center gap-2">${day} <div class="h-[1px] flex-1 bg-white/5"></div></div>`;

        tasks.forEach(t => {
            const isDone = t.done;
            list.innerHTML += `
                <div class="${isDone ? 'bg-emerald-600/70 border-emerald-400 shadow-lg shadow-emerald-500/10' : 'bg-white/[0.03] border-white/5'} border p-5 rounded-[2.5rem] group relative mb-4 transition-all hover:bg-white/[0.05]">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[8px] opacity-40 font-mono italic">${t.time}</span>
                        <div class="flex gap-4 opacity-0 group-hover:opacity-100 transition-all translate-x-2 group-hover:translate-x-0">
                            <button onclick="editItemV23('major', ${t.id}, '${day}')"><i class="fas fa-pen text-[10px] hover:text-indigo-400"></i></button>
                            <button onclick="addSubV23(${t.id}, '${day}')"><i class="fas fa-list-ul text-[10px] hover:text-indigo-400"></i></button>
                            <button onclick="toggleMajor(${t.id}, '${day}')"><i class="fas fa-check-double text-[10px] hover:text-emerald-400"></i></button>
                            <button onclick="deleteTask(${t.id}, '${day}')"><i class="fas fa-trash-alt text-[10px] hover:text-red-400"></i></button>
                        </div>
                    </div>
                    <h4 class="text-sm font-bold ${isDone ? 'line-through text-white/60' : 'text-white'}">${t.text}</h4>
                    <div class="mt-3 space-y-2">
                        ${t.subtasks.map(s => `
                            <div class="flex items-center gap-3 bg-black/20 p-2.5 px-4 rounded-2xl group/sub border border-white/5 transition-all hover:border-white/20">
                                <i onclick="toggleSub(${t.id}, ${s.id}, '${day}')" class="fas ${s.done ? 'fa-check-circle text-emerald-400' : 'fa-circle text-white/5'} cursor-pointer text-[10px]"></i>
                                <span class="text-[11px] flex-1 ${s.done ? 'line-through opacity-40' : 'text-slate-200'}">${s.text}</span>
                                <button onclick="editItemV23('sub', ${t.id}, '${day}', ${s.id})" class="opacity-0 group-hover/sub:opacity-100 transition-all hover:text-indigo-400"><i class="fas fa-pen text-[9px]"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
    });
}

function addSubV23(taskId, day) {
    openUnifiedModal({
        title: 'Tactical Step',
        placeholder: 'What is the next step?',
        confirmText: 'ADD TO MISSION',
        onConfirm: (val) => {
            const task = TASKS_V23.data.days[day].find(t => t.id === taskId);
            task.subtasks.push({ id: Date.now(), text: val, done: false });
            task.done = false;
            saveLedger();
        }
    });
}

function editItemV23(type, taskId, day, subId = null) {
    const task = TASKS_V23.data.days[day].find(t => t.id === taskId);
    let oldVal = type === 'major' ? task.text : task.subtasks.find(s => s.id === subId).text;
    
    openUnifiedModal({
        title: 'Edit Mission',
        value: oldVal,
        confirmText: 'UPDATE',
        onConfirm: (val) => {
            if (type === 'major') task.text = val;
            else task.subtasks.find(s => s.id === subId).text = val;
            saveLedger();
        }
    });
}

function toggleMajor(id, day) {
    const task = TASKS_V23.data.days[day].find(t => t.id === id);
    task.done = !task.done; 
    if (task.done) task.subtasks.forEach(s => s.done = true);
    saveLedger();
}

function toggleSub(taskId, subId, day) {
    const task = TASKS_V23.data.days[day].find(t => t.id === taskId);
    const sub = task.subtasks.find(s => s.id === subId);
    sub.done = !sub.done; 
    task.done = task.subtasks.length > 0 && task.subtasks.every(s => s.done);
    saveLedger();
}

function setFilter(f) {
    TASKS_V23.filter = f;
    ['all', 'pending', 'completed'].forEach(id => {
        const btn = document.getElementById(`f-${id}`);
        btn.classList.remove('bg-indigo-600');
    });
    document.getElementById(`f-${f}`).classList.add('bg-indigo-600');
    renderLedger();
}

function saveLedger() { 
    localStorage.setItem('pro_ledger_v23', JSON.stringify(TASKS_V23.data)); 
    renderLedger(); 
}

function toggleLedger() {
    const p = document.getElementById('ledgerPanel');
    const f = document.getElementById('taskFab');
    TASKS_V23.isOpen = !TASKS_V23.isOpen;
    p.style.left = TASKS_V23.isOpen ? '20px' : '-500px';
    f.style.opacity = TASKS_V23.isOpen ? '0' : '1';
}

function deleteTask(id, day) {
    TASKS_V23.data.days[day] = TASKS_V23.data.days[day].filter(t => t.id !== id);
    saveLedger();
}

function makeDraggableV23(el) {
    let isDragging = false;
    el.onmousedown = (e) => {
        isDragging = true;
        document.onmousemove = (e) => { if (isDragging) { let y = e.clientY - 50; el.style.top = y + 'px'; TASKS_V23.pos.y = y; } };
        document.onmouseup = () => { isDragging = false; localStorage.setItem('task_pos_v23', JSON.stringify(TASKS_V23.pos)); document.onmousemove = null; };
    };
}

function syncV23() {
    const observer = new MutationObserver(() => {
        const isFocus = document.body.classList.contains('focus-mode');
        const fab = document.getElementById('taskFab');
        if (fab) fab.style.display = isFocus ? 'none' : 'flex';
        document.querySelectorAll('.fa-tasks, .fa-clipboard-list').forEach(icon => {
            const btn = icon.closest('button') || icon.parentElement;
            btn.onclick = (e) => { e.preventDefault(); toggleLedger(); };
        });
    });
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
}

document.addEventListener('DOMContentLoaded', initProTasksV23);
</script>
<script>
// ============================================
// الكود النهائي البسيط - يمنع الفتح التلقائي فقط
// ============================================

// 1. إغلاق الإعدادات فوراً عند تحميل الصفحة
window.addEventListener('load', function() {
    console.log("🔧 أقفل الإعدادات عند بداية التشغيل");
    
    // تأكد أن الإعدادات مغلقة
    const panel = document.getElementById('settingsPanel');
    if (panel) {
        panel.classList.add('translate-x-full');
    }
});

// 2. استبدل دالة toggleSettings الأصلية
const originalToggleSettings = window.toggleSettings;

// 3. دالة toggleSettings الجديدة
window.toggleSettings = function() {
    console.log("🔄 محاولة فتح الإعدادات...");
    
    // استدعاء الدالة الأصلية
    if (originalToggleSettings) {
        return originalToggleSettings();
    }
};

// 4. مراقبة فتح الإعدادات وإغلاقها إذا فتحت تلقائياً
let pageLoadedTime = Date.now();
let userManuallyOpened = false;

// تحقق كل نصف ثانية إذا فتحت الإعدادات تلقائياً
setInterval(function() {
    const now = Date.now();
    const secondsSinceLoad = (now - pageLoadedTime) / 1000;
    
    // فقط خلال أول 10 ثواني من تشغيل الصفحة
    if (secondsSinceLoad < 10) {
        const panel = document.getElementById('settingsPanel');
        
        // إذا الإعدادات فتحت تلقائياً (بدون أن المستخدم فتحها)
        if (panel && !panel.classList.contains('translate-x-full') && !userManuallyOpened) {
            console.log("🚫 أقفل الإعدادات (فتحت تلقائياً)");
            panel.classList.add('translate-x-full');
        }
    }
}, 500);

// 5. كشف عندما يفتح المستخدم الإعدادات يدوياً
document.addEventListener('click', function(event) {
    // إذا ضغط على زر الإعدادات
    if (event.target.closest('#settingsBtn') || 
        event.target.closest('[onclick*="toggleSettings"]')) {
        
        console.log("👆 المستخدم فتح الإعدادات يدوياً");
        userManuallyOpened = true;
    }
});

console.log("✅ النظام جاهز - الإعدادات تفتح يدوياً فقط");
</script>
<div id="pro-cursor-holder">
    <div id="cursor-main-dot"></div>
    <div id="cursor-outer-ring"></div>
</div>

<style>
    /* 1. القواعد الأساسية */
    @media (pointer: fine) {
        body.cursor-enabled, body.cursor-enabled * { cursor: none !important; }
    }

    #cursor-main-dot, #cursor-outer-ring {
        position: fixed; pointer-events: none; z-index: 99999999; display: none;
        transform: translate(-50%, -50%); transition: width 0.2s, height 0.2s, background 0.3s, border 0.3s, opacity 0.3s;
    }

    /* --- مكتبة الأشكال الـ 15 مع ميكس التفاعل --- */
    .st-sandglass #cursor-main-dot { display: block; width: 12px; height: 12px; background: #fbbf24; clip-path: polygon(0% 0%, 100% 0%, 50% 50%, 100% 100%, 0% 100%, 50% 50%); animation: cursor-flip 2s infinite; }
    .st-sandglass #cursor-outer-ring { display: block; width: 32px; height: 32px; border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 50%; }

    .st-chrono #cursor-main-dot { display: block; width: 6px; height: 6px; background: #6366f1; border-radius: 50%; }
    .st-chrono #cursor-outer-ring { display: block; width: 30px; height: 30px; border: 2px solid #6366f1; border-radius: 50%; border-top-color: transparent; animation: cursor-spin 1s linear infinite; }

    .st-vortex #cursor-outer-ring { display: block; width: 35px; height: 35px; border: 3px double #a855f7; border-radius: 40% 60% 70% 30% / 40% 50% 60% 70%; animation: cursor-spin 2s linear infinite; }
    .st-vortex #cursor-main-dot { display: block; width: 8px; height: 8px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px #a855f7; }

    .st-ticktock #cursor-main-dot { display: block; width: 4px; height: 20px; background: #ef4444; border-radius: 2px; transform-origin: top center; animation: cursor-swing 1s ease-in-out infinite alternate; }
    .st-ticktock #cursor-outer-ring { display: block; width: 30px; height: 30px; border: 1px dashed #ef4444; border-radius: 50%; }

    .st-infinity #cursor-main-dot { display: block; width: 10px; height: 10px; border: 2px solid #ec4899; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); }
    .st-infinity #cursor-outer-ring { display: block; width: 35px; height: 35px; border: 2px solid #ec4899; border-radius: 50%; border-right-color: transparent; animation: cursor-spin 0.5s linear infinite; }

    .st-solar #cursor-main-dot { display: block; width: 10px; height: 10px; background: #f97316; border-radius: 50%; box-shadow: 0 0 15px #f97316; }
    .st-solar #cursor-outer-ring { display: block; width: 35px; height: 35px; border: 2px dotted #f97316; border-radius: 50%; animation: cursor-spin 5s linear infinite; }

    .st-cybergear #cursor-main-dot { display: block; width: 8px; height: 8px; background: #0ea5e9; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); animation: cursor-spin 1s linear infinite; }
    .st-cybergear #cursor-outer-ring { display: block; width: 35px; height: 35px; border: 2px dashed #0ea5e9; border-radius: 50%; animation: cursor-pulse 1s infinite; }

    .st-flow #cursor-main-dot { display: block; width: 15px; height: 15px; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); border-radius: 50%; border: 1px solid rgba(255,255,255,0.5); }
    .st-flow #cursor-outer-ring { display: block; width: 40px; height: 40px; border: 1px solid #fff; border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; animation: cursor-spin 3s ease-in-out infinite alternate; }

    .st-deadline #cursor-main-dot { display: block; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; }
    .st-deadline #cursor-outer-ring { display: block; width: 20px; height: 20px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; animation: cursor-pulse 0.6s infinite; }

    .st-digital #cursor-main-dot { display: block; width: 14px; height: 14px; border: 1px solid #22c55e; background: rgba(34, 197, 94, 0.1); }
    .st-digital #cursor-outer-ring { display: block; width: 30px; height: 30px; border: 1px solid #22c55e; opacity: 0.5; }

    .st-atomic #cursor-main-dot { display: block; width: 4px; height: 4px; background: #fff; border-radius: 50%; }
    .st-atomic #cursor-outer-ring { display: block; width: 40px; height: 15px; border: 1px solid #6366f1; border-radius: 50%; animation: cursor-spin 0.5s linear infinite; }

    .st-orbit #cursor-main-dot { display: block; width: 6px; height: 6px; background: #8b5cf6; border-radius: 50%; }
    .st-orbit #cursor-outer-ring { display: block; width: 30px; height: 30px; border: 1px solid #8b5cf6; border-radius: 50%; border-right: 5px solid #8b5cf6; animation: cursor-spin 0.3s linear infinite; }

    .st-ghost #cursor-outer-ring { display: block; width: 35px; height: 35px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; backdrop-filter: blur(2px); animation: cursor-spin 10s linear infinite; }

    .st-target #cursor-main-dot { display: block; width: 2px; height: 20px; background: #fff; }
    .st-target #cursor-main-dot::after { content:''; position:absolute; width:20px; height:2px; background:#fff; top:50%; left:50%; transform:translate(-50%,-50%); }
    .st-target #cursor-outer-ring { display: block; width: 30px; height: 30px; border: 1px solid #fff; border-radius: 50%; }

    .st-minimal #cursor-main-dot { display: block; width: 8px; height: 8px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.8); }

    /* --- تفاعلات الأنيميشن --- */
    @keyframes cursor-spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
    @keyframes cursor-pulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.6); opacity: 0; } }
    @keyframes cursor-flip { 0%, 10% { transform: translate(-50%, -50%) rotate(0deg); } 90%, 100% { transform: translate(-50%, -50%) rotate(180deg); } }
    @keyframes cursor-swing { from { transform: translate(-50%, -50%) rotate(-45deg); } to { transform: translate(-50%, -50%) rotate(45deg); } }

    /* تفاعلات Hover و Click */
    .hvr-active #cursor-outer-ring { transform: translate(-50%, -50%) scale(1.4); border-color: #fff !important; background: rgba(255,255,255,0.1); border-style: solid; }
    body.cursor-clicked #cursor-main-dot { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }

    /* --- تنسيق الواجهة كجزء من الإعدادات --- */
    .cursor-settings-section {
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .cursor-grid-final {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 16px;
    }
    .cursor-option-card {
        background: rgba(15, 23, 42, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }
    .cursor-option-card:hover {
        background: rgba(99, 102, 241, 0.05);
        border-color: rgba(99, 102, 241, 0.4);
        transform: translateY(-2px);
    }
    .cursor-option-card.active {
        background: rgba(99, 102, 241, 0.15);
        border-color: #6366f1;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.1);
    }
    .preview-box-final {
        width: 42px;
        height: 42px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .cursor-label-final {
        font-size: 10px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .cursor-option-card.active .cursor-label-final {
        color: white;
    }
</style>

<script>
    const mDot = document.getElementById('cursor-main-dot');
    const oRing = document.getElementById('cursor-outer-ring');

    // تتبع الماوس
    window.addEventListener('mousemove', (e) => {
        const x = e.clientX, y = e.clientY;
        requestAnimationFrame(() => {
            mDot.style.left = x + 'px'; mDot.style.top = y + 'px';
            oRing.style.left = x + 'px'; oRing.style.top = y + 'px';
        });
    });

    // تأثير الكليك
    window.addEventListener('mousedown', () => document.body.classList.add('cursor-clicked'));
    window.addEventListener('mouseup', () => setTimeout(() => document.body.classList.remove('cursor-clicked'), 150));

    // تبديل الماوس وحفظه
    function updateCursor(id) {
        document.body.classList.remove('cursor-enabled');
        const styles = ['sandglass', 'chrono', 'vortex', 'ticktock', 'infinity', 'solar', 'cybergear', 'flow', 'deadline', 'digital', 'atomic', 'orbit', 'ghost', 'target', 'minimal'];
        styles.forEach(s => document.body.classList.remove('st-' + s));

        if (id !== 'default') {
            document.body.classList.add('cursor-enabled', 'st-' + id);
            mDot.style.display = 'block'; oRing.style.display = 'block';
        } else {
            mDot.style.display = 'none'; oRing.style.display = 'none';
        }
        localStorage.setItem('pt_cursor_v8', id);
        injectToSettings(); // إعادة رسم الواجهة لتحديث الـ Active
    }

    // الحقن الذكي أسفل الإعدادات
    function injectToSettings() {
        const current = localStorage.getItem('pt_cursor_v8') || 'sandglass';
        
        // البحث عن آخر عنصر في حاوية الإعدادات
        const settingsContainer = document.querySelector('#settingsPanel .space-y-6') || 
                                  document.querySelector('.settings-content') ||
                                  document.querySelector('#appearance-settings');

        if (!settingsContainer) return;

        let uiWrapper = document.getElementById('cursor-manager-v8');
        if (!uiWrapper) {
            uiWrapper = document.createElement('div');
            uiWrapper.id = 'cursor-manager-v8';
            uiWrapper.className = 'cursor-settings-section';
            settingsContainer.appendChild(uiWrapper);
        }

        const options = [
            { id: 'default', name: 'System', icon: '🖱️' },
            { id: 'sandglass', name: 'Sand Glass', icon: '⏳' },
            { id: 'chrono', name: 'Chrono', icon: '⏱️' },
            { id: 'vortex', name: 'Vortex', icon: '🌀' },
            { id: 'ticktock', name: 'Pendulum', icon: '🔔' },
            { id: 'infinity', name: 'Infinity', icon: '♾️' },
            { id: 'solar', name: 'Solar', icon: '☀️' },
            { id: 'cybergear', name: 'Cyber', icon: '🤖' },
            { id: 'flow', name: 'Flow', icon: '🌊' },
            { id: 'deadline', name: 'Alert', icon: '🚨' },
            { id: 'digital', name: 'Digital', icon: '📟' },
            { id: 'atomic', name: 'Atomic', icon: '⚛️' },
            { id: 'orbit', name: 'Orbit', icon: '🛰️' },
            { id: 'ghost', name: 'Glass', icon: '👻' },
            { id: 'target', name: 'Sniper', icon: '🎯' }
        ];

        uiWrapper.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <i class="fas fa-wand-magic-sparkles text-indigo-400"></i>
                    <h3 class="text-xs font-black text-gray-200 uppercase tracking-widest">Cursor Theme</h3>
                </div>
                <span class="text-[9px] bg-indigo-500/20 text-indigo-400 px-2 py-0.5 rounded-full font-bold">15 STYLES</span>
            </div>
            <div class="cursor-grid-final">
                ${options.map(opt => `
                    <div class="cursor-option-card ${current === opt.id ? 'active' : ''}" onclick="updateCursor('${opt.id}')">
                        <div class="preview-box-final">
                             ${opt.id === 'default' ? `<span>${opt.icon}</span>` : `<div class="st-${opt.id} scale-50"><div id="cursor-main-dot" style="display:block; position:relative; left:auto; top:auto; transform:none;"></div><div id="cursor-outer-ring" style="display:block; position:relative; left:auto; top:auto; transform:none; margin-top:-10px;"></div></div>`}
                        </div>
                        <span class="cursor-label-final">${opt.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // تفاعلات الـ Hover
    document.addEventListener('mouseover', (e) => {
        if (e.target.closest('button, a, .control-btn, .cursor-option-card, input, [onclick]')) {
            document.body.classList.add('hvr-active');
        }
    });
    document.addEventListener('mouseout', (e) => {
        if (e.target.closest('button, a, .control-btn, .cursor-option-card, input, [onclick]')) {
            document.body.classList.remove('hvr-active');
        }
    });

    // تهيئة التشغيل
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('pt_cursor_v8');
        if (!saved) {
            updateCursor('sandglass'); // أول مرة
        } else {
            updateCursor(saved);
        }
        // محاولة الحقن فوراً وبعد ثانية لضمان ظهور الإعدادات
        setTimeout(injectToSettings, 500);
        setTimeout(injectToSettings, 1500);
    });

    // مراقبة الضغط لفتح القوائم
    document.addEventListener('click', () => setTimeout(injectToSettings, 100));
</script>
<script>
(function() {
    // 1. إعداد الحاويات في الخلفية
    if (!document.getElementById('bgVideoContainer')) {
        const bgDiv = document.createElement('div');
        bgDiv.id = 'bgVideoContainer';
        bgDiv.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; pointer-events:none; overflow:hidden; display:none;";
        
        // وسم الفيديو للملفات المباشرة
        const vElement = document.createElement('video');
        vElement.id = 'proVideoBackground';
        vElement.loop = true; vElement.muted = true; vElement.autoplay = true;
        vElement.setAttribute('playsinline', '');
        vElement.style.cssText = "width:100%; height:100%; object-fit:cover;";
        
        // وسم الـ Iframe لليوتيوب
        const ytElement = document.createElement('iframe');
        ytElement.id = 'proYoutubeBackground';
        ytElement.style.cssText = "width:300%; height:100%; margin-left:-100%; pointer-events:none; border:none;";
        ytElement.style.display = "none";

        bgDiv.appendChild(vElement);
        bgDiv.appendChild(ytElement);
        document.body.prepend(bgDiv);
    }

    // 2. دالة لاستخراج ID اليوتيوب
    function getYoutubeID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // 3. دالة بناء القسم بتصميم مطابق للإعدادات
    function createVideoSectionHTML() {
        const container = document.getElementById('bgVideoContainer');
        const isActive = container.style.display === 'block';
        const currentOpacity = Math.round(container.style.opacity * 100) || 40;

        return `
            <div id="customVideoSection" class="space-y-6 animate-fade-in" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px dashed rgba(255,255,255,0.1);">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-medium">خلفية الفيديو الحية</h3>
                        <p class="text-xs opacity-50">يدعم ملفات MP4 وروابط YouTube</p>
                    </div>
                    <div id="vToggle" class="toggle-switch ${isActive ? 'active' : ''}" onclick="handleVideoToggle()">
                        <div class="toggle-switch-handle"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10 hover:border-indigo-500/50 transition-all cursor-pointer" onclick="document.getElementById('vLocalFile').click()">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">رفع فيديو محلي</p>
                                <p class="text-xs opacity-50">من جهازك مباشرة</p>
                            </div>
                        </div>
                        <input type="file" id="vLocalFile" accept="video/*" class="hidden" onchange="handleVUpload(this)">
                    </div>

                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10 hover:border-red-500/50 transition-all cursor-pointer" onclick="promptVideoUrl()">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500">
                                <i class="fab fa-youtube"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">رابط فيديو / YouTube</p>
                                <p class="text-xs opacity-50">الصق الرابط هنا</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                    <div class="flex justify-between mb-4">
                        <span class="text-sm opacity-70">درجة الشفافية</span>
                        <span class="text-sm font-mono text-indigo-400" id="vOpVal">${currentOpacity}%</span>
                    </div>
                    <input type="range" id="vOpacity" min="0" max="100" value="${currentOpacity}" 
                           class="range-slider w-full" oninput="updateVOpacity(this.value)">
                </div>
            </div>
        `;
    }

    // 4. وظائف التحكم والتغيير
    window.handleVideoToggle = function() {
        const container = document.getElementById('bgVideoContainer');
        const btn = document.getElementById('vToggle');
        const active = btn.classList.toggle('active');
        container.style.display = active ? 'block' : 'none';
        saveVPrefs();
    };

    window.promptVideoUrl = async function() {
        const { value: url } = await Swal.fire({
            title: 'رابط الفيديو',
            input: 'url',
            inputPlaceholder: 'رابط فيديو مباشر أو يوتيوب...',
            showCancelButton: true,
            confirmButtonText: 'تطبيق',
            cancelButtonText: 'إلغاء',
            background: '#0f172a',
            color: '#fff',
            confirmButtonColor: '#6366f1'
        });
        
        if (url) {
            setVideoSource(url);
            Swal.fire({ icon: 'success', title: 'تم التحديث', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        }
    };

    function setVideoSource(url) {
        const vTag = document.getElementById('proVideoBackground');
        const ytTag = document.getElementById('proYoutubeBackground');
        const ytID = getYoutubeID(url);

        if (ytID) {
            vTag.style.display = "none";
            vTag.pause();
            ytTag.src = `https://www.youtube.com/embed/${ytID}?autoplay=1&mute=1&loop=1&playlist=${ytID}&controls=0&showinfo=0&rel=0&iv_load_policy=3`;
            ytTag.style.display = "block";
        } else {
            ytTag.style.display = "none";
            ytTag.src = "";
            vTag.src = url;
            vTag.style.display = "block";
            vTag.play().catch(e => console.log("Direct video error"));
        }
        saveVPrefs();
    }

    window.handleVUpload = function(input) {
        if (input.files && input.files[0]) {
            const url = URL.createObjectURL(input.files[0]);
            setVideoSource(url);
        }
    };

    window.updateVOpacity = function(val) {
        document.getElementById('vOpVal').textContent = val + '%';
        document.getElementById('bgVideoContainer').style.opacity = val / 100;
        saveVPrefs();
    };

    function saveVPrefs() {
        const container = document.getElementById('bgVideoContainer');
        const vTag = document.getElementById('proVideoBackground');
        const ytTag = document.getElementById('proYoutubeBackground');
        localStorage.setItem('pt_video_pref_v2', JSON.stringify({
            enabled: container.style.display === 'block',
            opacity: container.style.opacity,
            src: ytTag.src || vTag.src
        }));
    }

    // المراقبة المستمرة للحقن
    setInterval(() => {
        const settings = document.querySelector('.settings-content');
        if (settings && !document.getElementById('customVideoSection')) {
            settings.insertAdjacentHTML('beforeend', createVideoSectionHTML());
        }
    }, 500);

    // تحميل الإعدادات عند البدء
    window.addEventListener('load', () => {
        const saved = JSON.parse(localStorage.getItem('pt_video_pref_v2') || '{}');
        const container = document.getElementById('bgVideoContainer');
        if (saved.src) setVideoSource(saved.src);
        container.style.display = saved.enabled ? 'block' : 'none';
        container.style.opacity = saved.opacity || 0.4;
    });
})();
</script>
<script>
// ============================================
// نظام التنبيهات الصوتية المتكامل (آخر 10 ثوانٍ + النهاية)
// ============================================
(function() {
    // 1. إضافة خيار التحكم في الإعدادات برمجياً
    setInterval(() => {
        const audioSettingsContent = document.querySelector('[data-tab-content="audio"]');
        if (audioSettingsContent && !document.getElementById('nearFinishAlertContainer')) {
            const settingHTML = `
                <div id="nearFinishAlertContainer" class="flex items-center justify-between p-3 bg-white/5 rounded-lg mb-2">
                    <div class="flex flex-col">
                        <span class="font-medium">تنبيه آخر 10 ثوانٍ</span>
                        <span class="text-xs opacity-50">تشغيل صوت "تيك" تصاعدي</span>
                    </div>
                    <div id="nearFinishSoundToggle" class="toggle-switch ${APP_STATE.settings.nearFinishAlertEnabled ? 'active' : ''}" 
                         onclick="this.classList.toggle('active'); APP_STATE.settings.nearFinishAlertEnabled = this.classList.contains('active'); saveToLocalStorage();">
                        <div class="toggle-switch-handle"></div>
                    </div>
                </div>`;
            audioSettingsContent.insertAdjacentHTML('afterbegin', settingHTML);
        }
    }, 1000);

    // 2. دالة توليد الأصوات (تغنيك عن ملفات خارجية لضمان العمل دائماً)
    function playBeep(freq, duration, vol) {
        if (!APP_STATE.settings.audioEnabled) return;
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const osc = context.createOscillator();
            const gain = context.createGain();
            osc.connect(gain);
            gain.connect(context.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(vol / 100, context.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + duration);
            osc.start();
            osc.stop(context.currentTime + duration);
        } catch(e) { console.error("Sound error:", e); }
    }

    // 3. مراقبة التايمر وتشغيل الأصوات
    let lastSecondHandled = -1;
    
    // حقن المنطق داخل حلقة التحديث الرئيسية
    const originalUpdateDisplay = window.updateDisplay;
    window.updateDisplay = function() {
        if (originalUpdateDisplay) originalUpdateDisplay();
        
        const secondsLeft = APP_STATE.remainingSeconds;
        
        // منع تكرار الصوت في نفس الثانية
        if (secondsLeft === lastSecondHandled) return;
        lastSecondHandled = secondsLeft;

        if (APP_STATE.isRunning && !APP_STATE.isFinished) {
            // تنبيه آخر 10 ثوانٍ
            if (secondsLeft <= 10 && secondsLeft > 0 && APP_STATE.settings.nearFinishAlertEnabled) {
                // تزداد حدة الصوت كلما اقتربنا من الصفر
                const pitch = 800 + ((10 - secondsLeft) * 50); 
                playBeep(pitch, 0.1, APP_STATE.settings.audioVolume);
            }
            
            // تنبيه النهاية (عند الوصول للصفر)
            if (secondsLeft === 0) {
                playBeep(1200, 0.5, APP_STATE.settings.audioVolume);
                setTimeout(() => playBeep(1200, 0.8, APP_STATE.settings.audioVolume), 600);
            }
        }
    };
})();
</script>
<script>
/**
 * نظام دعم التطبيقات (Desktop App Support) والتحكم في صوت فيديو الخلفية
 */
(function() {
    // 1. إضافة خيار الصوت في قائمة الإعدادات
    function injectVideoSoundSetting() {
        const audioTab = document.querySelector('[data-tab-content="audio"]');
        if (audioTab && !document.getElementById('video_sound_setting_row')) {
            const isVideoMuted = localStorage.getItem('bg_video_muted') === 'true';
            const rowHTML = `
                <div id="video_sound_setting_row" class="flex items-center justify-between p-3 bg-white/5 rounded-lg mb-2">
                    <div class="flex flex-col">
                        <span class="font-medium">صوت فيديو الخلفية</span>
                        <span class="text-xs opacity-50">تشغيل الصوت للفيديو الحالي</span>
                    </div>
                    <div id="videoSoundToggle" class="toggle-switch ${!isVideoMuted ? 'active' : ''}" 
                         onclick="toggleBgVideoSound(this)">
                        <div class="toggle-switch-handle"></div>
                    </div>
                </div>`;
            audioTab.insertAdjacentHTML('beforeend', rowHTML);
        }
    }
    setInterval(injectVideoSoundSetting, 1000);

    // 2. دالة تبديل الصوت
    window.toggleBgVideoSound = function(el) {
        el.classList.toggle('active');
        const isMuted = !el.classList.contains('active');
        localStorage.setItem('bg_video_muted', isMuted);
        
        // تحديث الفيديو الحالي فوراً
        const ytIframe = document.getElementById('proYoutubeBackground');
        if (ytIframe && ytIframe.src) {
            let url = new URL(ytIframe.src);
            url.searchParams.set('mute', isMuted ? '1' : '0');
            ytIframe.src = url.toString();
        }
    };

    // 3. تعديل دالة اليوتيوب لتعمل كـ Desktop App
    const originalSetVideoSource = window.setVideoSource;
    window.setVideoSource = function(url) {
        if (!url) return;
        
        const ytIdMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
        const ytIframe = document.getElementById('proYoutubeBackground');
        const vTag = document.getElementById('proVideoBackground');
        const container = document.getElementById('bgVideoContainer');
        const isMuted = localStorage.getItem('bg_video_muted') !== 'false'; // افتراضياً مكتوم

        if (ytIdMatch) {
            const videoId = ytIdMatch[1];
            vTag.style.display = 'none';
            ytIframe.style.display = 'block';
            
            // الرابط السحري الذي يعمل داخل التطبيقات (DMG/MSI)
            // نستخدم nocookie ونمرر الـ Origin لفك حظر التشغيل
            const desktopFriendlyUrl = `https://www.youtube-nocookie.com/embed/${videoId}?` + 
                `autoplay=1&mute=${isMuted ? 1 : 0}&loop=1&playlist=${videoId}` +
                `&controls=0&showinfo=0&rel=0&enablejsapi=1&origin=${encodeURIComponent(window.location.origin)}`;
            
            ytIframe.src = desktopFriendlyUrl;
            container.style.display = 'block';
            
            // حفظ الرابط الأخير للتشغيل عند إعادة الفتح
            localStorage.setItem('last_video_url', url);
        } else if (originalSetVideoSource) {
            // إذا لم يكن يوتيوب، نستخدم الدالة الأصلية للملفات المحلية
            originalSetVideoSource(url);
        }
    };

    // 4. إصلاح مشكلة الـ Autoplay في التطبيقات
    // بعض التطبيقات تمنع الفيديو حتى يتفاعل المستخدم مع الشاشة
    document.addEventListener('mousedown', function() {
        const ytIframe = document.getElementById('proYoutubeBackground');
        if (ytIframe && ytIframe.contentWindow) {
            ytIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        }
    }, { once: true });

})();
</script>
<script>
// ==========================================
// كود تشغيل صوت فيديو اليوتيوب والتحكم به (للتطبيقات والويب)
// ==========================================
(function() {
    // 1. تعريف حالة الصوت (افتراضياً غير مكتوم)
    if (localStorage.getItem('bgVideoMuted') === null) {
        localStorage.setItem('bgVideoMuted', 'false');
    }

    // 2. حقن زر التحكم في قائمة الإعدادات (تبويب الصوت)
    setInterval(() => {
        const audioTab = document.querySelector('[data-tab-content="audio"]');
        if (audioTab && !document.getElementById('videoSoundSettingRow')) {
            const isMuted = localStorage.getItem('bgVideoMuted') === 'true';
            const settingHTML = `
                <div id="videoSoundSettingRow" class="flex items-center justify-between p-3 bg-white/5 rounded-lg mb-2">
                    <div class="flex flex-col">
                        <span class="font-medium">صوت فيديو الخلفية</span>
                        <span class="text-xs opacity-50">تشغيل الصوت للفيديو الحالي</span>
                    </div>
                    <div id="videoSoundToggle" class="toggle-switch ${!isMuted ? 'active' : ''}" 
                         onclick="toggleVideoSoundAction(this)">
                        <div class="toggle-switch-handle"></div>
                    </div>
                </div>`;
            audioTab.insertAdjacentHTML('beforeend', settingHTML);
        }
    }, 1000);

    // 3. دالة تبديل الصوت وتحديث الفيديو فوراً
    window.toggleVideoSoundAction = function(el) {
        el.classList.toggle('active');
        const shouldMute = !el.classList.contains('active');
        localStorage.setItem('bgVideoMuted', shouldMute);
        
        const ytIframe = document.getElementById('proYoutubeBackground');
        if (ytIframe && ytIframe.src) {
            let url = new URL(ytIframe.src);
            url.searchParams.set('mute', shouldMute ? '1' : '0');
            // إعادة تعيين المصدر لتحديث حالة الصوت فوراً
            ytIframe.src = url.toString();
        }
    };

    // 4. تعديل دالة التحميل لضمان عمل الصوت في التطبيقات (Desktop)
    const originalSetVideoSource = window.setVideoSource;
    window.setVideoSource = function(url) {
        if (!url) return;
        
        const ytIdMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
        const isMuted = localStorage.getItem('bgVideoMuted') === 'true';

        if (ytIdMatch) {
            const videoId = ytIdMatch[1];
            const ytIframe = document.getElementById('proYoutubeBackground');
            const vTag = document.getElementById('proVideoBackground');
            const container = document.getElementById('bgVideoContainer');

            vTag.style.display = 'none';
            ytIframe.style.display = 'block';
            
            // الرابط المطور ليعمل داخل التطبيقات dmg/msi مع تفعيل الصوت
            const desktopUrl = `https://www.youtube-nocookie.com/embed/${videoId}?` + 
                `autoplay=1&mute=${isMuted ? 1 : 0}&loop=1&playlist=${videoId}` +
                `&controls=0&showinfo=0&rel=0&enablejsapi=1&origin=${encodeURIComponent(window.location.origin)}`;
            
            ytIframe.src = desktopUrl;
            container.style.display = 'block';
        } else if (originalSetVideoSource) {
            originalSetVideoSource(url);
        }
    };

    // 5. حل مشكلة حظر الصوت التلقائي (Autoplay Policy)
    // المتصفحات تمنع الصوت حتى يلمس المستخدم الشاشة
    document.addEventListener('click', function() {
        const ytIframe = document.getElementById('proYoutubeBackground');
        const isMuted = localStorage.getItem('bgVideoMuted') === 'true';
        if (ytIframe && !isMuted) {
            // إرسال أمر تشغيل الصوت عبر API اليوتيوب
            ytIframe.contentWindow.postMessage('{"event":"command","func":"unMute","args":""}', '*');
            ytIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        }
    }, { once: true });

})();
</script>
</body>
</html> 
