<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProTimer ⏱️ - Professional Timer App</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProTimer">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-TileColor" content="#0f172a">
    
    <!-- Favicon for PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Roboto+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            background: var(--darker);
            color: var(--light);
            height: 100vh;
            width: 100vw;
            -webkit-overflow-scrolling: touch;
            transition: all 0.3s ease;
        }
        
        /* PWA Styles */
        @media (display-mode: standalone) {
            body {
                height: 100dvh;
                width: 100dvw;
            }
            
            .pwa-controls {
                display: none !important;
            }
            
            .control-panel {
                padding-bottom: max(16px, env(safe-area-inset-bottom)) !important;
            }
            
            #installPWAButton {
                display: none !important;
            }
            
            /* مميزات إضافية عند التثبيت كتطبيق */
            .pwa-feature {
                display: block !important;
            }
        }
        
        /* Safe Area Insets for Notch Devices */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes flash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(255, 65, 54, 0.3); }
        }
        
        @keyframes wipe {
            0% { 
                transform: translate(-50%, -50%) scale(0); 
                border-radius: 50%; 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(3); 
                border-radius: 0; 
                opacity: 1; 
            }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Utility Classes */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-bounce-slow { animation: bounce 2s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out; }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-out { animation: fadeOut 0.3s ease-out; }
        
        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Digit Styles */
        .digit {
            text-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.3),
                0 8px 16px rgba(0, 0, 0, 0.2),
                0 0 0 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .digit-interactive:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }
        
        .digit-interactive:active {
            transform: scale(0.95);
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Settings Panel */
        .settings-panel {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Tabs Container Scrollable */
        .tabs-container {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        
        .tabs-container::-webkit-scrollbar {
            display: none;
        }
        
        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            stroke-linecap: round;
            transition: stroke-dashoffset 0.35s;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            width: 60px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .toggle-switch.active {
            background: var(--secondary);
        }
        
        .toggle-switch-handle {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active .toggle-switch-handle {
            transform: translateX(28px);
        }
        
        /* Color Picker */
        .color-picker {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 10px;
        }
        
        /* Range Slider */
        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            border: 2px solid white;
        }
        
        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        /* علامات النقطتين مصممة بشكل أفضل */
        .time-separator {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            user-select: none;
            height: 100%;
            padding: 0 5px;
            position: relative;
        }
        
        .time-separator-dot {
            width: 8px;
            height: 8px;
            background-color: currentColor;
            border-radius: 50%;
            opacity: 0.8;
            margin: 4px 0;
        }
        
        /* تحسينات للشاشات المختلفة */
        .focus-mode .time-separator-dot {
            width: 12px;
            height: 12px;
            margin: 6px 0;
        }
        
        @media (max-width: 768px) {
            .time-separator-dot {
                width: 6px;
                height: 6px;
                margin: 3px 0;
            }
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        /* Card Styles */
        .card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* Tab Styles */
        .tab {
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            flex-shrink: 0;
            touch-action: manipulation;
        }
        
        .tab.active {
            background: rgba(99, 102, 241, 0.2);
            color: white;
            border: 1px solid rgba(99, 102, 241, 0.4);
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Input Styles */
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 16px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        
        /* Timer Finish Wipe */
        .wipe-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 100vh;
            height: 100vh;
            background: var(--danger);
            border-radius: 50%;
            z-index: 100;
            animation: wipe 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            pointer-events: none;
        }
        
        /* Finish Overlay */
        .finish-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--danger), #dc2626);
            z-index: 90;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Flashing Background */
        .flashing-bg {
            animation: flash 0.5s infinite alternate;
        }
        
        /* Media Background */
        .media-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            transition: opacity 0.5s ease;
        }
        
        /* Control Panel */
        .control-panel {
            background: linear-gradient(to top, rgba(2, 6, 23, 0.9), transparent);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            padding-bottom: 15px;
        }
        
        /* PWA Install Button */
        .pwa-install-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 40;
            animation: bounce 2s infinite;
        }
        
        /* Settings Panel Scrollable Content */
        .settings-content {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* نظام Flexbox محسن لمنع التزاحم */
        .timer-digits-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 100vw;
            overflow: hidden;
            padding: 10px 0;
        }
        
        .time-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            min-width: 100px;
        }
        
        .time-value {
            font-size: 4.5rem;
            line-height: 1;
            text-align: center;
            transition: all 0.3s ease;
            font-variant-numeric: tabular-nums;
            -moz-font-feature-settings: "tnum";
            -webkit-font-feature-settings: "tnum";
            font-feature-settings: "tnum";
            cursor: pointer;
            font-weight: 700;
            min-width: 110px;
        }
        
        .time-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .time-unit {
                min-width: 70px;
            }
            
            .time-value {
                font-size: 3.2rem;
                min-width: 80px;
            }
            
            .time-label {
                font-size: 0.75rem;
            }
            
            .time-separator-dot {
                width: 5px;
                height: 5px;
                margin: 2.5px 0;
            }
        }
        
        @media (max-width: 480px) {
            .time-unit {
                min-width: 60px;
            }
            
            .time-value {
                font-size: 2.8rem;
                min-width: 70px;
            }
            
            .time-label {
                font-size: 0.65rem;
            }
            
            .time-separator-dot {
                width: 4px;
                height: 4px;
                margin: 2px 0;
            }
        }
        
        /* تحسينات الفوكس مود - التايمر في المنتصف دائماً */
        .focus-mode .timer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 95vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .focus-mode .timer-digits-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            flex-wrap: nowrap;
        }
        
        .focus-mode .time-unit {
            min-width: auto;
            flex: 0 0 auto;
        }
        
        .focus-mode .time-value {
            font-size: 14vw !important;
            line-height: 1;
            min-width: auto;
            width: auto;
            margin: 0;
        }
        
        .focus-mode .time-label {
            font-size: 2vw !important;
            margin-top: 1vw;
            display: block;
        }
        
        .focus-mode .time-separator {
            margin: 0 2vw;
        }
        
        .focus-mode .time-separator-dot {
            width: 1.5vw !important;
            height: 1.5vw !important;
            margin: 0.8vw 0 !important;
        }
        
        .focus-mode .control-panel,
        .focus-mode #instructions,
        .focus-mode #quickAddButtons,
        .focus-mode .timer-title-section,
        .focus-mode .progress-container,
        .focus-mode .app-title,
        .focus-mode #timerStatus {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            transform: translateY(100%) !important;
            transition: all 0.3s ease;
        }
        
        /* إصلاح وقت النظام في الفوكس مود */
        .focus-mode .header-section .system-time {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            transform: none !important;
            position: fixed !important;
            top: 15px !important;
            right: 15px !important;
            z-index: 1000 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        /* إخفاء العنوان في الفوكس مود */
        .focus-mode .header-section .app-title {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        #focusModeToggle {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            z-index: 1000 !important;
            background: rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 50% !important;
            width: 60px !important;
            height: 60px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
            animation: pulse 2s infinite !important;
        }
        
        #focusModeToggle:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            transform: scale(1.1) !important;
        }
        
        /* Minimized Controls */
        .minimized-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(100%);
            transition: all 0.3s ease;
        }
        
        .minimized-controls.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .minimized-controls .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }
        
        .minimized-controls .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .minimized-controls .control-btn:active {
            transform: scale(0.95);
        }
        
        /* تحسينات التناسق العامة */
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .header-section {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
            min-height: 70px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 10px 20px;
            position: relative;
            z-index: 10;
            overflow: hidden;
            min-height: 0;
        }
        
        .timer-display-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .progress-container {
            margin: 10px 0;
            position: relative;
            width: 140px;
            height: 140px;
            flex-shrink: 0;
        }
        
        .timer-title-section {
            margin-bottom: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .quick-add-section {
            margin-bottom: 10px;
            width: 100%;
            max-width: 600px;
            flex-shrink: 0;
        }
        
        .instructions-section {
            margin-top: 10px;
            width: 100%;
            max-width: 800px;
            flex-shrink: 0;
        }
        
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            flex-shrink: 0;
        }
        
        /* تحسينات لمنع التزاحم */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        
        .non-scrollable {
            flex-shrink: 0;
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover, .btn-secondary:hover, .tab:hover, .card:hover {
                transform: none;
            }
            
            .digit-interactive:hover {
                transform: none;
            }
        }
        
        /* Custom Alert Styles */
        .swal2-popup {
            background: var(--darker) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 16px !important;
        }
        
        .swal2-title {
            color: var(--light) !important;
        }
        
        .swal2-html-container {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .swal2-confirm {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
            border-radius: 12px !important;
        }
        
        .swal2-deny {
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 12px !important;
            color: white !important;
        }
        
        /* مميزات إضافية عند التثبيت كتطبيق */
        .pwa-feature {
            display: none;
        }
        
        /* تحسينات للموبايل */
        .touch-feedback:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        /* Keyboard Shortcut Help */
        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 2px 6px;
            margin: 0 2px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
        
        /* Font Upload Styles */
        .font-upload-container {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .font-upload-container:hover {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .font-upload-container.drag-over {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .font-preview {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .font-preview-text {
            font-size: 24px;
            text-align: center;
            padding: 10px;
        }
        
        /* Uploaded Fonts List */
        .uploaded-fonts-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .font-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .font-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .font-item.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
        }
        
        .font-actions {
            display: flex;
            gap: 10px;
        }
        
        .font-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .font-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .font-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* تحسين تناسق عناصر التحكم */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 800px;
        }
        
        .control-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        /* التمرير السلس */
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        /* ضبط تباعد أزرار الكويك أد */
        .quick-add-section .flex {
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-add-section button {
            padding: 8px 12px;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        /* إصلاحات للعرض العام */
        .timer-digits-container > * {
            flex-shrink: 0;
        }
        
        /* ضبط الحجم في الوضع العادي */
        @media (min-width: 769px) {
            .time-value {
                font-size: 5rem !important;
                min-width: 120px !important;
            }
        }
        
        /* إصلاح مشكلة تحميل الخطوط */
        @font-face {
            font-family: 'DigitalFont';
            src: local('Arial');
        }
        
        /* تصميم أزرار المطورين */
        .developer-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .developer-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }
        
        .developer-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .developer-role {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 10px;
        }
        
        .developer-contact-btn {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(37, 211, 102, 0.2);
            border: 1px solid rgba(37, 211, 102, 0.3);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .developer-contact-btn:hover {
            background: rgba(37, 211, 102, 0.3);
            transform: translateY(-1px);
        }
        
        .whatsapp-icon {
            color: #25D366;
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="h-screen w-screen overflow-hidden relative">
        <!-- Media Background -->
        <div id="mediaBackground" class="media-bg opacity-0 transition-opacity duration-500">
            <!-- Background image/video will be inserted here -->
        </div>
        
        <!-- Header Section -->
        <div class="header-section">
            <!-- App Title -->
            <div class="app-title glass rounded-2xl px-4 py-2">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-stopwatch text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">ProTimer ⏱️</h1>
                        <p class="text-xs opacity-60">Professional Timer</p>
                    </div>
                </div>
            </div>
            
            <!-- Current Time -->
            <div class="system-time glass rounded-2xl px-4 py-2 text-center">
                <div id="currentTime" class="font-mono font-bold">00:00:00 PM</div>
                <div class="text-xs opacity-60">SYSTEM TIME</div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Timer Title -->
            <div class="timer-title-section">
                <div id="timerTitle" class="text-3xl md:text-4xl font-bold gradient-text">PROFESSIONAL TIMER</div>
            </div>
            
            <!-- Timer Display Section -->
            <div class="timer-display-section">
                <!-- Progress Ring -->
                <div class="progress-container">
                    <svg class="progress-ring w-full h-full" width="140" height="140">
                        <circle class="progress-ring-circle" 
                                stroke="rgba(99, 102, 241, 0.3)" 
                                stroke-width="8" 
                                fill="transparent" 
                                r="60" 
                                cx="70" 
                                cy="70" />
                        <circle id="progressCircle" 
                                class="progress-ring-circle" 
                                stroke="#6366f1" 
                                stroke-width="8" 
                                fill="transparent" 
                                r="60" 
                                cx="70" 
                                cy="70"
                                stroke-dasharray="377"
                                stroke-dashoffset="377" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div id="progressText" class="text-xl font-bold">100%</div>
                    </div>
                </div>
                
                <!-- Timer Digits -->
                <div class="timer-container">
                    <div id="timerDigitsContainer" class="timer-digits-container">
                        <!-- ساعة -->
                        <div class="time-unit">
                            <div id="hoursDisplay" 
                                 class="time-value cursor-pointer transition-all duration-300 hover:scale-105 active:scale-95"
                                 onclick="adjustTime('hours', 1)"
                                 ontouchstart="handleTouchStart(this, 'hours', 1)"
                                 ontouchend="handleTouchEnd(this)">
                                00
                            </div>
                            <div class="time-label"></div>
                        </div>
                        
                        <!-- النقطة الأولى -->
                        <div class="time-separator">
                            <div class="time-separator-dot"></div>
                            <div class="time-separator-dot"></div>
                        </div>
                        
                        <!-- دقائق -->
                        <div class="time-unit">
                            <div id="minutesDisplay" 
                                 class="time-value cursor-pointer transition-all duration-300 hover:scale-105 active:scale-95"
                                 onclick="adjustTime('minutes', 1)"
                                 ontouchstart="handleTouchStart(this, 'minutes', 1)"
                                 ontouchend="handleTouchEnd(this)">
                                10
                            </div>
                            <div class="time-label"></div>
                        </div>
                        
                        <!-- النقطة الثانية -->
                        <div class="time-separator">
                            <div class="time-separator-dot"></div>
                            <div class="time-separator-dot"></div>
                        </div>
                        
                        <!-- ثواني -->
                        <div class="time-unit">
                            <div id="secondsDisplay" 
                                 class="time-value cursor-pointer transition-all duration-300 hover:scale-105 active:scale-95"
                                 onclick="adjustTime('seconds', 1)"
                                 ontouchstart="handleTouchStart(this, 'seconds', 1)"
                                 ontouchend="handleTouchEnd(this)">
                                00
                            </div>
                            <div class="time-label"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Add Minutes Buttons -->
            <div id="quickAddButtons" class="quick-add-section glass rounded-2xl px-6 py-4 animate-fade-in mx-4">
                <div class="flex items-center justify-center gap-3 md:gap-4">
                    <span class="opacity-80 font-medium mr-2">Quick Add:</span>
                    <button onclick="addMinutes(1)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +1 min
                    </button>
                    <button onclick="addMinutes(5)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +5 min
                    </button>
                    <button onclick="addMinutes(10)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +10 min
                    </button>
                    <button onclick="addMinutes(15)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +15 min
                    </button>
                    <button onclick="addMinutes(30)" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors touch-feedback">
                        +30 min
                    </button>
                </div>
            </div>
            
            <!-- Timer Status -->
            <div id="timerStatus" class="text-center mt-2 text-lg opacity-80">
                <div class="flex items-center justify-center gap-3">
                    <i class="fas fa-info-circle"></i>
                    <span>Timer is ready. Set your time and press START.</span>
                </div>
            </div>
            
            <!-- Instructions -->
            <div id="instructions" class="instructions-section glass rounded-2xl px-4 py-3 animate-fade-in mx-4">
                <div class="flex flex-wrap items-center justify-center gap-3 text-sm md:text-base">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-keyboard text-xs"></i>
                        </div>
                        <span><span class="shortcut-key">SPACE</span> Start/Pause</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-mouse-pointer text-xs"></i>
                        </div>
                        <span>CLICK to Add Time</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-eye text-xs"></i>
                        </div>
                        <span><span class="shortcut-key">F</span> Focus Mode</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel absolute bottom-0 left-0 right-0 p-4 z-20">
            <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4">
                <!-- Start/Pause Button -->
                <button id="startPauseBtn" 
                        class="btn-primary flex items-center gap-3 animate-glow touch-feedback"
                        onclick="toggleTimer()">
                    <i class="fas fa-play text-lg"></i>
                    <span class="text-lg font-semibold">START TIMER</span>
                </button>
                
                <!-- Reset Button -->
                <button id="resetBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="confirmReset()">
                    <i class="fas fa-redo text-lg"></i>
                    <span>RESET</span>
                </button>
                
                <!-- Add Minute Button -->
                <button id="addMinuteBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="addMinutes(1)">
                    <i class="fas fa-plus text-lg"></i>
                    <span>+1 MIN</span>
                </button>
                
                <!-- Settings Button -->
                <button id="settingsBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="toggleSettings()">
                    <i class="fas fa-cog text-lg"></i>
                    <span>SETTINGS</span>
                </button>
                
                <!-- Fullscreen Button -->
                <button id="fullscreenBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="toggleFullscreen()">
                    <i class="fas fa-expand text-lg"></i>
                    <span>FULLSCREEN</span>
                </button>
                
                <!-- Sound Toggle -->
                <button id="soundToggleBtn" 
                        class="btn-secondary flex items-center gap-3 touch-feedback"
                        onclick="toggleSound()">
                    <i id="soundIcon" class="fas fa-volume-up text-lg"></i>
                    <span id="soundText">SOUND ON</span>
                </button>
                
                <!-- Focus Mode Toggle -->
                <!-- تم التعديل هنا: إزالة النص وإبقاء الأيقونة فقط -->
                <button id="focusModeToggle" 
                        class="btn-secondary flex items-center justify-center gap-0 touch-feedback"
                        onclick="toggleFocusMode()">
                    <i id="focusIcon" class="fas fa-eye text-lg"></i>
                </button>
            </div>
            
            <!-- Keyboard Shortcuts Help (Collapsible) -->
            <div class="mt-2 text-center">
                <button onclick="toggleShortcutsHelp()" class="text-sm opacity-60 hover:opacity-100 transition-opacity">
                    <i class="fas fa-keyboard mr-1"></i> All Keyboard Shortcuts
                </button>
                <div id="shortcutsHelp" class="hidden mt-2 glass rounded-lg p-3 text-xs">
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="shortcut-key">SPACE</span> Start/Pause</div>
                        <div><span class="shortcut-key">R</span> Reset Timer</div>
                        <div><span class="shortcut-key">+</span> Add 1 min</div>
                        <div><span class="shortcut-key">-</span> Subtract 1 min</div>
                        <div><span class="shortcut-key">0-9</span> Quick Presets</div>
                        <div><span class="shortcut-key">:</span> Manual Time Input</div>
                        <div><span class="shortcut-key">F</span> Toggle Focus Mode</div>
                        <div><span class="shortcut-key">F11</span> Fullscreen</div>
                        <div><span class="shortcut-key">ESC</span> Close Panels</div>
                        <div><span class="shortcut-key">Ctrl+S</span> Save Preset</div>
                        <div><span class="shortcut-key">Ctrl+O</span> Open Settings</div>
                        <div><span class="shortcut-key">Ctrl+I</span> Manual Input</div>
                        <div><span class="shortcut-key">H</span> Show Shortcuts</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Minimized Controls (Hidden by default) -->
        <div id="minimizedControls" class="minimized-controls">
            <button id="minimizedStartPause" class="control-btn" onclick="toggleTimer()">
                <i class="fas fa-play"></i>
            </button>
            <button id="minimizedReset" class="control-btn" onclick="confirmReset()">
                <i class="fas fa-redo"></i>
            </button>
            <button id="minimizedSettings" class="control-btn" onclick="toggleSettings()">
                <i class="fas fa-cog"></i>
            </button>
            <button id="minimizedFocus" class="control-btn" onclick="toggleFocusMode()">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        
        <!-- PWA Install Button -->
        <button id="installPWAButton" class="fixed bottom-24 right-6 z-40 btn-primary shadow-lg flex items-center gap-2 pwa-install-btn hidden">
            <i class="fas fa-download"></i>
            <span>Install App</span>
        </button>
        
        <!-- Settings Panel -->
        <div id="settingsPanel" class="settings-panel fixed inset-y-0 right-0 w-full md:w-1/3 lg:w-1/4 glass-dark z-30 transform translate-x-full transition-transform duration-300 overflow-hidden">
            <div class="h-full flex flex-col">
                <!-- Header -->
                <div class="p-6 border-b border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">Timer Settings</h2>
                            <p class="opacity-60">Customize your experience</p>
                        </div>
                        <button onclick="toggleSettings()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors touch-feedback">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Tabs Container (Scrollable) -->
                <div class="tabs-container px-6 pt-4">
                    <button data-tab="timer" class="tab active" onclick="switchTab('timer')">
                        <i class="fas fa-clock mr-2"></i> Timer
                    </button>
                    <button data-tab="appearance" class="tab" onclick="switchTab('appearance')">
                        <i class="fas fa-palette mr-2"></i> Appearance
                    </button>
                    <button data-tab="fonts" class="tab" onclick="switchTab('fonts')">
                        <i class="fas fa-font mr-2"></i> Fonts
                    </button>
                    <button data-tab="media" class="tab" onclick="switchTab('media')">
                        <i class="fas fa-photo-video mr-2"></i> Media
                    </button>
                    <button data-tab="audio" class="tab" onclick="switchTab('audio')">
                        <i class="fas fa-volume-up mr-2"></i> Audio
                    </button>
                    <button data-tab="advanced" class="tab" onclick="switchTab('advanced')">
                        <i class="fas fa-cogs mr-2"></i> Advanced
                    </button>
                    <!-- Scroll indicator -->
                    <div class="flex items-center px-2 opacity-50">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                
                <!-- Tab Content (Scrollable) -->
                <div class="settings-content flex-1 overflow-y-auto px-6 smooth-scroll">
                    <div id="tabContent" class="space-y-6 pb-6">
                        <!-- Timer Tab -->
                        <div data-tab-content="timer" class="tab-content active">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-hourglass-start"></i> Timer Duration
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Hours -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Hours</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="hoursSlider" min="0" max="23" value="0" class="range-slider flex-1">
                                                <input type="number" id="hoursInput" min="0" max="23" value="0" class="input-field w-20 text-center">
                                            </div>
                                        </div>
                                        
                                        <!-- Minutes -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Minutes</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="minutesSlider" min="0" max="59" value="10" class="range-slider flex-1">
                                                <input type="number" id="minutesInput" min="0" max="59" value="10" class="input-field w-20 text-center">
                                            </div>
                                        </div>
                                        
                                        <!-- Seconds -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Seconds</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="secondsSlider" min="0" max="59" value="0" class="range-slider flex-1">
                                                <input type="number" id="secondsInput" min="0" max="59" value="0" class="input-field w-20 text-center">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-flag-checkered"></i> Finish Message
                                    </h3>
                                    <input type="text" id="finishMessage" value="Time's Up!" class="input-field" placeholder="Enter finish message...">
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-bolt"></i> Quick Presets
                                    </h3>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="setQuickPreset(1)" class="btn-secondary py-3 touch-feedback">1 min</button>
                                        <button onclick="setQuickPreset(5)" class="btn-secondary py-3 touch-feedback">5 min</button>
                                        <button onclick="setQuickPreset(10)" class="btn-secondary py-3 touch-feedback">10 min</button>
                                        <button onclick="setQuickPreset(15)" class="btn-secondary py-3 touch-feedback">15 min</button>
                                        <button onclick="setQuickPreset(30)" class="btn-secondary py-3 touch-feedback">30 min</button>
                                        <button onclick="setQuickPreset(60)" class="btn-secondary py-3 touch-feedback">1 hour</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Appearance Tab -->
                        <div data-tab-content="appearance" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-fill-drip"></i> Colors
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Background Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Background Color</label>
                                            <input type="color" id="bgColor" value="#0f172a" class="color-picker">
                                        </div>
                                        
                                        <!-- Text Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Digit Color</label>
                                            <input type="color" id="textColor" value="#ffffff" class="color-picker">
                                        </div>
                                        
                                        <!-- Outline Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Outline Color</label>
                                            <input type="color" id="outlineColor" value="#000000" class="color-picker">
                                        </div>
                                        
                                        <!-- Progress Color -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Progress Ring Color</label>
                                            <input type="color" id="progressColor" value="#6366f1" class="color-picker">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-brush"></i> Outline Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Outline Toggle -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Enable Outline</span>
                                            <div id="outlineToggle" class="toggle-switch" onclick="toggleOutline()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Outline Thickness -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Outline Thickness: <span id="outlineThicknessValue">2</span>px</label>
                                            <input type="range" id="outlineThickness" min="1" max="10" value="2" class="range-slider">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-adjust"></i> Opacity Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Background Opacity -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Background Opacity: <span id="bgOpacityValue">100</span>%</label>
                                            <input type="range" id="bgOpacity" min="20" max="100" value="100" class="range-slider">
                                        </div>
                                        
                                        <!-- Control Panel Opacity -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Control Panel Opacity: <span id="panelOpacityValue">90</span>%</label>
                                            <input type="range" id="panelOpacity" min="50" max="100" value="90" class="range-slider">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fonts Tab -->
                        <div data-tab-content="fonts" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-font"></i> Font Settings
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Font Family -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Font Family</label>
                                            <select id="fontFamily" class="input-field">
                                                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                                                <option value="'Inter', sans-serif">Inter</option>
                                                <option value="'Orbitron', sans-serif">Orbitron (Digital)</option>
                                                <option value="'Roboto Mono', monospace">Roboto Mono</option>
                                                <option value="'Segoe UI', sans-serif">Segoe UI</option>
                                                <option value="Arial, sans-serif">Arial</option>
                                                <option value="'Courier New', monospace">Courier New</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Font Size -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Digit Size: <span id="fontSizeValue">12</span>rem</label>
                                            <input type="range" id="fontSize" min="8" max="20" value="12" class="range-slider">
                                        </div>
                                        
                                        <!-- Font Weight -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Font Weight</label>
                                            <select id="fontWeight" class="input-field">
                                                <option value="400">Normal</option>
                                                <option value="600">Semibold</option>
                                                <option value="700" selected>Bold</option>
                                                <option value="800">Extra Bold</option>
                                                <option value="900">Black</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-upload"></i> Upload Custom Fonts
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Font Upload Area -->
                                        <div id="fontUploadArea" class="font-upload-container" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleFontDrop(event)">
                                            <i class="fas fa-cloud-upload-alt text-4xl opacity-50 mb-4"></i>
                                            <h4 class="text-lg font-semibold mb-2">Drag & Drop Font Files</h4>
                                            <p class="opacity-70 mb-4">Supports: .ttf, .otf, .woff, .woff2</p>
                                            <button onclick="document.getElementById('fontFileInput').click()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-folder-open mr-2"></i> Browse Files
                                            </button>
                                            <input type="file" id="fontFileInput" accept=".ttf,.otf,.woff,.woff2" multiple class="hidden" onchange="handleFontFileSelect(event)">
                                        </div>
                                        
                                        <!-- Uploaded Fonts -->
                                        <div class="mt-4">
                                            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
                                                <i class="fas fa-font-case"></i> Uploaded Fonts
                                            </h4>
                                            <div id="uploadedFontsList" class="uploaded-fonts-list">
                                                <!-- Uploaded fonts will be listed here -->
                                                <div class="text-center py-8 opacity-50">
                                                    <i class="fas fa-font text-3xl mb-3"></i>
                                                    <p>No custom fonts uploaded yet</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Font Preview -->
                                        <div id="fontPreviewContainer" class="hidden">
                                            <h4 class="text-lg font-semibold mb-3">Font Preview</h4>
                                            <div class="font-preview">
                                                <div id="fontPreviewText" class="font-preview-text" style="font-size: 24px;">
                                                    00:10:00
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Media Tab -->
                        <div data-tab-content="media" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-image"></i> Background Media
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Media Toggle -->
                                        <div class="flex items-center justify-between mb-4">
                                            <span class="opacity-80">Enable Background Media</span>
                                            <div id="mediaToggle" class="toggle-switch" onclick="toggleMedia()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Media Type -->
                                        <div class="space-y-4">
                                            <!-- URL Input -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Media URL</label>
                                                <div class="flex gap-2">
                                                    <input type="text" id="mediaUrl" placeholder="Enter image/video URL..." class="input-field flex-1">
                                                    <button onclick="testMedia()" class="btn-secondary whitespace-nowrap touch-feedback">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </div>
                                                <p class="text-xs opacity-50 mt-1">Supports: JPG, PNG, GIF, MP4, WebM</p>
                                            </div>
                                            
                                            <!-- File Upload -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Upload Local File</label>
                                                <div class="flex gap-2">
                                                    <input type="file" id="mediaFile" accept="image/*,video/*" class="hidden">
                                                    <button onclick="document.getElementById('mediaFile').click()" class="btn-secondary flex-1 touch-feedback">
                                                        <i class="fas fa-upload mr-2"></i> Choose File
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Remove Media Button -->
                                            <div>
                                                <button onclick="removeMedia()" class="btn-secondary w-full text-red-300 border-red-500/30 touch-feedback">
                                                    <i class="fas fa-trash-alt mr-2"></i> Remove Current Media
                                                </button>
                                            </div>
                                            
                                            <!-- Media Audio -->
                                            <div class="flex items-center justify-between pt-4 border-t border-white/10">
                                                <span class="opacity-80">Enable Media Audio</span>
                                                <div id="mediaAudioToggle" class="toggle-switch" onclick="toggleMediaAudio()">
                                                    <div class="toggle-switch-handle"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- Media Opacity -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Media Opacity: <span id="mediaOpacityValue">30</span>%</label>
                                                <input type="range" id="mediaOpacity" min="10" max="100" value="30" class="range-slider">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Media Preview -->
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-eye"></i> Preview
                                    </h3>
                                    <div id="mediaPreview" class="aspect-video bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden">
                                        <div class="text-center p-4">
                                            <i class="fas fa-image text-4xl opacity-30 mb-2"></i>
                                            <p class="opacity-50">No media selected</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audio Tab -->
                        <div data-tab-content="audio" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-music"></i> Soundtrack
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Audio Toggle -->
                                        <div class="flex items-center justify-between mb-4">
                                            <span class="opacity-80">Enable Soundtrack</span>
                                            <div id="audioToggle" class="toggle-switch" onclick="toggleAudio()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Audio Source -->
                                        <div class="space-y-4">
                                            <!-- URL Input -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Audio URL</label>
                                                <div class="flex gap-2">
                                                    <input type="text" id="audioUrl" placeholder="Enter audio URL..." class="input-field flex-1">
                                                    <button onclick="testAudio()" class="btn-secondary whitespace-nowrap touch-feedback">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- File Upload -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Upload Audio File</label>
                                                <div class="flex gap-2">
                                                    <input type="file" id="audioFile" accept="audio/*" class="hidden">
                                                    <button onclick="document.getElementById('audioFile').click()" class="btn-secondary flex-1 touch-feedback">
                                                        <i class="fas fa-upload mr-2"></i> Choose File
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Remove Audio Button -->
                                            <div>
                                                <button onclick="removeAudio()" class="btn-secondary w-full text-red-300 border-red-500/30 touch-feedback">
                                                    <i class="fas fa-trash-alt mr-2"></i> Remove Current Audio
                                                </button>
                                            </div>
                                            
                                            <!-- Volume Control -->
                                            <div>
                                                <label class="block mb-2 opacity-80">Volume: <span id="volumeValue">50</span>%</label>
                                                <input type="range" id="volumeSlider" min="0" max="100" value="50" class="range-slider">
                                            </div>
                                            
                                            <!-- Loop Control -->
                                            <div class="flex items-center justify-between">
                                                <span class="opacity-80">Loop Audio</span>
                                                <div id="loopToggle" class="toggle-switch active" onclick="toggleLoop()">
                                                    <div class="toggle-switch-handle"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-bell"></i> Alert Sounds
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Tick Sound -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Tick Sound (Last 10s)</span>
                                            <div id="tickToggle" class="toggle-switch" onclick="toggleTickSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Finish Sound -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Finish Sound</span>
                                            <div id="finishSoundToggle" class="toggle-switch active" onclick="toggleFinishSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Finish Sound Selector -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Finish Sound</label>
                                            <select id="finishSound" class="input-field">
                                                <option value="bell">Bell</option>
                                                <option value="alarm">Alarm</option>
                                                <option value="beep">Beep</option>
                                                <option value="chime">Chime</option>
                                                <option value="horn">Horn</option>
                                                <option value="digital">Digital Beep</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Click Sound -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Click Sound</span>
                                            <div id="clickSoundToggle" class="toggle-switch" onclick="toggleClickSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Warning Sound (Last 30s) -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Warning Sound (Last 30s)</span>
                                            <div id="warningSoundToggle" class="toggle-switch active" onclick="toggleWarningSound()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Warning Sound Selector -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Warning Sound</label>
                                            <select id="warningSound" class="input-field">
                                                <option value="tick">Tick</option>
                                                <option value="beep">Soft Beep</option>
                                                <option value="ping">Ping</option>
                                                <option value="click">Click</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Tab -->
                        <div data-tab-content="advanced" class="tab-content hidden">
                            <div class="space-y-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-magic"></i> Features
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Wake Lock -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Keep Screen Awake</span>
                                            <div id="wakeLockToggle" class="toggle-switch" onclick="toggleWakeLock()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Auto Start -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Auto-start on Load</span>
                                            <div id="autoStartToggle" class="toggle-switch" onclick="toggleAutoStart()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Countdown Flash -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Countdown Flash (last 10s)</span>
                                            <div id="flashToggle" class="toggle-switch active" onclick="toggleFlash()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Show Milliseconds -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Show Milliseconds</span>
                                            <div id="millisecondsToggle" class="toggle-switch" onclick="toggleMilliseconds()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Vibrate on Finish -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Vibrate on Finish</span>
                                            <div id="vibrateToggle" class="toggle-switch active" onclick="toggleVibrate()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Focus Mode Auto-hide -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Auto-hide in Focus Mode</span>
                                            <div id="focusAutoHideToggle" class="toggle-switch active" onclick="toggleFocusAutoHide()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Minimized Controls -->
                                        <div class="flex items-center justify-between">
                                            <span class="opacity-80">Show Minimized Controls</span>
                                            <div id="minimizedControlsToggle" class="toggle-switch active" onclick="toggleMinimizedControls()">
                                                <div class="toggle-switch-handle"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-save"></i> Save & Load
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Preset Name -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Preset Name</label>
                                            <input type="text" id="presetName" placeholder="My Timer Preset" class="input-field">
                                        </div>
                                        
                                        <!-- Preset Actions -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="savePreset()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-save mr-2"></i> Save
                                            </button>
                                            <button onclick="loadPreset()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-folder-open mr-2"></i> Load
                                            </button>
                                        </div>
                                        
                                        <!-- Preset List -->
                                        <div>
                                            <label class="block mb-2 opacity-80">Saved Presets</label>
                                            <select id="presetList" class="input-field">
                                                <option value="">Select a preset...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Export/Import -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="exportSettings()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-download mr-2"></i> Export
                                            </button>
                                            <button onclick="importSettings()" class="btn-secondary touch-feedback">
                                                <i class="fas fa-upload mr-2"></i> Import
                                            </button>
                                        </div>
                                        
                                        <!-- Reset All -->
                                        <button onclick="resetAllSettings()" class="btn-secondary w-full mt-4 text-red-300 border-red-500/30 touch-feedback">
                                            <i class="fas fa-trash-alt mr-2"></i> Reset All Settings
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <i class="fas fa-code"></i> About
                                    </h3>
                                    <div class="space-y-4">
                                        <div class="flex justify-between">
                                            <span class="opacity-80">Version</span>
                                            <span>2.0.1</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="opacity-80">Developers</span>
                                            <span class="gradient-text font-bold">Ahmed & Abdalrahman</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="opacity-80">License</span>
                                            <span>MIT</span>
                                        </div>
                                        
                                        <!-- قسم المطورين مع روابط الاتصال -->
                                        <div class="mt-4 pt-4 border-t border-white/10">
                                            <h4 class="text-lg font-semibold mb-3">Contact Developers</h4>
                                            
                                            <!-- مطور: عبدالرحمن -->
                                            <div class="developer-card">
                                                <div class="developer-name">Abdalrahman</div>
                                                <div class="developer-role">Developer</div>
                                                <button onclick="contactDeveloper('abdalrahman')" class="developer-contact-btn touch-feedback">
                                                    <i class="fab fa-whatsapp whatsapp-icon"></i>
                                                    Contact on WhatsApp
                                                </button>
                                            </div>
                                            
                                            <!-- مطور: أحمد -->
                                            <div class="developer-card">
                                                <div class="developer-name">Ahmed</div>
                                                <div class="developer-role">Developer</div>
                                                <button onclick="contactDeveloper('ahmed')" class="developer-contact-btn touch-feedback">
                                                    <i class="fab fa-whatsapp whatsapp-icon"></i>
                                                    Contact on WhatsApp
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="pt-4 border-t border-white/10">
                                            <p class="text-sm opacity-60">Professional Timer App with PWA support and advanced features.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="p-6 border-t border-white/10">
                    <div class="flex gap-3">
                        <button onclick="applySettings()" class="btn-primary flex-1 touch-feedback">
                            <i class="fas fa-check mr-2"></i> Apply Settings
                        </button>
                        <button onclick="toggleSettings()" class="btn-secondary touch-feedback">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Finish Overlay -->
        <div id="finishOverlay" class="finish-overlay hidden">
            <div class="text-center p-8 max-w-4xl">
                <h1 id="finishMessageDisplay" class="text-6xl md:text-8xl font-bold mb-8 animate-bounce-slow">TIME'S UP!</h1>
                <p class="text-2xl mb-12 opacity-90">The timer has completed successfully</p>
                <div class="flex flex-wrap gap-4 justify-center">
                    <button onclick="resetTimer()" class="btn-primary text-2xl px-10 py-5 touch-feedback">
                        <i class="fas fa-redo mr-3"></i> RESTART TIMER
                    </button>
                    <button onclick="closeFinishOverlay()" class="btn-secondary text-2xl px-10 py-5 touch-feedback">
                        <i class="fas fa-times mr-3"></i> CLOSE
                    </button>
                </div>
                <div class="mt-12 text-xl opacity-70">
                    <p>Press SPACE or TAP to start a new timer</p>
                </div>
            </div>
        </div>
        
        <!-- Wipe Effect -->
        <div id="wipeEffect" class="wipe-effect hidden"></div>
        
        <!-- Toast Notifications -->
        <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-3 max-w-md"></div>
        
        <!-- Keyboard Time Input Overlay -->
        <div id="keyboardInputOverlay" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-4">Enter Time Manually</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block mb-2 opacity-80">Time (HH:MM:SS)</label>
                        <input type="text" id="manualTimeInput" 
                               placeholder="00:10:00" 
                               class="input-field text-center text-2xl font-mono"
                               value="00:10:00">
                        <p class="text-sm opacity-50 mt-2">Format: Hours:Minutes:Seconds</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="applyManualTime()" class="btn-primary flex-1 touch-feedback">
                        <i class="fas fa-check mr-2"></i> Set Time
                    </button>
                    <button onclick="closeKeyboardInput()" class="btn-secondary touch-feedback">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ============================================
        // PWA & INSTALLATION HANDLING
        // ============================================
        let deferredPrompt;
        let isPWAInstalled = false;
        
        // Check if app is installed as PWA
        function checkPWAInstallation() {
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                isPWAInstalled = true;
                document.getElementById('installPWAButton').classList.add('hidden');
                document.body.classList.add('pwa-installed');
                
                // Show PWA installed indicator
                const pwaFeatures = document.querySelectorAll('.pwa-feature');
                pwaFeatures.forEach(feature => feature.style.display = 'flex');
                
                // Register service worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered with scope:', registration.scope);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            }
        }
        
        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button if not already installed
            if (!isPWAInstalled) {
                setTimeout(() => {
                    document.getElementById('installPWAButton').classList.remove('hidden');
                }, 3000);
            }
        });
        
        // Install PWA
        function installPWA() {
            if (!deferredPrompt) {
                showToast('App installation is not available', 'warning');
                return;
            }
            
            deferredPrompt.prompt();
            
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    showToast('App installed successfully!', 'success');
                    isPWAInstalled = true;
                    document.getElementById('installPWAButton').classList.add('hidden');
                    
                    // Show PWA features
                    const pwaFeatures = document.querySelectorAll('.pwa-feature');
                    pwaFeatures.forEach(feature => feature.style.display = 'flex');
                } else {
                    showToast('App installation cancelled', 'info');
                }
                deferredPrompt = null;
            });
        }
        
        // Detect app installed
        window.addEventListener('appinstalled', () => {
            isPWAInstalled = true;
            document.getElementById('installPWAButton').classList.add('hidden');
            showToast('ProTimer installed successfully!', 'success');
            
            // Show PWA features
            const pwaFeatures = document.querySelectorAll('.pwa-feature');
            pwaFeatures.forEach(feature => feature.style.display = 'flex');
        });
        
        // Attach install function to button
        document.getElementById('installPWAButton').addEventListener('click', installPWA);
        
        // ============================================
        // APPLICATION STATE & CONFIGURATION
        // ============================================
        const APP_STATE = {
            // Timer State
            hours: 0,
            minutes: 10,
            seconds: 0,
            totalSeconds: 600,
            remainingSeconds: 600,
            originalHours: 0,
            originalMinutes: 10,
            originalSeconds: 0,
            isRunning: false,
            isPaused: false,
            isFinished: false,
            timerInterval: null,
            
            // Focus Mode State
            focusMode: false,
            focusModeAutoHide: true,
            showMinimizedControls: true,
            
            // Touch state for mobile
            touchTimer: null,
            touchElement: null,
            touchType: null,
            touchAmount: 0,
            
            // Audio State - تم التصحيح
            audioEnabled: true,
            audioContext: null,
            tickSoundEnabled: true,
            finishSoundEnabled: true,
            clickSoundEnabled: true,
            warningSoundEnabled: true,
            backgroundAudio: null,
            backgroundAudioEnabled: false,
            backgroundAudioVolume: 0.5,
            lastTickTime: 0,
            lastWarningTime: 0,
            
            // Font State
            uploadedFonts: {},
            currentFont: "'JetBrains Mono', monospace",
            
            // Settings - تم التصحيح
            settings: {
                // Appearance
                bgColor: '#0f172a',
                textColor: '#ffffff',
                outlineColor: '#000000',
                progressColor: '#6366f1',
                outlineEnabled: false,
                outlineThickness: 2,
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: 12,
                fontWeight: 700,
                bgOpacity: 100,
                panelOpacity: 90,
                
                // Media
                mediaEnabled: false,
                mediaUrl: '',
                mediaType: '',
                mediaAudioEnabled: false,
                mediaOpacity: 30,
                
                // Audio - تم التصحيح
                audioEnabled: false,
                audioUrl: '',
                audioLoop: true,
                audioVolume: 50,
                
                // Timer
                finishMessage: "Time's Up!",
                flashEnabled: true,
                wakeLockEnabled: false,
                autoStart: false,
                showMilliseconds: false,
                vibrateOnFinish: true,
                focusAutoHide: true,
                minimizedControls: true,
                
                // Sounds - تم التصحيح
                finishSound: 'bell',
                tickSound: true,
                clickSound: true,
                warningSound: 'tick',
                warningSoundEnabled: true,
                finishSoundEnabled: true
            },
            
            // Presets
            presets: {},
            currentPreset: null,
            
            // System
            wakeLock: null,
            lastSaveTime: 0,
            isFullscreen: false,
            keyboardInputBuffer: '',
            keyboardInputTimeout: null,
            minimizedControlsVisible: false,
            minimizedControlsTimeout: null
        };
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            // Timer Display
            hoursDisplay: document.getElementById('hoursDisplay'),
            minutesDisplay: document.getElementById('minutesDisplay'),
            secondsDisplay: document.getElementById('secondsDisplay'),
            
            // Progress
            progressCircle: document.getElementById('progressCircle'),
            progressText: document.getElementById('progressText'),
            
            // Controls
            startPauseBtn: document.getElementById('startPauseBtn'),
            resetBtn: document.getElementById('resetBtn'),
            addMinuteBtn: document.getElementById('addMinuteBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            soundToggleBtn: document.getElementById('soundToggleBtn'),
            soundIcon: document.getElementById('soundIcon'),
            soundText: document.getElementById('soundText'),
            focusModeToggle: document.getElementById('focusModeToggle'),
            focusIcon: document.getElementById('focusIcon'),
            focusText: document.getElementById('focusText'),
            installPWAButton: document.getElementById('installPWAButton'),
            shortcutsHelp: document.getElementById('shortcutsHelp'),
            minimizedControls: document.getElementById('minimizedControls'),
            minimizedStartPause: document.getElementById('minimizedStartPause'),
            minimizedReset: document.getElementById('minimizedReset'),
            minimizedSettings: document.getElementById('minimizedSettings'),
            minimizedFocus: document.getElementById('minimizedFocus'),
            
            // Status
            timerStatus: document.getElementById('timerStatus'),
            timerTitle: document.getElementById('timerTitle'),
            instructions: document.getElementById('instructions'),
            quickAddButtons: document.getElementById('quickAddButtons'),
            
            // Settings
            settingsPanel: document.getElementById('settingsPanel'),
            
            // Timer Settings
            hoursSlider: document.getElementById('hoursSlider'),
            hoursInput: document.getElementById('hoursInput'),
            minutesSlider: document.getElementById('minutesSlider'),
            minutesInput: document.getElementById('minutesInput'),
            secondsSlider: document.getElementById('secondsSlider'),
            secondsInput: document.getElementById('secondsInput'),
            finishMessage: document.getElementById('finishMessage'),
            
            // Appearance Settings
            bgColor: document.getElementById('bgColor'),
            textColor: document.getElementById('textColor'),
            outlineColor: document.getElementById('outlineColor'),
            progressColor: document.getElementById('progressColor'),
            outlineToggle: document.getElementById('outlineToggle'),
            outlineThickness: document.getElementById('outlineThickness'),
            outlineThicknessValue: document.getElementById('outlineThicknessValue'),
            bgOpacity: document.getElementById('bgOpacity'),
            bgOpacityValue: document.getElementById('bgOpacityValue'),
            panelOpacity: document.getElementById('panelOpacity'),
            panelOpacityValue: document.getElementById('panelOpacityValue'),
            
            // Font Settings
            fontFamily: document.getElementById('fontFamily'),
            fontSize: document.getElementById('fontSize'),
            fontSizeValue: document.getElementById('fontSizeValue'),
            fontWeight: document.getElementById('fontWeight'),
            fontUploadArea: document.getElementById('fontUploadArea'),
            fontFileInput: document.getElementById('fontFileInput'),
            uploadedFontsList: document.getElementById('uploadedFontsList'),
            fontPreviewContainer: document.getElementById('fontPreviewContainer'),
            fontPreviewText: document.getElementById('fontPreviewText'),
            
            // Media Settings
            mediaToggle: document.getElementById('mediaToggle'),
            mediaUrl: document.getElementById('mediaUrl'),
            mediaFile: document.getElementById('mediaFile'),
            mediaAudioToggle: document.getElementById('mediaAudioToggle'),
            mediaPreview: document.getElementById('mediaPreview'),
            mediaOpacity: document.getElementById('mediaOpacity'),
            mediaOpacityValue: document.getElementById('mediaOpacityValue'),
            
            // Audio Settings - تم التصحيح
            audioToggle: document.getElementById('audioToggle'),
            audioUrl: document.getElementById('audioUrl'),
            audioFile: document.getElementById('audioFile'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeValue: document.getElementById('volumeValue'),
            loopToggle: document.getElementById('loopToggle'),
            tickToggle: document.getElementById('tickToggle'),
            finishSoundToggle: document.getElementById('finishSoundToggle'),
            clickSoundToggle: document.getElementById('clickSoundToggle'),
            warningSoundToggle: document.getElementById('warningSoundToggle'),
            finishSound: document.getElementById('finishSound'),
            warningSound: document.getElementById('warningSound'),
            
            // Advanced Settings
            wakeLockToggle: document.getElementById('wakeLockToggle'),
            autoStartToggle: document.getElementById('autoStartToggle'),
            flashToggle: document.getElementById('flashToggle'),
            millisecondsToggle: document.getElementById('millisecondsToggle'),
            vibrateToggle: document.getElementById('vibrateToggle'),
            focusAutoHideToggle: document.getElementById('focusAutoHideToggle'),
            minimizedControlsToggle: document.getElementById('minimizedControlsToggle'),
            presetName: document.getElementById('presetName'),
            presetList: document.getElementById('presetList'),
            
            // Overlays
            finishOverlay: document.getElementById('finishOverlay'),
            finishMessageDisplay: document.getElementById('finishMessageDisplay'),
            wipeEffect: document.getElementById('wipeEffect'),
            mediaBackground: document.getElementById('mediaBackground'),
            keyboardInputOverlay: document.getElementById('keyboardInputOverlay'),
            manualTimeInput: document.getElementById('manualTimeInput'),
            
            // System
            currentTime: document.getElementById('currentTime'),
            toastContainer: document.getElementById('toastContainer')
        };
        
        // ============================================
        // ENHANCED AUDIO FUNCTIONS - تم التصحيح بالكامل
        // ============================================
        
        // Initialize Audio Context
        function initializeAudioContext() {
            if (!APP_STATE.audioContext) {
                try {
                    APP_STATE.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('Audio Context initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize Audio Context:', error);
                    showToast('Audio not supported in this browser', 'warning');
                    return false;
                }
            }
            return true;
        }
        
        // Play enhanced sound with Web Audio API
        function playSound(type, frequency = 800, duration = 0.1) {
            // Check if audio is enabled globally
            if (!APP_STATE.audioEnabled) return;
            
            // Check specific sound settings
            if (type === 'click' && !APP_STATE.settings.clickSound) return;
            if (type === 'tick' && !APP_STATE.settings.tickSound) return;
            if (type === 'finish' && !APP_STATE.settings.finishSoundEnabled) return;
            if (type === 'warning' && !APP_STATE.settings.warningSoundEnabled) return;
            
            // Initialize audio context if needed
            if (!initializeAudioContext()) return;
            
            try {
                const ctx = APP_STATE.audioContext;
                
                // Resume context if suspended
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                
                // Create oscillator and gain node
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                // Configure based on sound type
                let freq = frequency;
                let gain = 0.05;
                let oscType = 'sine';
                let attack = 0.01;
                let decay = 0.1;
                
                switch(type) {
                    case 'tick':
                        freq = 800;
                        gain = 0.03;
                        duration = 0.05;
                        oscType = 'sine';
                        break;
                    case 'click':
                        freq = 600;
                        gain = 0.04;
                        duration = 0.03;
                        oscType = 'square';
                        break;
                    case 'bell':
                        freq = 1200;
                        gain = 0.1;
                        duration = 1.0;
                        oscType = 'sine';
                        attack = 0.1;
                        decay = 0.9;
                        break;
                    case 'alarm':
                        freq = 600;
                        gain = 0.2;
                        duration = 0.5;
                        oscType = 'square';
                        break;
                    case 'beep':
                        freq = 1000;
                        gain = 0.08;
                        duration = 0.2;
                        oscType = 'sine';
                        break;
                    case 'chime':
                        freq = 800;
                        gain = 0.12;
                        duration = 0.8;
                        oscType = 'sine';
                        attack = 0.2;
                        decay = 0.6;
                        break;
                    case 'horn':
                        freq = 400;
                        gain = 0.25;
                        duration = 0.3;
                        oscType = 'sawtooth';
                        break;
                    case 'digital':
                        freq = 1000;
                        gain = 0.15;
                        duration = 0.3;
                        oscType = 'square';
                        break;
                    case 'ping':
                        freq = 1200;
                        gain = 0.06;
                        duration = 0.15;
                        oscType = 'sine';
                        break;
                    case 'warning':
                        // Use the selected warning sound
                        return playSound(APP_STATE.settings.warningSound, 900, 0.08);
                }
                
                // Connect nodes
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // Configure oscillator
                oscillator.type = oscType;
                oscillator.frequency.setValueAtTime(freq, ctx.currentTime);
                
                // Configure gain envelope
                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(gain, ctx.currentTime + attack);
                gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + attack + decay);
                
                // Start and stop oscillator
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + attack + decay);
                
            } catch (error) {
                console.error('Sound playback error:', error);
            }
        }
        
        // Play sequence of sounds for alarms
        function playAlarmSequence(type) {
            if (!APP_STATE.audioEnabled) return;
            
            switch(type) {
                case 'finish':
                    if (!APP_STATE.settings.finishSoundEnabled) return;
                    
                    const finishSound = APP_STATE.settings.finishSound;
                    switch(finishSound) {
                        case 'alarm':
                            // Play alarm sequence
                            setTimeout(() => playSound('alarm', 600, 0.3), 0);
                            setTimeout(() => playSound('alarm', 700, 0.3), 400);
                            setTimeout(() => playSound('alarm', 600, 0.3), 800);
                            break;
                        case 'horn':
                            // Play horn sequence
                            setTimeout(() => playSound('horn', 400, 0.5), 0);
                            setTimeout(() => playSound('horn', 300, 0.5), 600);
                            break;
                        case 'digital':
                            // Play digital sequence
                            setTimeout(() => playSound('digital', 1000, 0.2), 0);
                            setTimeout(() => playSound('digital', 1200, 0.2), 300);
                            setTimeout(() => playSound('digital', 1000, 0.2), 600);
                            break;
                        default:
                            // Default bell/chime
                            playSound(finishSound, 1200, 1.0);
                    }
                    break;
                    
                case 'warning':
                    if (!APP_STATE.settings.warningSoundEnabled) return;
                    playSound(APP_STATE.settings.warningSound, 900, 0.08);
                    break;
            }
        }
        
        // Toggle sound globally
        function toggleSound() {
            APP_STATE.audioEnabled = !APP_STATE.audioEnabled;
            
            elements.soundIcon.className = APP_STATE.audioEnabled ? 'fas fa-volume-up text-lg' : 'fas fa-volume-mute text-lg';
            elements.soundText.textContent = APP_STATE.audioEnabled ? 'SOUND ON' : 'SOUND OFF';
            
            // Update button style
            if (APP_STATE.audioEnabled) {
                elements.soundToggleBtn.classList.remove('bg-red-500/20', 'border-red-500/30');
                elements.soundToggleBtn.classList.add('bg-white/20', 'border-white/10');
                playSound('click');
            } else {
                elements.soundToggleBtn.classList.remove('bg-white/20', 'border-white/10');
                elements.soundToggleBtn.classList.add('bg-red-500/20', 'border-red-500/30');
            }
            
            showToast(`Sound ${APP_STATE.audioEnabled ? 'enabled' : 'disabled'}`, 'info');
        }
        
        // ============================================
        // ENHANCED TOUCH HANDLING
        // ============================================
        
        // Handle touch start for time adjustment
        function handleTouchStart(element, type, amount) {
            if (APP_STATE.isRunning || APP_STATE.isFinished) return;
            
            APP_STATE.touchElement = element;
            APP_STATE.touchType = type;
            APP_STATE.touchAmount = amount;
            
            // Add visual feedback
            element.classList.add('scale-95', 'opacity-80');
            
            // Play click sound
            if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
                playSound('click');
            }
            
            // Start with single adjustment
            adjustTime(type, amount);
            
            // Start repeating adjustment after 500ms
            APP_STATE.touchTimer = setTimeout(() => {
                APP_STATE.touchTimer = setInterval(() => {
                    adjustTime(type, amount);
                }, 100);
            }, 500);
        }
        
        // Handle touch end
        function handleTouchEnd(element) {
            if (APP_STATE.touchTimer) {
                clearTimeout(APP_STATE.touchTimer);
                clearInterval(APP_STATE.touchTimer);
                APP_STATE.touchTimer = null;
            }
            
            if (element) {
                element.classList.remove('scale-95', 'opacity-80');
            }
        }
        
        // Handle context menu (right-click) for subtract
        document.addEventListener('contextmenu', (e) => {
            if (e.target.closest('.time-unit') && !APP_STATE.isRunning && !APP_STATE.isFinished) {
                e.preventDefault();
                const timeUnit = e.target.closest('.time-unit');
                const valueElement = timeUnit.querySelector('.time-value');
                const type = valueElement.getAttribute('data-type');
                if (type) {
                    adjustTime(type, -1);
                }
                return false;
            }
        });
        
        // ============================================
        // ENHANCED UTILITY FUNCTIONS
        // ============================================
        
        // Format time to 2 digits
        function formatTime(num) {
            return num.toString().padStart(2, '0');
        }
        
        // Calculate total seconds
        function calculateTotalSeconds() {
            return APP_STATE.hours * 3600 + APP_STATE.minutes * 60 + APP_STATE.seconds;
        }
        
        // Update total seconds
        function updateTotalSeconds() {
            APP_STATE.totalSeconds = calculateTotalSeconds();
            APP_STATE.remainingSeconds = APP_STATE.totalSeconds;
        }
        
        // Save original time
        function saveOriginalTime() {
            APP_STATE.originalHours = APP_STATE.hours;
            APP_STATE.originalMinutes = APP_STATE.minutes;
            APP_STATE.originalSeconds = APP_STATE.seconds;
        }
        
        // Restore original time
        function restoreOriginalTime() {
            APP_STATE.hours = APP_STATE.originalHours;
            APP_STATE.minutes = APP_STATE.originalMinutes;
            APP_STATE.seconds = APP_STATE.originalSeconds;
            updateTotalSeconds();
            updateDisplay();
        }
        
        // Show toast notification
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `animate-slide-in-right glass rounded-2xl p-4 flex items-start gap-3 ${type === 'success' ? 'border-l-4 border-green-500' : type === 'error' ? 'border-l-4 border-red-500' : type === 'warning' ? 'border-l-4 border-yellow-500' : 'border-l-4 border-blue-500'}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-lg ${type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : 'text-blue-400'}"></i>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-white/40 hover:text-white/60 touch-feedback">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
        
        // Vibrate device if supported
        function vibrate(pattern = [200, 100, 200]) {
            if (APP_STATE.settings.vibrateOnFinish && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }
        
        // Update progress ring with enhanced styling
        function updateProgressRing() {
            if (APP_STATE.totalSeconds === 0) return;
            
            const progress = (APP_STATE.remainingSeconds / APP_STATE.totalSeconds) * 100;
            const circumference = 2 * Math.PI * 60;
            const offset = circumference - (progress / 100) * circumference;
            
            elements.progressCircle.style.strokeDashoffset = offset;
            elements.progressCircle.style.stroke = APP_STATE.settings.progressColor;
            elements.progressText.textContent = `${Math.round(progress)}%`;
            
            // Update progress color based on remaining time
            if (progress <= 25) {
                elements.progressCircle.style.stroke = '#ef4444';
            } else if (progress <= 50) {
                elements.progressCircle.style.stroke = '#f59e0b';
            } else {
                elements.progressCircle.style.stroke = APP_STATE.settings.progressColor;
            }
        }
        
        // Update digit colors with enhanced styling
        function updateDigitColors() {
            const textColor = APP_STATE.settings.textColor;
            const outlineColor = APP_STATE.settings.outlineColor;
            const outlineEnabled = APP_STATE.settings.outlineEnabled;
            const outlineThickness = APP_STATE.settings.outlineThickness;
            const fontWeight = APP_STATE.settings.fontWeight;
            
            const timeValues = document.querySelectorAll('.time-value');
            const timeLabels = document.querySelectorAll('.time-label');
            
            timeValues.forEach(digit => {
                digit.style.color = textColor;
                digit.style.fontWeight = fontWeight;
                
                if (outlineEnabled) {
                    digit.style.textShadow = `
                        0 0 ${outlineThickness}px ${outlineColor},
                        0 0 ${outlineThickness * 2}px ${outlineColor},
                        0 0 ${outlineThickness * 3}px ${outlineColor},
                        0 4px 8px rgba(0, 0, 0, 0.3)
                    `;
                } else {
                    digit.style.textShadow = `
                        0 4px 8px rgba(0, 0, 0, 0.3),
                        0 8px 16px rgba(0, 0, 0, 0.2)
                    `;
                }
            });
            
            timeLabels.forEach(label => {
                label.style.color = textColor;
                label.style.opacity = 0.6;
            });
        }
        
        // Update background with opacity control
        function updateBackground() {
            const bgOpacity = APP_STATE.settings.bgOpacity / 100;
            document.body.style.backgroundColor = APP_STATE.settings.bgColor;
            document.body.style.opacity = bgOpacity;
            
            // Update control panel opacity
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.style.opacity = APP_STATE.settings.panelOpacity / 100;
            }
            
            // Update media background
            if (APP_STATE.settings.mediaEnabled && APP_STATE.settings.mediaUrl) {
                elements.mediaBackground.style.opacity = (APP_STATE.settings.mediaOpacity / 100).toString();
                
                if (APP_STATE.settings.mediaType === 'video') {
                    elements.mediaBackground.innerHTML = `
                        <video autoplay loop muted playsinline class="media-bg">
                            <source src="${APP_STATE.settings.mediaUrl}" type="video/mp4">
                        </video>
                    `;
                    
                    const video = elements.mediaBackground.querySelector('video');
                    if (video) {
                        video.muted = !APP_STATE.settings.mediaAudioEnabled;
                        video.volume = APP_STATE.settings.audioVolume / 100;
                    }
                } else {
                    elements.mediaBackground.innerHTML = `
                        <img src="${APP_STATE.settings.mediaUrl}" alt="Background" class="media-bg">
                    `;
                }
            } else {
                elements.mediaBackground.style.opacity = '0';
                elements.mediaBackground.innerHTML = '';
            }
        }
        
        // Update font settings
        function updateFontSettings() {
            const timeValues = document.querySelectorAll('.time-value');
            const timeLabels = document.querySelectorAll('.time-label');
            
            timeValues.forEach(digit => {
                digit.style.fontFamily = APP_STATE.currentFont;
                digit.style.fontSize = `${APP_STATE.settings.fontSize * 0.5}rem`;
                digit.style.fontWeight = APP_STATE.settings.fontWeight;
            });
            
            timeLabels.forEach(label => {
                label.style.fontFamily = APP_STATE.currentFont;
            });
            
            if (elements.fontPreviewContainer.classList.contains('hidden') === false) {
                elements.fontPreviewText.style.fontFamily = APP_STATE.currentFont;
            }
        }
        
        // Enhanced save to localStorage
        function saveToLocalStorage() {
            const now = Date.now();
            
            if (now - APP_STATE.lastSaveTime < 1000) return;
            
            APP_STATE.lastSaveTime = now;
            
            try {
                const data = {
                    timer: {
                        hours: APP_STATE.hours,
                        minutes: APP_STATE.minutes,
                        seconds: APP_STATE.seconds,
                        originalHours: APP_STATE.originalHours,
                        originalMinutes: APP_STATE.originalMinutes,
                        originalSeconds: APP_STATE.originalSeconds,
                        totalSeconds: APP_STATE.totalSeconds,
                        remainingSeconds: APP_STATE.remainingSeconds,
                        isRunning: APP_STATE.isRunning,
                        isPaused: APP_STATE.isPaused,
                        isFinished: APP_STATE.isFinished
                    },
                    settings: APP_STATE.settings,
                    presets: APP_STATE.presets,
                    currentPreset: APP_STATE.currentPreset,
                    uploadedFonts: APP_STATE.uploadedFonts,
                    currentFont: APP_STATE.currentFont,
                    timestamp: now,
                    version: '2.0.1'
                };
                
                const compressedData = JSON.stringify(data);
                localStorage.setItem('proTimerEnhancedData', compressedData);
                console.debug('Enhanced data saved to localStorage');
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
                if (error.name === 'QuotaExceededError') {
                    showToast('Storage full. Clearing old data...', 'warning');
                    clearOldData();
                }
            }
        }
        
        // Clear old data
        function clearOldData() {
            try {
                const presetKeys = Object.keys(APP_STATE.presets);
                if (presetKeys.length > 5) {
                    const sortedPresets = presetKeys.map(key => ({
                        key,
                        timestamp: APP_STATE.presets[key].timestamp || 0
                    })).sort((a, b) => b.timestamp - a.timestamp);
                    
                    for (let i = 5; i < sortedPresets.length; i++) {
                        delete APP_STATE.presets[sortedPresets[i].key];
                    }
                    
                    saveToLocalStorage();
                    showToast('Old presets cleared to save space', 'info');
                }
            } catch (error) {
                console.error('Failed to clear old data:', error);
            }
        }
        
        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('proTimerEnhancedData');
                if (!saved) {
                    const oldData = localStorage.getItem('proTimerData');
                    if (oldData) {
                        migrateOldData(JSON.parse(oldData));
                    }
                    return;
                }
                
                const data = JSON.parse(saved);
                
                if (data.version && data.version !== '2.0.1') {
                    migrateData(data);
                }
                
                if (data.timer) {
                    APP_STATE.hours = data.timer.hours || 0;
                    APP_STATE.minutes = data.timer.minutes || 10;
                    APP_STATE.seconds = data.timer.seconds || 0;
                    APP_STATE.originalHours = data.timer.originalHours || APP_STATE.hours;
                    APP_STATE.originalMinutes = data.timer.originalMinutes || APP_STATE.minutes;
                    APP_STATE.originalSeconds = data.timer.originalSeconds || APP_STATE.seconds;
                    APP_STATE.totalSeconds = data.timer.totalSeconds || calculateTotalSeconds();
                    APP_STATE.remainingSeconds = data.timer.remainingSeconds || APP_STATE.totalSeconds;
                    APP_STATE.isRunning = data.timer.isRunning || false;
                    APP_STATE.isPaused = data.timer.isPaused || false;
                    APP_STATE.isFinished = data.timer.isFinished || false;
                    
                    updateDisplay();
                }
                
                if (data.settings) {
                    APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
                    updateSettingsUI();
                    applySettings();
                }
                
                if (data.uploadedFonts) {
                    APP_STATE.uploadedFonts = data.uploadedFonts;
                    updateUploadedFontsList();
                }
                
                if (data.currentFont) {
                    APP_STATE.currentFont = data.currentFont;
                }
                
                if (data.presets) {
                    APP_STATE.presets = data.presets;
                    updatePresetList();
                }
                
                if (data.currentPreset) {
                    APP_STATE.currentPreset = data.currentPreset;
                    elements.presetName.value = data.currentPreset;
                }
                
                console.log('Enhanced data loaded from localStorage');
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
                showToast('Failed to load saved data', 'error');
            }
        }
        
        // Migrate old data format
        function migrateOldData(oldData) {
            try {
                if (oldData.timer) {
                    APP_STATE.hours = oldData.timer.hours || 0;
                    APP_STATE.minutes = oldData.timer.minutes || 10;
                    APP_STATE.seconds = oldData.timer.seconds || 0;
                    APP_STATE.originalHours = APP_STATE.hours;
                    APP_STATE.originalMinutes = APP_STATE.minutes;
                    APP_STATE.originalSeconds = APP_STATE.seconds;
                }
                
                if (oldData.settings) {
                    APP_STATE.settings = { ...APP_STATE.settings, ...oldData.settings };
                }
                
                if (oldData.presets) {
                    APP_STATE.presets = oldData.presets;
                }
                
                updateDisplay();
                updateSettingsUI();
                applySettings();
                updatePresetList();
                
                showToast('Data migrated from old version', 'success');
                saveToLocalStorage();
            } catch (error) {
                console.error('Migration failed:', error);
            }
        }
        
        // Migrate data between versions
        function migrateData(data) {
            console.log(`Migrating data from version ${data.version} to 2.0.1`);
            return data;
        }
        
        // Setup auto-save
        function setupAutoSave() {
            window.addEventListener('beforeunload', () => {
                saveToLocalStorage();
            });
            
            setInterval(saveToLocalStorage, 10000);
            
            document.addEventListener('input', (e) => {
                if (e.target.closest('#settingsPanel')) {
                    saveToLocalStorage();
                }
            });
        }
        
        // ============================================
        // ENHANCED TIMER FUNCTIONS
        // ============================================
        
        // Update timer display
        function updateDisplay() {
            const hoursDisplay = document.getElementById('hoursDisplay');
            const minutesDisplay = document.getElementById('minutesDisplay');
            const secondsDisplay = document.getElementById('secondsDisplay');
            
            if (hoursDisplay) hoursDisplay.textContent = formatTime(APP_STATE.hours);
            if (minutesDisplay) minutesDisplay.textContent = formatTime(APP_STATE.minutes);
            if (secondsDisplay) secondsDisplay.textContent = formatTime(APP_STATE.seconds);
            
            updateProgressRing();
            updateTimerStatus();
            updateMinimizedControls();
        }
        
        // Update timer status text
        function updateTimerStatus() {
            const status = elements.timerStatus;
            
            if (APP_STATE.isFinished) {
                status.innerHTML = `
                    <div class="flex items-center justify-center gap-3 text-red-300">
                        <i class="fas fa-flag-checkered animate-pulse"></i>
                        <span>Timer finished!</span>
                    </div>
                `;
                return;
            }
            
            if (APP_STATE.isRunning) {
                const remainingSeconds = APP_STATE.remainingSeconds;
                
                if (remainingSeconds <= 10 && APP_STATE.settings.flashEnabled) {
                    status.innerHTML = `
                        <div class="flex items-center justify-center gap-3 text-yellow-300 animate-pulse">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>${remainingSeconds} seconds remaining!</span>
                        </div>
                    `;
                } else {
                    const hours = Math.floor(remainingSeconds / 3600);
                    const minutes = Math.floor((remainingSeconds % 3600) / 60);
                    const seconds = remainingSeconds % 60;
                    
                    let timeString = '';
                    if (hours > 0) timeString += `${hours}h `;
                    if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                    timeString += `${seconds}s`;
                    
                    status.innerHTML = `
                        <div class="flex items-center justify-center gap-3 text-green-300">
                            <i class="fas fa-play-circle"></i>
                            <span>Timer running... ${timeString} remaining</span>
                        </div>
                    `;
                }
            } else if (APP_STATE.isPaused) {
                status.innerHTML = `
                    <div class="flex items-center justify-center gap-3 text-yellow-300">
                        <i class="fas fa-pause-circle"></i>
                        <span>Timer paused</span>
                    </div>
                `;
            } else {
                const totalSeconds = calculateTotalSeconds();
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let timeString = '';
                if (hours > 0) timeString += `${hours}h `;
                if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                timeString += `${seconds}s`;
                
                status.innerHTML = `
                    <div class="flex items-center justify-center gap-3">
                        <i class="fas fa-clock"></i>
                        <span>Timer ready. Total duration: ${timeString}</span>
                    </div>
                `;
            }
        }
        
        // Adjust time with click sound
        function adjustTime(type, amount) {
            if (APP_STATE.isRunning || APP_STATE.isFinished) return;
            
            // Play click sound
            if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
                playSound('click');
            }
            
            // Save original time if not already saved
            if (APP_STATE.originalHours === undefined) {
                saveOriginalTime();
            }
            
            switch(type) {
                case 'hours':
                    APP_STATE.hours = (APP_STATE.hours + amount + 24) % 24;
                    break;
                case 'minutes':
                    APP_STATE.minutes = (APP_STATE.minutes + amount + 60) % 60;
                    break;
                case 'seconds':
                    APP_STATE.seconds = (APP_STATE.seconds + amount + 60) % 60;
                    break;
            }
            
            updateTotalSeconds();
            updateDisplay();
        }
        
        // Add minutes function
        function addMinutes(minutes) {
            if (APP_STATE.isRunning || APP_STATE.isFinished) return;
            
            // Play click sound
            if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
                playSound('click');
            }
            
            // Save original time if not already saved
            if (APP_STATE.originalHours === undefined) {
                saveOriginalTime();
            }
            
            const totalMinutes = APP_STATE.hours * 60 + APP_STATE.minutes + minutes;
            APP_STATE.hours = Math.floor(totalMinutes / 60);
            APP_STATE.minutes = totalMinutes % 60;
            
            // Keep hours within 24
            if (APP_STATE.hours >= 24) {
                APP_STATE.hours = 23;
                APP_STATE.minutes = 59;
                APP_STATE.seconds = 59;
                showToast('Maximum time reached (23:59:59)', 'warning');
            }
            
            updateTotalSeconds();
            updateDisplay();
            
            showToast(`Added ${minutes} minute${minutes !== 1 ? 's' : ''}`, 'info');
        }
        
        // Set quick preset
        function setQuickPreset(minutes) {
            if (APP_STATE.isRunning || APP_STATE.isFinished) return;
            
            // Save original time
            saveOriginalTime();
            
            APP_STATE.hours = Math.floor(minutes / 60);
            APP_STATE.minutes = minutes % 60;
            APP_STATE.seconds = 0;
            
            updateTotalSeconds();
            updateDisplay();
            
            showToast(`Timer set to ${minutes} minute${minutes !== 1 ? 's' : ''}`, 'success');
        }
        
        // Toggle timer (start/pause)
        function toggleTimer() {
            if (APP_STATE.isFinished) {
                resetTimer();
                return;
            }
            
            if (APP_STATE.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }
        
        // Start timer
        function startTimer() {
            if (APP_STATE.totalSeconds === 0) {
                showToast('Please set a timer duration first', 'warning');
                return;
            }
            
            // Save original time if not already saved
            if (APP_STATE.originalHours === undefined) {
                saveOriginalTime();
            }
            
            APP_STATE.isRunning = true;
            APP_STATE.isPaused = false;
            APP_STATE.isFinished = false;
            
            // Update button
            elements.startPauseBtn.innerHTML = `
                <i class="fas fa-pause text-lg"></i>
                <span class="text-lg font-semibold">PAUSE TIMER</span>
            `;
            elements.startPauseBtn.classList.add('animate-glow');
            
            // Update minimized controls
            elements.minimizedStartPause.innerHTML = '<i class="fas fa-pause"></i>';
            
            // Update status
            updateTimerStatus();
            
            // Reset sound timers
            APP_STATE.lastTickTime = 0;
            APP_STATE.lastWarningTime = 0;
            
            // Start countdown
            APP_STATE.timerInterval = setInterval(() => {
                if (APP_STATE.remainingSeconds <= 0) {
                    finishTimer();
                    return;
                }
                
                APP_STATE.remainingSeconds--;
                
                // Update time display
                const hours = Math.floor(APP_STATE.remainingSeconds / 3600);
                const minutes = Math.floor((APP_STATE.remainingSeconds % 3600) / 60);
                const seconds = APP_STATE.remainingSeconds % 60;
                
                APP_STATE.hours = hours;
                APP_STATE.minutes = minutes;
                APP_STATE.seconds = seconds;
                
                // Update display
                updateDisplay();
                
                // Handle sounds based on remaining time - تم التصحيح
                const now = Date.now();
                
                // Warning sound for last 30 seconds
                if (APP_STATE.remainingSeconds <= 30 && APP_STATE.remainingSeconds > 0) {
                    if (APP_STATE.settings.warningSoundEnabled && 
                        now - APP_STATE.lastWarningTime > 1000) {
                        playAlarmSequence('warning');
                        APP_STATE.lastWarningTime = now;
                    }
                }
                
                // Tick sound for last 10 seconds
                if (APP_STATE.remainingSeconds <= 10) {
                    if (APP_STATE.settings.flashEnabled) {
                        document.body.classList.toggle('flashing-bg');
                    }
                    
                    if (APP_STATE.settings.tickSound && 
                        now - APP_STATE.lastTickTime > 1000) {
                        playSound('tick');
                        APP_STATE.lastTickTime = now;
                    }
                }
                
                // Update progress
                updateProgressRing();
                
            }, 1000);
            
            // Request wake lock
            if (APP_STATE.settings.wakeLockEnabled && 'wakeLock' in navigator) {
                navigator.wakeLock.request('screen')
                    .then(wakeLock => {
                        APP_STATE.wakeLock = wakeLock;
                        console.log('Wake lock acquired');
                    })
                    .catch(err => {
                        console.error('Wake lock error:', err);
                    });
            }
            
            // Auto-hide controls in focus mode
            if (APP_STATE.focusMode && APP_STATE.settings.focusAutoHide) {
                setTimeout(() => {
                    hideMinimizedControls();
                }, 2000);
            }
            
            showToast('Timer started', 'success');
        }
        
        // Pause timer
        function pauseTimer() {
            APP_STATE.isRunning = false;
            APP_STATE.isPaused = true;
            
            clearInterval(APP_STATE.timerInterval);
            
            // Update button
            elements.startPauseBtn.innerHTML = `
                <i class="fas fa-play text-lg"></i>
                <span class="text-lg font-semibold">RESUME TIMER</span>
            `;
            elements.startPauseBtn.classList.remove('animate-glow');
            
            // Update minimized controls
            elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
            
            // Update status
            updateTimerStatus();
            
            // Release wake lock
            if (APP_STATE.wakeLock) {
                APP_STATE.wakeLock.release()
                    .then(() => {
                        APP_STATE.wakeLock = null;
                        console.log('Wake lock released');
                    });
            }
            
            // Remove flashing
            document.body.classList.remove('flashing-bg');
            
            // Show minimized controls
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
            
            showToast('Timer paused', 'warning');
        }
        
        // Confirm reset with SweetAlert - تم التعديل لتحسين أداء إعادة الضبط
        function confirmReset() {
            if (APP_STATE.isRunning || APP_STATE.isPaused || APP_STATE.isFinished) {
                Swal.fire({
                    title: 'Reset Timer?',
                    text: 'Are you sure you want to reset the timer?',
                    icon: 'warning',
                    background: '#0f172a',
                    color: '#f8fafc',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, reset it!',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    customClass: {
                        popup: 'glass-dark'
                    },
                    allowOutsideClick: false,
                    allowEscapeKey: true,
                    allowEnterKey: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        resetTimer();
                    }
                }).catch(() => {
                    // معالجة أي خطأ في تأكيد إعادة الضبط
                    console.log('Reset confirmation cancelled or errored');
                    // إعادة تعيين مباشرة إذا فشل التأكيد
                    if (APP_STATE.isRunning || APP_STATE.isPaused) {
                        resetTimer();
                    }
                });
            } else {
                resetTimer();
            }
        }
        
        // Reset timer - تم التعديل لضمان عمل إعادة الضبط بشكل موثوق
        function resetTimer() {
            try {
                // أولاً: إيقاف أي مؤقتات حالية
                if (APP_STATE.timerInterval) {
                    clearInterval(APP_STATE.timerInterval);
                    APP_STATE.timerInterval = null;
                }
                
                // ثانياً: إعادة تعيين حالة التايمر
                APP_STATE.isRunning = false;
                APP_STATE.isPaused = false;
                APP_STATE.isFinished = false;
                
                // ثالثاً: استعادة الوقت الأصلي
                if (APP_STATE.originalHours !== undefined && 
                    APP_STATE.originalMinutes !== undefined && 
                    APP_STATE.originalSeconds !== undefined) {
                    APP_STATE.hours = APP_STATE.originalHours;
                    APP_STATE.minutes = APP_STATE.originalMinutes;
                    APP_STATE.seconds = APP_STATE.originalSeconds;
                } else {
                    // قيم افتراضية إذا لم يتم حفظ وقت أصلي
                    APP_STATE.hours = 0;
                    APP_STATE.minutes = 10;
                    APP_STATE.seconds = 0;
                    saveOriginalTime();
                }
                
                // رابعاً: تحديث الوقت الكلي
                updateTotalSeconds();
                APP_STATE.remainingSeconds = APP_STATE.totalSeconds;
                
                // خامساً: تحديث واجهة المستخدم
                elements.startPauseBtn.innerHTML = `
                    <i class="fas fa-play text-lg"></i>
                    <span class="text-lg font-semibold">START TIMER</span>
                `;
                elements.startPauseBtn.classList.remove('animate-glow');
                
                // تحديث عناصر التحكم المصغرة
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
                
                // تحديث العرض
                updateDisplay();
                
                // إزالة الوميض
                document.body.classList.remove('flashing-bg');
                
                // إغلاق نافذة الإنهاء إذا كانت مفتوحة
                if (!elements.finishOverlay.classList.contains('hidden')) {
                    closeFinishOverlay();
                }
                
                // إطلاق Wake Lock
                if (APP_STATE.wakeLock) {
                    try {
                        APP_STATE.wakeLock.release()
                            .then(() => {
                                APP_STATE.wakeLock = null;
                                console.log('Wake lock released');
                            })
                            .catch(err => {
                                console.error('Error releasing wake lock:', err);
                                APP_STATE.wakeLock = null;
                            });
                    } catch (err) {
                        console.error('Error releasing wake lock:', err);
                        APP_STATE.wakeLock = null;
                    }
                }
                
                // إظهار عناصر التحكم المصغرة
                if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                    showMinimizedControls();
                }
                
                showToast('Timer reset successfully', 'info');
                
            } catch (error) {
                console.error('Error in resetTimer:', error);
                // محاولة إعادة التعيين الأساسية
                APP_STATE.hours = 0;
                APP_STATE.minutes = 10;
                APP_STATE.seconds = 0;
                saveOriginalTime();
                updateTotalSeconds();
                updateDisplay();
                showToast('Timer reset to default', 'info');
            }
        }
        
        // Finish timer with enhanced effects - تم التصحيح
        function finishTimer() {
            APP_STATE.isRunning = false;
            APP_STATE.isFinished = true;
            
            clearInterval(APP_STATE.timerInterval);
            
            // Update button
            elements.startPauseBtn.innerHTML = `
                <i class="fas fa-redo text-lg"></i>
                <span class="text-lg font-semibold">RESTART TIMER</span>
            `;
            elements.startPauseBtn.classList.remove('animate-glow');
            
            // Update minimized controls
            elements.minimizedStartPause.innerHTML = '<i class="fas fa-redo"></i>';
            
            // Remove flashing
            document.body.classList.remove('flashing-bg');
            
            // Release wake lock
            if (APP_STATE.wakeLock) {
                APP_STATE.wakeLock.release()
                    .then(() => {
                        APP_STATE.wakeLock = null;
                    });
            }
            
            // Vibrate on finish
            vibrate([500, 200, 500]);
            
            // Show wipe effect
            elements.wipeEffect.classList.remove('hidden');
            setTimeout(() => {
                elements.wipeEffect.classList.add('hidden');
            }, 500);
            
            // Show finish overlay
            setTimeout(() => {
                elements.finishMessageDisplay.textContent = APP_STATE.settings.finishMessage;
                elements.finishOverlay.classList.remove('hidden');
            }, 500);
            
            // Play finish sound - تم التصحيح
            if (APP_STATE.audioEnabled && APP_STATE.settings.finishSoundEnabled) {
                playAlarmSequence('finish');
            }
            
            // Show minimized controls
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
            
            showToast('Timer completed!', 'success');
        }
        
        // Close finish overlay
        function closeFinishOverlay() {
            elements.finishOverlay.classList.add('hidden');
        }
        
        // ============================================
        // FOCUS MODE FUNCTIONS
        // ============================================
        
        // Toggle focus mode - تم التعديل لإزالة النص من الأيقونة
        function toggleFocusMode() {
            APP_STATE.focusMode = !APP_STATE.focusMode;
            
            if (APP_STATE.focusMode) {
                enableFocusMode();
            } else {
                disableFocusMode();
            }
            
            updateFocusModeUI();
        }
        
        // Enable focus mode - تم التعديل لضمان بقاء التايمر في المنتصف
        function enableFocusMode() {
            document.body.classList.add('focus-mode');
            
            // إخفاء جميع العناصر الغير ضرورية
            const elementsToHide = [
                elements.instructions,
                elements.quickAddButtons,
                elements.timerStatus,
                document.querySelector('.timer-title-section'),
                document.querySelector('.progress-container'),
                document.querySelector('.app-title')
            ];
            
            elementsToHide.forEach(el => {
                if (el) {
                    el.style.opacity = '0';
                    el.style.visibility = 'hidden';
                    el.style.pointerEvents = 'none';
                }
            });
            
            // إخفاء لوحة التحكم
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.style.opacity = '0';
                controlPanel.style.visibility = 'hidden';
                controlPanel.style.pointerEvents = 'none';
            }
            
            // تحديث الوقت الحالي
            const systemTime = elements.currentTime.parentElement;
            if (systemTime) {
                systemTime.style.position = 'fixed';
                systemTime.style.top = '15px';
                systemTime.style.right = '15px';
                systemTime.style.zIndex = '1000';
                systemTime.style.background = 'rgba(0, 0, 0, 0.5)';
                systemTime.style.backdropFilter = 'blur(10px)';
                systemTime.style.borderRadius = '12px';
                systemTime.style.padding = '8px 12px';
                systemTime.style.opacity = '1';
                systemTime.style.visibility = 'visible';
            }
            
            // إعادة ضبط التايمر ليكون في منتصف الشاشة بالضبط
            const timerContainer = document.querySelector('.timer-container');
            if (timerContainer) {
                timerContainer.style.position = 'fixed';
                timerContainer.style.top = '50%';
                timerContainer.style.left = '50%';
                timerContainer.style.transform = 'translate(-50%, -50%)';
                timerContainer.style.width = '100%';
                timerContainer.style.textAlign = 'center';
                timerContainer.style.zIndex = '10';
            }
            
            // إعادة ضبط عناصر الأرقام
            const timerDigits = document.querySelector('.timer-digits-container');
            if (timerDigits) {
                timerDigits.style.display = 'flex';
                timerDigits.style.justifyContent = 'center';
                timerDigits.style.alignItems = 'center';
                timerDigits.style.width = '100%';
                timerDigits.style.margin = '0 auto';
            }
            
            // تحديث الأيقونة
            elements.focusIcon.className = 'fas fa-eye-slash text-lg';
            
            // تحديث الأيقونة المصغرة
            elements.minimizedFocus.innerHTML = '<i class="fas fa-eye-slash"></i>';
            
            // إظهار عناصر التحكم المصغرة
            if (APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
                
                if (APP_STATE.settings.focusAutoHide && APP_STATE.isRunning) {
                    setTimeout(() => {
                        hideMinimizedControls();
                    }, 2000);
                }
            }
            
            showToast('Focus mode enabled', 'success');
        }
        
        // Disable focus mode
        function disableFocusMode() {
            document.body.classList.remove('focus-mode');
            
            // إعادة إظهار جميع العناصر
            const elementsToShow = [
                elements.instructions,
                elements.quickAddButtons,
                elements.timerStatus,
                document.querySelector('.timer-title-section'),
                document.querySelector('.progress-container'),
                document.querySelector('.app-title')
            ];
            
            elementsToShow.forEach(el => {
                if (el) {
                    el.style.opacity = '';
                    el.style.visibility = '';
                    el.style.pointerEvents = '';
                }
            });
            
            // إعادة إظهار لوحة التحكم
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.style.opacity = '';
                controlPanel.style.visibility = '';
                controlPanel.style.pointerEvents = '';
            }
            
            // إعادة ضبط الوقت الحالي
            const systemTime = elements.currentTime.parentElement;
            if (systemTime) {
                systemTime.style.position = '';
                systemTime.style.top = '';
                systemTime.style.right = '';
                systemTime.style.zIndex = '';
                systemTime.style.background = '';
                systemTime.style.backdropFilter = '';
                systemTime.style.borderRadius = '';
                systemTime.style.padding = '';
            }
            
            // إعادة ضبط التايمر
            const timerContainer = document.querySelector('.timer-container');
            if (timerContainer) {
                timerContainer.style.position = '';
                timerContainer.style.top = '';
                timerContainer.style.left = '';
                timerContainer.style.transform = '';
                timerContainer.style.width = '';
                timerContainer.style.textAlign = '';
                timerContainer.style.zIndex = '';
            }
            
            // تحديث الأيقونة
            elements.focusIcon.className = 'fas fa-eye text-lg';
            
            // تحديث الأيقونة المصغرة
            elements.minimizedFocus.innerHTML = '<i class="fas fa-eye"></i>';
            
            // إخفاء عناصر التحكم المصغرة
            hideMinimizedControls();
            
            showToast('Focus mode disabled', 'info');
        }
        
        // Update focus mode UI
        function updateFocusModeUI() {
            if (APP_STATE.focusMode) {
                elements.focusModeToggle.classList.add('bg-blue-500/20', 'border-blue-500/30');
            } else {
                elements.focusModeToggle.classList.remove('bg-blue-500/20', 'border-blue-500/30');
            }
        }
        
        // Toggle focus auto-hide
        function toggleFocusAutoHide() {
            elements.focusAutoHideToggle.classList.toggle('active');
            APP_STATE.settings.focusAutoHide = elements.focusAutoHideToggle.classList.contains('active');
            
            if (!APP_STATE.settings.focusAutoHide && APP_STATE.focusMode) {
                showMinimizedControls();
            }
        }
        
        // ============================================
        // MINIMIZED CONTROLS FUNCTIONS
        // ============================================
        
        // Show minimized controls
        function showMinimizedControls() {
            if (!APP_STATE.settings.minimizedControls || !APP_STATE.focusMode) return;
            
            clearTimeout(APP_STATE.minimizedControlsTimeout);
            elements.minimizedControls.classList.add('show');
            APP_STATE.minimizedControlsVisible = true;
            
            if (APP_STATE.settings.focusAutoHide && APP_STATE.isRunning) {
                APP_STATE.minimizedControlsTimeout = setTimeout(() => {
                    hideMinimizedControls();
                }, 3000);
            }
        }
        
        // Hide minimized controls
        function hideMinimizedControls() {
            if (!APP_STATE.minimizedControlsVisible) return;
            
            elements.minimizedControls.classList.remove('show');
            APP_STATE.minimizedControlsVisible = false;
        }
        
        // Toggle minimized controls
        function toggleMinimizedControls() {
            elements.minimizedControlsToggle.classList.toggle('active');
            APP_STATE.settings.minimizedControls = elements.minimizedControlsToggle.classList.contains('active');
            
            if (APP_STATE.settings.minimizedControls && APP_STATE.focusMode) {
                showMinimizedControls();
            } else {
                hideMinimizedControls();
            }
        }
        
        // Update minimized controls
        function updateMinimizedControls() {
            if (APP_STATE.isRunning) {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-pause"></i>';
            } else if (APP_STATE.isPaused) {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
            } else if (APP_STATE.isFinished) {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-redo"></i>';
            } else {
                elements.minimizedStartPause.innerHTML = '<i class="fas fa-play"></i>';
            }
            
            if (APP_STATE.focusMode) {
                elements.minimizedFocus.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                elements.minimizedFocus.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }
        
        // Handle mouse movement for showing controls
        document.addEventListener('mousemove', (e) => {
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
        });
        
        // Handle touch for showing controls
        document.addEventListener('touchstart', () => {
            if (APP_STATE.focusMode && APP_STATE.settings.minimizedControls) {
                showMinimizedControls();
            }
        });
        
        // ============================================
        // FONT HANDLING FUNCTIONS
        // ============================================
        
        // Handle drag over for font upload
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            elements.fontUploadArea.classList.add('drag-over');
        }
        
        // Handle drag leave for font upload
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            elements.fontUploadArea.classList.remove('drag-over');
        }
        
        // Handle font drop
        function handleFontDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            elements.fontUploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            handleFontFiles(files);
        }
        
        // Handle font file selection
        function handleFontFileSelect(e) {
            const files = e.target.files;
            handleFontFiles(files);
        }
        
        // Handle font files
        function handleFontFiles(files) {
            const fontFiles = Array.from(files).filter(file => 
                file.name.match(/\.(ttf|otf|woff|woff2)$/i)
            );
            
            if (fontFiles.length === 0) {
                showToast('No valid font files selected. Supported formats: .ttf, .otf, .woff, .woff2', 'error');
                return;
            }
            
            let loadedCount = 0;
            const totalFiles = fontFiles.length;
            
            fontFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fontData = e.target.result;
                    const fontName = file.name.replace(/\.[^/.]+$/, "");
                    
                    const fontFamilyName = `CustomFont_${fontName.replace(/\s+/g, '_')}_${Date.now()}`;
                    
                    const fontFace = new FontFace(fontFamilyName, `url(${fontData})`);
                    
                    fontFace.load().then(loadedFace => {
                        document.fonts.add(loadedFace);
                        
                        APP_STATE.uploadedFonts[fontFamilyName] = {
                            name: fontName,
                            family: fontFamilyName,
                            data: fontData,
                            timestamp: Date.now()
                        };
                        
                        loadedCount++;
                        
                        if (loadedCount === totalFiles) {
                            updateUploadedFontsList();
                            showToast(`${loadedCount} font${loadedCount > 1 ? 's' : ''} uploaded successfully`, 'success');
                            saveToLocalStorage();
                        }
                    }).catch(error => {
                        console.error('Failed to load font:', error);
                        showToast(`Failed to load font: ${file.name}`, 'error');
                    });
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // Update uploaded fonts list
        function updateUploadedFontsList() {
            const fontsList = elements.uploadedFontsList;
            const fonts = APP_STATE.uploadedFonts;
            
            if (Object.keys(fonts).length === 0) {
                fontsList.innerHTML = `
                    <div class="text-center py-8 opacity-50">
                        <i class="fas fa-font text-3xl mb-3"></i>
                        <p>No custom fonts uploaded yet</p>
                    </div>
                `;
                return;
            }
            
            fontsList.innerHTML = '';
            
            Object.entries(fonts).forEach(([family, font]) => {
                const fontItem = document.createElement('div');
                fontItem.className = `font-item ${APP_STATE.currentFont === `'${family}', sans-serif` ? 'active' : ''}`;
                fontItem.innerHTML = `
                    <div class="font-info">
                        <div class="font-name font-medium">${font.name}</div>
                        <div class="font-family text-xs opacity-60">${family}</div>
                    </div>
                    <div class="font-actions">
                        <button class="font-action-btn preview" onclick="previewFont('${family}')" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="font-action-btn ${APP_STATE.currentFont === `'${family}', sans-serif` ? 'active' : ''}" onclick="selectFont('${family}')" title="Select">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="font-action-btn delete" onclick="deleteFont('${family}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                fontsList.appendChild(fontItem);
            });
        }
        
        // Preview font
        function previewFont(fontFamily) {
            elements.fontPreviewText.style.fontFamily = `'${fontFamily}', sans-serif`;
            elements.fontPreviewContainer.classList.remove('hidden');
            
            elements.fontPreviewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Select font
        function selectFont(fontFamily) {
            APP_STATE.currentFont = `'${fontFamily}', sans-serif`;
            updateFontSettings();
            updateUploadedFontsList();
            showToast(`Font "${APP_STATE.uploadedFonts[fontFamily].name}" selected`, 'success');
            saveToLocalStorage();
        }
        
        // Delete font
        function deleteFont(fontFamily) {
            Swal.fire({
                title: 'Delete Font?',
                text: `Are you sure you want to delete "${APP_STATE.uploadedFonts[fontFamily].name}"?`,
                icon: 'warning',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    const fontFaces = Array.from(document.fonts).filter(font => 
                        font.family === fontFamily
                    );
                    
                    fontFaces.forEach(font => {
                        document.fonts.delete(font);
                    });
                    
                    delete APP_STATE.uploadedFonts[fontFamily];
                    
                    if (APP_STATE.currentFont === `'${fontFamily}', sans-serif`) {
                        APP_STATE.currentFont = "'JetBrains Mono', monospace";
                        updateFontSettings();
                    }
                    
                    updateUploadedFontsList();
                    saveToLocalStorage();
                    
                    showToast('Font deleted successfully', 'success');
                }
            });
        }
        
        // ============================================
        // DEVELOPER CONTACT FUNCTIONS
        // ============================================
        
        // Function to contact developer via WhatsApp
        function contactDeveloper(developer) {
            let phoneNumber = '';
            let developerName = '';
            
            if (developer === 'abdalrahman') {
                phoneNumber = '+201065351971';
                developerName = 'Abdalrahman';
            } else if (developer === 'ahmed') {
                phoneNumber = '+201152681848';
                developerName = 'Ahmed';
            } else {
                showToast('Invalid developer selection', 'error');
                return;
            }
            
            // Create WhatsApp link
            const whatsappLink = `https://wa.me/${phoneNumber.replace('+', '')}`;
            
            // Open WhatsApp in new tab
            window.open(whatsappLink, '_blank');
            
            showToast(`Opening WhatsApp to contact ${developerName}`, 'info');
        }
        
        // ============================================
        // ENHANCED SETTINGS FUNCTIONS
        // ============================================
        
        // Toggle settings panel
        function toggleSettings() {
            elements.settingsPanel.classList.toggle('translate-x-full');
            
            if (!elements.settingsPanel.classList.contains('translate-x-full')) {
                updateSettingsUI();
                
                setTimeout(() => {
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab) {
                        activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }, 100);
            }
        }
        
        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });
            document.querySelector(`[data-tab-content="${tabName}"]`).classList.remove('hidden');
            document.querySelector(`[data-tab-content="${tabName}"]`).classList.add('active');
            
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
            
            if (tabName === 'fonts') {
                updateUploadedFontsList();
            }
        }
        
        // Update settings UI from state
        function updateSettingsUI() {
            // Timer settings
            elements.hoursSlider.value = APP_STATE.hours;
            elements.hoursInput.value = APP_STATE.hours;
            elements.minutesSlider.value = APP_STATE.minutes;
            elements.minutesInput.value = APP_STATE.minutes;
            elements.secondsSlider.value = APP_STATE.seconds;
            elements.secondsInput.value = APP_STATE.seconds;
            elements.finishMessage.value = APP_STATE.settings.finishMessage;
            
            // Appearance settings
            elements.bgColor.value = APP_STATE.settings.bgColor;
            elements.textColor.value = APP_STATE.settings.textColor;
            elements.outlineColor.value = APP_STATE.settings.outlineColor;
            elements.progressColor.value = APP_STATE.settings.progressColor;
            elements.outlineToggle.classList.toggle('active', APP_STATE.settings.outlineEnabled);
            elements.outlineThickness.value = APP_STATE.settings.outlineThickness;
            elements.outlineThicknessValue.textContent = APP_STATE.settings.outlineThickness;
            elements.bgOpacity.value = APP_STATE.settings.bgOpacity;
            elements.bgOpacityValue.textContent = APP_STATE.settings.bgOpacity;
            elements.panelOpacity.value = APP_STATE.settings.panelOpacity;
            elements.panelOpacityValue.textContent = APP_STATE.settings.panelOpacity;
            
            // Font settings
            elements.fontFamily.value = APP_STATE.currentFont;
            elements.fontSize.value = APP_STATE.settings.fontSize;
            elements.fontSizeValue.textContent = APP_STATE.settings.fontSize;
            elements.fontWeight.value = APP_STATE.settings.fontWeight;
            
            // Media settings
            elements.mediaToggle.classList.toggle('active', APP_STATE.settings.mediaEnabled);
            elements.mediaUrl.value = APP_STATE.settings.mediaUrl;
            elements.mediaAudioToggle.classList.toggle('active', APP_STATE.settings.mediaAudioEnabled);
            elements.mediaOpacity.value = APP_STATE.settings.mediaOpacity;
            elements.mediaOpacityValue.textContent = APP_STATE.settings.mediaOpacity;
            updateMediaPreview();
            
            // Audio settings - تم التصحيح
            elements.audioToggle.classList.toggle('active', APP_STATE.settings.audioEnabled);
            elements.audioUrl.value = APP_STATE.settings.audioUrl;
            elements.volumeSlider.value = APP_STATE.settings.audioVolume;
            elements.volumeValue.textContent = APP_STATE.settings.audioVolume;
            elements.loopToggle.classList.toggle('active', APP_STATE.settings.audioLoop);
            elements.tickToggle.classList.toggle('active', APP_STATE.settings.tickSound);
            elements.finishSoundToggle.classList.toggle('active', APP_STATE.settings.finishSoundEnabled);
            elements.clickSoundToggle.classList.toggle('active', APP_STATE.settings.clickSound);
            elements.warningSoundToggle.classList.toggle('active', APP_STATE.settings.warningSoundEnabled);
            elements.finishSound.value = APP_STATE.settings.finishSound;
            elements.warningSound.value = APP_STATE.settings.warningSound;
            
            // Advanced settings
            elements.wakeLockToggle.classList.toggle('active', APP_STATE.settings.wakeLockEnabled);
            elements.autoStartToggle.classList.toggle('active', APP_STATE.settings.autoStart);
            elements.flashToggle.classList.toggle('active', APP_STATE.settings.flashEnabled);
            elements.millisecondsToggle.classList.toggle('active', APP_STATE.settings.showMilliseconds);
            elements.vibrateToggle.classList.toggle('active', APP_STATE.settings.vibrateOnFinish);
            elements.focusAutoHideToggle.classList.toggle('active', APP_STATE.settings.focusAutoHide);
            elements.minimizedControlsToggle.classList.toggle('active', APP_STATE.settings.minimizedControls);
            
            // Presets
            elements.presetName.value = APP_STATE.currentPreset || '';
            updatePresetList();
        }
        
        // Update media preview
        function updateMediaPreview() {
            if (APP_STATE.settings.mediaUrl) {
                if (APP_STATE.settings.mediaType === 'video') {
                    elements.mediaPreview.innerHTML = `
                        <video class="w-full h-full object-cover" controls>
                            <source src="${APP_STATE.settings.mediaUrl}" type="video/mp4">
                        </video>
                    `;
                } else {
                    elements.mediaPreview.innerHTML = `
                        <img src="${APP_STATE.settings.mediaUrl}" alt="Preview" class="w-full h-full object-cover">
                    `;
                }
            } else {
                elements.mediaPreview.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-image text-4xl opacity-30 mb-2"></i>
                        <p class="opacity-50">No media selected</p>
                    </div>
                `;
            }
        }
        
        // Apply settings
        function applySettings() {
            // Timer settings
            APP_STATE.hours = parseInt(elements.hoursInput.value) || 0;
            APP_STATE.minutes = parseInt(elements.minutesInput.value) || 0;
            APP_STATE.seconds = parseInt(elements.secondsInput.value) || 0;
            APP_STATE.settings.finishMessage = elements.finishMessage.value;
            
            // Save original time
            saveOriginalTime();
            
            // Appearance settings
            APP_STATE.settings.bgColor = elements.bgColor.value;
            APP_STATE.settings.textColor = elements.textColor.value;
            APP_STATE.settings.outlineColor = elements.outlineColor.value;
            APP_STATE.settings.progressColor = elements.progressColor.value;
            APP_STATE.settings.outlineEnabled = elements.outlineToggle.classList.contains('active');
            APP_STATE.settings.outlineThickness = parseInt(elements.outlineThickness.value);
            APP_STATE.settings.bgOpacity = parseInt(elements.bgOpacity.value);
            APP_STATE.settings.panelOpacity = parseInt(elements.panelOpacity.value);
            
            // Font settings
            APP_STATE.currentFont = elements.fontFamily.value;
            APP_STATE.settings.fontSize = parseInt(elements.fontSize.value);
            APP_STATE.settings.fontWeight = elements.fontWeight.value;
            
            // Media settings
            APP_STATE.settings.mediaEnabled = elements.mediaToggle.classList.contains('active');
            APP_STATE.settings.mediaUrl = elements.mediaUrl.value;
            APP_STATE.settings.mediaAudioEnabled = elements.mediaAudioToggle.classList.contains('active');
            APP_STATE.settings.mediaOpacity = parseInt(elements.mediaOpacity.value);
            
            // Audio settings - تم التصحيح
            APP_STATE.settings.audioEnabled = elements.audioToggle.classList.contains('active');
            APP_STATE.settings.audioUrl = elements.audioUrl.value;
            APP_STATE.settings.audioVolume = parseInt(elements.volumeSlider.value);
            APP_STATE.settings.audioLoop = elements.loopToggle.classList.contains('active');
            APP_STATE.settings.tickSound = elements.tickToggle.classList.contains('active');
            APP_STATE.settings.finishSoundEnabled = elements.finishSoundToggle.classList.contains('active');
            APP_STATE.settings.clickSound = elements.clickSoundToggle.classList.contains('active');
            APP_STATE.settings.warningSoundEnabled = elements.warningSoundToggle.classList.contains('active');
            APP_STATE.settings.finishSound = elements.finishSound.value;
            APP_STATE.settings.warningSound = elements.warningSound.value;
            
            // Advanced settings
            APP_STATE.settings.wakeLockEnabled = elements.wakeLockToggle.classList.contains('active');
            APP_STATE.settings.autoStart = elements.autoStartToggle.classList.contains('active');
            APP_STATE.settings.flashEnabled = elements.flashToggle.classList.contains('active');
            APP_STATE.settings.showMilliseconds = elements.millisecondsToggle.classList.contains('active');
            APP_STATE.settings.vibrateOnFinish = elements.vibrateToggle.classList.contains('active');
            APP_STATE.settings.focusAutoHide = elements.focusAutoHideToggle.classList.contains('active');
            APP_STATE.settings.minimizedControls = elements.minimizedControlsToggle.classList.contains('active');
            
            // Update display
            updateTotalSeconds();
            updateDisplay();
            updateDigitColors();
            updateBackground();
            updateFontSettings();
            updateFocusModeUI();
            
            // Close settings
            toggleSettings();
            
            // Save to localStorage
            saveToLocalStorage();
            
            showToast('Settings applied successfully', 'success');
        }
        
        // Toggle outline
        function toggleOutline() {
            elements.outlineToggle.classList.toggle('active');
        }
        
        // Toggle media
        function toggleMedia() {
            elements.mediaToggle.classList.toggle('active');
        }
        
        // Toggle media audio
        function toggleMediaAudio() {
            elements.mediaAudioToggle.classList.toggle('active');
        }
        
        // Test media
        function testMedia() {
            const url = elements.mediaUrl.value;
            if (!url) {
                showToast('Please enter a media URL', 'warning');
                return;
            }
            
            const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi'];
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
            
            const extension = url.substring(url.lastIndexOf('.')).toLowerCase();
            
            if (videoExtensions.includes(extension)) {
                APP_STATE.settings.mediaType = 'video';
            } else if (imageExtensions.includes(extension)) {
                APP_STATE.settings.mediaType = 'image';
            } else {
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    showToast('YouTube URLs are not directly supported. Please use a direct video link.', 'warning');
                    return;
                } else {
                    APP_STATE.settings.mediaType = 'image';
                }
            }
            
            APP_STATE.settings.mediaUrl = url;
            updateMediaPreview();
            showToast('Media loaded for preview', 'success');
        }
        
        // Remove media
        function removeMedia() {
            APP_STATE.settings.mediaUrl = '';
            APP_STATE.settings.mediaType = '';
            elements.mediaUrl.value = '';
            updateMediaPreview();
            updateBackground();
            showToast('Media removed', 'info');
        }
        
        // Handle media file upload
        elements.mediaFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                APP_STATE.settings.mediaUrl = event.target.result;
                APP_STATE.settings.mediaType = file.type.startsWith('video/') ? 'video' : 'image';
                elements.mediaUrl.value = APP_STATE.settings.mediaUrl;
                updateMediaPreview();
                showToast('Media file loaded', 'success');
            };
            reader.readAsDataURL(file);
        });
        
        // Toggle audio
        function toggleAudio() {
            elements.audioToggle.classList.toggle('active');
        }
        
        // Test audio
        function testAudio() {
            const url = elements.audioUrl.value;
            if (!url) {
                showToast('Please enter an audio URL', 'warning');
                return;
            }
            
            if (APP_STATE.backgroundAudio) {
                APP_STATE.backgroundAudio.pause();
                APP_STATE.backgroundAudio = null;
            }
            
            APP_STATE.backgroundAudio = new Audio(url);
            APP_STATE.backgroundAudio.volume = APP_STATE.settings.audioVolume / 100;
            APP_STATE.backgroundAudio.loop = APP_STATE.settings.audioLoop;
            
            APP_STATE.backgroundAudio.play()
                .then(() => {
                    showToast('Audio playback started', 'success');
                })
                .catch(error => {
                    showToast('Failed to play audio: ' + error.message, 'error');
                });
        }
        
        // Remove audio
        function removeAudio() {
            if (APP_STATE.backgroundAudio) {
                APP_STATE.backgroundAudio.pause();
                APP_STATE.backgroundAudio = null;
            }
            
            APP_STATE.settings.audioUrl = '';
            elements.audioUrl.value = '';
            showToast('Audio removed', 'info');
        }
        
        // Handle audio file upload
        elements.audioFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                APP_STATE.settings.audioUrl = event.target.result;
                elements.audioUrl.value = APP_STATE.settings.audioUrl;
                showToast('Audio file loaded', 'success');
                
                testAudio();
            };
            reader.readAsDataURL(file);
        });
        
        // Update volume display
        elements.volumeSlider.addEventListener('input', function() {
            elements.volumeValue.textContent = this.value;
        });
        
        // Update opacity displays
        elements.bgOpacity.addEventListener('input', function() {
            elements.bgOpacityValue.textContent = this.value;
        });
        
        elements.panelOpacity.addEventListener('input', function() {
            elements.panelOpacityValue.textContent = this.value;
        });
        
        elements.mediaOpacity.addEventListener('input', function() {
            elements.mediaOpacityValue.textContent = this.value;
        });
        
        // Toggle loop
        function toggleLoop() {
            elements.loopToggle.classList.toggle('active');
        }
        
        // Toggle tick sound
        function toggleTickSound() {
            elements.tickToggle.classList.toggle('active');
        }
        
        // Toggle finish sound
        function toggleFinishSound() {
            elements.finishSoundToggle.classList.toggle('active');
        }
        
        // Toggle click sound
        function toggleClickSound() {
            elements.clickSoundToggle.classList.toggle('active');
        }
        
        // Toggle warning sound
        function toggleWarningSound() {
            elements.warningSoundToggle.classList.toggle('active');
        }
        
        // Toggle wake lock
        function toggleWakeLock() {
            elements.wakeLockToggle.classList.toggle('active');
        }
        
        // Toggle auto start
        function toggleAutoStart() {
            elements.autoStartToggle.classList.toggle('active');
        }
        
        // Toggle flash
        function toggleFlash() {
            elements.flashToggle.classList.toggle('active');
        }
        
        // Toggle milliseconds
        function toggleMilliseconds() {
            elements.millisecondsToggle.classList.toggle('active');
        }
        
        // Toggle vibrate
        function toggleVibrate() {
            elements.vibrateToggle.classList.toggle('active');
        }
        
        // Update outline thickness display
        elements.outlineThickness.addEventListener('input', function() {
            elements.outlineThicknessValue.textContent = this.value;
        });
        
        // Update font size display
        elements.fontSize.addEventListener('input', function() {
            elements.fontSizeValue.textContent = this.value;
        });
        
        // Link sliders and inputs
        function linkSliderAndInput(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            
            slider.addEventListener('input', function() {
                input.value = this.value;
            });
            
            input.addEventListener('input', function() {
                let value = parseInt(this.value) || 0;
                const max = parseInt(slider.max);
                const min = parseInt(slider.min);
                
                if (value > max) value = max;
                if (value < min) value = min;
                
                this.value = value;
                slider.value = value;
            });
        }
        
        // Link all timer controls
        linkSliderAndInput('hoursSlider', 'hoursInput');
        linkSliderAndInput('minutesSlider', 'minutesInput');
        linkSliderAndInput('secondsSlider', 'secondsInput');
        
        // ============================================
        // KEYBOARD TIME INPUT FUNCTIONALITY
        // ============================================
        
        // Open keyboard input overlay
        function openKeyboardInput() {
            const timeString = `${formatTime(APP_STATE.hours)}:${formatTime(APP_STATE.minutes)}:${formatTime(APP_STATE.seconds)}`;
            elements.manualTimeInput.value = timeString;
            elements.keyboardInputOverlay.classList.remove('hidden');
            elements.manualTimeInput.focus();
            elements.manualTimeInput.select();
        }
        
        // Close keyboard input overlay
        function closeKeyboardInput() {
            elements.keyboardInputOverlay.classList.add('hidden');
        }
        
        // Apply manual time input
        function applyManualTime() {
            const timeString = elements.manualTimeInput.value.trim();
            const timeRegex = /^(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            
            if (!timeRegex.test(timeString)) {
                showToast('Invalid time format. Use HH:MM:SS', 'error');
                return;
            }
            
            const matches = timeString.match(timeRegex);
            let hours = parseInt(matches[1]);
            let minutes = parseInt(matches[2]);
            let seconds = parseInt(matches[3]);
            
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59 || seconds < 0 || seconds > 59) {
                showToast('Invalid time values. Hours: 0-23, Minutes: 0-59, Seconds: 0-59', 'error');
                return;
            }
            
            saveOriginalTime();
            
            APP_STATE.hours = hours;
            APP_STATE.minutes = minutes;
            APP_STATE.seconds = seconds;
            
            updateTotalSeconds();
            updateDisplay();
            closeKeyboardInput();
            
            showToast(`Time set to ${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`, 'success');
        }
        
        // Handle direct keyboard input on timer display
        function handleTimerKeyboardInput(key) {
            if (APP_STATE.isRunning || APP_STATE.isFinished) return;
            
            if (key >= '0' && key <= '9') {
                APP_STATE.keyboardInputBuffer += key;
                
                if (APP_STATE.keyboardInputTimeout) {
                    clearTimeout(APP_STATE.keyboardInputTimeout);
                }
                
                APP_STATE.keyboardInputTimeout = setTimeout(() => {
                    APP_STATE.keyboardInputBuffer = '';
                }, 2000);
                
                if (APP_STATE.keyboardInputBuffer.length === 2) {
                    const minutes = parseInt(APP_STATE.keyboardInputBuffer);
                    if (minutes >= 0 && minutes <= 59) {
                        saveOriginalTime();
                        
                        APP_STATE.minutes = minutes;
                        APP_STATE.keyboardInputBuffer = '';
                        updateTotalSeconds();
                        updateDisplay();
                        showToast(`Minutes set to ${formatTime(minutes)}`, 'info');
                    }
                } else if (APP_STATE.keyboardInputBuffer.length === 4) {
                    const hours = parseInt(APP_STATE.keyboardInputBuffer.substring(0, 2));
                    const minutes = parseInt(APP_STATE.keyboardInputBuffer.substring(2, 4));
                    
                    if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                        saveOriginalTime();
                        
                        APP_STATE.hours = hours;
                        APP_STATE.minutes = minutes;
                        APP_STATE.keyboardInputBuffer = '';
                        updateTotalSeconds();
                        updateDisplay();
                        showToast(`Time set to ${formatTime(hours)}:${formatTime(minutes)}`, 'success');
                    }
                } else if (APP_STATE.keyboardInputBuffer.length === 6) {
                    const hours = parseInt(APP_STATE.keyboardInputBuffer.substring(0, 2));
                    const minutes = parseInt(APP_STATE.keyboardInputBuffer.substring(2, 4));
                    const seconds = parseInt(APP_STATE.keyboardInputBuffer.substring(4, 6));
                    
                    if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59 && seconds >= 0 && seconds <= 59) {
                        saveOriginalTime();
                        
                        APP_STATE.hours = hours;
                        APP_STATE.minutes = minutes;
                        APP_STATE.seconds = seconds;
                        APP_STATE.keyboardInputBuffer = '';
                        updateTotalSeconds();
                        updateDisplay();
                        showToast(`Time set to ${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`, 'success');
                    }
                }
            } else if (key === ':' || key === 'Enter') {
                openKeyboardInput();
            }
        }
        
        // ============================================
        // ENHANCED PRESET FUNCTIONS
        // ============================================
        
        // Save preset with confirmation
        function savePreset() {
            const name = elements.presetName.value.trim();
            if (!name) {
                showToast('Please enter a preset name', 'warning');
                return;
            }
            
            if (APP_STATE.presets[name]) {
                Swal.fire({
                    title: 'Overwrite Preset?',
                    text: `A preset named "${name}" already exists. Do you want to overwrite it?`,
                    icon: 'warning',
                    background: '#0f172a',
                    color: '#f8fafc',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, overwrite it!',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280'
                }).then((result) => {
                    if (result.isConfirmed) {
                        savePresetConfirmed(name);
                    }
                });
            } else {
                savePresetConfirmed(name);
            }
        }
        
        // Save preset confirmed
        function savePresetConfirmed(name) {
            APP_STATE.presets[name] = {
                timer: {
                    hours: APP_STATE.hours,
                    minutes: APP_STATE.minutes,
                    seconds: APP_STATE.seconds,
                    originalHours: APP_STATE.originalHours,
                    originalMinutes: APP_STATE.originalMinutes,
                    originalSeconds: APP_STATE.originalSeconds
                },
                settings: { ...APP_STATE.settings },
                timestamp: Date.now()
            };
            
            APP_STATE.currentPreset = name;
            updatePresetList();
            saveToLocalStorage();
            
            showToast(`Preset "${name}" saved`, 'success');
        }
        
        // Load preset
        function loadPreset() {
            const name = elements.presetList.value;
            if (!name || !APP_STATE.presets[name]) {
                showToast('Please select a preset', 'warning');
                return;
            }
            
            const preset = APP_STATE.presets[name];
            
            Swal.fire({
                title: 'Load Preset?',
                text: `Are you sure you want to load preset "${name}"?`,
                icon: 'question',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, load it!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    APP_STATE.hours = preset.timer.hours;
                    APP_STATE.minutes = preset.timer.minutes;
                    APP_STATE.seconds = preset.timer.seconds;
                    APP_STATE.originalHours = preset.timer.originalHours || preset.timer.hours;
                    APP_STATE.originalMinutes = preset.timer.originalMinutes || preset.timer.minutes;
                    APP_STATE.originalSeconds = preset.timer.originalSeconds || preset.timer.seconds;
                    updateTotalSeconds();
                    
                    APP_STATE.settings = { ...APP_STATE.settings, ...preset.settings };
                    
                    updateDisplay();
                    updateSettingsUI();
                    applySettings();
                    
                    APP_STATE.currentPreset = name;
                    elements.presetName.value = name;
                    
                    showToast(`Preset "${name}" loaded`, 'success');
                }
            });
        }
        
        // Update preset list
        function updatePresetList() {
            const select = elements.presetList;
            select.innerHTML = '<option value="">Select a preset...</option>';
            
            const presetNames = Object.keys(APP_STATE.presets).sort((a, b) => {
                return (APP_STATE.presets[b].timestamp || 0) - (APP_STATE.presets[a].timestamp || 0);
            });
            
            for (const name of presetNames) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
            
            if (APP_STATE.currentPreset) {
                select.value = APP_STATE.currentPreset;
            }
        }
        
        // Export settings
        function exportSettings() {
            const data = {
                settings: APP_STATE.settings,
                presets: APP_STATE.presets,
                uploadedFonts: APP_STATE.uploadedFonts,
                currentFont: APP_STATE.currentFont,
                version: '2.0.1',
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `protimer-settings-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Settings exported successfully', 'success');
        }
        
        // Import settings
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => { 
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        Swal.fire({
                            title: 'Import Settings?',
                            text: 'This will overwrite your current settings and presets. Are you sure?',
                            icon: 'warning',
                            background: '#0f172a',
                            color: '#f8fafc',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, import them!',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#ef4444',
                            cancelButtonColor: '#6b7280'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                if (data.settings) {
                                    APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
                                }
                                
                                if (data.presets) {
                                    APP_STATE.presets = data.presets;
                                }
                                
                                if (data.uploadedFonts) {
                                    APP_STATE.uploadedFonts = data.uploadedFonts;
                                }
                                
                                if (data.currentFont) {
                                    APP_STATE.currentFont = data.currentFont;
                                }
                                
                                updateSettingsUI();
                                applySettings();
                                updateUploadedFontsList();
                                updatePresetList();
                                saveToLocalStorage();
                                
                                showToast('Settings imported successfully', 'success');
                            }
                        });
                    } catch (error) {
                        showToast('Failed to import settings: Invalid file format', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Reset all settings
        function resetAllSettings() {
            Swal.fire({
                title: 'Reset All Settings?',
                text: 'This will reset ALL settings to defaults and cannot be undone!',
                icon: 'warning',
                background: '#0f172a',
                color: '#f8fafc',
                showCancelButton: true,
                confirmButtonText: 'Yes, reset everything!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                showDenyButton: true,
                denyButtonText: 'Keep presets only'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetEverything();
                } else if (result.isDenied) {
                    resetSettingsKeepPresets();
                }
            });
        }
        
        // Reset everything
        function resetEverything() {
            APP_STATE.hours = 0;
            APP_STATE.minutes = 10;
            APP_STATE.seconds = 0;
            saveOriginalTime();
            updateTotalSeconds();
            
            APP_STATE.settings = {
                bgColor: '#0f172a',
                textColor: '#ffffff',
                outlineColor: '#000000',
                progressColor: '#6366f1',
                outlineEnabled: false,
                outlineThickness: 2,
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: 12,
                fontWeight: 700,
                bgOpacity: 100,
                panelOpacity: 90,
                
                mediaEnabled: false,
                mediaUrl: '',
                mediaType: '',
                mediaAudioEnabled: false,
                mediaOpacity: 30,
                
                audioEnabled: false,
                audioUrl: '',
                audioLoop: true,
                audioVolume: 50,
                
                finishMessage: "Time's Up!",
                flashEnabled: true,
                wakeLockEnabled: false,
                autoStart: false,
                showMilliseconds: false,
                vibrateOnFinish: true,
                focusAutoHide: true,
                minimizedControls: true,
                
                finishSound: 'bell',
                tickSound: true,
                clickSound: true,
                finishSoundEnabled: true,
                warningSound: 'tick',
                warningSoundEnabled: true
            };
            
            APP_STATE.uploadedFonts = {};
            APP_STATE.currentFont = "'JetBrains Mono', monospace";
            
            APP_STATE.presets = {};
            APP_STATE.currentPreset = null;
            
            APP_STATE.focusMode = false;
            document.body.classList.remove('focus-mode');
            
            updateDisplay();
            updateSettingsUI();
            applySettings();
            updateUploadedFontsList();
            updateFocusModeUI();
            
            showToast('All settings reset to defaults', 'success');
        }
        
        // Reset settings but keep presets
        function resetSettingsKeepPresets() {
            APP_STATE.hours = 0;
            APP_STATE.minutes = 10;
            APP_STATE.seconds = 0;
            saveOriginalTime();
            updateTotalSeconds();
            
            APP_STATE.settings = {
                bgColor: '#0f172a',
                textColor: '#ffffff',
                outlineColor: '#000000',
                progressColor: '#6366f1',
                outlineEnabled: false,
                outlineThickness: 2,
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: 12,
                fontWeight: 700,
                bgOpacity: 100,
                panelOpacity: 90,
                
                mediaEnabled: false,
                mediaUrl: '',
                mediaType: '',
                mediaAudioEnabled: false,
                mediaOpacity: 30,
                
                audioEnabled: false,
                audioUrl: '',
                audioLoop: true,
                audioVolume: 50,
                
                finishMessage: "Time's Up!",
                flashEnabled: true,
                wakeLockEnabled: false,
                autoStart: false,
                showMilliseconds: false,
                vibrateOnFinish: true,
                focusAutoHide: true,
                minimizedControls: true,
                
                finishSound: 'bell',
                tickSound: true,
                clickSound: true,
                finishSoundEnabled: true,
                warningSound: 'tick',
                warningSoundEnabled: true
            };
            
            APP_STATE.currentFont = "'JetBrains Mono', monospace";
            
            APP_STATE.focusMode = false;
            document.body.classList.remove('focus-mode');
            
            updateDisplay();
            updateSettingsUI();
            applySettings();
            updateFocusModeUI();
            
            showToast('Settings reset, presets kept', 'success');
        }
        
        // ============================================
        // ENHANCED SYSTEM FUNCTIONS
        // ============================================
        
        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    showToast('Fullscreen not supported', 'warning');
                });
                APP_STATE.isFullscreen = true;
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress text-lg"></i><span>EXIT FULLSCREEN</span>';
            } else {
                document.exitFullscreen();
                APP_STATE.isFullscreen = false;
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand text-lg"></i><span>FULLSCREEN</span>';
            }
        }
        
        // Toggle shortcuts help
        function toggleShortcutsHelp() {
            elements.shortcutsHelp.classList.toggle('hidden');
        }
        
        // Update current time in 12-hour format
        function updateCurrentTime() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12;
            
            const timeString = `${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)} ${ampm}`;
            elements.currentTime.textContent = timeString;
        }
        
        // Enhanced keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if (e.code === 'Space' && !e.target.matches('input, textarea, select')) {
                e.preventDefault();
                toggleTimer();
                
                const btn = elements.startPauseBtn;
                btn.classList.add('scale-95');
                setTimeout(() => btn.classList.remove('scale-95'), 200);
                
                return;
            }
            
            if (e.code === 'KeyF' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                e.preventDefault();
                toggleFocusMode();
                return;
            }
            
            if (e.code === 'F11') {
                e.preventDefault();
                toggleFullscreen();
                return;
            }
            
            if (e.code === 'Escape') {
                if (!elements.settingsPanel.classList.contains('translate-x-full')) {
                    toggleSettings();
                }
                if (!elements.finishOverlay.classList.contains('hidden')) {
                    closeFinishOverlay();
                }
                if (!elements.keyboardInputOverlay.classList.contains('hidden')) {
                    closeKeyboardInput();
                }
                if (!elements.shortcutsHelp.classList.contains('hidden')) {
                    toggleShortcutsHelp();
                }
                return;
            }
            
            if ((e.ctrlKey || e.metaKey) && e.code === 'KeyS') {
                e.preventDefault();
                savePreset();
                return;
            }
            
            if ((e.ctrlKey || e.metaKey) && e.code === 'KeyO') {
                e.preventDefault();
                toggleSettings();
                return;
            }
            
            if ((e.ctrlKey || e.metaKey) && e.code === 'KeyI') {
                e.preventDefault();
                openKeyboardInput();
                return;
            }
            
            if (e.code.startsWith('Digit') && !APP_STATE.isRunning && !e.target.matches('input, textarea, select')) {
                const number = parseInt(e.code.replace('Digit', ''));
                
                const presets = {
                    1: { minutes: 1, seconds: 0 },
                    2: { minutes: 2, seconds: 0 },
                    3: { minutes: 5, seconds: 0 },
                    4: { minutes: 10, seconds: 0 },
                    5: { minutes: 15, seconds: 0 },
                    6: { minutes: 30, seconds: 0 },
                    7: { minutes: 45, seconds: 0 },
                    8: { hours: 1, minutes: 0, seconds: 0 },
                    9: { hours: 1, minutes: 30, seconds: 0 },
                    0: { hours: 2, minutes: 0, seconds: 0 }
                };
                
                if (presets[number]) {
                    saveOriginalTime();
                    
                    APP_STATE.minutes = presets[number].minutes || 0;
                    APP_STATE.hours = presets[number].hours || 0;
                    APP_STATE.seconds = presets[number].seconds || 0;
                    updateTotalSeconds();
                    updateDisplay();
                    showToast(`Quick preset ${number} loaded`, 'info');
                }
                
                handleTimerKeyboardInput(number.toString());
            }
            
            if ((e.code === 'Equal' && e.shiftKey) || e.code === 'NumpadAdd') {
                e.preventDefault();
                if (!APP_STATE.isRunning) {
                    addMinutes(1);
                }
                return;
            }
            
            if (e.code === 'Minus' || e.code === 'NumpadSubtract') {
                e.preventDefault();
                if (!APP_STATE.isRunning) {
                    const totalMinutes = APP_STATE.hours * 60 + APP_STATE.minutes;
                    if (totalMinutes > 0) {
                        addMinutes(-1);
                    }
                }
                return;
            }
            
            if (e.code === 'KeyR' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                confirmReset();
                return;
            }
            
            if (e.code === 'Semicolon' && e.shiftKey) {
                e.preventDefault();
                openKeyboardInput();
                return;
            }
            
            if (!APP_STATE.isRunning && !e.target.matches('input, textarea, select')) {
                const key = e.key;
                if ((key >= '0' && key <= '9') || key === ':' || key === 'Enter') {
                    e.preventDefault();
                    handleTimerKeyboardInput(key);
                }
            }
            
            if (e.code === 'KeyH' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                toggleShortcutsHelp();
                return;
            }
        }
        
        // Handle fullscreen change
        function handleFullscreenChange() {
            if (!document.fullscreenElement && APP_STATE.isFullscreen) {
                APP_STATE.isFullscreen = false;
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand text-lg"></i><span>FULLSCREEN</span>';
            }
        }
        
        // Handle visibility change for PWA
        function handleVisibilityChange() {
            if (document.hidden && APP_STATE.isRunning) {
                console.log('App went to background');
            }
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        function initializeApp() {
            checkPWAInstallation();
            
            updateDisplay();
            updateCurrentTime();
            
            saveOriginalTime();
            
            setInterval(updateCurrentTime, 1000);
            
            loadFromLocalStorage();
            
            setupAutoSave();
            
            applySettings();
            
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            elements.mediaFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    APP_STATE.settings.mediaUrl = event.target.result;
                    APP_STATE.settings.mediaType = file.type.startsWith('video/') ? 'video' : 'image';
                    elements.mediaUrl.value = APP_STATE.settings.mediaUrl;
                    updateMediaPreview();
                    showToast('Media file loaded', 'success');
                };
                reader.readAsDataURL(file);
            });
            
            elements.audioFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    APP_STATE.settings.audioUrl = event.target.result;
                    elements.audioUrl.value = APP_STATE.settings.audioUrl;
                    showToast('Audio file loaded', 'success');
                };
                reader.readAsDataURL(file);
            });
            
            if (APP_STATE.settings.autoStart && APP_STATE.totalSeconds > 0) {
                setTimeout(() => {
                    startTimer();
                }, 1000);
            }
            
            setTimeout(() => {
                showToast('Professional Timer v2.0.1 loaded successfully!', 'success');
                if (!isPWAInstalled) {
                    showToast('Install as app for better experience', 'info', 5000);
                }
            }, 1000);
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            document.querySelectorAll('.time-value').forEach(digit => {
                digit.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                    openKeyboardInput();
                });
            });
            
            document.querySelectorAll('button, .time-value, .tab, .toggle-switch, .control-btn').forEach(el => {
                el.classList.add('touch-feedback');
            });
            
            console.log('Professional Timer PWA App v2.0.1 initialized successfully');
        }
        
        window.addEventListener('DOMContentLoaded', initializeApp);
        
        document.addEventListener('touchend', function(e) {
            handleTouchEnd();
        });
    </script>
</body>
</html>