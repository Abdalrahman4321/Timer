// ============================================
// إصلاح كامل لنظام اللمس المزدوج والاختصارات
// ============================================

// 1. إصلاح اللمس المزدوج مع إدارة الإعدادات
let touchSettings = {
    isEnabled: true,
    tapCount: 0,
    lastTapTime: 0,
    tapTimeout: null
};

// 2. تعطيل نظام اللمس المزدوج القديم
function disableOldTouchSystem() {
    // تعطيل الحدث القديم على أرقام الوقت
    document.querySelectorAll('.time-value').forEach(digit => {
        digit.onclick = null;
        digit.ontouchstart = null;
        digit.ontouchend = null;
        digit.ondblclick = null;
        
        // إضافة النظام الجديد
        digit.addEventListener('click', handleNewTimeClick);
        digit.addEventListener('touchstart', handleNewTouchStart);
        digit.addEventListener('touchend', handleNewTouchEnd);
    });
}

// 3. نظام النقر الجديد
function handleNewTimeClick(e) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) return;
    
    const type = e.target.id.includes('hours') ? 'hours' : 
                e.target.id.includes('minutes') ? 'minutes' : 'seconds';
    
    if (!APP_STATE.settings.doubleTapEnabled) {
        // إذا اللمس المزدوج معطل: نقر واحد يضيف وقت
        adjustTime(type, 1);
        return;
    }
    
    // النظام القديم للكشف عن النقر المزدوج (للسيطرة)
    const now = Date.now();
    if (touchSettings.tapTimeout) clearTimeout(touchSettings.tapTimeout);
    
    touchSettings.tapCount++;
    
    if (touchSettings.tapCount === 1) {
        touchSettings.tapTimeout = setTimeout(() => {
            // نقر واحد - ضبط الوقت
            if (APP_STATE.settings.clickAdjustEnabled) {
                adjustTime(type, 1);
            }
            touchSettings.tapCount = 0;
        }, 300);
    } else if (touchSettings.tapCount === 2) {
        clearTimeout(touchSettings.tapTimeout);
        // نقر مزدوج - فتح الإدخال اليدوي
        openKeyboardInput();
        touchSettings.tapCount = 0;
    }
}

// 4. نظام اللمس للجوال
function handleNewTouchStart(e) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) return;
    
    const target = e.target;
    const type = target.id.includes('hours') ? 'hours' : 
                target.id.includes('minutes') ? 'minutes' : 'seconds';
    
    // إضافة تأثير مرئي
    target.classList.add('scale-95', 'opacity-80');
    
    // إذا كان اللمس المزدوج معطل - ضبط الوقت مباشرة
    if (!APP_STATE.settings.doubleTapEnabled && APP_STATE.settings.clickAdjustEnabled) {
        adjustTime(type, 1);
    }
}

function handleNewTouchEnd(e) {
    const target = e.target;
    target.classList.remove('scale-95', 'opacity-80');
}

// 5. إصلاح اختصارات لوحة المفاتيح أثناء الكتابة
function fixKeyboardShortcutsWhileTyping() {
    // تعطيل الاختصارات أثناء الكتابة في أي حقل إدخال
    document.addEventListener('keydown', (e) => {
        const activeElement = document.activeElement;
        const isInput = activeElement.tagName === 'INPUT' || 
                       activeElement.tagName === 'TEXTAREA' || 
                       activeElement.tagName === 'SELECT';
        
        if (isInput) {
            // السماح فقط ببعض المفاتيح الأساسية
            const allowedKeys = [
                'Escape', 'Tab', 'Enter',
                'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
                'Backspace', 'Delete', 'Home', 'End'
            ];
            
            // منع جميع اختصارات التطبيق أثناء الكتابة
            if (!allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey) {
                e.stopPropagation();
            }
            
            // السماح بـ Escape فقط لإغلاق النوافذ
            if (e.key === 'Escape') {
                if (!elements.keyboardInputOverlay.classList.contains('hidden')) {
                    closeKeyboardInput();
                    e.preventDefault();
                }
                if (elements.quickTasksPanel.classList.contains('show')) {
                    toggleQuickTasks();
                }
            }
        }
    }, true); // استخدام capture: true للسيطرة على الأحداث
}

// 6. تحديث وظيفة تعديل الوقت لتجنب التعارض
function adjustTimeFixed(type, amount) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) {
        if (APP_STATE.settings.notificationsEnabled) {
            showToast('لا يمكن تعديل الوقت أثناء تشغيل المؤقت', 'warning');
        }
        return;
    }
    
    // التحقق من إعدادات تعديل النقر
    if (!APP_STATE.settings.clickAdjustEnabled) {
        if (APP_STATE.settings.notificationsEnabled) {
            showToast('تعديل الوقت بالنقر معطل. قم بتفعيله في الإعدادات', 'info');
        }
        return;
    }
    
    // تشغيل صوت النقر إذا مفعل
    if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
        playSound('click');
    }
    
    // حفظ الوقت الأصلي
    saveOriginalTime();
    
    // تعديل الوقت
    switch(type) {
        case 'hours':
            APP_STATE.hours = (APP_STATE.hours + amount + 100) % 100;
            break;
        case 'minutes':
            APP_STATE.minutes = (APP_STATE.minutes + amount + 60) % 60;
            break;
        case 'seconds':
            APP_STATE.seconds = (APP_STATE.seconds + amount + 60) % 60;
            break;
    }
    
    updateTotalSeconds();
    updateDisplay();
    
    // إشعار إذا كان مفعلاً
    if (APP_STATE.settings.notificationsEnabled) {
        const direction = amount > 0 ? 'زاد' : 'نقص';
        showToast(`${type} ${direction} بمقدار ${Math.abs(amount)}`, 'info');
    }
    
    saveToLocalStorage();
}

// 7. إصلاح إعدادات اللمس المزدوج
function setupDoubleTapSettings() {
    // تحديث القيمة الأولية
    APP_STATE.settings.doubleTapEnabled = true;
    
    // ربط التبديل مع الوظيفة الصحيحة
    if (elements.doubleTapToggle) {
        elements.doubleTapToggle.onclick = function() {
            this.classList.toggle('active');
            APP_STATE.settings.doubleTapEnabled = this.classList.contains('active');
            
            if (APP_STATE.settings.doubleTapEnabled) {
                showToast('اللمس المزدوج مفعل للإدخال اليدوي', 'info');
            } else {
                showToast('اللمس المزدوج معطل - النقر يضبط الوقت مباشرة', 'info');
            }
        };
    }
}

// 8. إصلاح إعدادات تعديل النقر
function setupClickAdjustSettings() {
    // تحديث القيمة الأولية
    APP_STATE.settings.clickAdjustEnabled = true;
    
    // ربط التبديل مع الوظيفة الصحيحة
    if (elements.clickAdjustToggle) {
        elements.clickAdjustToggle.onclick = function() {
            this.classList.toggle('active');
            APP_STATE.settings.clickAdjustEnabled = this.classList.contains('active');
            
            if (APP_STATE.settings.clickAdjustEnabled) {
                showToast('تعديل الوقت بالنقر مفعل', 'info');
            } else {
                showToast('تعديل الوقت بالنقر معطل', 'info');
            }
        };
    }
}

// 9. وظيفة إعادة تهيئة النظام بالكامل
function reinitializeTouchSystem() {
    // تعطيل النظام القديم
    disableOldTouchSystem();
    
    // إصلاح الاختصارات أثناء الكتابة
    fixKeyboardShortcutsWhileTyping();
    
    // إعداد إعدادات اللمس المزدوج
    setupDoubleTapSettings();
    
    // إعداد إعدادات تعديل النقر
    setupClickAdjustSettings();
    
    // استبدال وظيفة adjustTime القديمة
    window.adjustTime = adjustTimeFixed;
    
    console.log('تم إعادة تهيئة نظام اللمس والاختصارات بنجاح');
}

// 10. تهيئة النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        reinitializeTouchSystem();
        showToast('نظام اللمس والاختصارات جاهز للاستخدام', 'success');
    }, 1500);
});

// 11. إصلاح مشكلة الكتابة في المهام
function fixTaskInputIssue() {
    const taskInput = document.getElementById('newTaskInput');
    if (taskInput) {
        taskInput.addEventListener('keydown', function(e) {
            // منع تنفيذ اختصارات التطبيق أثناء الكتابة
            e.stopPropagation();
            
            // السماح فقط بـ Enter لإضافة المهمة
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewTask();
            }
        });
    }
}

// 12. إضافة هذه الوظيفة إلى تهيئة التطبيق
if (typeof initializeApp === 'function') {
    const originalInit = initializeApp;
    window.initializeApp = function() {
        originalInit();
        setTimeout(() => {
            fixTaskInputIssue();
        }, 1000);
    };
}

// 13. تحديث أزرار الكويك أدد
function setupQuickAddButtons() {
    // ربط جميع أزرار إضافة الدقائق
    const quickAddSelectors = [
        'button[onclick*="addMinutes(1)"]',
        'button[onclick*="addMinutes(5)"]',
        'button[onclick*="addMinutes(10)"]',
        'button[onclick*="addMinutes(15)"]',
        'button[onclick*="addMinutes(30)"]'
    ];
    
    quickAddSelectors.forEach(selector => {
        const buttons = document.querySelectorAll(selector);
        buttons.forEach(btn => {
            const match = btn.getAttribute('onclick')?.match(/addMinutes\((\d+)\)/);
            if (match) {
                const minutes = parseInt(match[1]);
                btn.onclick = () => addMinutesFixed(minutes);
            }
        });
    });
}

// 14. نسخة محسنة من addMinutes
function addMinutesFixed(minutes) {
    if (APP_STATE.isRunning || APP_STATE.isFinished) {
        showToast('لا يمكن تعديل الوقت أثناء تشغيل المؤقت', 'warning');
        return;
    }
    
    if (APP_STATE.audioEnabled && APP_STATE.settings.clickSound) {
        playSound('click');
    }
    
    saveOriginalTime();
    
    const totalMinutes = APP_STATE.hours * 60 + APP_STATE.minutes + minutes;
    APP_STATE.hours = Math.floor(totalMinutes / 60);
    APP_STATE.minutes = totalMinutes % 60;
    
    if (APP_STATE.hours < 0) APP_STATE.hours = 0;
    if (APP_STATE.minutes < 0) APP_STATE.minutes = 0;
    
    updateTotalSeconds();
    updateDisplay();
    
    showToast(`تم إضافة ${minutes} دقيقة`, 'info');
    saveToLocalStorage();
}

// 15. تشغيل جميع الإصلاحات
function runAllFixes() {
    reinitializeTouchSystem();
    setupQuickAddButtons();
    fixTaskInputIssue();
    
    // تحديث وظائف النقر الأساسية
    window.adjustTime = adjustTimeFixed;
    window.addMinutes = addMinutesFixed;
    
    console.log('تم تطبيق جميع الإصلاحات بنجاح');
}

// 16. تشغيل الإصلاحات عند تحميل الصفحة
window.addEventListener('load', function() {
    setTimeout(runAllFixes, 2000);
});